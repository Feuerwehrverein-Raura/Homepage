<!DOCTYPE html>
<html lang="de" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veranstaltungen - Feuerwehrverein Raura Kaiseraugst</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fire: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="font-sans antialiased bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-fire-700 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-fire-300 shadow-lg bg-white">
                        <img src="images/logo.png" alt="Feuerwehrverein Raura Logo" class="w-full h-full object-contain p-1">
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Feuerwehrverein Raura</h1>
                        <p class="text-fire-200 text-sm">Kaiseraugst</p>
                    </div>
                </div>
                <div class="flex space-x-6">
                    <a href="index.html" class="hover:text-fire-200 transition-colors">Home</a>
                    <a href="calendar.html" class="hover:text-fire-200 transition-colors">Kalender</a>
                    <a href="events.html" class="text-fire-200 font-semibold">Veranstaltungen</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <section class="bg-gradient-to-r from-fire-600 to-fire-700 text-white py-12">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl font-bold mb-4">Unsere Veranstaltungen</h2>
            <p class="text-fire-100 text-lg mb-6">Detaillierte Informationen zu allen Terminen und Events</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="filter-all" class="filter-btn active bg-white text-fire-700 px-6 py-3 rounded-lg font-semibold hover:bg-fire-50 transition-colors" data-filter="all">
                    Alle Veranstaltungen
                </button>
                <button id="filter-upcoming" class="filter-btn border-2 border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-white hover:text-fire-700 transition-colors" data-filter="upcoming">
                    Kommende
                </button>
                <button id="filter-past" class="filter-btn border-2 border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-white hover:text-fire-700 transition-colors" data-filter="past">
                    Vergangene
                </button>
            </div>
        </div>
    </section>

    <!-- Filters and Search -->
    <section class="bg-white shadow-sm py-6">
        <div class="container mx-auto px-4">
            <div class="flex flex-col lg:flex-row justify-between items-center space-y-4 lg:space-y-0">
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Veranstaltungen suchen..." 
                               class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500 w-full sm:w-64">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-400">🔍</span>
                        </div>
                    </div>
                    <select id="category-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                        <option value="">Alle Kategorien</option>
                        <option value="Hauptveranstaltung">Hauptveranstaltung</option>
                        <option value="Gesellschaftsanlass">Gesellschaftsanlass</option>
                        <option value="Ausflug">Ausflug</option>
                        <option value="Vereinsintern">Vereinsintern</option>
                    </select>
                </div>
                <div class="flex space-x-2">
                    <button id="list-view-btn" class="p-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600 transition-colors">
                        <span class="text-xl">📋</span>
                    </button>
                    <button id="grid-view-btn" class="p-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors">
                        <span class="text-xl">⊞</span>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Events List -->
    <section class="py-8">
        <div class="container mx-auto px-4">
            <div id="events-container" class="space-y-6">
                <!-- Events will be loaded here -->
            </div>
            
            <!-- No events message -->
            <div id="no-events" class="hidden text-center py-12">
                <div class="text-gray-400 text-6xl mb-4">📅</div>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">Keine Veranstaltungen gefunden</h3>
                <p class="text-gray-500">Versuchen Sie andere Suchkriterien oder Filter.</p>
            </div>
        </div>
    </section>

    <!-- Event Detail Modal -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="relative">
                <!-- Modal Header -->
                <div id="modal-header" class="bg-gradient-to-r from-fire-500 to-fire-600 text-white p-6 rounded-t-lg">
                    <button id="close-modal" class="absolute top-4 right-4 text-white hover:text-fire-200 text-2xl">×</button>
                    <h2 id="modal-title" class="text-2xl font-bold mb-2"></h2>
                    <div id="modal-meta" class="flex flex-wrap gap-4 text-fire-100 text-sm"></div>
                </div>
                
                <!-- Modal Content -->
                <div class="p-6">
                    <div id="modal-content" class="prose max-w-none">
                        <!-- Event details will be loaded here -->
                    </div>
                    
                    <!-- Registration Section -->
                    <div id="registration-section" class="hidden mt-8 border-t pt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">📧 Anmeldung</h3>
                        
                        <!-- Shift Selection -->
                        <div id="shift-selection" class="hidden mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Verfügbare Schichten:</h4>
                            <div id="shifts-container" class="space-y-2">
                                <!-- Shifts will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Personal Information -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                                <input type="text" id="reg-name" placeholder="Ihr Name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">E-Mail *</label>
                                <input type="email" id="reg-email" placeholder="ihre@email.ch" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Telefon</label>
                                <input type="tel" id="reg-phone" placeholder="079 123 45 67" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div id="participants-section" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Anzahl Personen</label>
                                <select id="reg-participants" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                                    <option value="1">1 Person</option>
                                    <option value="2">2 Personen</option>
                                    <option value="3">3 Personen</option>
                                    <option value="4">4 Personen</option>
                                    <option value="5">5+ Personen</option>
                                </select>
                            </div>
                        </div>

                        <!-- Additional Notes -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bemerkungen</label>
                            <textarea id="reg-notes" rows="3" placeholder="Besondere Wünsche, Allergien, etc." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500"></textarea>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                            <button id="send-registration-email" class="flex-1 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center space-x-2">
                                <span>📧</span>
                                <span>Anmeldung per E-Mail senden</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Shift Planning Section -->
                    <div id="shift-planning-section" class="hidden mt-8 border-t pt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">👷 Schichtplanung</h3>
                        
                        <!-- Shift Overview -->
                        <div id="shift-overview" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <!-- Shift statistics will be populated by JavaScript -->
                        </div>
                        
                        <!-- Critical Shifts Alert -->
                        <div id="critical-shifts" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                            <div class="flex items-start space-x-3">
                                <div class="text-red-500 text-xl">⚠️</div>
                                <div>
                                    <h4 class="font-semibold text-red-800 mb-2">Dringend: Helfer gesucht!</h4>
                                    <div id="critical-shifts-list" class="text-red-700 text-sm"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Button -->
                        <div class="flex space-x-3">
                            <button id="view-arbeitsplan" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2">
                                <span>📋</span>
                                <span>Vollständigen Arbeitsplan anzeigen</span>
                            </button>
                        </div>
                    </div>

                    <!-- Regular Modal Actions -->
                    <div class="mt-6 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                        <button id="download-event-ics" class="flex-1 bg-fire-500 text-white px-4 py-3 rounded-lg hover:bg-fire-600 transition-colors flex items-center justify-center space-x-2">
                            <span>⬇️</span>
                            <span>ICS herunterladen</span>
                        </button>
                        <button id="share-event" class="flex-1 border border-fire-500 text-fire-500 px-4 py-3 rounded-lg hover:bg-fire-50 transition-colors flex items-center justify-center space-x-2">
                            <span>📤</span>
                            <span>Teilen</span>
                        </button>
                        <button id="close-modal-btn" class="flex-1 border border-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors">
                            Schließen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Arbeitsplan Modal -->
    <div id="arbeitsplan-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div class="relative">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-t-lg">
                    <button id="close-arbeitsplan-modal" class="absolute top-4 right-4 text-white hover:text-blue-200 text-2xl">×</button>
                    <h2 id="arbeitsplan-title" class="text-2xl font-bold mb-2">Arbeitsplan</h2>
                    <p id="arbeitsplan-status" class="text-blue-100 text-sm"></p>
                </div>
                
                <!-- Modal Content -->
                <div class="p-6">
                    <div id="arbeitsplan-content">
                        <!-- Arbeitsplan content will be loaded here -->
                    </div>
                    
                    <!-- Modal Actions -->
                    <div class="mt-6 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                        <button id="download-arbeitsplan-pdf" class="flex-1 bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center space-x-2">
                            <span>📄</span>
                            <span>PDF herunterladen</span>
                        </button>
                        <button id="edit-arbeitsplan" class="flex-1 border border-blue-500 text-blue-500 px-4 py-3 rounded-lg hover:bg-blue-50 transition-colors flex items-center justify-center space-x-2">
                            <span>✏️</span>
                            <span>Bearbeiten</span>
                        </button>
                        <button id="close-arbeitsplan-modal-btn" class="flex-1 border border-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors">
                            Schließen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-fire-500 mx-auto mb-4"></div>
            <p class="text-gray-600">Lade Veranstaltungen...</p>
        </div>
    </div>

    <script src="scripts/config.js"></script>
    <script>
        class EventsManager {
            constructor() {
                this.events = [];
                this.filteredEvents = [];
                this.currentFilter = 'all';
                this.currentCategory = '';
                this.searchQuery = '';
                this.viewMode = 'list';
                this.selectedEvent = null;
                this.selectedShifts = [];
                this.arbeitsplanData = {};
                
                this.init();
            }

            async init() {
                console.log('🔄 Initialisiere Event-System...');
                await this.loadEvents();
                await this.loadArbeitsplanData();
                this.setupEventListeners();
                this.filterEvents();
                this.renderEvents();
                document.getElementById('loading').classList.add('hidden');
            }

            async loadEvents() {
                try {
                    console.log('📂 Lade Events aus Markdown-Dateien...');
                    this.events = await this.loadEventsFromMarkdown();
                    console.log(`✅ ${this.events.length} Events erfolgreich geladen:`, 
                        this.events.map(e => `${e.title} (${e.id})`));
                } catch (error) {
                    console.error('❌ Fehler beim Laden der Veranstaltungen:', error);
                    this.events = await this.getFallbackEvents();
                }
            }

            async loadArbeitsplanData() {
                for (const event of this.events) {
                    if (event.shifts && event.shifts.length > 0) {
                        const arbeitsplanFile = `events/${event.id}-assignments.md`;
                        try {
                            console.log(`📋 Lade Arbeitsplan: ${arbeitsplanFile}`);
                            const response = await fetch(arbeitsplanFile);
                            
                            if (!response.ok) {
                                console.warn(`⚠️ ${arbeitsplanFile}: HTTP ${response.status}`);
                                this.createEmptyArbeitsplan(event);
                                continue;
                            }
                            
                            const content = await response.text();
                            console.log(`✅ ${arbeitsplanFile}: ${content.length} Zeichen geladen`);
                            
                            const arbeitsplan = this.parseArbeitsplanMarkdown(content, event);
                            this.arbeitsplanData[event.id] = arbeitsplan;
                            
                            console.log(`📊 Arbeitsplan ${event.id}: ${arbeitsplan.filledShifts}/${arbeitsplan.totalShifts} Schichten besetzt`);
                            
                        } catch (error) {
                            console.warn(`❌ Fehler beim Laden von ${arbeitsplanFile}:`, error);
                            this.createEmptyArbeitsplan(event);
                        }
                    }
                }
            }

            createEmptyArbeitsplan(event) {
                this.arbeitsplanData[event.id] = {
                    assignments: {},
                    lastUpdated: new Date(),
                    totalShifts: event.shifts?.length || 0,
                    filledShifts: 0
                };
            }

            parseArbeitsplanMarkdown(content, event) {
                const assignments = {};
                let filledShifts = 0;
                
                try {
                    const lines = content.split('\n');
                    let currentShiftId = null;
                    
                    console.log('🔍 DEBUG: Starte Arbeitsplan-Parsing');
                    console.log(`📄 Content Länge: ${content.length} Zeichen`);
                    console.log(`📋 Anzahl Zeilen: ${lines.length}`);
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        
                        // Debug für Aufbau-Bereich
                        if (i >= 8 && i <= 16) {
                            console.log(`Zeile ${i+1}: "${line}"`);
                        }
                        
                        // Erkenne Schicht-Header (### schicht-id)
                        if (line.startsWith('### ')) {
                            // Wenn wir bereits eine Schicht verarbeiten, schließe sie ab
                            if (currentShiftId) {
                                console.log(`🔚 Ende von Schicht: ${currentShiftId} (neuer Header gefunden)`);
                            }
                            
                            const headerText = line.replace('### ', '').toLowerCase();
                            console.log(`🔍 Header gefunden: "${headerText}"`);
                            
                            // Suche nach passender Schicht-ID
                            currentShiftId = null; // Reset zuerst
                            if (event.shifts) {
                                for (const shift of event.shifts) {
                                    if (headerText.includes(shift.id) || 
                                        headerText.includes(shift.id.replace(/-/g, ''))) {
                                        currentShiftId = shift.id;
                                        assignments[currentShiftId] = assignments[currentShiftId] || [];
                                        console.log(`📋 ✅ Matched zu Schicht: ${shift.id}`);
                                        break;
                                    }
                                }
                            }
                        }
                        // Sammle zugeteilte Personen
                        else if (currentShiftId && line.startsWith('- ')) {
                            console.log(`🔍 Prüfe Person-Zeile: "${line}" (Schicht: ${currentShiftId})`);
                            console.log(`  - Enthält **[OFFEN: ${line.includes('**[OFFEN')}`);
                            console.log(`  - Enthält Personen benötigt: ${line.includes('Personen benötigt')}`);
                            
                            if (!line.includes('**[OFFEN') && !line.includes('Personen benötigt')) {
                                let name = line.replace('- ', '').trim();
                                console.log(`  - Name vor ✅-Entfernung: "${name}"`);
                                
                                // Entferne ✅ falls vorhanden
                                if (name.startsWith('✅')) {
                                    name = name.replace('✅', '').trim();
                                    console.log(`  - Name nach ✅-Entfernung: "${name}"`);
                                }
                                
                                // Ignoriere leere Namen oder OFFEN-Plätze
                                if (name && 
                                    !name.includes('[OFFEN') && 
                                    !name.includes('**[OFFEN') && 
                                    name !== '**[OFFEN - 2 Plätze]**' &&
                                    !assignments[currentShiftId].includes(name)) {
                                    
                                    assignments[currentShiftId].push(name);
                                    console.log(`👤 ✅ Person hinzugefügt: ${currentShiftId}: ${name}`);
                                } else {
                                    console.log(`  - ❌ Person nicht hinzugefügt (Grund: leer oder OFFEN)`);
                                }
                            } else {
                                console.log(`  - ❌ Zeile übersprungen (OFFEN oder benötigt)`);
                            }
                        }
                        // Reset bei neuen Sections
                        else if (line.startsWith('##') || line.startsWith('---')) {
                            if (currentShiftId) {
                                console.log(`🔚 Ende von Schicht: ${currentShiftId} (Sektion-Ende)`);
                                currentShiftId = null;
                            }
                        }
                    }
                    
                    // Berechne Gesamtzahl zugeteilter Schichten
                    filledShifts = Object.values(assignments).reduce((sum, arr) => sum + arr.length, 0);
                    
                    console.log(`📊 Arbeitsplan-Parsing abgeschlossen:`);
                    console.log(`   - ${filledShifts} Personen auf ${Object.keys(assignments).length} Schichten verteilt`);
                    console.log(`   - Assignments:`, assignments);
                    
                } catch (error) {
                    console.error('❌ Fehler beim Parsen des Arbeitsplans:', error);
                }
                
                return {
                    assignments: assignments,
                    lastUpdated: new Date(),
                    totalShifts: event.shifts?.length || 0,
                    filledShifts: filledShifts
                };
            }

            async loadEventsFromMarkdown() {
                // Liste aller Event-Dateien (manuell gepflegt oder dynamisch erweitert)
                const eventFiles = [
                    'events/chilbi-2024.md',
                    'events/chilbi-2025.md',
                    'events/grillplausch-sommer-2024.md',
                    // Weitere Event-Dateien hier hinzufügen
                ];

                const promises = eventFiles.map(async (file) => {
                    try {
                        console.log(`📄 Lade: ${file}`);
                        const response = await fetch(file);
                        
                        if (!response.ok) {
                            console.warn(`⚠️ ${file}: HTTP ${response.status}`);
                            return null;
                        }
                        
                        const content = await response.text();
                        
                        if (!content.trim()) {
                            console.warn(`⚠️ ${file}: Datei ist leer`);
                            return null;
                        }
                        
                        const event = this.parseMarkdownEvent(content, file);
                        if (event) {
                            console.log(`✅ Parsed: ${event.title}`);
                            return event;
                        }
                        
                    } catch (error) {
                        console.error(`❌ Fehler beim Laden von ${file}:`, error);
                        return null;
                    }
                });

                const results = await Promise.allSettled(promises);
                return results
                    .filter(result => result.status === 'fulfilled' && result.value !== null)
                    .map(result => result.value)
                    .sort((a, b) => a.startDate - b.startDate);
            }

            parseMarkdownEvent(content, filename = '') {
                try {
                    // Frontmatter pattern matching
                    const frontmatterMatch = content.match(/^---\r?\n([\s\S]*?)\r?\n---\r?\n([\s\S]*)$/);
                    
                    if (!frontmatterMatch) {
                        console.warn(`⚠️ ${filename}: Kein Frontmatter gefunden`);
                        return null;
                    }

                    const [, frontmatterStr, markdownContent] = frontmatterMatch;
                    const frontmatter = this.parseFrontmatter(frontmatterStr);
                    
                    // Pflichtfelder validieren
                    if (!frontmatter.id || !frontmatter.title || !frontmatter.startDate || !frontmatter.endDate) {
                        console.warn(`⚠️ ${filename}: Pflichtfelder fehlen`);
                        return null;
                    }
                    
                    return {
                        ...frontmatter,
                        description: this.parseMarkdownDescription(markdownContent.trim()),
                        startDate: new Date(frontmatter.startDate),
                        endDate: new Date(frontmatter.endDate),
                        registrationDeadline: frontmatter.registrationDeadline ? 
                            new Date(frontmatter.registrationDeadline) : null,
                        _source: filename
                    };
                    
                } catch (error) {
                    console.error(`❌ ${filename}: Parse-Fehler:`, error);
                    return null;
                }
            }

            parseFrontmatter(frontmatterStr) {
                const result = {};
                const lines = frontmatterStr.split(/\r?\n/).filter(line => line.trim());
                
                let currentKey = null;
                let currentValue = '';
                let inArrayOrObject = false;
                let arrayDepth = 0;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Skip comments
                    if (line.trim().startsWith('#')) continue;
                    
                    // Handle array/object continuation
                    if (inArrayOrObject) {
                        currentValue += '\n' + line;
                        
                        // Count array depth
                        arrayDepth += (line.match(/- /g) || []).length;
                        
                        // Check if array/object is complete
                        const nextLine = lines[i + 1];
                        if (!nextLine || (!nextLine.startsWith(' ') && !nextLine.startsWith('-') && nextLine.includes(':'))) {
                            // Process the complete value
                            result[currentKey] = this.parseComplexValue(currentValue);
                            inArrayOrObject = false;
                            currentKey = null;
                            currentValue = '';
                            arrayDepth = 0;
                        }
                        continue;
                    }
                    
                    const colonIndex = line.indexOf(':');
                    if (colonIndex === -1) continue;
                    
                    const key = line.substring(0, colonIndex).trim();
                    let value = line.substring(colonIndex + 1).trim();
                    
                    if (!key) continue;
                    
                    // Handle multiline values (arrays, objects)
                    if (!value || value === '|' || value === '>') {
                        currentKey = key;
                        currentValue = value;
                        inArrayOrObject = true;
                        continue;
                    }
                    
                    // Parse simple values
                    result[key] = this.parseSimpleValue(value);
                }
                
                return result;
            }

            parseComplexValue(value) {
                try {
                    // Handle shifts array - improved parsing
                    if (value.includes('- id:')) {
                        console.log('🔄 Parse shifts array...');
                        const shifts = [];
                        
                        // Split by shift entries but keep the delimiter
                        const shiftEntries = value.split(/(?=\s*- id:)/g).filter(entry => entry.trim());
                        
                        for (const entry of shiftEntries) {
                            const shift = {};
                            const lines = entry.split('\n');
                            
                            for (const line of lines) {
                                const trimmed = line.trim();
                                if (!trimmed || trimmed.startsWith('#')) continue;
                                
                                const colonIndex = trimmed.indexOf(':');
                                if (colonIndex === -1) continue;
                                
                                const key = trimmed.substring(0, colonIndex).replace(/^-\s*/, '').trim();
                                let shiftValue = trimmed.substring(colonIndex + 1).trim();
                                
                                // Remove quotes if present
                                if ((shiftValue.startsWith('"') && shiftValue.endsWith('"')) || 
                                    (shiftValue.startsWith("'") && shiftValue.endsWith("'"))) {
                                    shiftValue = shiftValue.slice(1, -1);
                                }
                                
                                switch(key) {
                                    case 'id':
                                        shift.id = shiftValue;
                                        break;
                                    case 'name':
                                        shift.name = shiftValue;
                                        break;
                                    case 'date':
                                        shift.date = shiftValue;
                                        break;
                                    case 'time':
                                        shift.time = shiftValue;
                                        break;
                                    case 'needed':
                                        shift.needed = parseInt(shiftValue) || 1;
                                        break;
                                    case 'description':
                                        shift.description = shiftValue;
                                        break;
                                }
                            }
                            
                            if (shift.id && shift.name) {
                                shifts.push(shift);
                                console.log(`✅ Parsed shift: ${shift.name} (${shift.id})`);
                            }
                        }
                        
                        console.log(`📊 Total shifts parsed: ${shifts.length}`);
                        return shifts;
                    }
                    
                    // Handle simple arrays
                    if (value.includes('[') && value.includes(']')) {
                        const match = value.match(/\[(.*)\]/);
                        if (match) {
                            return match[1].split(',').map(s => s.trim().replace(/['"]/g, ''));
                        }
                    }
                    
                    return value.trim();
                } catch (error) {
                    console.error('❌ Fehler beim Parsen von komplexem Wert:', error, 'Value:', value);
                    return value;
                }
            }

            parseSimpleValue(value) {
                // Remove quotes
                if ((value.startsWith('"') && value.endsWith('"')) || 
                    (value.startsWith("'") && value.endsWith("'"))) {
                    value = value.slice(1, -1);
                }
                
                // Parse booleans
                if (value === 'true') return true;
                if (value === 'false') return false;
                
                // Parse numbers
                if (!isNaN(value) && value !== '' && !isNaN(parseFloat(value))) {
                    return parseFloat(value);
                }
                
                // Parse arrays
                if (value.startsWith('[') && value.endsWith(']')) {
                    const arrayContent = value.slice(1, -1);
                    return arrayContent.split(',').map(s => s.trim().replace(/['"]/g, ''));
                }
                
                return value;
            }

            parseMarkdownDescription(markdown) {
                // Simple markdown to plain text conversion for preview
                return markdown
                    .replace(/^#{1,6}\s+/gm, '') // Remove headers
                    .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold
                    .replace(/\*(.*?)\*/g, '$1') // Remove italic
                    .replace(/- /g, '• ') // Convert lists
                    .replace(/\n\n+/g, '\n\n') // Normalize newlines
                    .substring(0, 300); // Limit length for preview
            }

            async getFallbackEvents() {
                // Fallback events wenn Markdown-Dateien nicht geladen werden können
                console.log('⚠️ Verwende Fallback-Events');
                return [
                    {
                        id: 'chilbi-fallback',
                        title: 'Chilbi 2025',
                        subtitle: 'Traditionelle Dorfchilbi',
                        description: 'Unsere traditionelle Chilbi im Roten Schopf. Details werden geladen...',
                        startDate: new Date(2025, 9, 18, 12, 0),
                        endDate: new Date(2025, 9, 19, 22, 0),
                        location: 'Roter Schopf, Kaiseraugst',
                        category: 'Hauptveranstaltung',
                        organizer: 'Stefan Müller',
                        email: FWV_CONFIG.kontakte.aktuar.email,
                        status: 'confirmed',
                        registrationRequired: true,
                        cost: 'Kostenlos',
                        tags: ['Chilbi', 'Familie', 'Helfer']
                    }
                ];
            }

            setupEventListeners() {
                // Filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.currentFilter = e.target.dataset.filter;
                        this.updateFilterButtons();
                        this.filterEvents();
                        this.renderEvents();
                    });
                });

                // Search and filters
                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.searchQuery = e.target.value.toLowerCase();
                    this.filterEvents();
                    this.renderEvents();
                });

                document.getElementById('category-filter').addEventListener('change', (e) => {
                    this.currentCategory = e.target.value;
                    this.filterEvents();
                    this.renderEvents();
                });

                // View mode buttons
                document.getElementById('list-view-btn').addEventListener('click', () => {
                    this.viewMode = 'list';
                    this.updateViewButtons();
                    this.renderEvents();
                });

                document.getElementById('grid-view-btn').addEventListener('click', () => {
                    this.viewMode = 'grid';
                    this.updateViewButtons();
                    this.renderEvents();
                });

                // Modal controls
                document.getElementById('close-modal').addEventListener('click', () => this.closeModal());
                document.getElementById('close-modal-btn').addEventListener('click', () => this.closeModal());
                document.getElementById('download-event-ics').addEventListener('click', () => this.downloadEventICS());
                document.getElementById('share-event').addEventListener('click', () => this.shareEvent());
                
                // Arbeitsplan controls
                document.getElementById('view-arbeitsplan').addEventListener('click', () => this.showArbeitsplanModal());
                document.getElementById('close-arbeitsplan-modal').addEventListener('click', () => this.closeArbeitsplanModal());
                document.getElementById('close-arbeitsplan-modal-btn').addEventListener('click', () => this.closeArbeitsplanModal());
                document.getElementById('download-arbeitsplan-pdf').addEventListener('click', () => this.downloadArbeitsplanPDF());
                document.getElementById('edit-arbeitsplan').addEventListener('click', () => this.editArbeitsplan());
                
                // Registration
                document.getElementById('send-registration-email').addEventListener('click', () => this.sendRegistrationEmail());
                
                document.getElementById('event-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'event-modal') this.closeModal();
                });
                
                document.getElementById('arbeitsplan-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'arbeitsplan-modal') this.closeArbeitsplanModal();
                });
            }

            updateFilterButtons() {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    const isActive = btn.dataset.filter === this.currentFilter;
                    btn.className = isActive 
                        ? 'filter-btn active bg-white text-fire-700 px-6 py-3 rounded-lg font-semibold hover:bg-fire-50 transition-colors'
                        : 'filter-btn border-2 border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-white hover:text-fire-700 transition-colors';
                });
            }

            updateViewButtons() {
                const listBtn = document.getElementById('list-view-btn');
                const gridBtn = document.getElementById('grid-view-btn');
                
                if (this.viewMode === 'list') {
                    listBtn.className = 'p-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600 transition-colors';
                    gridBtn.className = 'p-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors';
                } else {
                    listBtn.className = 'p-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors';
                    gridBtn.className = 'p-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600 transition-colors';
                }
            }

            filterEvents() {
                const now = new Date();
                let filtered = [...this.events];

                // Time filter
                if (this.currentFilter === 'upcoming') {
                    filtered = filtered.filter(event => event.startDate > now);
                } else if (this.currentFilter === 'past') {
                    filtered = filtered.filter(event => event.endDate < now);
                }

                // Category filter
                if (this.currentCategory) {
                    filtered = filtered.filter(event => event.category === this.currentCategory);
                }

                // Search filter
                if (this.searchQuery) {
                    filtered = filtered.filter(event => 
                        event.title.toLowerCase().includes(this.searchQuery) ||
                        event.description.toLowerCase().includes(this.searchQuery) ||
                        event.location.toLowerCase().includes(this.searchQuery) ||
                        event.organizer.toLowerCase().includes(this.searchQuery) ||
                        (event.tags && event.tags.some(tag => tag.toLowerCase().includes(this.searchQuery)))
                    );
                }

                // Sort by date
                filtered.sort((a, b) => {
                    if (this.currentFilter === 'past') {
                        return b.startDate - a.startDate;
                    }
                    return a.startDate - b.startDate;
                });

                this.filteredEvents = filtered;
            }

            renderEvents() {
                const container = document.getElementById('events-container');
                const noEventsMsg = document.getElementById('no-events');

                if (this.filteredEvents.length === 0) {
                    container.innerHTML = '';
                    noEventsMsg.classList.remove('hidden');
                    return;
                }

                noEventsMsg.classList.add('hidden');

                if (this.viewMode === 'list') {
                    container.className = 'space-y-6';
                    container.innerHTML = this.filteredEvents.map(event => this.createEventListItem(event)).join('');
                } else {
                    container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                    container.innerHTML = this.filteredEvents.map(event => this.createEventGridItem(event)).join('');
                }

                // Add click listeners
                container.querySelectorAll('[data-event-id]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const eventId = e.currentTarget.dataset.eventId;
                        this.showEventModal(eventId);
                    });
                });
            }

            createEventListItem(event) {
                const isPast = event.endDate < new Date();
                const statusBadge = this.getStatusBadge(event);
                const registrationBadge = this.getRegistrationBadge(event);
                
                return `
                    <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer overflow-hidden ${isPast ? 'opacity-75' : ''}" 
                         data-event-id="${event.id}">
                        <div class="p-6">
                            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
                                <div class="flex-1">
                                    <div class="flex items-start justify-between mb-3">
                                        <div>
                                            <h3 class="text-xl font-bold text-gray-800 mb-1">${event.title}</h3>
                                            <p class="text-fire-600 font-medium">${event.subtitle || ''}</p>
                                        </div>
                                        <div class="flex space-x-2">
                                            ${statusBadge}
                                            ${registrationBadge}
                                        </div>
                                    </div>
                                    
                                    <div class="prose prose-sm max-w-none mb-4 text-gray-600">
                                        ${this.truncateText(event.description, 200)}
                                    </div>
                                    
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-gray-500 mb-4">
                                        <div class="space-y-2">
                                            <div class="flex items-center">
                                                <span class="mr-2">📅</span>
                                                <span>${this.formatDate(event.startDate)}</span>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="mr-2">⏰</span>
                                                <span>${this.formatTime(event.startDate)} - ${this.formatTime(event.endDate)}</span>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex items-center">
                                                <span class="mr-2">📍</span>
                                                <span>${event.location}</span>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="mr-2">👤</span>
                                                <span>${event.organizer}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex flex-wrap gap-2">
                                        ${(event.tags || []).map(tag => `
                                            <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs">
                                                ${tag}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="mt-4 lg:mt-0 lg:ml-6 flex-shrink-0">
                                    <span class="inline-block px-3 py-1 bg-fire-100 text-fire-800 rounded-full text-sm font-medium">
                                        ${event.category || 'Event'}
                                    </span>
                                    ${event.cost && event.cost !== 'Kostenlos' ? `
                                        <div class="mt-2 text-lg font-bold text-fire-600">
                                            ${event.cost}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            createEventGridItem(event) {
                const isPast = event.endDate < new Date();
                const statusBadge = this.getStatusBadge(event);
                const registrationBadge = this.getRegistrationBadge(event);
                
                return `
                    <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer overflow-hidden ${isPast ? 'opacity-75' : ''}" 
                         data-event-id="${event.id}">
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-lg font-bold text-gray-800 leading-tight">${event.title}</h3>
                                <div class="flex flex-col space-y-1">
                                    ${statusBadge}
                                    ${registrationBadge}
                                </div>
                            </div>
                            
                            <p class="text-fire-600 text-sm font-medium mb-3">${event.subtitle || ''}</p>
                            
                            <div class="text-sm text-gray-600 mb-4">
                                ${this.truncateText(event.description, 120)}
                            </div>
                            
                            <div class="space-y-2 text-sm text-gray-500 mb-4">
                                <div class="flex items-center">
                                    <span class="mr-2">📅</span>
                                    <span>${this.formatDate(event.startDate)}</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="mr-2">📍</span>
                                    <span class="truncate">${event.location}</span>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <span class="px-2 py-1 bg-fire-100 text-fire-800 rounded-full text-xs font-medium">
                                    ${event.category || 'Event'}
                                </span>
                                ${event.cost && event.cost !== 'Kostenlos' ? `
                                    <span class="text-fire-600 font-bold text-sm">${event.cost}</span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            getStatusBadge(event) {
                const now = new Date();
                
                if (event.endDate < now) {
                    return '<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium">Vergangen</span>';
                } else if (event.startDate <= now && event.endDate >= now) {
                    return '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium animate-pulse">Läuft</span>';
                } else if (event.registrationRequired && event.registrationDeadline && event.registrationDeadline < now) {
                    return '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">Anmeldung geschlossen</span>';
                } else {
                    return '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">Geplant</span>';
                }
            }

            getRegistrationBadge(event) {
                if (!event.registrationRequired) return '';
                
                const now = new Date();
                if (event.registrationDeadline && event.registrationDeadline < now) return '';
                if (event.endDate < now) return '';
                
                if (event.shifts && event.shifts.length > 0) {
                    return '<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-medium">👷 Helfer gesucht</span>';
                } else if (event.participantRegistration) {
                    return '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">📧 Anmeldung möglich</span>';
                }
                
                return '';
            }

            showEventModal(eventId) {
                const event = this.events.find(e => e.id === eventId);
                if (!event) return;

                this.selectedEvent = event;
                this.selectedShifts = [];
                
                document.getElementById('modal-title').textContent = event.title;
                document.getElementById('modal-meta').innerHTML = `
                    <span>📅 ${this.formatDate(event.startDate)}</span>
                    <span>⏰ ${this.formatTime(event.startDate)} - ${this.formatTime(event.endDate)}</span>
                    <span>📍 ${event.location}</span>
                    <span>👤 ${event.organizer}</span>
                `;

                document.getElementById('modal-content').innerHTML = `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">${event.subtitle || ''}</h3>
                        <div class="prose max-w-none">
                            ${this.parseMarkdownToHTML(event.description)}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-800">Veranstaltungsdetails</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Kategorie:</span>
                                    <span class="px-2 py-1 bg-fire-100 text-fire-800 rounded text-xs">${event.category || 'Event'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Kosten:</span>
                                    <span class="font-medium">${event.cost || 'Nicht angegeben'}</span>
                                </div>
                                ${event.registrationRequired ? `
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Anmeldung:</span>
                                        <span class="text-fire-600">Erforderlich</span>
                                    </div>
                                ` : ''}
                                ${event.registrationDeadline ? `
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Anmeldeschluss:</span>
                                        <span>${this.formatDate(event.registrationDeadline)}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-800">Kontakt</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Organisator:</span>
                                    <span class="font-medium">${event.organizer}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">E-Mail:</span>
                                    <a href="mailto:${event.email}" class="text-fire-600 hover:text-fire-700">${event.email}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${(event.tags && event.tags.length > 0) ? `
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 mb-2">Tags</h4>
                            <div class="flex flex-wrap gap-2">
                                ${event.tags.map(tag => `
                                    <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">
                                        ${tag}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;

                // Show registration section if applicable
                this.setupRegistrationSection(event);
                
                document.getElementById('event-modal').classList.remove('hidden');
            }

            setupRegistrationSection(event) {
                const registrationSection = document.getElementById('registration-section');
                const shiftSelection = document.getElementById('shift-selection');
                const shiftsContainer = document.getElementById('shifts-container');
                const participantsSection = document.getElementById('participants-section');

                console.log('🔄 Setup Registration für Event:', event.title);
                console.log('📋 Event shifts:', event.shifts);

                // Check if registration is possible
                const now = new Date();
                const canRegister = event.registrationRequired && 
                    (!event.registrationDeadline || event.registrationDeadline > now) &&
                    event.endDate > now;

                if (!canRegister) {
                    console.log('❌ Anmeldung nicht möglich für:', event.title);
                    registrationSection.classList.add('hidden');
                    return;
                }

                registrationSection.classList.remove('hidden');

                // Setup shifts if available
                if (event.shifts && Array.isArray(event.shifts) && event.shifts.length > 0) {
                    console.log(`✅ ${event.shifts.length} Schichten gefunden, zeige Schichtauswahl`);
                    shiftSelection.classList.remove('hidden');
                    participantsSection.classList.add('hidden');
                    
                    const arbeitsplan = this.arbeitsplanData[event.id] || { assignments: {} };
                    
                    shiftsContainer.innerHTML = event.shifts.map(shift => {
                        const assignments = arbeitsplan.assignments[shift.id] || [];
                        const remainingSpots = shift.needed - assignments.length;
                        const isFullyBooked = remainingSpots <= 0;
                        
                        let assignedHTML = '';
                        if (assignments.length > 0) {
                            assignedHTML = `
                                <div class="mt-2 p-2 bg-green-50 border border-green-200 rounded text-xs">
                                    <p class="font-medium text-green-800 mb-1">Bereits zugewiesen:</p>
                                    ${assignments.map(person => `<span class="text-green-700">✅ ${person}</span>`).join('<br>')}
                                </div>
                            `;
                        }
                        
                        console.log('📝 Erstelle Schicht-HTML für:', shift, 'Assignments:', assignments);
                        return `
                        <label class="flex items-start space-x-3 p-3 border border-gray-200 rounded-lg ${isFullyBooked ? 'bg-gray-100 opacity-75' : 'hover:bg-gray-50 cursor-pointer'} transition-colors">
                            <input type="checkbox" value="${shift.id}" class="shift-checkbox mt-1 text-fire-500 focus:ring-fire-500" 
                                   ${isFullyBooked ? 'disabled' : ''} 
                                   onchange="window.eventsManager.toggleShift('${shift.id}')">
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-800">${shift.name || 'Unnamed Shift'}</p>
                                        <p class="text-sm text-gray-600">${shift.date || 'TBD'} • ${shift.time || 'TBD'}</p>
                                        <p class="text-xs text-gray-500">${shift.description || 'Keine Beschreibung'}</p>
                                        ${assignedHTML}
                                    </div>
                                    <div class="ml-3 text-right">
                                        <span class="text-xs ${isFullyBooked ? 'bg-red-100 text-red-800' : remainingSpots <= 2 ? 'bg-yellow-100 text-yellow-800' : 'bg-fire-100 text-fire-800'} px-2 py-1 rounded-full block mb-1">
                                            ${isFullyBooked ? 'Voll besetzt' : `${remainingSpots} offen`}
                                        </span>
                                        <span class="text-xs text-gray-500">
                                            ${shift.needed || 1} gesamt
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </label>
                    `}).join('');
                    
                    // Setup shift planning section
                    this.setupShiftPlanningSection(event);
                } else if (event.participantRegistration) {
                    console.log('✅ Teilnehmer-Anmeldung verfügbar');
                    shiftSelection.classList.add('hidden');
                    participantsSection.classList.remove('hidden');
                } else {
                    console.log('⚠️ Weder Schichten noch Teilnehmer-Anmeldung verfügbar');
                    shiftSelection.classList.add('hidden');
                    participantsSection.classList.add('hidden');
                }

                // Make eventsManager globally accessible for checkbox events
                window.eventsManager = this;
            }

            setupShiftPlanningSection(event) {
                const shiftPlanningSection = document.getElementById('shift-planning-section');
                
                if (!event.shifts || event.shifts.length === 0) {
                    shiftPlanningSection.classList.add('hidden');
                    return;
                }
                
                shiftPlanningSection.classList.remove('hidden');
                
                const arbeitsplan = this.arbeitsplanData[event.id] || { 
                    totalShifts: event.shifts.length, 
                    filledShifts: 0,
                    assignments: {}
                };
                
                const shiftOverview = document.getElementById('shift-overview');
                shiftOverview.innerHTML = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-600">${arbeitsplan.totalShifts}</div>
                        <div class="text-sm text-blue-800">Schichten gesamt</div>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-green-600">${arbeitsplan.filledShifts}</div>
                        <div class="text-sm text-green-800">Besetzt</div>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-red-600">${arbeitsplan.totalShifts - arbeitsplan.filledShifts}</div>
                        <div class="text-sm text-red-800">Offen</div>
                    </div>
                `;
                
                const criticalShifts = event.shifts.filter(shift => {
                    const assignments = arbeitsplan.assignments[shift.id] || [];
                    return assignments.length === 0;
                });
                
                const criticalShiftsDiv = document.getElementById('critical-shifts');
                if (criticalShifts.length > 0) {
                    criticalShiftsDiv.classList.remove('hidden');
                    document.getElementById('critical-shifts-list').innerHTML = 
                        criticalShifts.map(shift => `• ${shift.name} (${shift.date}, ${shift.time})`).join('<br>');
                } else {
                    criticalShiftsDiv.classList.add('hidden');
                }
            }

            showArbeitsplanModal() {
                if (!this.selectedEvent || !this.selectedEvent.shifts || this.selectedEvent.shifts.length === 0) return;
                
                const event = this.selectedEvent;
                const arbeitsplan = this.arbeitsplanData[event.id];
                
                document.getElementById('arbeitsplan-title').textContent = `Arbeitsplan ${event.title}`;
                document.getElementById('arbeitsplan-status').textContent = 
                    `Stand: ${new Date().toLocaleDateString('de-DE')} • ${arbeitsplan?.filledShifts || 0} von ${arbeitsplan?.totalShifts || 0} Schichten besetzt`;
                
                const content = this.generateArbeitsplanHTML(event);
                document.getElementById('arbeitsplan-content').innerHTML = content;
                
                document.getElementById('arbeitsplan-modal').classList.remove('hidden');
            }

            generateArbeitsplanHTML(event) {
                const arbeitsplan = this.arbeitsplanData[event.id] || { assignments: {} };
                
                let html = `
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">📊 Übersicht</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-blue-600">${event.shifts?.length || 0}</div>
                                <div class="text-sm text-blue-800">Schichten gesamt</div>
                            </div>
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-green-600">${arbeitsplan.filledShifts || 0}</div>
                                <div class="text-sm text-green-800">Besetzt</div>
                            </div>
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-red-600">${(event.shifts?.length || 0) - (arbeitsplan.filledShifts || 0)}</div>
                                <div class="text-sm text-red-800">Offen</div>
                            </div>
                        </div>
                    </div>
                `;
                
        // Separate regular shifts from special shifts (Aufbau/Abbau)
        const regularShifts = event.shifts ? event.shifts.filter(s => 
            !s.name.toLowerCase().includes('aufbau') && 
            !s.name.toLowerCase().includes('abbau')
        ) : [];
        
        const specialShifts = event.shifts ? event.shifts.filter(s => 
            s.name.toLowerCase().includes('aufbau') || 
            s.name.toLowerCase().includes('abbau')
        ) : [];
        
        // Add special shifts section
        if (specialShifts.length > 0) {
            specialShifts.forEach(shift => {
                const assignments = arbeitsplan.assignments[shift.id] || [];
                const isAufbau = shift.name.toLowerCase().includes('aufbau');
                const title = isAufbau ? 'Aufbau' : 'Abbau';
                
                html += `
                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">${title}</h3>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-3">
                                <span class="font-medium">${shift.date} • ${shift.time}</span>
                                <span class="text-sm text-gray-600">${shift.needed} Personen benötigt</span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                ${assignments.map(person => `
                                    <div class="flex items-center space-x-2 bg-green-50 border border-green-200 rounded px-3 py-2">
                                        <span class="text-green-600">✅</span>
                                        <span class="text-green-800 font-medium">${person}</span>
                                    </div>
                                `).join('')}
                                ${Array(Math.max(0, shift.needed - assignments.length)).fill().map(() => `
                                    <div class="flex items-center space-x-2 bg-red-50 border border-red-200 rounded px-3 py-2">
                                        <span class="text-red-600">❌</span>
                                        <span class="text-red-700">Offen</span>
                                    </div>
                                `).join('')}
                            </div>
                            ${shift.description ? `<p class="text-sm text-gray-600 mt-2">${shift.description}</p>` : ''}
                        </div>
                    </div>
                `;
            });
        }
        
        // Group regular shifts by date
        const shiftsByDate = {};
        regularShifts.forEach(shift => {
            if (!shiftsByDate[shift.date]) {
                shiftsByDate[shift.date] = {};
            }
            
            const timeMatch = shift.time.match(/(\d+:\d+)-(\d+:\d+|Open End)/);
            const time = timeMatch ? timeMatch[0] : shift.time;
            
            if (!shiftsByDate[shift.date][time]) {
                shiftsByDate[shift.date][time] = {};
            }
            
            let type = 'Service / Kasse';
            if (shift.name.toLowerCase().includes('bar')) type = 'Bar';
            else if (shift.name.toLowerCase().includes('küche')) type = 'Küche';
            else if (shift.name.toLowerCase().includes('kasse')) type = 'Service / Kasse';
            
            shiftsByDate[shift.date][time][type] = {
                shift: shift,
                assignments: arbeitsplan.assignments[shift.id] || []
            };
        });
                
                Object.keys(shiftsByDate).sort().forEach(date => {
                    const dateObj = new Date(date);
                    const dayName = dateObj.toLocaleDateString('de-DE', { weekday: 'long' });
                    const formattedDate = dateObj.toLocaleDateString('de-DE');
                    
                    html += `
                        <div class="mb-8">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">${dayName}, ${formattedDate}</h3>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse border border-gray-300">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-4 py-2 text-left">Zeit</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">Küche</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">Bar</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">Service / Kasse</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    Object.keys(shiftsByDate[date]).sort().forEach(time => {
                        const timeShifts = shiftsByDate[date][time];
                        
                        html += `
                            <tr>
                                <td class="border border-gray-300 px-4 py-2 font-medium">${time}</td>
                                <td class="border border-gray-300 px-4 py-2">
                                    ${this.formatShiftAssignments(timeShifts['Küche'])}
                                </td>
                                <td class="border border-gray-300 px-4 py-2">
                                    ${this.formatShiftAssignments(timeShifts['Bar'])}
                                </td>
                                <td class="border border-gray-300 px-4 py-2">
                                    ${this.formatShiftAssignments(timeShifts['Kasse'])}
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });
                
                return html;
            }

            formatShiftAssignments(shiftData) {
                if (!shiftData) return '-';
                
                const assignments = shiftData.assignments || [];
                const needed = shiftData.shift.needed;
                
                let html = '';
                
                assignments.forEach(person => {
                    html += `<div class="text-green-600">✅ ${person}</div>`;
                });
                
                const openPositions = needed - assignments.length;
                for (let i = 0; i < openPositions; i++) {
                    html += `<div class="text-red-600">❌ Offen</div>`;
                }
                
                if (html === '') {
                    html = `<div class="text-red-600">❌ ${needed} Helfer gesucht</div>`;
                }
                
                return html;
            }

            closeArbeitsplanModal() {
                document.getElementById('arbeitsplan-modal').classList.add('hidden');
            }

            downloadArbeitsplanPDF() {
                if (!this.selectedEvent || !this.selectedEvent.shifts) return;
                
                // Generate HTML content for PDF
                const htmlContent = this.generatePrintableArbeitsplan(this.selectedEvent);
                
                // Create a new window with the content
                const printWindow = window.open('', '_blank');
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                
                // Wait for content to load, then trigger print dialog
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                    }, 250);
                };
            }

            generatePrintableArbeitsplan(event) {
                const arbeitsplan = this.arbeitsplanData[event.id] || { assignments: {} };
                const stats = this.calculateArbeitsplanStats(event, arbeitsplan);
                
                return `
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbeitsplan ${event.title}</title>
    <style>
        ${this.getPrintCSS()}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <h1>🔥 Feuerwehrverein Raura Kaiseraugst</h1>
                    <h2>📋 Arbeitsplan ${event.title}</h2>
                </div>
                <div class="event-info">
                    <div class="info-item"><strong>📅 Datum:</strong> ${this.formatDate(event.startDate)} - ${this.formatDate(event.endDate)}</div>
                    <div class="info-item"><strong>📍 Ort:</strong> ${event.location}</div>
                    <div class="info-item"><strong>⏰ Stand:</strong> ${new Date().toLocaleDateString('de-DE')} ${new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })} Uhr</div>
                    <div class="info-item"><strong>👤 Koordination:</strong> ${event.organizer} (${event.email})</div>
                </div>
            </div>
        </header>

        <!-- Statistics Dashboard -->
        <section class="stats-section">
            <h3>📊 Übersicht</h3>
            <div class="stats-grid">
                <div class="stat-card ${stats.fillPercentage >= 80 ? 'stat-good' : stats.fillPercentage >= 50 ? 'stat-warning' : 'stat-critical'}">
                    <div class="stat-number">${stats.filledPositions}/${stats.totalPositions}</div>
                    <div class="stat-label">Besetzte Positionen</div>
                    <div class="stat-percentage">${stats.fillPercentage}%</div>
                </div>
                <div class="stat-card ${stats.filledShifts === stats.totalShifts ? 'stat-good' : stats.filledShifts < stats.totalShifts/2 ? 'stat-critical' : 'stat-warning'}">
                    <div class="stat-number">${stats.filledShifts}/${stats.totalShifts}</div>
                    <div class="stat-label">Besetzte Schichten</div>
                </div>
                <div class="stat-card ${stats.criticalShifts === 0 ? 'stat-good' : 'stat-critical'}">
                    <div class="stat-number">${stats.criticalShifts}</div>
                    <div class="stat-label">Unbesetzte Schichten</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${stats.fillPercentage}%"></div>
                <div class="progress-text">${stats.fillPercentage}% belegt (${stats.filledPositions}/${stats.totalPositions})</div>
            </div>
        </section>

        ${stats.criticalShifts > 0 ? this.generateCriticalSection(event, arbeitsplan) : ''}

        <!-- Shift Tables -->
        ${this.generateShiftSections(event, arbeitsplan)}

        <!-- Contact Information -->
        <section class="contact-section">
            <h3>📞 Kontakt & Anmeldung</h3>
            <div class="contact-grid">
                <div class="contact-card">
                    <h4>Schichtkoordination</h4>
                    <p><strong>${event.organizer}</strong></p>
                    <p>📧 ${event.email}</p>
                    ${event.registrationDeadline ? `<p>📅 Anmeldeschluss: ${this.formatDate(event.registrationDeadline)}</p>` : ''}
                </div>
                <div class="contact-card">
                    <h4>Springer & Vertretung</h4>
                    <p><strong>${FWV_CONFIG.system.springer.hauptspringer}</strong></p>
                    <p>📧 ${FWV_CONFIG.kontakte.aktuar.email}</p>
                    <p>⏰ Verfügbar bei kurzfristigen Ausfällen</p>
                </div>
            </div>
            <div class="anmeldung-hinweis">
                <h4>💡 Anmeldung</h4>
                <p>Anmeldungen bitte per E-Mail an <strong>${event.email}</strong> mit Angabe der gewünschten Schicht(en).</p>
                <p>Bei Fragen oder kurzfristigen Änderungen bitte direkt Kontakt aufnehmen.</p>
            </div>
        </section>
    </div>
</body>
</html>`;
            }

            calculateArbeitsplanStats(event, arbeitsplan) {
                if (!event.shifts) return { totalShifts: 0, filledShifts: 0, totalPositions: 0, filledPositions: 0, fillPercentage: 0, criticalShifts: 0 };
                
                let totalPositions = 0;
                let filledPositions = 0;
                let filledShifts = 0;
                let criticalShifts = 0;
                
                for (const shift of event.shifts) {
                    const assignments = arbeitsplan.assignments[shift.id] || [];
                    const needed = shift.needed || 1;
                    
                    totalPositions += needed;
                    filledPositions += assignments.length;
                    
                    if (assignments.length > 0) {
                        filledShifts++;
                    } else {
                        criticalShifts++;
                    }
                }
                
                const fillPercentage = totalPositions > 0 ? Math.round((filledPositions / totalPositions) * 100) : 0;
                
                return {
                    totalShifts: event.shifts.length,
                    filledShifts,
                    totalPositions,
                    filledPositions,
                    fillPercentage,
                    criticalShifts
                };
            }

            generateCriticalSection(event, arbeitsplan) {
                const criticalShifts = event.shifts.filter(shift => {
                    const assignments = arbeitsplan.assignments[shift.id] || [];
                    return assignments.length === 0;
                });
                
                if (criticalShifts.length === 0) return '';
                
                return `
                <section class="critical-section">
                    <h3>🚨 Dringende Hilfe gesucht</h3>
                    <div class="critical-alert">
                        <h4>❌ Noch unbesetzte Schichten (${criticalShifts.length})</h4>
                        <ul class="critical-list">
                            ${criticalShifts.map(shift => `
                                <li><strong>${shift.name}</strong> - ${shift.date}, ${shift.time} (${shift.needed || 1} Personen benötigt)</li>
                            `).join('')}
                        </ul>
                        <p class="critical-note">
                            <strong>📞 Bitte meldet euch:</strong> Diese Schichten brauchen noch Helfer! 
                            Kontakt: ${event.email}
                        </p>
                    </div>
                </section>`;
            }

            generateShiftSections(event, arbeitsplan) {
                // Group shifts by category
                const categories = this.groupShiftsByCategory(event.shifts);
                let sections = '';

                const categoryOrder = ['aufbau', 'samstag', 'sonntag', 'abbau', 'sonstige'];
                const categoryTitles = {
                    'aufbau': '🔨 Aufbau',
                    'samstag': '🎪 Chilbi-Betrieb Samstag',
                    'sonntag': '🎪 Chilbi-Betrieb Sonntag', 
                    'abbau': '🔧 Abbau',
                    'sonstige': '📋 Weitere Schichten'
                };

                for (const category of categoryOrder) {
                    if (!categories[category] || categories[category].length === 0) continue;

                    const shifts = categories[category];
                    sections += `
                    <section class="shift-category">
                        <h3>${categoryTitles[category]}</h3>
                        ${this.generateShiftTable(shifts, arbeitsplan, category)}
                    </section>`;
                }

                return sections;
            }

            groupShiftsByCategory(shifts) {
                const categories = {
                    aufbau: [],
                    samstag: [], 
                    sonntag: [],
                    abbau: [],
                    sonstige: []
                };
                
                for (const shift of shifts) {
                    if (shift.id.includes('aufbau')) {
                        categories.aufbau.push(shift);
                    } else if (shift.id.includes('abbau')) {
                        categories.abbau.push(shift);
                    } else if (shift.id.includes('samstag')) {
                        categories.samstag.push(shift);
                    } else if (shift.id.includes('sonntag')) {
                        categories.sonntag.push(shift);
                    } else {
                        categories.sonstige.push(shift);
                    }
                }
                
                return categories;
            }

            generateShiftTable(shifts, arbeitsplan, category) {
                if (category === 'samstag' || category === 'sonntag') {
                    return this.generateDailyShiftTable(shifts, arbeitsplan);
                }
                return this.generateSimpleShiftTable(shifts, arbeitsplan);
            }

            generateDailyShiftTable(shifts, arbeitsplan) {
                // Group by time slots
                const timeSlots = {};

                for (const shift of shifts) {
                    const timeMatch = shift.time.match(/(\d{2}:\d{2})-(\d{2}:\d{2}|Open End)/);
                    if (timeMatch) {
                        const timeKey = shift.time;
                        if (!timeSlots[timeKey]) {
                            timeSlots[timeKey] = [];
                        }
                        timeSlots[timeKey].push(shift);
                    }
                }

                let html = '';

                for (const [timeKey, timeShifts] of Object.entries(timeSlots).sort()) {
                    html += `
                    <div class="time-slot">
                        <h4>${timeKey}</h4>
                        <table class="shift-table">
                            <thead>
                                <tr>
                                    <th>Bereich</th>
                                    <th>Benötigt</th>
                                    <th>Status</th>
                                    <th>Zugewiesene Helfer</th>
                                </tr>
                            </thead>
                            <tbody>`;

                    // Sort shifts (Bar, Küche, Kasse)
                    const sortedShifts = timeShifts.sort((a, b) => {
                        const order = { 'bar': 0, 'kueche': 1, 'kasse': 2 };
                        const aType = a.id.includes('bar') ? 'bar' : a.id.includes('kueche') ? 'kueche' : 'kasse';
                        const bType = b.id.includes('bar') ? 'bar' : b.id.includes('kueche') ? 'kueche' : 'kasse';
                        return order[aType] - order[bType];
                    });

                    for (const shift of sortedShifts) {
                        const assignments = arbeitsplan.assignments[shift.id] || [];
                        const needed = shift.needed || 1;
                        const assigned = assignments.length;

                        let statusClass, statusText;
                        if (assigned >= needed) {
                            statusClass = 'status-complete';
                            statusText = `✅ Komplett besetzt (${assigned}/${needed})`;
                        } else if (assigned === 0) {
                            statusClass = 'status-critical';
                            statusText = `❌ Unbesetzt (0/${needed})`;
                        } else {
                            statusClass = 'status-partial';
                            statusText = `⚠️ Teilweise besetzt (${assigned}/${needed})`;
                        }

                        const helpers = assigned > 0 
                            ? assignments.join(', ')
                            : '--- noch niemand angemeldet ---';

                        const areaName = shift.description.split(' - ')[0] || 
                            (shift.id.includes('bar') ? 'Bar' : 
                             shift.id.includes('kueche') ? 'Küche' : 'Service/Kasse');

                        html += `
                                <tr class="${statusClass}">
                                    <td><strong>${areaName}</strong></td>
                                    <td class="text-center">${needed}</td>
                                    <td class="${statusClass}">${statusText}</td>
                                    <td>${helpers}</td>
                                </tr>`;
                    }

                    html += `
                            </tbody>
                        </table>
                    </div>`;
                }

                return html;
            }

            generateSimpleShiftTable(shifts, arbeitsplan) {
                let html = `
                <table class="shift-table">
                    <thead>
                        <tr>
                            <th>Schicht</th>
                            <th>Zeit</th>
                            <th>Benötigt</th>
                            <th>Status</th>
                            <th>Zugewiesene Helfer</th>
                        </tr>
                    </thead>
                    <tbody>`;

                for (const shift of shifts) {
                    const assignments = arbeitsplan.assignments[shift.id] || [];
                    const needed = shift.needed || 1;
                    const assigned = assignments.length;

                    let statusClass, statusText;
                    if (assigned >= needed) {
                        statusClass = 'status-complete';
                        statusText = `✅ Komplett besetzt (${assigned}/${needed})`;
                    } else if (assigned === 0) {
                        statusClass = 'status-critical';
                        statusText = `❌ Unbesetzt (0/${needed})`;
                    } else {
                        statusClass = 'status-partial';
                        statusText = `⚠️ Teilweise besetzt (${assigned}/${needed})`;
                    }

                    const helpers = assigned > 0 
                        ? assignments.join(', ')
                        : '--- noch niemand angemeldet ---';

                    html += `
                        <tr class="${statusClass}">
                            <td><strong>${shift.name}</strong></td>
                            <td>${shift.time}</td>
                            <td class="text-center">${needed}</td>
                            <td class="${statusClass}">${statusText}</td>
                            <td>${helpers}</td>
                        </tr>`;
                }

                html += `
                    </tbody>
                </table>`;

                return html;
            }

            getPrintCSS() {
                return `
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }

                body {
                    font-family: 'Arial', 'Helvetica', sans-serif;
                    line-height: 1.4;
                    color: #333;
                    background: white;
                    font-size: 14px;
                }

                .container {
                    max-width: 100%;
                    margin: 0 auto;
                    background: white;
                }

                .header {
                    background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
                    color: white;
                    padding: 20px;
                    margin-bottom: 20px;
                    page-break-inside: avoid;
                }

                .header-content {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    flex-wrap: wrap;
                }

                .logo-section h1 {
                    font-size: 22px;
                    font-weight: bold;
                    margin-bottom: 5px;
                }

                .logo-section h2 {
                    font-size: 18px;
                    font-weight: normal;
                    opacity: 0.9;
                }

                .event-info {
                    text-align: right;
                }

                .info-item {
                    margin-bottom: 3px;
                    font-size: 12px;
                }

                .stats-section {
                    background: white;
                    padding: 15px;
                    margin-bottom: 20px;
                    border: 2px solid #d32f2f;
                    border-radius: 8px;
                    page-break-inside: avoid;
                }

                .stats-section h3 {
                    margin-bottom: 15px;
                    color: #d32f2f;
                    border-bottom: 2px solid #d32f2f;
                    padding-bottom: 5px;
                    font-size: 16px;
                }

                .stats-grid {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 15px;
                    margin-bottom: 15px;
                }

                .stat-card {
                    background: white;
                    padding: 15px;
                    border-radius: 6px;
                    text-align: center;
                    border: 2px solid #e0e0e0;
                }

                .stat-card.stat-good {
                    border-color: #4caf50;
                    background: #f1f8e9;
                }

                .stat-card.stat-warning {
                    border-color: #ff9800;
                    background: #fff3e0;
                }

                .stat-card.stat-critical {
                    border-color: #f44336;
                    background: #ffebee;
                }

                .stat-number {
                    font-size: 24px;
                    font-weight: bold;
                    margin-bottom: 5px;
                }

                .stat-label {
                    font-size: 12px;
                    color: #666;
                    margin-bottom: 5px;
                }

                .stat-percentage {
                    font-size: 14px;
                    font-weight: bold;
                    color: #d32f2f;
                }

                .progress-bar {
                    background: #e0e0e0;
                    height: 25px;
                    border-radius: 12px;
                    position: relative;
                    overflow: hidden;
                }

                .progress-fill {
                    background: linear-gradient(90deg, #4caf50, #8bc34a);
                    height: 100%;
                    border-radius: 12px;
                }

                .progress-text {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    font-weight: bold;
                    color: #333;
                    font-size: 12px;
                }

                .critical-section {
                    background: #ffebee;
                    border: 2px solid #f44336;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 20px;
                    page-break-inside: avoid;
                }

                .critical-section h3 {
                    color: #d32f2f;
                    margin-bottom: 10px;
                    font-size: 16px;
                }

                .critical-alert {
                    background: white;
                    padding: 10px;
                    border-radius: 6px;
                    border-left: 4px solid #f44336;
                }

                .critical-list {
                    list-style-type: none;
                    margin: 10px 0;
                }

                .critical-list li {
                    padding: 3px 0;
                    border-bottom: 1px solid #eee;
                    font-size: 13px;
                }

                .critical-note {
                    margin-top: 10px;
                    padding: 8px;
                    background: #ffcdd2;
                    border-radius: 4px;
                    font-size: 12px;
                }

                .shift-category {
                    background: white;
                    margin-bottom: 20px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    overflow: hidden;
                    page-break-inside: avoid;
                }

                .shift-category h3 {
                    background: #d32f2f;
                    color: white;
                    padding: 12px 15px;
                    margin: 0;
                    font-size: 16px;
                }

                .time-slot {
                    padding: 12px 15px;
                    border-bottom: 1px solid #eee;
                }

                .time-slot:last-child {
                    border-bottom: none;
                }

                .time-slot h4 {
                    color: #d32f2f;
                    margin-bottom: 8px;
                    font-size: 14px;
                }

                .shift-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 8px;
                    font-size: 12px;
                }

                .shift-table th {
                    background: #f5f5f5;
                    padding: 8px 6px;
                    text-align: left;
                    border: 1px solid #ddd;
                    font-weight: bold;
                    font-size: 12px;
                }

                .shift-table td {
                    padding: 6px;
                    border: 1px solid #ddd;
                    vertical-align: top;
                    font-size: 11px;
                }

                .shift-table .text-center {
                    text-align: center;
                }

                .shift-table tr.status-complete {
                    background: #f1f8e9;
                }

                .shift-table tr.status-partial {
                    background: #fff3e0;
                }

                .shift-table tr.status-critical {
                    background: #ffebee;
                }

                .status-complete {
                    color: #2e7d32;
                    font-weight: bold;
                }

                .status-partial {
                    color: #f57c00;
                    font-weight: bold;
                }

                .status-critical {
                    color: #d32f2f;
                    font-weight: bold;
                }

                .contact-section {
                    background: white;
                    padding: 15px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    margin-top: 20px;
                    page-break-inside: avoid;
                }

                .contact-section h3 {
                    color: #d32f2f;
                    margin-bottom: 10px;
                    border-bottom: 2px solid #d32f2f;
                    padding-bottom: 5px;
                    font-size: 16px;
                }

                .contact-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 15px;
                    margin-bottom: 15px;
                }

                .contact-card {
                    background: #f8f9fa;
                    padding: 10px;
                    border-radius: 6px;
                    border-left: 4px solid #d32f2f;
                }

                .contact-card h4 {
                    color: #d32f2f;
                    margin-bottom: 8px;
                    font-size: 14px;
                }

                .contact-card p {
                    margin-bottom: 3px;
                    font-size: 12px;
                }

                .anmeldung-hinweis {
                    background: #e3f2fd;
                    padding: 10px;
                    border-radius: 6px;
                    border-left: 4px solid #2196f3;
                }

                .anmeldung-hinweis h4 {
                    color: #1976d2;
                    margin-bottom: 8px;
                    font-size: 14px;
                }

                .anmeldung-hinweis p {
                    margin-bottom: 5px;
                    font-size: 12px;
                }

                /* Print optimizations */
                @media print {
                    .container {
                        margin: 0;
                        padding: 0;
                    }
                    
                    .shift-category {
                        page-break-inside: avoid;
                        break-inside: avoid;
                    }
                    
                    .time-slot {
                        page-break-inside: avoid;
                        break-inside: avoid;
                    }
                    
                    .stats-section {
                        page-break-after: avoid;
                    }
                    
                    .critical-section {
                        page-break-after: avoid;
                    }
                }

                @page {
                    margin: 15mm;
                    size: A4;
                }
                `;
            }

            editArbeitsplan() {
                const event = this.selectedEvent;
                if (!event) return;
                
                const arbeitsplanFile = `events/${event.id}-assignments.md`;
                alert(`Um den Arbeitsplan zu bearbeiten, öffnen Sie die Datei:\n\n${arbeitsplanFile}\n\nTragen Sie die Helfer manuell in die entsprechenden Schichten ein und speichern Sie die Datei.`);
            }

            toggleShift(shiftId) {
                const index = this.selectedShifts.indexOf(shiftId);
                if (index > -1) {
                    this.selectedShifts.splice(index, 1);
                } else {
                    this.selectedShifts.push(shiftId);
                }
            }

            sendRegistrationEmail() {
                const event = this.selectedEvent;
                if (!event) return;

                // Get form data
                const name = document.getElementById('reg-name').value.trim();
                const email = document.getElementById('reg-email').value.trim();
                const phone = document.getElementById('reg-phone').value.trim();
                const notes = document.getElementById('reg-notes').value.trim();

                // Validation
                if (!name || !email) {
                    alert('Bitte füllen Sie mindestens Name und E-Mail aus.');
                    return;
                }

                // Build email content
                let subject, body;

                if (event.shifts && event.shifts.length > 0 && this.selectedShifts.length > 0) {
                    // Helper registration with shifts
                    subject = `Helfer-Anmeldung: ${event.title}`;
                    
                    const selectedShiftDetails = event.shifts
                        .filter(shift => this.selectedShifts.includes(shift.id))
                        .map(shift => `• ${shift.name} (${shift.date}, ${shift.time}) - ${shift.description}`)
                        .join('\n');

                    body = `Hallo ${event.organizer},

hiermit melde ich mich als Helfer für folgende Schichten an:

VERANSTALTUNG: ${event.title}
DATUM: ${this.formatDate(event.startDate)}
ORT: ${event.location}

GEWÄHLTE SCHICHTEN:
${selectedShiftDetails}

MEINE KONTAKTDATEN:
Name: ${name}
E-Mail: ${email}
${phone ? `Telefon: ${phone}` : ''}

${notes ? `BEMERKUNGEN:\n${notes}` : ''}

Vielen Dank für die Organisation!

Mit freundlichen Grüssen
${name}`;

                } else if (event.participantRegistration) {
                    // Participant registration
                    const participants = document.getElementById('reg-participants').value || '1';
                    subject = `Anmeldung: ${event.title}`;
                    
                    body = `Hallo ${event.organizer},

hiermit melde ich mich für die Veranstaltung an:

VERANSTALTUNG: ${event.title}
DATUM: ${this.formatDate(event.startDate)}
ZEIT: ${this.formatTime(event.startDate)} - ${this.formatTime(event.endDate)}
ORT: ${event.location}
${event.cost && event.cost !== 'Kostenlos' ? `KOSTEN: ${event.cost}` : ''}

ANMELDUNG:
Name: ${name}
E-Mail: ${email}
${phone ? `Telefon: ${phone}` : ''}
${event.participantRegistration && participants !== '1' ? `Anzahl Personen: ${participants}` : ''}

${notes ? `BEMERKUNGEN:\n${notes}` : ''}

Vielen Dank für die Organisation!

Mit freundlichen Grüssen
${name}`;

                } else {
                    // General registration
                    subject = `Anmeldung: ${event.title}`;
                    body = `Hallo ${event.organizer},

hiermit melde ich mich für die Veranstaltung an:

VERANSTALTUNG: ${event.title}
DATUM: ${this.formatDate(event.startDate)}

KONTAKTDATEN:
Name: ${name}
E-Mail: ${email}
${phone ? `Telefon: ${phone}` : ''}

${notes ? `BEMERKUNGEN:\n${notes}` : ''}

Mit freundlichen Grüssen
${name}`;
                }

                // Create mailto link
                const mailtoLink = `mailto:${event.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                // Open email client
                window.location.href = mailtoLink;

                // Show success message
                setTimeout(() => {
                    alert('E-Mail-Client wurde geöffnet. Bitte senden Sie die E-Mail ab.');
                }, 500);
            }

            closeModal() {
                document.getElementById('event-modal').classList.add('hidden');
                this.selectedEvent = null;
                this.selectedShifts = [];
                
                // Reset form
                document.getElementById('reg-name').value = '';
                document.getElementById('reg-email').value = '';
                document.getElementById('reg-phone').value = '';
                document.getElementById('reg-notes').value = '';
                
                // Uncheck all shift checkboxes
                document.querySelectorAll('.shift-checkbox').forEach(cb => cb.checked = false);
            }

            downloadEventICS() {
                if (!this.selectedEvent) return;
                const icsData = this.generateICS([this.selectedEvent]);
                this.downloadICS(icsData, `${this.selectedEvent.id}.ics`);
            }

            shareEvent() {
                if (!this.selectedEvent) return;
                
                const url = `${window.location.origin}${window.location.pathname}#event-${this.selectedEvent.id}`;
                const text = `${this.selectedEvent.title} - ${this.formatDate(this.selectedEvent.startDate)}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: this.selectedEvent.title,
                        text: text,
                        url: url
                    });
                } else {
                    navigator.clipboard.writeText(`${text}\n${url}`).then(() => {
                        alert('Link wurde in die Zwischenablage kopiert!');
                    });
                }
            }

            generateICS(events) {
                const now = new Date();
                let ics = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    `PRODID:${FWV_CONFIG.system.calendar.prodId}`,
                    'CALSCALE:GREGORIAN',
                    'METHOD:PUBLISH',
                    `X-WR-CALNAME:${FWV_CONFIG.system.calendar.calendarName}`,
                    `X-WR-CALDESC:${FWV_CONFIG.system.calendar.calendarDescription}`,
                    `X-WR-TIMEZONE:${FWV_CONFIG.system.defaultTimezone}`
                ];

                events.forEach(event => {
                    const uid = `${event.id}@feuerwehrverein-raura.ch`;
                    const dtstart = this.formatDateForICS(event.startDate);
                    const dtend = this.formatDateForICS(event.endDate);
                    const dtstamp = this.formatDateForICS(now);
                    const description = event.description.replace(/\n/g, '\\n');

                    ics.push(
                        'BEGIN:VEVENT',
                        `UID:${uid}`,
                        `DTSTAMP:${dtstamp}`,
                        `DTSTART:${dtstart}`,
                        `DTEND:${dtend}`,
                        `SUMMARY:${event.title}`,
                        `DESCRIPTION:${description}`,
                        `LOCATION:${event.location}`,
                        `ORGANIZER;CN=${event.organizer}:mailto:${event.email}`,
                        `CATEGORIES:${event.category}`,
                        'STATUS:CONFIRMED',
                        'END:VEVENT'
                    );
                });

                ics.push('END:VCALENDAR');
                return ics.join('\r\n');
            }

            downloadICS(icsData, filename) {
                const blob = new Blob([icsData], { type: 'text/calendar;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }

            parseMarkdownToHTML(text) {
                return text
                    .replace(/\n\n/g, '</p><p class="mb-3">')
                    .replace(/\n- /g, '</p><li class="ml-4">• ')
                    .replace(/\n/g, '<br>')
                    .replace(/^(.+)$/gm, '<p class="mb-3">$1</p>')
                    .replace(/(<li.*<\/li>)/gs, '<ul class="mb-3 list-none">$1</ul>')
                    .replace(/<p class="mb-3"><\/p>/g, '');
            }

            truncateText(text, maxLength) {
                const plainText = text.replace(/\n/g, ' ').trim();
                if (plainText.length <= maxLength) return plainText;
                return plainText.substring(0, maxLength) + '...';
            }

            formatDate(date) {
                return new Intl.DateTimeFormat('de-DE', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                }).format(date);
            }

            formatTime(date) {
                return new Intl.DateTimeFormat('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            }

            formatDateForICS(date) {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            }
        }

        // Initialize events manager when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new EventsManager();
        });
    </script>
</body>
</html>
