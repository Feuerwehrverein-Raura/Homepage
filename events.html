<!DOCTYPE html>
<html lang="de" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veranstaltungen - Feuerwehrverein Raura Kaiseraugst</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fire: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="font-sans antialiased bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-fire-700 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-fire-300 shadow-lg bg-white">
                        <img src="images/logo.png" alt="Feuerwehrverein Raura Logo" class="w-full h-full object-contain p-1">
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Feuerwehrverein Raura</h1>
                        <p class="text-fire-200 text-sm">Kaiseraugst</p>
                    </div>
                </div>
                <div class="flex space-x-6">
                    <a href="index.html" class="hover:text-fire-200 transition-colors">Home</a>
                    <a href="calendar.html" class="hover:text-fire-200 transition-colors">Kalender</a>
                    <a href="events.html" class="text-fire-200 font-semibold">Veranstaltungen</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <section class="bg-gradient-to-r from-fire-600 to-fire-700 text-white py-12">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl font-bold mb-4">Unsere Veranstaltungen</h2>
            <p class="text-fire-100 text-lg mb-6">Detaillierte Informationen zu allen Terminen und Events</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="filter-all" class="filter-btn active bg-white text-fire-700 px-6 py-3 rounded-lg font-semibold hover:bg-fire-50 transition-colors" data-filter="all">
                    Alle Veranstaltungen
                </button>
                <button id="filter-upcoming" class="filter-btn border-2 border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-white hover:text-fire-700 transition-colors" data-filter="upcoming">
                    Kommende
                </button>
                <button id="filter-past" class="filter-btn border-2 border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-white hover:text-fire-700 transition-colors" data-filter="past">
                    Vergangene
                </button>
            </div>
        </div>
    </section>

    <!-- Filters and Search -->
    <section class="bg-white shadow-sm py-6">
        <div class="container mx-auto px-4">
            <div class="flex flex-col lg:flex-row justify-between items-center space-y-4 lg:space-y-0">
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Veranstaltungen suchen..." 
                               class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500 w-full sm:w-64">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-400">🔍</span>
                        </div>
                    </div>
                    <select id="category-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                        <option value="">Alle Kategorien</option>
                        <option value="Hauptveranstaltung">Hauptveranstaltung</option>
                        <option value="Gesellschaftsanlass">Gesellschaftsanlass</option>
                        <option value="Ausflug">Ausflug</option>
                        <option value="Vereinsintern">Vereinsintern</option>
                    </select>
                </div>
                <div class="flex space-x-2">
                    <button id="list-view-btn" class="p-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600 transition-colors">
                        <span class="text-xl">📋</span>
                    </button>
                    <button id="grid-view-btn" class="p-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors">
                        <span class="text-xl">⊞</span>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Events List -->
    <section class="py-8">
        <div class="container mx-auto px-4">
            <div id="events-container" class="space-y-6">
                <!-- Events will be loaded here -->
            </div>
            
            <!-- No events message -->
            <div id="no-events" class="hidden text-center py-12">
                <div class="text-gray-400 text-6xl mb-4">📅</div>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">Keine Veranstaltungen gefunden</h3>
                <p class="text-gray-500">Versuchen Sie andere Suchkriterien oder Filter.</p>
            </div>
        </div>
    </section>

    <!-- Event Detail Modal -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div class="relative">
                <!-- Modal Header -->
                <div id="modal-header" class="bg-gradient-to-r from-fire-500 to-fire-600 text-white p-6 rounded-t-lg">
                    <button id="close-modal" class="absolute top-4 right-4 text-white hover:text-fire-200 text-2xl">×</button>
                    <h2 id="modal-title" class="text-2xl font-bold mb-2"></h2>
                    <div id="modal-meta" class="flex flex-wrap gap-4 text-fire-100 text-sm"></div>
                </div>
                
                <!-- Modal Content -->
                <div class="p-6">
                    <div id="modal-content" class="prose max-w-none">
                        <!-- Event details will be loaded here -->
                    </div>
                    
                    <!-- Registration Section -->
                    <div id="registration-section" class="hidden mt-8 border-t pt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">📧 Anmeldung</h3>
                        
                        <!-- Shift Selection -->
                        <div id="shift-selection" class="hidden mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Verfügbare Schichten:</h4>
                            <div id="shifts-container" class="space-y-2">
                                <!-- Shifts will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Personal Information -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                                <input type="text" id="reg-name" placeholder="Ihr Name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">E-Mail *</label>
                                <input type="email" id="reg-email" placeholder="ihre@email.ch" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Telefon</label>
                                <input type="tel" id="reg-phone" placeholder="079 123 45 67" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div id="participants-section" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Anzahl Personen</label>
                                <select id="reg-participants" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                                    <option value="1">1 Person</option>
                                    <option value="2">2 Personen</option>
                                    <option value="3">3 Personen</option>
                                    <option value="4">4 Personen</option>
                                    <option value="5">5+ Personen</option>
                                </select>
                            </div>
                        </div>

                        <!-- Additional Notes -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bemerkungen</label>
                            <textarea id="reg-notes" rows="3" placeholder="Besondere Wünsche, Allergien, etc." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500"></textarea>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                            <button id="send-registration-email" class="flex-1 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center space-x-2">
                                <span>📧</span>
                                <span>Anmeldung per E-Mail senden</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Regular Modal Actions -->
                    <div class="mt-6 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                        <button id="download-event-ics" class="flex-1 bg-fire-500 text-white px-4 py-3 rounded-lg hover:bg-fire-600 transition-colors flex items-center justify-center space-x-2">
                            <span>⬇️</span>
                            <span>ICS herunterladen</span>
                        </button>
                        <button id="view-full-assignments" class="hidden flex-1 bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center space-x-2">
                            <span>📋</span>
                            <span>Vollständiger Arbeitsplan</span>
                        </button>
                        <button id="download-assignments-pdf" class="hidden flex-1 bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center space-x-2">
                            <span>📄</span>
                            <span>PDF Arbeitsplan</span>
                        </button>
                        <button id="share-event" class="flex-1 border border-fire-500 text-fire-500 px-4 py-3 rounded-lg hover:bg-fire-50 transition-colors flex items-center justify-center space-x-2">
                            <span>📤</span>
                            <span>Teilen</span>
                        </button>
                        <button id="close-modal-btn" class="flex-1 border border-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors">
                            Schließen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assignments Full View Modal (NEW) -->
    <div id="assignments-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-7xl w-full max-h-[90vh] overflow-y-auto">
            <div class="relative">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-t-lg">
                    <button id="close-assignments-modal" class="absolute top-4 right-4 text-white hover:text-blue-200 text-2xl">×</button>
                    <h2 id="assignments-modal-title" class="text-2xl font-bold mb-2">📋 Arbeitsplan</h2>
                    <div id="assignments-modal-meta" class="text-blue-100 text-sm"></div>
                </div>
                
                <div class="p-6">
                    <div id="assignments-content" class="space-y-6">
                        <!-- Assignments will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-fire-500 mx-auto mb-4"></div>
            <p class="text-gray-600">Lade Veranstaltungen...</p>
        </div>
    </div>

    <script>
        class EventsManager {
            constructor() {
                this.events = [];
                this.filteredEvents = [];
                this.currentFilter = 'all';
                this.currentCategory = '';
                this.searchQuery = '';
                this.viewMode = 'list';
                this.selectedEvent = null;
                this.selectedShifts = [];
                
                this.init();
            }

            async init() {
                await this.loadEvents();
                this.setupEventListeners();
                this.filterEvents();
                this.renderEvents();
                document.getElementById('loading').classList.add('hidden');
            }

            async loadEvents() {
                try {
                    this.events = await this.loadEventsFromMarkdown();
                } catch (error) {
                    console.error('Fehler beim Laden der Veranstaltungen:', error);
                    this.events = [];
                }
            }

            async loadEventsFromMarkdown() {
                // Enhanced sample data with assignments integration
                return [
                    {
                        id: 'chilbi-2025',
                        title: 'Chilbi 2025',
                        subtitle: 'Traditionelle Dorfchilbi',
                        description: 'Unsere traditionelle Chilbi findet auch dieses Jahr wieder im Roten Schopf statt. Wir verwandeln das Vereinslokal in ein gemütliches Festlokal für die ganze Familie.\n\nProgramm:\n- Samstag: 12:00 - 22:00 Uhr - Festbetrieb mit warmen Speisen\n- Sonntag: 12:00 - 22:00 Uhr - Familientag mit besonderen Angeboten\n\nHelfer gesucht: Wir suchen noch Helfer für verschiedene Schichten.',
                        startDate: new Date(2025, 9, 18, 12, 0),
                        endDate: new Date(2025, 9, 19, 22, 0),
                        location: 'Roter Schopf, Kaiseraugst',
                        category: 'Hauptveranstaltung',
                        organizer: 'Stefan Müller',
                        email: 'aktuar@fwv-raura.ch',
                        status: 'confirmed',
                        registrationRequired: true,
                        registrationDeadline: new Date(2025, 9, 4),
                        cost: 'Kostenlos',
                        tags: ['Chilbi', 'Familie', 'Essen', 'Tradition', 'Helfer'],
                        // NEU: Assignments integration
                        hasAssignments: true,
                        assignmentsFile: 'events/chilbi-2025-assignments.md',
                        shifts: [
                            {
                                id: 'aufbau',
                                name: 'Aufbau',
                                date: '16.10.2025',
                                time: '17:00-20:00',
                                needed: 5,
                                description: 'Grundaufbau und Vorbereitung des Roten Schopfs'
                            },
                            {
                                id: 'samstag-bar-12-14',
                                name: 'Bar Samstag 12:00-14:00',
                                date: '18.10.2025',
                                time: '12:00-14:00',
                                needed: 2,
                                description: 'Bar - Getränke ausgeben und zubereiten'
                            },
                            {
                                id: 'samstag-kueche-12-14',
                                name: 'Küche Samstag 12:00-14:00',
                                date: '18.10.2025',
                                time: '12:00-14:00',
                                needed: 2,
                                description: 'Küche - Essen zubereiten und ausgeben'
                            },
                            {
                                id: 'samstag-kasse-12-14',
                                name: 'Kasse Samstag 12:00-14:00',
                                date: '18.10.2025',
                                time: '12:00-14:00',
                                needed: 2,
                                description: 'Kasse - Geld kassieren und Bons ausgeben'
                            },
                            {
                                id: 'samstag-bar-20-22',
                                name: 'Bar Samstag 20:00-22:00',
                                date: '18.10.2025',
                                time: '20:00-22:00',
                                needed: 2,
                                description: 'Bar - Getränke ausgeben und zubereiten'
                            },
                            {
                                id: 'sonntag-bar-12-14',
                                name: 'Bar Sonntag 12:00-14:00',
                                date: '19.10.2025',
                                time: '12:00-14:00',
                                needed: 2,
                                description: 'Bar - Getränke ausgeben und zubereiten'
                            },
                            {
                                id: 'abbau',
                                name: 'Abbau',
                                date: '20.10.2025',
                                time: '18:00-21:00',
                                needed: 5,
                                description: 'Abbau und Aufräumarbeiten nach der Chilbi'
                            }
                        ],
                        // Real assignments (loaded from assignments.md file)
                        assignments: {
                            // Leer - alle Schichten offen, bereit für Anmeldungen
                        }
                    },
                    {
                        id: 'grillplausch-sommer-2025',
                        title: 'Grillplausch bei Edi Grossenbacher',
                        subtitle: 'Geselliger Sommerevent',
                        description: 'Hiermit lädt der Vorstand alle Mitglieder zum gemütlichen Grillplausch bei Edi Grossenbacher ein.\n\nDetails:\n- Essen und Getränke werden gestellt\n- Salate und Desserts können gerne mitgebracht werden\n\nAnfahrt: Kurzenbettli 23, bei der Schiessanlage Augst',
                        startDate: new Date(2025, 5, 17, 16, 0),
                        endDate: new Date(2025, 5, 17, 22, 0),
                        location: 'Kurzenbettli 23, 4302 Augst BL',
                        category: 'Gesellschaftsanlass',
                        organizer: 'Edi Grossenbacher',
                        email: 'materialwart@fwv-raura.ch',
                        status: 'confirmed',
                        registrationRequired: true,
                        registrationDeadline: new Date(2025, 5, 12),
                        cost: 'Kostenlos',
                        tags: ['Grillen', 'Geselligkeit', 'Sommer', 'Familie'],
                        participantRegistration: true,
                        hasAssignments: false
                    }
                ];
            }

            setupEventListeners() {
                // Filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.currentFilter = e.target.dataset.filter;
                        this.updateFilterButtons();
                        this.filterEvents();
                        this.renderEvents();
                    });
                });

                // Search and filters
                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.searchQuery = e.target.value.toLowerCase();
                    this.filterEvents();
                    this.renderEvents();
                });

                document.getElementById('category-filter').addEventListener('change', (e) => {
                    this.currentCategory = e.target.value;
                    this.filterEvents();
                    this.renderEvents();
                });

                // View mode buttons
                document.getElementById('list-view-btn').addEventListener('click', () => {
                    this.viewMode = 'list';
                    this.updateViewButtons();
                    this.renderEvents();
                });

                document.getElementById('grid-view-btn').addEventListener('click', () => {
                    this.viewMode = 'grid';
                    this.updateViewButtons();
                    this.renderEvents();
                });

                // Modal controls
                document.getElementById('close-modal').addEventListener('click', () => this.closeModal());
                document.getElementById('close-modal-btn').addEventListener('click', () => this.closeModal());
                document.getElementById('download-event-ics').addEventListener('click', () => this.downloadEventICS());
                document.getElementById('share-event').addEventListener('click', () => this.shareEvent());
                
                // NEW: Assignments controls
                document.getElementById('view-full-assignments').addEventListener('click', () => this.showAssignmentsModal());
                document.getElementById('download-assignments-pdf').addEventListener('click', () => this.downloadAssignmentsPDF());
                document.getElementById('close-assignments-modal').addEventListener('click', () => this.closeAssignmentsModal());
                
                // Registration
                document.getElementById('send-registration-email').addEventListener('click', () => this.sendRegistrationEmail());
                
                document.getElementById('event-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'event-modal') this.closeModal();
                });

                document.getElementById('assignments-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'assignments-modal') this.closeAssignmentsModal();
                });
            }

            updateFilterButtons() {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    const isActive = btn.dataset.filter === this.currentFilter;
                    btn.className = isActive 
                        ? 'filter-btn active bg-white text-fire-700 px-6 py-3 rounded-lg font-semibold hover:bg-fire-50 transition-colors'
                        : 'filter-btn border-2 border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-white hover:text-fire-700 transition-colors';
                });
            }

            updateViewButtons() {
                const listBtn = document.getElementById('list-view-btn');
                const gridBtn = document.getElementById('grid-view-btn');
                
                if (this.viewMode === 'list') {
                    listBtn.className = 'p-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600 transition-colors';
                    gridBtn.className = 'p-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors';
                } else {
                    listBtn.className = 'p-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors';
                    gridBtn.className = 'p-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600 transition-colors';
                }
            }

            filterEvents() {
                const now = new Date();
                let filtered = [...this.events];

                // Time filter
                if (this.currentFilter === 'upcoming') {
                    filtered = filtered.filter(event => event.startDate > now);
                } else if (this.currentFilter === 'past') {
                    filtered = filtered.filter(event => event.endDate < now);
                }

                // Category filter
                if (this.currentCategory) {
                    filtered = filtered.filter(event => event.category === this.currentCategory);
                }

                // Search filter
                if (this.searchQuery) {
                    filtered = filtered.filter(event => 
                        event.title.toLowerCase().includes(this.searchQuery) ||
                        event.description.toLowerCase().includes(this.searchQuery) ||
                        event.location.toLowerCase().includes(this.searchQuery) ||
                        event.organizer.toLowerCase().includes(this.searchQuery) ||
                        event.tags.some(tag => tag.toLowerCase().includes(this.searchQuery))
                    );
                }

                // Sort by date
                filtered.sort((a, b) => {
                    if (this.currentFilter === 'past') {
                        return b.startDate - a.startDate;
                    }
                    return a.startDate - b.startDate;
                });

                this.filteredEvents = filtered;
            }

            renderEvents() {
                const container = document.getElementById('events-container');
                const noEventsMsg = document.getElementById('no-events');

                if (this.filteredEvents.length === 0) {
                    container.innerHTML = '';
                    noEventsMsg.classList.remove('hidden');
                    return;
                }

                noEventsMsg.classList.add('hidden');

                if (this.viewMode === 'list') {
                    container.className = 'space-y-6';
                    container.innerHTML = this.filteredEvents.map(event => this.createEventListItem(event)).join('');
                } else {
                    container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                    container.innerHTML = this.filteredEvents.map(event => this.createEventGridItem(event)).join('');
                }

                // Add click listeners
                container.querySelectorAll('[data-event-id]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const eventId = e.currentTarget.dataset.eventId;
                        this.showEventModal(eventId);
                    });
                });
            }

            createEventListItem(event) {
                const isPast = event.endDate < new Date();
                const statusBadge = this.getStatusBadge(event);
                const registrationBadge = this.getRegistrationBadge(event);
                
                return `
                    <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer overflow-hidden ${isPast ? 'opacity-75' : ''}" 
                         data-event-id="${event.id}">
                        <div class="p-6">
                            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
                                <div class="flex-1">
                                    <div class="flex items-start justify-between mb-3">
                                        <div>
                                            <h3 class="text-xl font-bold text-gray-800 mb-1">${event.title}</h3>
                                            <p class="text-fire-600 font-medium">${event.subtitle}</p>
                                        </div>
                                        <div class="flex space-x-2">
                                            ${statusBadge}
                                            ${registrationBadge}
                                        </div>
                                    </div>
                                    
                                    <div class="prose prose-sm max-w-none mb-4 text-gray-600">
                                        ${this.truncateText(event.description, 200)}
                                    </div>
                                    
                                    <!-- NEU: Schichtplan-Übersicht für Helfer-Events -->
                                    ${event.hasAssignments ? this.createCompactAssignmentsView(event) : ''}
                                    
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-gray-500 mb-4">
                                        <div class="space-y-2">
                                            <div class="flex items-center">
                                                <span class="mr-2">📅</span>
                                                <span>${this.formatDate(event.startDate)}</span>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="mr-2">⏰</span>
                                                <span>${this.formatTime(event.startDate)} - ${this.formatTime(event.endDate)}</span>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex items-center">
                                                <span class="mr-2">📍</span>
                                                <span>${event.location}</span>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="mr-2">👤</span>
                                                <span>${event.organizer}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex flex-wrap gap-2">
                                        ${event.tags.map(tag => `
                                            <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs">
                                                ${tag}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="mt-4 lg:mt-0 lg:ml-6 flex-shrink-0">
                                    <span class="inline-block px-3 py-1 bg-fire-100 text-fire-800 rounded-full text-sm font-medium">
                                        ${event.category}
                                    </span>
                                    ${event.cost !== 'Kostenlos' ? `
                                        <div class="mt-2 text-lg font-bold text-fire-600">
                                            ${event.cost}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            createCompactAssignmentsView(event) {
                if (!event.shifts || !event.assignments) return '';

                let totalSlots = 0;
                let filledSlots = 0;
                
                event.shifts.forEach(shift => {
                    totalSlots += shift.needed;
                    const assigned = event.assignments[shift.id] || [];
                    filledSlots += assigned.length;
                });

                const percentage = Math.round((filledSlots / totalSlots) * 100);
                const openSlots = totalSlots - filledSlots;

                return `
                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-gray-800 text-sm">📋 Schichtplan-Status</h4>
                            <span class="text-sm font-medium ${percentage >= 80 ? 'text-green-600' : percentage >= 50 ? 'text-yellow-600' : 'text-red-600'}">
                                ${filledSlots}/${totalSlots} (${percentage}%)
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                            <div class="h-2 rounded-full transition-all duration-300 ${percentage >= 80 ? 'bg-green-500' : percentage >= 50 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                 style="width: ${percentage}%"></div>
                        </div>
                        <div class="text-xs text-gray-600">
                            ${openSlots > 0 ? `${openSlots} Plätze noch offen` : 'Alle Schichten besetzt'} • ${event.shifts.length} Schichten total
                        </div>
                    </div>
                `;
            }

            createEventGridItem(event) {
                const isPast = event.endDate < new Date();
                const statusBadge = this.getStatusBadge(event);
                const registrationBadge = this.getRegistrationBadge(event);
                
                return `
                    <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer overflow-hidden ${isPast ? 'opacity-75' : ''}" 
                         data-event-id="${event.id}">
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-lg font-bold text-gray-800 leading-tight">${event.title}</h3>
                                <div class="flex flex-col space-y-1">
                                    ${statusBadge}
                                    ${registrationBadge}
                                </div>
                            </div>
                            
                            <p class="text-fire-600 text-sm font-medium mb-3">${event.subtitle}</p>
                            
                            <div class="text-sm text-gray-600 mb-4">
                                ${this.truncateText(event.description, 120)}
                            </div>
                            
                            <!-- NEU: Mini Schichtplan für Grid View -->
                            ${event.hasAssignments ? this.createMiniAssignmentsView(event) : ''}
                            
                            <div class="space-y-2 text-sm text-gray-500 mb-4">
                                <div class="flex items-center">
                                    <span class="mr-2">📅</span>
                                    <span>${this.formatDate(event.startDate)}</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="mr-2">📍</span>
                                    <span class="truncate">${event.location}</span>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <span class="px-2 py-1 bg-fire-100 text-fire-800 rounded-full text-xs font-medium">
                                    ${event.category}
                                </span>
                                ${event.cost !== 'Kostenlos' ? `
                                    <span class="text-fire-600 font-bold text-sm">${event.cost}</span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            createMiniAssignmentsView(event) {
                if (!event.shifts || !event.assignments) return '';

                let totalSlots = 0;
                let filledSlots = 0;
                
                event.shifts.forEach(shift => {
                    totalSlots += shift.needed;
                    const assigned = event.assignments[shift.id] || [];
                    filledSlots += assigned.length;
                });

                const percentage = Math.round((filledSlots / totalSlots) * 100);

                return `
                    <div class="mb-3 p-2 bg-blue-50 rounded">
                        <div class="flex justify-between items-center text-xs mb-1">
                            <span class="font-medium text-gray-700">Schichtplan</span>
                            <span class="${percentage >= 80 ? 'text-green-600' : 'text-red-600'}">${filledSlots}/${totalSlots}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded h-1">
                            <div class="h-1 rounded ${percentage >= 80 ? 'bg-green-500' : 'bg-red-500'}" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }

            getStatusBadge(event) {
                const now = new Date();
                
                if (event.endDate < now) {
                    return '<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium">Vergangen</span>';
                } else if (event.startDate <= now && event.endDate >= now) {
                    return '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium animate-pulse">Läuft</span>';
                } else if (event.registrationRequired && event.registrationDeadline && event.registrationDeadline < now) {
                    return '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">Anmeldung geschlossen</span>';
                } else {
                    return '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">Geplant</span>';
                }
            }

            getRegistrationBadge(event) {
                if (!event.registrationRequired) return '';
                
                const now = new Date();
                if (event.registrationDeadline && event.registrationDeadline < now) return '';
                if (event.endDate < now) return '';
                
                if (event.shifts && event.shifts.length > 0) {
                    return '<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-medium">👷 Helfer gesucht</span>';
                } else if (event.participantRegistration) {
                    return '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">📧 Anmeldung möglich</span>';
                }
                
                return '';
            }

            showEventModal(eventId) {
                const event = this.events.find(e => e.id === eventId);
                if (!event) return;

                this.selectedEvent = event;
                this.selectedShifts = [];
                
                document.getElementById('modal-title').textContent = event.title;
                document.getElementById('modal-meta').innerHTML = `
                    <span>📅 ${this.formatDate(event.startDate)}</span>
                    <span>⏰ ${this.formatTime(event.startDate)} - ${this.formatTime(event.endDate)}</span>
                    <span>📍 ${event.location}</span>
                    <span>👤 ${event.organizer}</span>
                `;

                document.getElementById('modal-content').innerHTML = `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">${event.subtitle}</h3>
                        <div class="prose max-w-none">
                            ${this.parseMarkdown(event.description)}
                        </div>
                    </div>
                    
                    <!-- NEU: Schichtplan-Integration -->
                    ${event.hasAssignments ? this.createAssignmentsSection(event) : ''}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-800">Veranstaltungsdetails</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Kategorie:</span>
                                    <span class="px-2 py-1 bg-fire-100 text-fire-800 rounded text-xs">${event.category}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Kosten:</span>
                                    <span class="font-medium">${event.cost}</span>
                                </div>
                                ${event.registrationRequired ? `
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Anmeldung:</span>
                                        <span class="text-fire-600">Erforderlich</span>
                                    </div>
                                ` : ''}
                                ${event.registrationDeadline ? `
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Anmeldeschluss:</span>
                                        <span>${this.formatDate(event.registrationDeadline)}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-800">Kontakt</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Organisator:</span>
                                    <span class="font-medium">${event.organizer}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">E-Mail:</span>
                                    <a href="mailto:${event.email}" class="text-fire-600 hover:text-fire-700">${event.email}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${event.tags.length > 0 ? `
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 mb-2">Tags</h4>
                            <div class="flex flex-wrap gap-2">
                                ${event.tags.map(tag => `
                                    <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">
                                        ${tag}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;

                // Show/hide assignment buttons
                const viewAssignmentsBtn = document.getElementById('view-full-assignments');
                const downloadPDFBtn = document.getElementById('download-assignments-pdf');
                
                if (event.hasAssignments) {
                    viewAssignmentsBtn.classList.remove('hidden');
                    downloadPDFBtn.classList.remove('hidden');
                } else {
                    viewAssignmentsBtn.classList.add('hidden');
                    downloadPDFBtn.classList.add('hidden');
                }

                // Show registration section if applicable
                this.setupRegistrationSection(event);
                
                document.getElementById('event-modal').classList.remove('hidden');
            }

            createAssignmentsSection(event) {
                if (!event.shifts || !event.assignments) return '';

                // Berechne Statistiken
                let totalSlots = 0;
                let filledSlots = 0;
                
                event.shifts.forEach(shift => {
                    totalSlots += shift.needed;
                    const assigned = event.assignments[shift.id] || [];
                    filledSlots += assigned.length;
                });

                const percentage = Math.round((filledSlots / totalSlots) * 100);
                const openSlots = totalSlots - filledSlots;

                return `
                    <div class="mb-6 border-t pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-xl font-bold text-gray-800">📋 Schichtplan-Übersicht</h4>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">Besetzung</div>
                                <div class="text-lg font-bold ${percentage >= 80 ? 'text-green-600' : percentage >= 50 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${filledSlots}/${totalSlots} (${percentage}%)
                                </div>
                                ${openSlots > 0 ? `<div class="text-xs text-red-500">${openSlots} Plätze offen</div>` : '<div class="text-xs text-green-500">Vollständig besetzt</div>'}
                            </div>
                        </div>

                        <!-- Fortschrittsbalken -->
                        <div class="mb-4">
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="h-3 rounded-full transition-all duration-300 ${percentage >= 80 ? 'bg-green-500' : percentage >= 50 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                     style="width: ${percentage}%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0</span>
                                <span>${totalSlots} Plätze</span>
                            </div>
                        </div>

                        <!-- Kompakte Schichtübersicht -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            ${this.createShiftSummaryByCategory(event)}
                        </div>

                        <!-- Kritische Bereiche -->
                        ${this.createCriticalAreas(event)}
                    </div>
                `;
            }

            createShiftSummaryByCategory(event) {
                const categories = {
                    'Aufbau': [],
                    'Samstag': [],
                    'Sonntag': [],
                    'Abbau': []
                };

                // Gruppiere Schichten
                event.shifts.forEach(shift => {
                    if (shift.id.includes('aufbau')) {
                        categories['Aufbau'].push(shift);
                    } else if (shift.id.includes('samstag')) {
                        categories['Samstag'].push(shift);
                    } else if (shift.id.includes('sonntag')) {
                        categories['Sonntag'].push(shift);
                    } else if (shift.id.includes('abbau')) {
                        categories['Abbau'].push(shift);
                    }
                });

                return Object.entries(categories)
                    .filter(([cat, shifts]) => shifts.length > 0)
                    .map(([category, shifts]) => {
                        let totalNeeded = 0;
                        let totalFilled = 0;

                        shifts.forEach(shift => {
                            totalNeeded += shift.needed;
                            const assigned = event.assignments[shift.id] || [];
                            totalFilled += assigned.length;
                        });

                        const percentage = totalNeeded > 0 ? Math.round((totalFilled / totalNeeded) * 100) : 0;
                        const isComplete = totalFilled >= totalNeeded;

                        return `
                            <div class="border rounded-lg p-3 ${isComplete ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                                <div class="flex justify-between items-center">
                                    <h5 class="font-semibold text-gray-800">${category}</h5>
                                    <span class="text-sm ${isComplete ? 'text-green-600' : 'text-red-600'} font-medium">
                                        ${totalFilled}/${totalNeeded}
                                    </span>
                                </div>
                                <div class="mt-2">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="h-2 rounded-full ${isComplete ? 'bg-green-500' : 'bg-red-500'}" 
                                             style="width: ${percentage}%"></div>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-600 mt-1">
                                    ${shifts.length} Schichten • ${percentage}% besetzt
                                </div>
                            </div>
                        `;
                    }).join('');
            }

            createCriticalAreas(event) {
                const criticalShifts = event.shifts.filter(shift => {
                    const assigned = event.assignments[shift.id] || [];
                    return assigned.length === 0; // Völlig unbesetzte Schichten
                });

                if (criticalShifts.length === 0) return '';

                return `
                    <div class="border border-red-200 bg-red-50 rounded-lg p-4">
                        <h5 class="font-semibold text-red-800 mb-2">⚠️ Kritische Bereiche (${criticalShifts.length} unbesetzte Schichten)</h5>
                        <div class="text-sm text-red-700">
                            ${criticalShifts.slice(0, 3).map(shift => `
                                <div>• ${shift.name} (${shift.needed} Personen benötigt)</div>
                            `).join('')}
                            ${criticalShifts.length > 3 ? `<div class="text-red-600 mt-1">... und ${criticalShifts.length - 3} weitere</div>` : ''}
                        </div>
                    </div>
                `;
            }

            // NEU: Vollständiger Arbeitsplan Modal
            showAssignmentsModal() {
                if (!this.selectedEvent || !this.selectedEvent.hasAssignments) return;

                const event = this.selectedEvent;
                
                document.getElementById('assignments-modal-title').textContent = `Arbeitsplan ${event.title}`;
                document.getElementById('assignments-modal-meta').innerHTML = `
                    ${this.formatDate(event.startDate)} - ${this.formatDate(event.endDate)} • ${event.location}
                `;

                document.getElementById('assignments-content').innerHTML = this.createFullAssignmentsView(event);
                document.getElementById('assignments-modal').classList.remove('hidden');
            }

            createFullAssignmentsView(event) {
                if (!event.shifts || !event.assignments) return '<p>Keine Schichtdaten verfügbar.</p>';

                // Gruppiere Schichten nach Kategorien
                const categories = {
                    'Aufbau': [],
                    'Samstag': [],
                    'Sonntag': [],
                    'Abbau': []
                };

                event.shifts.forEach(shift => {
                    if (shift.id.includes('aufbau')) {
                        categories['Aufbau'].push(shift);
                    } else if (shift.id.includes('samstag')) {
                        categories['Samstag'].push(shift);
                    } else if (shift.id.includes('sonntag')) {
                        categories['Sonntag'].push(shift);
                    } else if (shift.id.includes('abbau')) {
                        categories['Abbau'].push(shift);
                    }
                });

                let html = '';

                // Aufbau Sektion
                if (categories['Aufbau'].length > 0) {
                    html += `
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">🔨 Aufbau</h3>
                            ${categories['Aufbau'].map(shift => {
                                const assigned = event.assignments[shift.id] || [];
                                const remaining = shift.needed - assigned.length;
                                return `
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                        <div class="flex justify-between items-center mb-2">
                                            <h4 class="font-semibold">${shift.name}</h4>
                                            <span class="text-sm text-gray-600">${shift.date} • ${shift.time}</span>
                                        </div>
                                        <div class="text-sm text-gray-600 mb-3">${shift.description}</div>
                                        <div class="space-y-1">
                                            ${assigned.map(person => `<div class="text-green-700">✅ ${person}</div>`).join('')}
                                            ${Array(remaining).fill().map(() => '<div class="text-red-600">❌ [OFFEN]</div>').join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }

                // Samstag/Sonntag als Tabelle
                ['Samstag', 'Sonntag'].forEach(day => {
                    if (categories[day].length > 0) {
                        html += this.createDayTable(day, categories[day], event);
                    }
                });

                // Abbau Sektion
                if (categories['Abbau'].length > 0) {
                    html += `
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">🛠️ Abbau</h3>
                            ${categories['Abbau'].map(shift => {
                                const assigned = event.assignments[shift.id] || [];
                                const remaining = shift.needed - assigned.length;
                                return `
                                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                                        <div class="flex justify-between items-center mb-2">
                                            <h4 class="font-semibold">${shift.name}</h4>
                                            <span class="text-sm text-gray-600">${shift.date} • ${shift.time}</span>
                                        </div>
                                        <div class="text-sm text-gray-600 mb-3">${shift.description}</div>
                                        <div class="space-y-1">
                                            ${assigned.map(person => `<div class="text-green-700">✅ ${person}</div>`).join('')}
                                            ${Array(remaining).fill().map(() => '<div class="text-red-600">❌ [OFFEN]</div>').join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }

                return html;
            }

            createDayTable(day, shifts, event) {
                // Gruppiere nach Zeitslots
                const timeSlots = {};
                shifts.forEach(shift => {
                    if (!timeSlots[shift.time]) {
                        timeSlots[shift.time] = { bar: null, kueche: null, kasse: null };
                    }
                    
                    if (shift.id.includes('bar')) {
                        timeSlots[shift.time].bar = shift;
                    } else if (shift.id.includes('kueche')) {
                        timeSlots[shift.time].kueche = shift;
                    } else if (shift.id.includes('kasse')) {
                        timeSlots[shift.time].kasse = shift;
                    }
                });

                return `
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">🎪 ${day}</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border border-gray-300 rounded-lg overflow-hidden">
                                <thead class="bg-fire-500 text-white">
                                    <tr>
                                        <th class="p-3 text-left border-r border-fire-400">Zeit</th>
                                        <th class="p-3 text-left border-r border-fire-400">Küche</th>
                                        <th class="p-3 text-left border-r border-fire-400">Bar</th>
                                        <th class="p-3 text-left">Service / Kasse</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(timeSlots).sort().map(([time, slots]) => `
                                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                                            <td class="p-3 font-medium border-r border-gray-200">${time}</td>
                                            <td class="p-3 border-r border-gray-200">
                                                ${this.renderTableCell(slots.kueche, event)}
                                            </td>
                                            <td class="p-3 border-r border-gray-200">
                                                ${this.renderTableCell(slots.bar, event)}
                                            </td>
                                            <td class="p-3">
                                                ${this.renderTableCell(slots.kasse, event)}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 text-sm text-gray-600">
                            <strong>Springer:</strong> Stefan Müller
                        </div>
                    </div>
                `;
            }

            renderTableCell(shift, event) {
                if (!shift) return '<span class="text-gray-400">-</span>';
                
                const assigned = event.assignments[shift.id] || [];
                const remaining = shift.needed - assigned.length;
                
                return `
                    <div class="space-y-1">
                        ${assigned.map(person => `<div class="text-green-700">• ${person}</div>`).join('')}
                        ${Array(remaining).fill().map(() => '<div class="text-red-600 italic">• [OFFEN]</div>').join('')}
                    </div>
                `;
            }

            closeAssignmentsModal() {
                document.getElementById('assignments-modal').classList.add('hidden');
            }

            downloadAssignmentsPDF() {
                if (!this.selectedEvent || !this.selectedEvent.hasAssignments) return;

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const event = this.selectedEvent;

                // Header
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Feuerwehrverein Raura, Kaiseraugst', 20, 20);
                
                doc.setFontSize(14);
                doc.text(`Arbeitsplan ${event.title}`, 20, 35);

                let yPos = 50;

                // Aufbau Section
                const aufbauShifts = event.shifts.filter(s => s.id.includes('aufbau'));
                if (aufbauShifts.length > 0) {
                    doc.setFont(undefined, 'bold');
                    const aufbauShift = aufbauShifts[0];
                    doc.text(`Aufbau ${aufbauShift.date} ab ${aufbauShift.time.split('-')[0]} für ${event.title}`, 20, yPos);
                    yPos += 10;

                    const aufbauAssigned = event.assignments[aufbauShift.id] || [];
                    aufbauAssigned.forEach(person => {
                        doc.setFont(undefined, 'normal');
                        doc.text(`- ${person}`, 25, yPos);
                        yPos += 7;
                    });
                    yPos += 10;
                }

                // Samstag Section
                const samstagShifts = event.shifts.filter(s => s.id.includes('samstag'));
                if (samstagShifts.length > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Samstag,18.10.2025', 20, yPos);
                    doc.text('Küche', 70, yPos);
                    doc.text('Bar', 120, yPos);
                    doc.text('Service / Kasse', 160, yPos);
                    yPos += 10;

                    // Group by time slots
                    const timeSlots = new Set();
                    samstagShifts.forEach(shift => {
                        timeSlots.add(shift.time);
                    });

                    Array.from(timeSlots).sort().forEach(time => {
                        doc.setFont(undefined, 'normal');
                        doc.text(time, 20, yPos);

                        const kueche = samstagShifts.find(s => s.time === time && s.id.includes('kueche'));
                        const bar = samstagShifts.find(s => s.time === time && s.id.includes('bar'));
                        const kasse = samstagShifts.find(s => s.time === time && s.id.includes('kasse'));

                        let maxLines = 0;

                        if (kueche) {
                            const kuecheAssigned = event.assignments[kueche.id] || [];
                            kuecheAssigned.forEach((person, idx) => {
                                doc.text(`- ${person}`, 70, yPos + (idx * 5));
                            });
                            maxLines = Math.max(maxLines, kuecheAssigned.length);
                        }

                        if (bar) {
                            const barAssigned = event.assignments[bar.id] || [];
                            barAssigned.forEach((person, idx) => {
                                doc.text(`- ${person}`, 120, yPos + (idx * 5));
                            });
                            maxLines = Math.max(maxLines, barAssigned.length);
                        }

                        if (kasse) {
                            const kasseAssigned = event.assignments[kasse.id] || [];
                            kasseAssigned.forEach((person, idx) => {
                                doc.text(`- ${person}`, 160, yPos + (idx * 5));
                            });
                            maxLines = Math.max(maxLines, kasseAssigned.length);
                        }

                        yPos += Math.max(10, maxLines * 5 + 5);
                    });

                    doc.setFont(undefined, 'bold');
                    doc.text('Springer: Stefan Müller', 20, yPos);
                    yPos += 20;
                }

                // New page if needed
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }

                // Sonntag Section (similar structure)
                const sonntagShifts = event.shifts.filter(s => s.id.includes('sonntag'));
                if (sonntagShifts.length > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Sonntag,19.10.2025', 20, yPos);
                    doc.text('Küche', 70, yPos);
                    doc.text('Bar', 120, yPos);
                    doc.text('Service / Kasse', 160, yPos);
                    yPos += 10;

                    const timeSlots = new Set();
                    sonntagShifts.forEach(shift => {
                        timeSlots.add(shift.time);
                    });

                    Array.from(timeSlots).sort().forEach(time => {
                        doc.setFont(undefined, 'normal');
                        doc.text(time, 20, yPos);

                        const kueche = sonntagShifts.find(s => s.time === time && s.id.includes('kueche'));
                        const bar = sonntagShifts.find(s => s.time === time && s.id.includes('bar'));
                        const kasse = sonntagShifts.find(s => s.time === time && s.id.includes('kasse'));

                        let maxLines = 0;

                        if (kueche) {
                            const kuecheAssigned = event.assignments[kueche.id] || [];
                            kuecheAssigned.forEach((person, idx) => {
                                doc.text(`- ${person}`, 70, yPos + (idx * 5));
                            });
                            maxLines = Math.max(maxLines, kuecheAssigned.length);
                        }

                        if (bar) {
                            const barAssigned = event.assignments[bar.id] || [];
                            barAssigned.forEach((person, idx) => {
                                doc.text(`- ${person}`, 120, yPos + (idx * 5));
                            });
                            maxLines = Math.max(maxLines, barAssigned.length);
                        }

                        if (kasse) {
                            const kasseAssigned = event.assignments[kasse.id] || [];
                            kasseAssigned.forEach((person, idx) => {
                                doc.text(`- ${person}`, 160, yPos + (idx * 5));
                            });
                            maxLines = Math.max(maxLines, kasseAssigned.length);
                        }

                        yPos += Math.max(10, maxLines * 5 + 5);
                    });

                    doc.setFont(undefined, 'bold');
                    doc.text('Springer: Stefan Müller', 20, yPos);
                    yPos += 20;
                }

                // Abbau Section
                const abbauShifts = event.shifts.filter(s => s.id.includes('abbau'));
                if (abbauShifts.length > 0) {
                    const abbauShift = abbauShifts[0];
                    doc.setFont(undefined, 'bold');
                    doc.text(`${abbauShift.date}: Abbauen ab ${abbauShift.time.split('-')[0]} Uhr`, 20, yPos);
                    yPos += 10;

                    const abbauAssigned = event.assignments[abbauShift.id] || [];
                    abbauAssigned.forEach(person => {
                        doc.setFont(undefined, 'normal');
                        doc.text(`- ${person}`, 25, yPos);
                        yPos += 7;
                    });
                }

                doc.save(`arbeitsplan-${event.id}.pdf`);
            }

            setupRegistrationSection(event) {
                const registrationSection = document.getElementById('registration-section');
                const shiftSelection = document.getElementById('shift-selection');
                const shiftsContainer = document.getElementById('shifts-container');
                const participantsSection = document.getElementById('participants-section');

                // Check if registration is possible
                const now = new Date();
                const canRegister = event.registrationRequired && 
                    (!event.registrationDeadline || event.registrationDeadline > now) &&
                    event.endDate > now;

                if (!canRegister) {
                    registrationSection.classList.add('hidden');
                    return;
                }

                registrationSection.classList.remove('hidden');

                // Setup shifts if available
                if (event.shifts && event.shifts.length > 0) {
                    shiftSelection.classList.remove('hidden');
                    participantsSection.classList.add('hidden');
                    
                    shiftsContainer.innerHTML = event.shifts.map(shift => `
                        <label class="flex items-start space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <input type="checkbox" value="${shift.id}" class="shift-checkbox mt-1 text-fire-500 focus:ring-fire-500" onchange="window.eventsManager.toggleShift('${shift.id}')">
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium text-gray-800">${shift.name}</p>
                                        <p class="text-sm text-gray-600">${shift.date} • ${shift.time}</p>
                                        <p class="text-xs text-gray-500">${shift.description}</p>
                                    </div>
                                    <span class="text-xs bg-fire-100 text-fire-800 px-2 py-1 rounded-full">
                                        ${shift.needed} benötigt
                                    </span>
                                </div>
                            </div>
                        </label>
                    `).join('');
                } else if (event.participantRegistration) {
                    shiftSelection.classList.add('hidden');
                    participantsSection.classList.remove('hidden');
                } else {
                    shiftSelection.classList.add('hidden');
                    participantsSection.classList.add('hidden');
                }

                // Make eventsManager globally accessible for checkbox events
                window.eventsManager = this;
            }

            toggleShift(shiftId) {
                const index = this.selectedShifts.indexOf(shiftId);
                if (index > -1) {
                    this.selectedShifts.splice(index, 1);
                } else {
                    this.selectedShifts.push(shiftId);
                }
            }

            sendRegistrationEmail() {
                const event = this.selectedEvent;
                if (!event) return;

                // Get form data
                const name = document.getElementById('reg-name').value.trim();
                const email = document.getElementById('reg-email').value.trim();
                const phone = document.getElementById('reg-phone').value.trim();
                const notes = document.getElementById('reg-notes').value.trim();

                // Validation
                if (!name || !email) {
                    alert('Bitte füllen Sie mindestens Name und E-Mail aus.');
                    return;
                }

                // Build email content
                let subject, body;

                if (event.shifts && event.shifts.length > 0 && this.selectedShifts.length > 0) {
                    // Helper registration with shifts
                    subject = `Helfer-Anmeldung: ${event.title}`;
                    
                    const selectedShiftDetails = event.shifts
                        .filter(shift => this.selectedShifts.includes(shift.id))
                        .map(shift => `• ${shift.name} (${shift.date}, ${shift.time}) - ${shift.description}`)
                        .join('\n');

                    body = `Hallo ${event.organizer},

hiermit melde ich mich als Helfer für folgende Schichten an:

VERANSTALTUNG: ${event.title}
DATUM: ${this.formatDate(event.startDate)}
ORT: ${event.location}

GEWÄHLTE SCHICHTEN:
${selectedShiftDetails}

MEINE KONTAKTDATEN:
Name: ${name}
E-Mail: ${email}
${phone ? `Telefon: ${phone}` : ''}

${notes ? `BEMERKUNGEN:\n${notes}` : ''}

Vielen Dank für die Organisation!

Mit freundlichen Grüssen
${name}`;

                } else if (event.participantRegistration) {
                    // Participant registration
                    const participants = document.getElementById('reg-participants').value || '1';
                    subject = `Anmeldung: ${event.title}`;
                    
                    body = `Hallo ${event.organizer},

hiermit melde ich mich für die Veranstaltung an:

VERANSTALTUNG: ${event.title}
DATUM: ${this.formatDate(event.startDate)}
ZEIT: ${this.formatTime(event.startDate)} - ${this.formatTime(event.endDate)}
ORT: ${event.location}
${event.cost !== 'Kostenlos' ? `KOSTEN: ${event.cost}` : ''}

ANMELDUNG:
Name: ${name}
E-Mail: ${email}
${phone ? `Telefon: ${phone}` : ''}
${event.participantRegistration && participants !== '1' ? `Anzahl Personen: ${participants}` : ''}

${notes ? `BEMERKUNGEN:\n${notes}` : ''}

Vielen Dank für die Organisation!

Mit freundlichen Grüssen
${name}`;

                } else {
                    // General registration
                    subject = `Anmeldung: ${event.title}`;
                    body = `Hallo ${event.organizer},

hiermit melde ich mich für die Veranstaltung an:

VERANSTALTUNG: ${event.title}
DATUM: ${this.formatDate(event.startDate)}

KONTAKTDATEN:
Name: ${name}
E-Mail: ${email}
${phone ? `Telefon: ${phone}` : ''}

${notes ? `BEMERKUNGEN:\n${notes}` : ''}

Mit freundlichen Grüssen
${name}`;
                }

                // Create mailto link
                const mailtoLink = `mailto:${event.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                // Open email client
                window.location.href = mailtoLink;

                // Show success message
                setTimeout(() => {
                    alert('E-Mail-Client wurde geöffnet. Bitte senden Sie die E-Mail ab.');
                }, 500);
            }

            closeModal() {
                document.getElementById('event-modal').classList.add('hidden');
                this.selectedEvent = null;
                this.selectedShifts = [];
                
                // Reset form
                document.getElementById('reg-name').value = '';
                document.getElementById('reg-email').value = '';
                document.getElementById('reg-phone').value = '';
                document.getElementById('reg-notes').value = '';
                
                // Uncheck all shift checkboxes
                document.querySelectorAll('.shift-checkbox').forEach(cb => cb.checked = false);
            }

            downloadEventICS() {
                if (!this.selectedEvent) return;
                const icsData = this.generateICS([this.selectedEvent]);
                this.downloadICS(icsData, `${this.selectedEvent.id}.ics`);
            }

            shareEvent() {
                if (!this.selectedEvent) return;
                
                const url = `${window.location.origin}${window.location.pathname}#event-${this.selectedEvent.id}`;
                const text = `${this.selectedEvent.title} - ${this.formatDate(this.selectedEvent.startDate)}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: this.selectedEvent.title,
                        text: text,
                        url: url
                    });
                } else {
                    navigator.clipboard.writeText(`${text}\n${url}`).then(() => {
                        alert('Link wurde in die Zwischenablage kopiert!');
                    });
                }
            }

            generateICS(events) {
                const now = new Date();
                let ics = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'PRODID:-//Feuerwehrverein Raura Kaiseraugst//Vereinskalender//DE',
                    'CALSCALE:GREGORIAN',
                    'METHOD:PUBLISH',
                    'X-WR-CALNAME:Feuerwehrverein Raura Kaiseraugst',
                    'X-WR-CALDESC:Termine und Veranstaltungen des Feuerwehrvereins Raura Kaiseraugst',
                    'X-WR-TIMEZONE:Europe/Zurich'
                ];

                events.forEach(event => {
                    const uid = `${event.id}@feuerwehrverein-raura.ch`;
                    const dtstart = this.formatDateForICS(event.startDate);
                    const dtend = this.formatDateForICS(event.endDate);
                    const dtstamp = this.formatDateForICS(now);
                    const description = event.description.replace(/\n/g, '\\n');

                    ics.push(
                        'BEGIN:VEVENT',
                        `UID:${uid}`,
                        `DTSTAMP:${dtstamp}`,
                        `DTSTART:${dtstart}`,
                        `DTEND:${dtend}`,
                        `SUMMARY:${event.title}`,
                        `DESCRIPTION:${description}`,
                        `LOCATION:${event.location}`,
                        `ORGANIZER;CN=${event.organizer}:mailto:${event.email}`,
                        `CATEGORIES:${event.category}`,
                        'STATUS:CONFIRMED',
                        'END:VEVENT'
                    );
                });

                ics.push('END:VCALENDAR');
                return ics.join('\r\n');
            }

            downloadICS(icsData, filename) {
                const blob = new Blob([icsData], { type: 'text/calendar;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }

            parseMarkdown(text) {
                return text
                    .replace(/\n\n/g, '</p><p class="mb-3">')
                    .replace(/\n- /g, '</p><li class="ml-4">• ')
                    .replace(/\n/g, '<br>')
                    .replace(/^(.+)$/gm, '<p class="mb-3">$1</p>')
                    .replace(/(<li.*<\/li>)/gs, '<ul class="mb-3 list-none">$1</ul>')
                    .replace(/<p class="mb-3"><\/p>/g, '');
            }

            truncateText(text, maxLength) {
                const plainText = text.replace(/\n/g, ' ').trim();
                if (plainText.length <= maxLength) return plainText;
                return plainText.substring(0, maxLength) + '...';
            }

            formatDate(date) {
                return new Intl.DateTimeFormat('de-DE', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                }).format(date);
            }

            formatTime(date) {
                return new Intl.DateTimeFormat('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            }

            formatDateForICS(date) {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            }
        }

        // Initialize events manager when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new EventsManager();
        });
    </script>
</body>
</html>
