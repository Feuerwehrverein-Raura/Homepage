<!DOCTYPE html>
<html lang="de" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veranstaltungen - Feuerwehrverein Raura Kaiseraugst</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fire: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="font-sans antialiased bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-fire-700 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-fire-300 shadow-lg bg-white">
                        <img src="images/logo.png" alt="Feuerwehrverein Raura Logo" class="w-full h-full object-contain p-1">
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Feuerwehrverein Raura</h1>
                        <p class="text-fire-200 text-sm">Kaiseraugst</p>
                    </div>
                </div>
                <div class="flex space-x-6">
                    <a href="index.html" class="hover:text-fire-200 transition-colors">Home</a>
                    <a href="calendar.html" class="hover:text-fire-200 transition-colors">Kalender</a>
                    <a href="events.html" class="text-fire-200 font-semibold">Veranstaltungen</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <section class="bg-gradient-to-r from-fire-600 to-fire-700 text-white py-12">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl font-bold mb-4">Unsere Veranstaltungen</h2>
            <p class="text-fire-100 text-lg mb-6">Detaillierte Informationen zu allen Terminen und Events</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="filter-all" class="filter-btn active bg-white text-fire-700 px-6 py-3 rounded-lg font-semibold hover:bg-fire-50 transition-colors" data-filter="all">
                    Alle Veranstaltungen
                </button>
                <button id="filter-upcoming" class="filter-btn border-2 border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-white hover:text-fire-700 transition-colors" data-filter="upcoming">
                    Kommende
                </button>
                <button id="filter-past" class="filter-btn border-2 border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-white hover:text-fire-700 transition-colors" data-filter="past">
                    Vergangene
                </button>
            </div>
        </div>
    </section>

    <!-- Events List -->
    <section class="py-8">
        <div class="container mx-auto px-4">
            <div id="events-container" class="space-y-6">
                <!-- Events will be loaded here -->
            </div>
            
            <!-- No events message -->
            <div id="no-events" class="hidden text-center py-12">
                <div class="text-gray-400 text-6xl mb-4">üìÖ</div>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">Keine Veranstaltungen gefunden</h3>
                <p class="text-gray-500">Versuchen Sie andere Suchkriterien oder Filter.</p>
            </div>
        </div>
    </section>

    <!-- Event Detail Modal -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="relative">
                <!-- Modal Header -->
                <div id="modal-header" class="bg-gradient-to-r from-fire-500 to-fire-600 text-white p-6 rounded-t-lg">
                    <button id="close-modal" class="absolute top-4 right-4 text-white hover:text-fire-200 text-2xl">√ó</button>
                    <h2 id="modal-title" class="text-2xl font-bold mb-2"></h2>
                    <div id="modal-meta" class="flex flex-wrap gap-4 text-fire-100 text-sm"></div>
                </div>
                
                <!-- Modal Content -->
                <div class="p-6">
                    <div id="modal-content" class="prose max-w-none">
                        <!-- Event details will be loaded here -->
                    </div>
                    
                    <!-- Shift Planning Section (only for events with shifts) -->
                    <div id="shift-planning-section" class="hidden mt-8 border-t pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">üìã Schichtplanung</h3>
                            <div class="flex space-x-2">
                                <button id="view-arbeitsplan" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2">
                                    <span>üìã</span>
                                    <span>Arbeitsplan anzeigen</span>
                                </button>
                                <button id="download-arbeitsplan-pdf" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors flex items-center space-x-2">
                                    <span>üìÑ</span>
                                    <span>PDF generieren</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Shift Overview -->
                        <div id="shift-overview" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <!-- Shift statistics will be populated -->
                        </div>
                        
                        <!-- Critical Shifts Warning -->
                        <div id="critical-shifts" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                            <h4 class="font-bold text-red-800 mb-2">‚ö†Ô∏è Kritische Schichten</h4>
                            <div id="critical-shifts-list" class="text-red-700 text-sm">
                                <!-- Critical shifts will be listed here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Registration Section -->
                    <div id="registration-section" class="hidden mt-8 border-t pt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üìß Anmeldung</h3>
                        
                        <!-- Shift Selection -->
                        <div id="shift-selection" class="hidden mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Verf√ºgbare Schichten:</h4>
                            <div id="shifts-container" class="space-y-2">
                                <!-- Shifts will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Personal Information -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                                <input type="text" id="reg-name" placeholder="Ihr Name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">E-Mail *</label>
                                <input type="email" id="reg-email" placeholder="ihre@email.ch" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Telefon</label>
                                <input type="tel" id="reg-phone" placeholder="079 123 45 67" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div id="participants-section" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Anzahl Personen</label>
                                <select id="reg-participants" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                                    <option value="1">1 Person</option>
                                    <option value="2">2 Personen</option>
                                    <option value="3">3 Personen</option>
                                    <option value="4">4 Personen</option>
                                    <option value="5">5+ Personen</option>
                                </select>
                            </div>
                        </div>

                        <!-- Additional Notes -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bemerkungen</label>
                            <textarea id="reg-notes" rows="3" placeholder="Besondere W√ºnsche, Allergien, etc." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500"></textarea>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                            <button id="send-registration-email" class="flex-1 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center space-x-2">
                                <span>üìß</span>
                                <span>Anmeldung per E-Mail senden</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Regular Modal Actions -->
                    <div class="mt-6 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                        <button id="download-event-ics" class="flex-1 bg-fire-500 text-white px-4 py-3 rounded-lg hover:bg-fire-600 transition-colors flex items-center justify-center space-x-2">
                            <span>‚¨áÔ∏è</span>
                            <span>ICS herunterladen</span>
                        </button>
                        <button id="share-event" class="flex-1 border border-fire-500 text-fire-500 px-4 py-3 rounded-lg hover:bg-fire-50 transition-colors flex items-center justify-center space-x-2">
                            <span>üì§</span>
                            <span>Teilen</span>
                        </button>
                        <button id="close-modal-btn" class="flex-1 border border-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors">
                            Schlie√üen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Arbeitsplan Modal -->
    <div id="arbeitsplan-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-60 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div class="relative">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-t-lg">
                    <button id="close-arbeitsplan-modal" class="absolute top-4 right-4 text-white hover:text-blue-200 text-2xl">√ó</button>
                    <h2 id="arbeitsplan-title" class="text-2xl font-bold mb-2">üìã Arbeitsplan</h2>
                    <div id="arbeitsplan-meta" class="text-blue-100 text-sm">
                        <span id="arbeitsplan-status"></span>
                    </div>
                </div>
                
                <!-- Modal Content -->
                <div class="p-6">
                    <div id="arbeitsplan-content" class="space-y-6">
                        <!-- Arbeitsplan content will be loaded here -->
                    </div>
                    
                    <div class="mt-6 flex space-x-3">
                        <button id="download-arbeitsplan-pdf-2" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors flex items-center space-x-2">
                            <span>üìÑ</span>
                            <span>PDF generieren</span>
                        </button>
                        <button id="edit-arbeitsplan" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2">
                            <span>‚úèÔ∏è</span>
                            <span>Arbeitsplan bearbeiten</span>
                        </button>
                        <button id="close-arbeitsplan-modal-btn" class="border border-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-50 transition-colors">
                            Schlie√üen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-fire-500 mx-auto mb-4"></div>
            <p class="text-gray-600">Lade Veranstaltungen...</p>
        </div>
    </div>

    <script>
        class EventsManager {
            constructor() {
                this.events = [];
                this.filteredEvents = [];
                this.currentFilter = 'all';
                this.selectedEvent = null;
                this.selectedShifts = [];
                this.arbeitsplanData = {};
                
                this.init();
            }

            async init() {
                await this.loadEvents();
                this.setupEventListeners();
                this.filterEvents();
                this.renderEvents();
                document.getElementById('loading').classList.add('hidden');
            }

            async loadEvents() {
                try {
                    this.events = await this.loadEventsFromMarkdown();
                    // Load associated arbeitsplan files
                    await this.loadArbeitsplanData();
                } catch (error) {
                    console.error('Fehler beim Laden der Veranstaltungen:', error);
                    this.events = [];
                }
            }

            async loadEventsFromMarkdown() {
                // Include the Chilbi 2025 event from the documents
                return [
                    {
                        id: 'chilbi-2025',
                        title: 'Chilbi 2025',
                        subtitle: 'Traditionelle Dorfchilbi',
                        description: 'Unsere traditionelle Chilbi findet auch dieses Jahr wieder im Roten Schopf statt. Wir verwandeln das Vereinslokal in ein gem√ºtliches Festlokal f√ºr die ganze Familie.',
                        startDate: new Date(2025, 9, 18, 12, 0), // 18. Oktober 2025
                        endDate: new Date(2025, 9, 19, 22, 0),   // 19. Oktober 2025
                        location: 'Roter Schopf, Kaiseraugst',
                        category: 'Hauptveranstaltung',
                        organizer: 'Stefan M√ºller',
                        email: 'aktuar@fwv-raura.ch',
                        status: 'confirmed',
                        registrationRequired: true,
                        registrationDeadline: new Date(2025, 9, 4),
                        cost: 'Kostenlos',
                        tags: ['Chilbi', 'Familie', 'Essen', 'Tradition', 'Helfer'],
                        hasShifts: true,
                        arbeitsplanFile: 'events/chilbi-2025-assignments.md',
                        shifts: [
                            {
                                id: 'aufbau',
                                name: 'Aufbau',
                                date: '2025-10-16',
                                time: '17:00-20:00',
                                needed: 5,
                                description: 'Grundaufbau und Vorbereitung des Roten Schopfs'
                            },
                            // Samstag Schichten
                            {
                                id: 'samstag-bar-12-14',
                                name: 'Bar Samstag 12:00-14:00',
                                date: '2025-10-18',
                                time: '12:00-14:00',
                                needed: 2,
                                description: 'Bar - Getr√§nke ausgeben und zubereiten'
                            },
                            {
                                id: 'samstag-kueche-12-14',
                                name: 'K√ºche Samstag 12:00-14:00',
                                date: '2025-10-18',
                                time: '12:00-14:00',
                                needed: 2,
                                description: 'K√ºche - Essen zubereiten und ausgeben'
                            },
                            {
                                id: 'samstag-kasse-12-14',
                                name: 'Kasse Samstag 12:00-14:00',
                                date: '2025-10-18',
                                time: '12:00-14:00',
                                needed: 2,
                                description: 'Kasse - Geld kassieren und Bons ausgeben'
                            }
                            // ... weitere Schichten k√∂nnen hier hinzugef√ºgt werden
                        ]
                    },
                    // Weitere Events...
                    {
                        id: 'grillplausch-sommer-2024',
                        title: 'Grillplausch bei Edi Grossenbacher',
                        subtitle: 'Geselliger Sommerevent',
                        description: 'Hiermit l√§dt der Vorstand alle Mitglieder zum gem√ºtlichen Grillplausch bei Edi Grossenbacher ein.',
                        startDate: new Date(2024, 5, 17, 16, 0),
                        endDate: new Date(2024, 5, 17, 22, 0),
                        location: 'Kurzenbettli 23, 4302 Augst BL',
                        category: 'Gesellschaftsanlass',
                        organizer: 'Edi Grossenbacher',
                        email: 'aktuar@fwv-raura.ch',
                        status: 'past',
                        registrationRequired: true,
                        registrationDeadline: new Date(2024, 5, 12),
                        cost: 'Kostenlos',
                        tags: ['Grillen', 'Geselligkeit', 'Sommer', 'Familie'],
                        participantRegistration: true
                    }
                ];
            }

            async loadArbeitsplanData() {
                for (const event of this.events) {
                    if (event.hasShifts && event.arbeitsplanFile) {
                        try {
                            console.log(`Lade Arbeitsplan: ${event.arbeitsplanFile}`);
                            // In einer echten Implementierung w√ºrde hier die Markdown-Datei geladen
                            // F√ºr Demo-Zwecke erstellen wir Mock-Daten
                            this.arbeitsplanData[event.id] = {
                                assignments: {},
                                lastUpdated: new Date(),
                                totalShifts: event.shifts?.length || 0,
                                filledShifts: 0
                            };
                        } catch (error) {
                            console.warn(`Konnte Arbeitsplan f√ºr ${event.id} nicht laden:`, error);
                        }
                    }
                }
            }

            setupEventListeners() {
                // Filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.currentFilter = e.target.dataset.filter;
                        this.updateFilterButtons();
                        this.filterEvents();
                        this.renderEvents();
                    });
                });

                // Modal controls
                document.getElementById('close-modal').addEventListener('click', () => this.closeModal());
                document.getElementById('close-modal-btn').addEventListener('click', () => this.closeModal());
                document.getElementById('download-event-ics').addEventListener('click', () => this.downloadEventICS());
                document.getElementById('share-event').addEventListener('click', () => this.shareEvent());
                
                // Registration
                document.getElementById('send-registration-email').addEventListener('click', () => this.sendRegistrationEmail());
                
                // Shift planning
                document.getElementById('view-arbeitsplan').addEventListener('click', () => this.showArbeitsplanModal());
                document.getElementById('download-arbeitsplan-pdf').addEventListener('click', () => this.generateArbeitsplanPDF());
                document.getElementById('download-arbeitsplan-pdf-2').addEventListener('click', () => this.generateArbeitsplanPDF());
                
                // Arbeitsplan modal
                document.getElementById('close-arbeitsplan-modal').addEventListener('click', () => this.closeArbeitsplanModal());
                document.getElementById('close-arbeitsplan-modal-btn').addEventListener('click', () => this.closeArbeitsplanModal());
                document.getElementById('edit-arbeitsplan').addEventListener('click', () => this.editArbeitsplan());
                
                document.getElementById('event-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'event-modal') this.closeModal();
                });
                
                document.getElementById('arbeitsplan-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'arbeitsplan-modal') this.closeArbeitsplanModal();
                });
            }

            updateFilterButtons() {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    const isActive = btn.dataset.filter === this.currentFilter;
                    btn.className = isActive 
                        ? 'filter-btn active bg-white text-fire-700 px-6 py-3 rounded-lg font-semibold hover:bg-fire-50 transition-colors'
                        : 'filter-btn border-2 border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-white hover:text-fire-700 transition-colors';
                });
            }

            filterEvents() {
                const now = new Date();
                let filtered = [...this.events];

                // Time filter
                if (this.currentFilter === 'upcoming') {
                    filtered = filtered.filter(event => event.startDate > now);
                } else if (this.currentFilter === 'past') {
                    filtered = filtered.filter(event => event.endDate < now);
                }

                // Sort by date
                filtered.sort((a, b) => {
                    if (this.currentFilter === 'past') {
                        return b.startDate - a.startDate;
                    }
                    return a.startDate - b.startDate;
                });

                this.filteredEvents = filtered;
            }

            renderEvents() {
                const container = document.getElementById('events-container');
                const noEventsMsg = document.getElementById('no-events');

                if (this.filteredEvents.length === 0) {
                    container.innerHTML = '';
                    noEventsMsg.classList.remove('hidden');
                    return;
                }

                noEventsMsg.classList.add('hidden');
                container.className = 'space-y-6';
                container.innerHTML = this.filteredEvents.map(event => this.createEventListItem(event)).join('');

                // Add click listeners
                container.querySelectorAll('[data-event-id]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const eventId = e.currentTarget.dataset.eventId;
                        this.showEventModal(eventId);
                    });
                });
            }

            createEventListItem(event) {
                const isPast = event.endDate < new Date();
                const statusBadge = this.getStatusBadge(event);
                const registrationBadge = this.getRegistrationBadge(event);
                const shiftBadge = this.getShiftBadge(event);
                
                return `
                    <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer overflow-hidden ${isPast ? 'opacity-75' : ''}" 
                         data-event-id="${event.id}">
                        <div class="p-6">
                            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
                                <div class="flex-1">
                                    <div class="flex items-start justify-between mb-3">
                                        <div>
                                            <h3 class="text-xl font-bold text-gray-800 mb-1">${event.title}</h3>
                                            <p class="text-fire-600 font-medium">${event.subtitle}</p>
                                        </div>
                                        <div class="flex flex-wrap gap-2">
                                            ${statusBadge}
                                            ${registrationBadge}
                                            ${shiftBadge}
                                        </div>
                                    </div>
                                    
                                    <div class="prose prose-sm max-w-none mb-4 text-gray-600">
                                        ${this.truncateText(event.description, 200)}
                                    </div>
                                    
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-gray-500 mb-4">
                                        <div class="space-y-2">
                                            <div class="flex items-center">
                                                <span class="mr-2">üìÖ</span>
                                                <span>${this.formatDate(event.startDate)}</span>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="mr-2">‚è∞</span>
                                                <span>${this.formatTime(event.startDate)} - ${this.formatTime(event.endDate)}</span>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex items-center">
                                                <span class="mr-2">üìç</span>
                                                <span>${event.location}</span>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="mr-2">üë§</span>
                                                <span>${event.organizer}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex flex-wrap gap-2">
                                        ${event.tags.map(tag => `
                                            <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs">
                                                ${tag}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="mt-4 lg:mt-0 lg:ml-6 flex-shrink-0">
                                    <span class="inline-block px-3 py-1 bg-fire-100 text-fire-800 rounded-full text-sm font-medium">
                                        ${event.category}
                                    </span>
                                    ${event.cost !== 'Kostenlos' ? `
                                        <div class="mt-2 text-lg font-bold text-fire-600">
                                            ${event.cost}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getStatusBadge(event) {
                const now = new Date();
                
                if (event.endDate < now) {
                    return '<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium">Vergangen</span>';
                } else if (event.startDate <= now && event.endDate >= now) {
                    return '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium animate-pulse">L√§uft</span>';
                } else if (event.registrationRequired && event.registrationDeadline && event.registrationDeadline < now) {
                    return '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">Anmeldung geschlossen</span>';
                } else {
                    return '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">Geplant</span>';
                }
            }

            getRegistrationBadge(event) {
                if (!event.registrationRequired) return '';
                
                const now = new Date();
                if (event.registrationDeadline && event.registrationDeadline < now) return '';
                if (event.endDate < now) return '';
                
                if (event.shifts && event.shifts.length > 0) {
                    return '<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-medium">üë∑ Helfer gesucht</span>';
                } else if (event.participantRegistration) {
                    return '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">üìß Anmeldung m√∂glich</span>';
                }
                
                return '';
            }

            getShiftBadge(event) {
                if (!event.hasShifts || !event.shifts) return '';
                
                const arbeitsplan = this.arbeitsplanData[event.id];
                if (!arbeitsplan) return '';
                
                const totalShifts = arbeitsplan.totalShifts;
                const filledShifts = arbeitsplan.filledShifts;
                const percentage = totalShifts > 0 ? Math.round((filledShifts / totalShifts) * 100) : 0;
                
                let badgeClass = 'bg-red-100 text-red-800';
                if (percentage >= 80) badgeClass = 'bg-green-100 text-green-800';
                else if (percentage >= 50) badgeClass = 'bg-yellow-100 text-yellow-800';
                
                return `<span class="px-2 py-1 ${badgeClass} rounded-full text-xs font-medium">üìã ${percentage}% besetzt</span>`;
            }

            showEventModal(eventId) {
                const event = this.events.find(e => e.id === eventId);
                if (!event) return;

                this.selectedEvent = event;
                this.selectedShifts = [];
                
                document.getElementById('modal-title').textContent = event.title;
                document.getElementById('modal-meta').innerHTML = `
                    <span>üìÖ ${this.formatDate(event.startDate)}</span>
                    <span>‚è∞ ${this.formatTime(event.startDate)} - ${this.formatTime(event.endDate)}</span>
                    <span>üìç ${event.location}</span>
                    <span>üë§ ${event.organizer}</span>
                `;

                document.getElementById('modal-content').innerHTML = `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">${event.subtitle}</h3>
                        <div class="prose max-w-none">
                            ${this.parseMarkdown(event.description)}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-800">Veranstaltungsdetails</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Kategorie:</span>
                                    <span class="px-2 py-1 bg-fire-100 text-fire-800 rounded text-xs">${event.category}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Kosten:</span>
                                    <span class="font-medium">${event.cost}</span>
                                </div>
                                ${event.registrationRequired ? `
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Anmeldung:</span>
                                        <span class="text-fire-600">Erforderlich</span>
                                    </div>
                                ` : ''}
                                ${event.registrationDeadline ? `
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Anmeldeschluss:</span>
                                        <span>${this.formatDate(event.registrationDeadline)}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-800">Kontakt</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Organisator:</span>
                                    <span class="font-medium">${event.organizer}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">E-Mail:</span>
                                    <a href="mailto:${event.email}" class="text-fire-600 hover:text-fire-700">${event.email}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${event.tags.length > 0 ? `
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 mb-2">Tags</h4>
                            <div class="flex flex-wrap gap-2">
                                ${event.tags.map(tag => `
                                    <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">
                                        ${tag}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;

                // Show shift planning section if applicable
                this.setupShiftPlanningSection(event);
                
                // Show registration section if applicable
                this.setupRegistrationSection(event);
                
                document.getElementById('event-modal').classList.remove('hidden');
            }

            setupShiftPlanningSection(event) {
                const shiftPlanningSection = document.getElementById('shift-planning-section');
                
                if (!event.hasShifts || !event.shifts) {
                    shiftPlanningSection.classList.add('hidden');
                    return;
                }
                
                shiftPlanningSection.classList.remove('hidden');
                
                // Setup shift overview
                const arbeitsplan = this.arbeitsplanData[event.id] || { 
                    totalShifts: event.shifts.length, 
                    filledShifts: 0 
                };
                
                const shiftOverview = document.getElementById('shift-overview');
                shiftOverview.innerHTML = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-600">${arbeitsplan.totalShifts}</div>
                        <div class="text-sm text-blue-800">Schichten gesamt</div>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-green-600">${arbeitsplan.filledShifts}</div>
                        <div class="text-sm text-green-800">Besetzt</div>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-red-600">${arbeitsplan.totalShifts - arbeitsplan.filledShifts}</div>
                        <div class="text-sm text-red-800">Offen</div>
                    </div>
                `;
                
                // Show critical shifts if any
                const criticalShifts = event.shifts.filter(shift => {
                    const assignments = arbeitsplan.assignments[shift.id] || [];
                    return assignments.length === 0;
                });
                
                const criticalShiftsDiv = document.getElementById('critical-shifts');
                if (criticalShifts.length > 0) {
                    criticalShiftsDiv.classList.remove('hidden');
                    document.getElementById('critical-shifts-list').innerHTML = 
                        criticalShifts.map(shift => `‚Ä¢ ${shift.name} (${shift.date}, ${shift.time})`).join('<br>');
                } else {
                    criticalShiftsDiv.classList.add('hidden');
                }
            }

            setupRegistrationSection(event) {
                const registrationSection = document.getElementById('registration-section');
                const shiftSelection = document.getElementById('shift-selection');
                const participantsSection = document.getElementById('participants-section');

                // Check if registration is possible
                const now = new Date();
                const canRegister = event.registrationRequired && 
                    (!event.registrationDeadline || event.registrationDeadline > now) &&
                    event.endDate > now;

                if (!canRegister) {
                    registrationSection.classList.add('hidden');
                    return;
                }

                registrationSection.classList.remove('hidden');

                // Setup shifts if available
                if (event.shifts && event.shifts.length > 0) {
                    shiftSelection.classList.remove('hidden');
                    participantsSection.classList.add('hidden');
                    
                    const shiftsContainer = document.getElementById('shifts-container');
                    shiftsContainer.innerHTML = event.shifts.map(shift => `
                        <label class="flex items-start space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <input type="checkbox" value="${shift.id}" class="shift-checkbox mt-1 text-fire-500 focus:ring-fire-500" onchange="window.eventsManager.toggleShift('${shift.id}')">
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium text-gray-800">${shift.name}</p>
                                        <p class="text-sm text-gray-600">${shift.date} ‚Ä¢ ${shift.time}</p>
                                        <p class="text-xs text-gray-500">${shift.description}</p>
                                    </div>
                                    <span class="text-xs bg-fire-100 text-fire-800 px-2 py-1 rounded-full">
                                        ${shift.needed} ben√∂tigt
                                    </span>
                                </div>
                            </div>
                        </label>
                    `).join('');
                } else if (event.participantRegistration) {
                    shiftSelection.classList.add('hidden');
                    participantsSection.classList.remove('hidden');
                } else {
                    shiftSelection.classList.add('hidden');
                    participantsSection.classList.add('hidden');
                }

                // Make eventsManager globally accessible for checkbox events
                window.eventsManager = this;
            }

            showArbeitsplanModal() {
                if (!this.selectedEvent || !this.selectedEvent.hasShifts) return;
                
                const event = this.selectedEvent;
                const arbeitsplan = this.arbeitsplanData[event.id];
                
                document.getElementById('arbeitsplan-title').textContent = `Arbeitsplan ${event.title}`;
                document.getElementById('arbeitsplan-status').textContent = 
                    `Stand: ${new Date().toLocaleDateString('de-DE')} ‚Ä¢ ${arbeitsplan?.filledShifts || 0} von ${arbeitsplan?.totalShifts || 0} Schichten besetzt`;
                
                // Generate arbeitsplan content
                const content = this.generateArbeitsplanHTML(event);
                document.getElementById('arbeitsplan-content').innerHTML = content;
                
                document.getElementById('arbeitsplan-modal').classList.remove('hidden');
            }

            generateArbeitsplanHTML(event) {
                const arbeitsplan = this.arbeitsplanData[event.id] || { assignments: {} };
                
                let html = `
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üìä √úbersicht</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-blue-600">${event.shifts?.length || 0}</div>
                                <div class="text-sm text-blue-800">Schichten gesamt</div>
                            </div>
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-green-600">${arbeitsplan.filledShifts || 0}</div>
                                <div class="text-sm text-green-800">Besetzt</div>
                            </div>
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-red-600">${(event.shifts?.length || 0) - (arbeitsplan.filledShifts || 0)}</div>
                                <div class="text-sm text-red-800">Offen</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Group shifts by date and type
                const shiftsByDate = {};
                if (event.shifts) {
                    event.shifts.forEach(shift => {
                        if (!shiftsByDate[shift.date]) {
                            shiftsByDate[shift.date] = {};
                        }
                        
                        // Extract time and type from shift name
                        const timeMatch = shift.time.match(/(\d+:\d+)-(\d+:\d+|Open End)/);
                        const time = timeMatch ? timeMatch[0] : shift.time;
                        
                        if (!shiftsByDate[shift.date][time]) {
                            shiftsByDate[shift.date][time] = {};
                        }
                        
                        // Determine shift type (Bar, K√ºche, Kasse, etc.)
                        let type = 'Sonstige';
                        if (shift.name.toLowerCase().includes('bar')) type = 'Bar';
                        else if (shift.name.toLowerCase().includes('k√ºche')) type = 'K√ºche';
                        else if (shift.name.toLowerCase().includes('kasse')) type = 'Kasse';
                        else if (shift.name.toLowerCase().includes('aufbau')) type = 'Aufbau';
                        else if (shift.name.toLowerCase().includes('abbau')) type = 'Abbau';
                        
                        shiftsByDate[shift.date][time][type] = {
                            shift: shift,
                            assignments: arbeitsplan.assignments[shift.id] || []
                        };
                    });
                }
                
                // Generate HTML for each date
                Object.keys(shiftsByDate).sort().forEach(date => {
                    const dateObj = new Date(date);
                    const dayName = dateObj.toLocaleDateString('de-DE', { weekday: 'long' });
                    const formattedDate = dateObj.toLocaleDateString('de-DE');
                    
                    html += `
                        <div class="mb-8">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">${dayName}, ${formattedDate}</h3>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse border border-gray-300">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-4 py-2 text-left">Zeit</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">K√ºche</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">Bar</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left">Service / Kasse</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                Object.keys(shiftsByDate[date]).sort().forEach(time => {
                    const timeShifts = shiftsByDate[date][time];
                    
                    html += `
                        <tr>
                            <td class="border border-gray-300 px-4 py-2 font-medium">${time}</td>
                            <td class="border border-gray-300 px-4 py-2">
                                ${this.formatShiftAssignments(timeShifts['K√ºche'])}
                            </td>
                            <td class="border border-gray-300 px-4 py-2">
                                ${this.formatShiftAssignments(timeShifts['Bar'])}
                            </td>
                            <td class="border border-gray-300 px-4 py-2">
                                ${this.formatShiftAssignments(timeShifts['Kasse'])}
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                `;
                });
                
                return html;
            }

            formatShiftAssignments(shiftData) {
                if (!shiftData) return '-';
                
                const assignments = shiftData.assignments || [];
                const needed = shiftData.shift.needed;
                
                let html = '';
                
                // Show assigned people
                assignments.forEach(person => {
                    html += `<div class="text-green-600">‚úÖ ${person}</div>`;
                });
                
                // Show open positions
                const openPositions = needed - assignments.length;
                for (let i = 0; i < openPositions; i++) {
                    html += `<div class="text-red-600">‚ùå Offen</div>`;
                }
                
                if (html === '') {
                    html = `<div class="text-red-600">‚ùå ${needed} Helfer gesucht</div>`;
                }
                
                return html;
            }

            async generateArbeitsplanPDF() {
                if (!this.selectedEvent || !this.selectedEvent.hasShifts) return;
                
                const event = this.selectedEvent;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                try {
                    // Try to load and add logo
                    await this.addLogoToPDF(doc);
                } catch (error) {
                    console.warn('Logo konnte nicht geladen werden:', error);
                }
                
                // Header with logo space
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Feuerwehrverein Raura, Kaiseraugst', 60, 25);
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text(`Arbeitsplan ${event.title}`, 60, 35);
                
                // Date and event info
                doc.setFontSize(10);
                doc.text(`Datum: ${event.startDate.toLocaleDateString('de-DE')} - ${event.endDate.toLocaleDateString('de-DE')}`, 60, 45);
                doc.text(`Ort: ${event.location}`, 60, 52);
                doc.text(`Erstellt: ${new Date().toLocaleDateString('de-DE')} ${new Date().toLocaleTimeString('de-DE')}`, 60, 59);
                
                let yPos = 75;
                
                // Aufbau section
                const aufbauShifts = event.shifts.filter(s => s.name.toLowerCase().includes('aufbau'));
                if (aufbauShifts.length > 0) {
                    yPos = this.addAufbauSection(doc, aufbauShifts, event, yPos);
                }
                
                // Daily shift tables - proper table format
                const dates = [...new Set(event.shifts.map(s => s.date))].sort();
                
                dates.forEach(date => {
                    const dateObj = new Date(date);
                    const dayName = dateObj.toLocaleDateString('de-DE', { weekday: 'long' });
                    const formattedDate = dateObj.toLocaleDateString('de-DE');
                    
                    // Skip if this is Aufbau or Abbau day
                    const dayShifts = event.shifts.filter(s => s.date === date && 
                        !s.name.toLowerCase().includes('aufbau') && 
                        !s.name.toLowerCase().includes('abbau'));
                    
                    if (dayShifts.length === 0) return;
                    
                    // Check if we need a new page
                    if (yPos > 200) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    yPos = this.addDayShiftTable(doc, dayShifts, event, dayName, formattedDate, yPos);
                });
                
                // Abbau section
                const abbauShifts = event.shifts.filter(s => s.name.toLowerCase().includes('abbau'));
                if (abbauShifts.length > 0) {
                    yPos = this.addAbbauSection(doc, abbauShifts, event, yPos);
                }
                
                // Save PDF
                doc.save(`Arbeitsplan_${event.title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
            }

            async addLogoToPDF(doc) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = () => {
                        try {
                            // Create canvas to convert image
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // Set canvas size
                            canvas.width = img.width;
                            canvas.height = img.height;
                            
                            // Draw image on canvas
                            ctx.drawImage(img, 0, 0);
                            
                            // Get image data
                            const dataURL = canvas.toDataURL('image/png');
                            
                            // Add to PDF (top left, 40x40mm size)
                            doc.addImage(dataURL, 'PNG', 10, 10, 40, 40);
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    img.onerror = () => reject(new Error('Logo could not be loaded'));
                    
                    // Try to load logo
                    img.src = 'images/logo.png';
                    
                    // Fallback timeout
                    setTimeout(() => reject(new Error('Logo loading timeout')), 3000);
                });
            }

            addAufbauSection(doc, aufbauShifts, event, yPos) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Aufbau', 20, yPos);
                yPos += 8;
                
                aufbauShifts.forEach(shift => {
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    doc.text(`${shift.date} ab ${shift.time} (${shift.needed} Personen ben√∂tigt)`, 20, yPos);
                    yPos += 6;
                    
                    const assignments = this.arbeitsplanData[event.id]?.assignments[shift.id] || [];
                    
                    // Create table for Aufbau
                    const tableData = [];
                    
                    // Add assigned people
                    assignments.forEach(person => {
                        tableData.push([person]);
                    });
                    
                    // Add open positions
                    const openPositions = shift.needed - assignments.length;
                    for (let i = 0; i < openPositions; i++) {
                        tableData.push(['[OFFEN]']);
                    }
                    
                    // Draw simple table
                    const startY = yPos;
                    tableData.forEach((row, index) => {
                        doc.rect(25, yPos, 60, 6);
                        doc.text(`- ${row[0]}`, 27, yPos + 4);
                        yPos += 6;
                    });
                });
                
                return yPos + 10;
            }

            addDayShiftTable(doc, dayShifts, event, dayName, formattedDate, yPos) {
                // Title
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`${dayName}, ${formattedDate}`, 20, yPos);
                yPos += 10;
                
                // Table setup
                const tableStartX = 20;
                const tableWidth = 170;
                const colWidths = [30, 46, 46, 48]; // Zeit, K√ºche, Bar, Service/Kasse
                const rowHeight = 8;
                
                // Table header
                doc.setFillColor(240, 240, 240); // Light gray background
                doc.rect(tableStartX, yPos, tableWidth, rowHeight, 'F');
                
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                
                let currentX = tableStartX;
                const headers = ['Zeit', 'K√ºche', 'Bar', 'Service / Kasse'];
                headers.forEach((header, index) => {
                    doc.rect(currentX, yPos, colWidths[index], rowHeight);
                    doc.text(header, currentX + 2, yPos + 5.5);
                    currentX += colWidths[index];
                });
                
                yPos += rowHeight;
                
                // Group shifts by time
                const timeGroups = {};
                dayShifts.forEach(shift => {
                    if (!timeGroups[shift.time]) {
                        timeGroups[shift.time] = { k√ºche: [], bar: [], kasse: [] };
                    }
                    
                    const assignments = this.arbeitsplanData[event.id]?.assignments[shift.id] || [];
                    
                    if (shift.name.toLowerCase().includes('k√ºche')) {
                        timeGroups[shift.time].k√ºche = assignments;
                    } else if (shift.name.toLowerCase().includes('bar')) {
                        timeGroups[shift.time].bar = assignments;
                    } else if (shift.name.toLowerCase().includes('kasse')) {
                        timeGroups[shift.time].kasse = assignments;
                    }
                });
                
                // Table rows
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                
                Object.keys(timeGroups).sort().forEach(time => {
                    const group = timeGroups[time];
                    
                    // Calculate row height based on content
                    const maxItems = Math.max(
                        group.k√ºche.length || 1,
                        group.bar.length || 1,
                        group.kasse.length || 1
                    );
                    const dynamicRowHeight = Math.max(rowHeight, maxItems * 4 + 4);
                    
                    currentX = tableStartX;
                    
                    // Draw cells and borders
                    headers.forEach((header, index) => {
                        doc.rect(currentX, yPos, colWidths[index], dynamicRowHeight);
                        currentX += colWidths[index];
                    });
                    
                    // Fill content
                    currentX = tableStartX;
                    
                    // Zeit
                    doc.text(time, currentX + 2, yPos + 5.5);
                    currentX += colWidths[0];
                    
                    // K√ºche
                    if (group.k√ºche.length > 0) {
                        group.k√ºche.forEach((person, index) => {
                            doc.text(`- ${person}`, currentX + 2, yPos + 5.5 + (index * 4));
                        });
                    } else {
                        doc.text('-', currentX + 2, yPos + 5.5);
                    }
                    currentX += colWidths[1];
                    
                    // Bar
                    if (group.bar.length > 0) {
                        group.bar.forEach((person, index) => {
                            doc.text(`- ${person}`, currentX + 2, yPos + 5.5 + (index * 4));
                        });
                    } else {
                        doc.text('-', currentX + 2, yPos + 5.5);
                    }
                    currentX += colWidths[2];
                    
                    // Service/Kasse
                    if (group.kasse.length > 0) {
                        group.kasse.forEach((person, index) => {
                            doc.text(`- ${person}`, currentX + 2, yPos + 5.5 + (index * 4));
                        });
                    } else {
                        doc.text('-', currentX + 2, yPos + 5.5);
                    }
                    
                    yPos += dynamicRowHeight;
                });
                
                return yPos + 15;
            }

            addAbbauSection(doc, abbauShifts, event, yPos) {
                // Check if we need a new page
                if (yPos > 230) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Abbau', 20, yPos);
                yPos += 8;
                
                abbauShifts.forEach(shift => {
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    doc.text(`${shift.date} ab ${shift.time} (${shift.needed} Personen ben√∂tigt)`, 20, yPos);
                    yPos += 6;
                    
                    const assignments = this.arbeitsplanData[event.id]?.assignments[shift.id] || [];
                    
                    // Create table for Abbau
                    const tableData = [];
                    
                    // Add assigned people
                    assignments.forEach(person => {
                        tableData.push([person]);
                    });
                    
                    // Add open positions
                    const openPositions = shift.needed - assignments.length;
                    for (let i = 0; i < openPositions; i++) {
                        tableData.push(['[OFFEN]']);
                    }
                    
                    // Draw simple table
                    tableData.forEach((row, index) => {
                        doc.rect(25, yPos, 60, 6);
                        doc.text(`- ${row[0]}`, 27, yPos + 4);
                        yPos += 6;
                    });
                });
                
                return yPos + 10;
            }

            closeArbeitsplanModal() {
                document.getElementById('arbeitsplan-modal').classList.add('hidden');
            }

            editArbeitsplan() {
                const event = this.selectedEvent;
                if (!event || !event.arbeitsplanFile) return;
                
                alert(`Um den Arbeitsplan zu bearbeiten, √∂ffnen Sie die Datei:\n\n${event.arbeitsplanFile}\n\nTragen Sie die Helfer manuell in die entsprechenden Schichten ein und speichern Sie die Datei.`);
            }

            toggleShift(shiftId) {
                const index = this.selectedShifts.indexOf(shiftId);
                if (index > -1) {
                    this.selectedShifts.splice(index, 1);
                } else {
                    this.selectedShifts.push(shiftId);
                }
            }

            sendRegistrationEmail() {
                const event = this.selectedEvent;
                if (!event) return;

                // Get form data
                const name = document.getElementById('reg-name').value.trim();
                const email = document.getElementById('reg-email').value.trim();
                const phone = document.getElementById('reg-phone').value.trim();
                const notes = document.getElementById('reg-notes').value.trim();

                // Validation
                if (!name || !email) {
                    alert('Bitte f√ºllen Sie mindestens Name und E-Mail aus.');
                    return;
                }

                // Build email content
                let subject, body;

                if (event.shifts && event.shifts.length > 0 && this.selectedShifts.length > 0) {
                    // Helper registration with shifts
                    subject = `Helfer-Anmeldung: ${event.title}`;
                    
                    const selectedShiftDetails = event.shifts
                        .filter(shift => this.selectedShifts.includes(shift.id))
                        .map(shift => `‚Ä¢ ${shift.name} (${shift.date}, ${shift.time}) - ${shift.description}`)
                        .join('\n');

                    body = `Hallo ${event.organizer},

hiermit melde ich mich als Helfer f√ºr folgende Schichten an:

VERANSTALTUNG: ${event.title}
DATUM: ${this.formatDate(event.startDate)}
ORT: ${event.location}

GEW√ÑHLTE SCHICHTEN:
${selectedShiftDetails}

MEINE KONTAKTDATEN:
Name: ${name}
E-Mail: ${email}
${phone ? `Telefon: ${phone}` : ''}

${notes ? `BEMERKUNGEN:\n${notes}` : ''}

Vielen Dank f√ºr die Organisation!

Mit freundlichen Gr√ºssen
${name}`;

                } else if (event.participantRegistration) {
                    // Participant registration
                    const participants = document.getElementById('reg-participants').value || '1';
                    subject = `Anmeldung: ${event.title}`;
                    
                    body = `Hallo ${event.organizer},

hiermit melde ich mich f√ºr die Veranstaltung an:

VERANSTALTUNG: ${event.title}
DATUM: ${this.formatDate(event.startDate)}
ZEIT: ${this.formatTime(event.startDate)} - ${this.formatTime(event.endDate)}
ORT: ${event.location}
${event.cost !== 'Kostenlos' ? `KOSTEN: ${event.cost}` : ''}

ANMELDUNG:
Name: ${name}
E-Mail: ${email}
${phone ? `Telefon: ${phone}` : ''}
${event.participantRegistration && participants !== '1' ? `Anzahl Personen: ${participants}` : ''}

${notes ? `BEMERKUNGEN:\n${notes}` : ''}

Vielen Dank f√ºr die Organisation!

Mit freundlichen Gr√ºssen
${name}`;

                } else {
                    // General registration
                    subject = `Anmeldung: ${event.title}`;
                    body = `Hallo ${event.organizer},

hiermit melde ich mich f√ºr die Veranstaltung an:

VERANSTALTUNG: ${event.title}
DATUM: ${this.formatDate(event.startDate)}

KONTAKTDATEN:
Name: ${name}
E-Mail: ${email}
${phone ? `Telefon: ${phone}` : ''}

${notes ? `BEMERKUNGEN:\n${notes}` : ''}

Mit freundlichen Gr√ºssen
${name}`;
                }

                // Create mailto link
                const mailtoLink = `mailto:${event.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                // Open email client
                window.location.href = mailtoLink;

                // Show success message
                setTimeout(() => {
                    alert('E-Mail-Client wurde ge√∂ffnet. Bitte senden Sie die E-Mail ab.');
                }, 500);
            }

            closeModal() {
                document.getElementById('event-modal').classList.add('hidden');
                this.selectedEvent = null;
                this.selectedShifts = [];
                
                // Reset form
                document.getElementById('reg-name').value = '';
                document.getElementById('reg-email').value = '';
                document.getElementById('reg-phone').value = '';
                document.getElementById('reg-notes').value = '';
                
                // Uncheck all shift checkboxes
                document.querySelectorAll('.shift-checkbox').forEach(cb => cb.checked = false);
            }

            downloadEventICS() {
                if (!this.selectedEvent) return;
                const icsData = this.generateICS([this.selectedEvent]);
                this.downloadICS(icsData, `${this.selectedEvent.id}.ics`);
            }

            shareEvent() {
                if (!this.selectedEvent) return;
                
                const url = `${window.location.origin}${window.location.pathname}#event-${this.selectedEvent.id}`;
                const text = `${this.selectedEvent.title} - ${this.formatDate(this.selectedEvent.startDate)}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: this.selectedEvent.title,
                        text: text,
                        url: url
                    });
                } else {
                    navigator.clipboard.writeText(`${text}\n${url}`).then(() => {
                        alert('Link wurde in die Zwischenablage kopiert!');
                    });
                }
            }

            generateICS(events) {
                const now = new Date();
                let ics = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'PRODID:-//Feuerwehrverein Raura Kaiseraugst//Vereinskalender//DE',
                    'CALSCALE:GREGORIAN',
                    'METHOD:PUBLISH',
                    'X-WR-CALNAME:Feuerwehrverein Raura Kaiseraugst',
                    'X-WR-CALDESC:Termine und Veranstaltungen des Feuerwehrvereins Raura Kaiseraugst',
                    'X-WR-TIMEZONE:Europe/Zurich'
                ];

                events.forEach(event => {
                    const uid = `${event.id}@feuerwehrverein-raura.ch`;
                    const dtstart = this.formatDateForICS(event.startDate);
                    const dtend = this.formatDateForICS(event.endDate);
                    const dtstamp = this.formatDateForICS(now);
                    const description = event.description.replace(/\n/g, '\\n');

                    ics.push(
                        'BEGIN:VEVENT',
                        `UID:${uid}`,
                        `DTSTAMP:${dtstamp}`,
                        `DTSTART:${dtstart}`,
                        `DTEND:${dtend}`,
                        `SUMMARY:${event.title}`,
                        `DESCRIPTION:${description}`,
                        `LOCATION:${event.location}`,
                        `ORGANIZER;CN=${event.organizer}:mailto:${event.email}`,
                        `CATEGORIES:${event.category}`,
                        'STATUS:CONFIRMED',
                        'END:VEVENT'
                    );
                });

                ics.push('END:VCALENDAR');
                return ics.join('\r\n');
            }

            downloadICS(icsData, filename) {
                const blob = new Blob([icsData], { type: 'text/calendar;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }

            parseMarkdown(text) {
                return text
                    .replace(/\n\n/g, '</p><p class="mb-3">')
                    .replace(/\n- /g, '</p><li class="ml-4">‚Ä¢ ')
                    .replace(/\n/g, '<br>')
                    .replace(/^(.+)$/gm, '<p class="mb-3">$1</p>')
                    .replace(/(<li.*<\/li>)/gs, '<ul class="mb-3 list-none">$1</ul>')
                    .replace(/<p class="mb-3"><\/p>/g, '');
            }

            truncateText(text, maxLength) {
                const plainText = text.replace(/\n/g, ' ').trim();
                if (plainText.length <= maxLength) return plainText;
                return plainText.substring(0, maxLength) + '...';
            }

            formatDate(date) {
                return new Intl.DateTimeFormat('de-DE', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                }).format(date);
            }

            formatTime(date) {
                return new Intl.DateTimeFormat('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            }

            formatDateForICS(date) {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            }
        }

        // Initialize events manager when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new EventsManager();
        });
    </script>
</body>
</html>
