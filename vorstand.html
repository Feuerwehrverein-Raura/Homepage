<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vorstand - Mitgliederverwaltung | FWV Raura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fire: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="font-sans bg-gray-50">
    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gradient-to-br from-fire-600 to-fire-800 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-8 shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-20 h-20 rounded-full overflow-hidden bg-fire-100 p-2 mx-auto mb-4">
                    <img src="images/logo.png" alt="Logo" class="w-full h-full object-contain">
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Vorstand Login</h2>
                <p class="text-gray-600 text-sm mt-2">Melden Sie sich mit Ihrer Vorstand E-Mail an</p>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">E-Mail</label>
                    <input type="email" id="login-email" required
                        placeholder="vorstand@fwv-raura.ch"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500 focus:border-fire-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Passwort</label>
                    <input type="password" id="login-password" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500 focus:border-fire-500">
                </div>
                <div id="login-error" class="hidden text-red-600 text-sm text-center"></div>
                <button type="submit" id="login-btn"
                    class="w-full bg-fire-600 text-white py-3 rounded-lg font-semibold hover:bg-fire-700 transition-colors">
                    Anmelden
                </button>
            </form>

            <p class="text-center text-gray-500 text-xs mt-6">
                Nur autorisierte Vorstandsmitglieder haben Zugang
            </p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-fire-700 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full overflow-hidden bg-white p-1">
                        <img src="images/logo.png" alt="Logo" class="w-full h-full object-contain">
                    </div>
                    <div>
                        <span class="text-xl font-bold">FWV Raura</span>
                        <p class="text-fire-200 text-sm">Vorstand-Portal</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <span id="user-info" class="text-fire-200 text-sm"></span>
                    <a href="index.html" class="hover:text-fire-200 transition-colors">Website</a>
                    <a href="events.html" class="hover:text-fire-200 transition-colors">Veranstaltungen</a>
                    <button id="logout-btn" class="hover:text-fire-200 transition-colors">Abmelden</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Tabs -->
    <section class="bg-white border-b">
        <div class="container mx-auto px-4">
            <div class="flex space-x-8 border-b">
                <button id="tab-members" class="tab-btn py-4 px-2 font-semibold border-b-2 border-fire-500 text-fire-600">
                    Mitglieder
                </button>
                <button id="tab-events" class="tab-btn py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                    Veranstaltungen
                </button>
                <button id="tab-audit" class="tab-btn py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                    Audit-Log
                </button>
            </div>
        </div>
    </section>

    <!-- Members Section -->
    <div id="members-section">
        <!-- Header -->
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Mitgliederverwaltung</h1>
                        <p class="text-gray-600 mt-1">Mitglieder verwalten und Statistiken einsehen</p>
                    </div>
                    <button id="add-member-btn" class="bg-fire-500 text-white px-6 py-2 rounded-lg hover:bg-fire-600 transition-colors flex items-center space-x-2">
                        <span>+</span>
                        <span>Neues Mitglied</span>
                    </button>
                </div>
            </div>
        </section>

    <!-- Statistics -->
    <section class="bg-white border-b">
        <div class="container mx-auto px-4 py-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-fire-50 p-4 rounded-lg">
                    <div class="text-fire-600 text-sm font-medium">Gesamt</div>
                    <div id="stat-total" class="text-3xl font-bold text-gray-800">-</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-green-600 text-sm font-medium">Aktivmitglieder</div>
                    <div id="stat-aktiv" class="text-3xl font-bold text-gray-800">-</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-blue-600 text-sm font-medium">Passivmitglieder</div>
                    <div id="stat-passiv" class="text-3xl font-bold text-gray-800">-</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <div class="text-yellow-600 text-sm font-medium">Ehrenmitglieder</div>
                    <div id="stat-ehren" class="text-3xl font-bold text-gray-800">-</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Filters and Search -->
    <section class="bg-white border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                <div class="flex items-center space-x-4">
                    <input type="text" id="search-input" placeholder="Suche nach Name oder E-Mail..."
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500 w-full md:w-80">
                    <select id="status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                        <option value="">Alle Status</option>
                        <option value="Aktivmitglied">Aktivmitglied</option>
                        <option value="Passivmitglied">Passivmitglied</option>
                        <option value="Ehrenmitglied">Ehrenmitglied</option>
                    </select>
                </div>
                <button id="export-btn" class="border border-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                    Export CSV
                </button>
            </div>
        </div>
    </section>

    <!-- Members Table -->
    <section class="py-8">
        <div class="container mx-auto px-4">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">E-Mail</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Telefon</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Funktion</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="members-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Members will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                <p class="mt-4 text-gray-600">Lade Mitglieder...</p>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="text-center py-12 hidden">
                <p class="text-gray-600">Keine Mitglieder gefunden.</p>
            </div>
        </div>
    </section>

    <!-- Member Modal -->
    <div id="member-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="modal-title" class="text-2xl font-bold text-gray-800">Mitglied bearbeiten</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>

                <form id="member-form" class="space-y-6">
                    <input type="hidden" id="member-id">

                    <!-- Persoenliche Daten -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Persoenliche Daten</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Anrede</label>
                                <select id="anrede" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    <option value="">-</option>
                                    <option value="Herr">Herr</option>
                                    <option value="Frau">Frau</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Geschlecht</label>
                                <select id="geschlecht" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    <option value="">-</option>
                                    <option value="M">Maennlich</option>
                                    <option value="W">Weiblich</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Vorname *</label>
                                <input type="text" id="vorname" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nachname *</label>
                                <input type="text" id="nachname" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Geburtstag</label>
                                <input type="date" id="geburtstag" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                        </div>
                    </div>

                    <!-- Adresse -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Adresse</h4>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Strasse</label>
                                <input type="text" id="strasse" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Adresszusatz</label>
                                <input type="text" id="adresszusatz" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">PLZ</label>
                                    <input type="text" id="plz" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ort</label>
                                    <input type="text" id="ort" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Kontakt -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Kontakt</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Telefon</label>
                                <input type="tel" id="telefon" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mobile</label>
                                <input type="tel" id="mobile" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">E-Mail</label>
                                <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                        </div>
                    </div>

                    <!-- Mitgliedschaft -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Mitgliedschaft</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    <option value="Aktivmitglied">Aktivmitglied</option>
                                    <option value="Passivmitglied">Passivmitglied</option>
                                    <option value="Ehrenmitglied">Ehrenmitglied</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Feuerwehr-Zugehoerigkeit</label>
                                <select id="feuerwehr-zugehoerigkeit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    <option value="keine">Keine</option>
                                    <option value="feuerwehr_raurica">Feuerwehr Raurica</option>
                                    <option value="externe_feuerwehr">Externe Feuerwehr</option>
                                    <option value="anderes">Anderes</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Funktion</label>
                                <input type="text" id="funktion" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Eintrittsdatum</label>
                                <input type="date" id="eintrittsdatum" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                        </div>
                    </div>

                    <!-- Zustellung -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Zustellung</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="zustellung-email" class="mr-2 rounded">
                                <span class="text-sm text-gray-700">E-Mail-Zustellung</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="zustellung-post" class="mr-2 rounded">
                                <span class="text-sm text-gray-700">Post-Zustellung</span>
                            </label>
                        </div>
                    </div>

                    <!-- Bemerkungen -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bemerkungen</label>
                        <textarea id="bemerkungen" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500"></textarea>
                    </div>

                    <!-- Buttons -->
                    <div class="flex justify-between pt-4 border-t">
                        <button type="button" id="delete-member-btn" class="text-red-600 hover:text-red-700 font-medium hidden">
                            Loeschen
                        </button>
                        <div class="flex space-x-3">
                            <button type="button" id="cancel-btn" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                Abbrechen
                            </button>
                            <button type="submit" class="px-6 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">
                                Speichern
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    </div> <!-- End Members Section -->

    <!-- Events Section -->
    <div id="events-section" class="hidden">
        <!-- Header -->
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Veranstaltungsverwaltung</h1>
                        <p class="text-gray-600 mt-1">Events und Schichten verwalten</p>
                    </div>
                    <button id="add-event-btn" class="bg-fire-500 text-white px-6 py-2 rounded-lg hover:bg-fire-600 transition-colors flex items-center space-x-2">
                        <span>+</span>
                        <span>Neues Event</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Events List -->
        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Titel</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Datum</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Kategorie</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Schichten</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="events-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Events will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div id="events-loading-state" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                    <p class="mt-4 text-gray-600">Lade Events...</p>
                </div>

                <!-- Empty State -->
                <div id="events-empty-state" class="text-center py-12 hidden">
                    <p class="text-gray-600">Keine Events gefunden.</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Audit Log Section -->
    <div id="audit-section" class="hidden">
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Audit-Log</h1>
                        <p class="text-gray-600 mt-1">Alle Aenderungen in der Mitgliederverwaltung</p>
                    </div>
                    <div class="flex space-x-4">
                        <select id="audit-action-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            <option value="">Alle Aktionen</option>
                            <option value="LOGIN_SUCCESS">Login erfolgreich</option>
                            <option value="LOGIN_FAILED">Login fehlgeschlagen</option>
                            <option value="MEMBER_CREATE">Mitglied erstellt</option>
                            <option value="MEMBER_UPDATE">Mitglied aktualisiert</option>
                            <option value="MEMBER_DELETE">Mitglied geloescht</option>
                            <option value="EVENT_CREATE">Event erstellt</option>
                            <option value="EVENT_UPDATE">Event aktualisiert</option>
                            <option value="EVENT_DELETE">Event geloescht</option>
                        </select>
                        <button id="refresh-audit-btn" class="border border-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-50">
                            Aktualisieren
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Zeitpunkt</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Aktion</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Benutzer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">IP-Adresse</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody id="audit-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Audit entries will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div id="audit-loading-state" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                    <p class="mt-4 text-gray-600">Lade Audit-Log...</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Event Modal (simplified) -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="event-modal-title" class="text-2xl font-bold text-gray-800">Event bearbeiten</h3>
                    <button id="close-event-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <form id="event-form" class="space-y-6">
                    <input type="hidden" id="event-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Basis-Informationen -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Titel *</label>
                            <input type="text" id="event-title" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Untertitel</label>
                            <input type="text" id="event-subtitle" placeholder="z.B. Roter Schopf" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Slug *</label>
                            <input type="text" id="event-slug" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kategorie</label>
                            <select id="event-category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                <option value="Jahresanlass">Jahresanlass</option>
                                <option value="Einsatz">Einsatz</option>
                                <option value="Uebung">Uebung</option>
                                <option value="Sonstiges">Sonstiges</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="event-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                <option value="planned">Geplant</option>
                                <option value="confirmed">Bestaetigt</option>
                                <option value="cancelled">Abgesagt</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Start-Datum *</label>
                            <input type="datetime-local" id="event-start-date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">End-Datum</label>
                            <input type="datetime-local" id="event-end-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ort</label>
                            <input type="text" id="event-location" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Beschreibung</label>
                            <textarea id="event-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500"></textarea>
                        </div>

                        <!-- Anmeldung -->
                        <div class="md:col-span-2 border-t pt-4 mt-2">
                            <h4 class="font-medium text-gray-800 mb-3">Anmeldung</h4>
                        </div>
                        <div>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="event-registration-required" class="rounded border-gray-300 text-fire-500 focus:ring-fire-500">
                                <span class="text-sm font-medium text-gray-700">Anmeldung erforderlich</span>
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Anmeldeschluss</label>
                            <input type="datetime-local" id="event-registration-deadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Max. Teilnehmer</label>
                            <input type="number" id="event-max-participants" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kosten</label>
                            <input type="text" id="event-cost" placeholder="z.B. CHF 20.- oder Kostenlos" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>

                        <!-- Schichten -->
                        <div class="md:col-span-2 border-t pt-4 mt-2">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-medium text-gray-800">Schichten</h4>
                                <button type="button" onclick="addShiftRow()" class="text-sm text-fire-600 hover:text-fire-800">+ Schicht hinzufuegen</button>
                            </div>
                            <div id="event-shifts-container" class="space-y-3">
                                <!-- Shifts will be added here dynamically -->
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Schichten werden bei Helfer-Events verwendet (z.B. Fasnacht)</p>
                        </div>
                    </div>
                    <div class="flex justify-between pt-4 border-t">
                        <button type="button" id="delete-event-btn" class="text-red-600 hover:text-red-700 font-medium hidden">Loeschen</button>
                        <div class="flex space-x-3">
                            <button type="button" id="cancel-event-btn" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">Abbrechen</button>
                            <button type="submit" class="px-6 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">Speichern</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://api.fwv-raura.ch';

        let members = [];
        let events = [];
        let auditLog = [];
        let authToken = null;
        let currentUser = null;
        let currentTab = 'members';

        // ============================================
        // AUTHENTICATION
        // ============================================

        async function checkAuth() {
            const token = localStorage.getItem('vorstand_token');
            if (!token) {
                showLoginModal();
                return false;
            }

            authToken = token;

            try {
                const response = await fetch(`${API_BASE}/auth/vorstand/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) {
                    localStorage.removeItem('vorstand_token');
                    showLoginModal();
                    return false;
                }
                currentUser = await response.json();
                document.getElementById('user-info').textContent = currentUser.name;
                hideLoginModal();
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                localStorage.removeItem('vorstand_token');
                showLoginModal();
                return false;
            }
        }

        function showLoginModal() {
            document.getElementById('login-modal').classList.remove('hidden');
        }

        function hideLoginModal() {
            document.getElementById('login-modal').classList.add('hidden');
        }

        async function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            const errorEl = document.getElementById('login-error');

            btn.disabled = true;
            btn.textContent = 'Anmelden...';
            errorEl.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE}/auth/vorstand/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Login fehlgeschlagen');
                }

                localStorage.setItem('vorstand_token', data.token);
                authToken = data.token;
                currentUser = data.user;
                document.getElementById('user-info').textContent = currentUser.name;

                hideLoginModal();
                await loadStats();
                await loadMembers();

            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Anmelden';
            }
        }

        document.getElementById('login-form').addEventListener('submit', handleLogin);

        // ============================================
        // MEMBERS
        // ============================================

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/members/stats/overview`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to load stats');
                const stats = await response.json();
                document.getElementById('stat-total').textContent = stats.total || 0;
                document.getElementById('stat-aktiv').textContent = stats.aktiv || 0;
                document.getElementById('stat-passiv').textContent = stats.passiv || 0;
                document.getElementById('stat-ehren').textContent = stats.ehren || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadMembers(filters = {}) {
            try {
                document.getElementById('loading-state').classList.remove('hidden');
                document.getElementById('empty-state').classList.add('hidden');

                const params = new URLSearchParams(filters);
                const response = await fetch(`${API_BASE}/members?${params}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('vorstand_token');
                        showLoginModal();
                        return;
                    }
                    throw new Error('Failed to load members');
                }

                members = await response.json();
                renderMembers();
            } catch (error) {
                console.error('Error loading members:', error);
            } finally {
                document.getElementById('loading-state').classList.add('hidden');
            }
        }

        function renderMembers() {
            const tbody = document.getElementById('members-tbody');

            if (members.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }

            document.getElementById('empty-state').classList.add('hidden');

            tbody.innerHTML = members.map(member => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${member.vorname} ${member.nachname}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-600">${member.email || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-600">${member.mobile || member.telefon || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusClass(member.status)}">
                            ${member.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-600">${member.funktion || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editMember('${member.id}')" class="text-fire-600 hover:text-fire-800">
                            Bearbeiten
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusClass(status) {
            const classes = {
                'Aktivmitglied': 'bg-green-100 text-green-800',
                'Passivmitglied': 'bg-blue-100 text-blue-800',
                'Ehrenmitglied': 'bg-yellow-100 text-yellow-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function openNewMemberModal() {
            document.getElementById('modal-title').textContent = 'Neues Mitglied';
            document.getElementById('member-form').reset();
            document.getElementById('member-id').value = '';
            document.getElementById('delete-member-btn').classList.add('hidden');
            document.getElementById('member-modal').classList.remove('hidden');
        }

        async function editMember(id) {
            try {
                const response = await fetch(`${API_BASE}/members/${id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to load member');
                const member = await response.json();

                document.getElementById('modal-title').textContent = 'Mitglied bearbeiten';
                document.getElementById('member-id').value = member.id;
                document.getElementById('anrede').value = member.anrede || '';
                document.getElementById('vorname').value = member.vorname;
                document.getElementById('nachname').value = member.nachname;
                document.getElementById('geschlecht').value = member.geschlecht || '';
                document.getElementById('geburtstag').value = member.geburtstag || '';
                document.getElementById('strasse').value = member.strasse || '';
                document.getElementById('adresszusatz').value = member.adresszusatz || '';
                document.getElementById('plz').value = member.plz || '';
                document.getElementById('ort').value = member.ort || '';
                document.getElementById('telefon').value = member.telefon || '';
                document.getElementById('mobile').value = member.mobile || '';
                document.getElementById('email').value = member.email || '';
                document.getElementById('status').value = member.status || 'Aktivmitglied';
                document.getElementById('funktion').value = member.funktion || '';
                document.getElementById('eintrittsdatum').value = member.eintrittsdatum || '';
                document.getElementById('zustellung-email').checked = member.zustellung_email !== false;
                document.getElementById('zustellung-post').checked = member.zustellung_post === true;
                document.getElementById('bemerkungen').value = member.bemerkungen || '';

                document.getElementById('feuerwehr-zugehoerigkeit').value = member.feuerwehr_zugehoerigkeit || 'keine';

                document.getElementById('delete-member-btn').classList.remove('hidden');
                document.getElementById('member-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading member:', error);
                alert('Fehler beim Laden des Mitglieds');
            }
        }

        async function saveMember(e) {
            e.preventDefault();

            const id = document.getElementById('member-id').value;
            const data = {
                anrede: document.getElementById('anrede').value,
                vorname: document.getElementById('vorname').value,
                nachname: document.getElementById('nachname').value,
                geschlecht: document.getElementById('geschlecht').value,
                geburtstag: document.getElementById('geburtstag').value || null,
                strasse: document.getElementById('strasse').value,
                adresszusatz: document.getElementById('adresszusatz').value,
                plz: document.getElementById('plz').value,
                ort: document.getElementById('ort').value,
                telefon: document.getElementById('telefon').value,
                mobile: document.getElementById('mobile').value,
                email: document.getElementById('email').value,
                status: document.getElementById('status').value,
                funktion: document.getElementById('funktion').value,
                eintrittsdatum: document.getElementById('eintrittsdatum').value || null,
                zustellung_email: document.getElementById('zustellung-email').checked,
                zustellung_post: document.getElementById('zustellung-post').checked,
                bemerkungen: document.getElementById('bemerkungen').value,
                feuerwehr_zugehoerigkeit: document.getElementById('feuerwehr-zugehoerigkeit').value
            };

            try {
                const url = id ? `${API_BASE}/members/${id}` : `${API_BASE}/members`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to save member');

                document.getElementById('member-modal').classList.add('hidden');
                await loadMembers();
                await loadStats();

            } catch (error) {
                console.error('Error saving member:', error);
                alert('Fehler beim Speichern');
            }
        }

        async function deleteMember() {
            const id = document.getElementById('member-id').value;
            if (!id) return;
            if (!confirm('Mitglied wirklich loeschen?')) return;

            try {
                const response = await fetch(`${API_BASE}/members/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to delete member');

                document.getElementById('member-modal').classList.add('hidden');
                await loadMembers();
                await loadStats();
            } catch (error) {
                console.error('Error deleting member:', error);
                alert('Fehler beim Loeschen');
            }
        }

        function exportCSV() {
            const csv = [
                ['Vorname', 'Nachname', 'E-Mail', 'Telefon', 'Status', 'Funktion'].join(','),
                ...members.map(m => [
                    m.vorname, m.nachname, m.email || '', m.mobile || m.telefon || '', m.status, m.funktion || ''
                ].join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mitglieder-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ============================================
        // EVENTS
        // ============================================

        async function loadEvents() {
            try {
                document.getElementById('events-loading-state').classList.remove('hidden');
                document.getElementById('events-empty-state').classList.add('hidden');

                const response = await fetch(`${API_BASE}/events`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to load events');

                events = await response.json();
                renderEvents();
            } catch (error) {
                console.error('Error loading events:', error);
            } finally {
                document.getElementById('events-loading-state').classList.add('hidden');
            }
        }

        function renderEvents() {
            const tbody = document.getElementById('events-tbody');

            if (events.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('events-empty-state').classList.remove('hidden');
                return;
            }

            document.getElementById('events-empty-state').classList.add('hidden');

            tbody.innerHTML = events.map(event => {
                const startDate = new Date(event.start_date);
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">${event.title}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">${startDate.toLocaleDateString('de-CH')}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">${event.category || '-'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getEventStatusClass(event.status)}">
                                ${event.status || 'planned'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm text-gray-600">${event.shifts?.length || 0}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="editEvent('${event.id}')" class="text-fire-600 hover:text-fire-800">
                                Bearbeiten
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getEventStatusClass(status) {
            const classes = {
                'planned': 'bg-blue-100 text-blue-800',
                'confirmed': 'bg-green-100 text-green-800',
                'cancelled': 'bg-red-100 text-red-800',
                'completed': 'bg-gray-100 text-gray-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function openNewEventModal() {
            document.getElementById('event-modal-title').textContent = 'Neues Event';
            document.getElementById('event-form').reset();
            document.getElementById('event-id').value = '';
            document.getElementById('event-shifts-container').innerHTML = '';
            document.getElementById('event-registration-required').checked = false;
            document.getElementById('delete-event-btn').classList.add('hidden');
            document.getElementById('event-modal').classList.remove('hidden');
        }

        async function editEvent(id) {
            try {
                const response = await fetch(`${API_BASE}/events/${id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to load event');

                const event = await response.json();

                document.getElementById('event-modal-title').textContent = 'Event bearbeiten';
                document.getElementById('event-id').value = event.id;
                document.getElementById('event-title').value = event.title || '';
                document.getElementById('event-subtitle').value = event.subtitle || '';
                document.getElementById('event-slug').value = event.slug || '';
                document.getElementById('event-category').value = event.category || 'Jahresanlass';
                document.getElementById('event-status').value = event.status || 'planned';
                document.getElementById('event-start-date').value = formatDateTimeLocal(event.start_date);
                document.getElementById('event-end-date').value = event.end_date ? formatDateTimeLocal(event.end_date) : '';
                document.getElementById('event-location').value = event.location || '';
                document.getElementById('event-description').value = event.description || '';
                document.getElementById('event-registration-required').checked = event.registration_required || false;
                document.getElementById('event-registration-deadline').value = event.registration_deadline ? formatDateTimeLocal(event.registration_deadline) : '';
                document.getElementById('event-max-participants').value = event.max_participants || '';
                document.getElementById('event-cost').value = event.cost || '';

                // Load shifts
                loadEventShifts(event.shifts || []);

                document.getElementById('delete-event-btn').classList.remove('hidden');
                document.getElementById('event-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading event:', error);
                alert('Fehler beim Laden des Events');
            }
        }

        function loadEventShifts(shifts) {
            const container = document.getElementById('event-shifts-container');
            container.innerHTML = '';
            shifts.forEach(shift => {
                addShiftRow(shift);
            });
        }

        function addShiftRow(shift = null) {
            const container = document.getElementById('event-shifts-container');
            const shiftId = shift?.id || 'new-' + Date.now();
            const row = document.createElement('div');
            row.className = 'shift-row border rounded-lg p-3 bg-gray-50';
            row.dataset.shiftId = shiftId;
            row.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-6 gap-2">
                    <div class="md:col-span-2">
                        <input type="text" placeholder="Name (z.B. Schicht 1)" value="${shift?.name || ''}"
                            class="shift-name w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                    </div>
                    <div>
                        <input type="date" value="${shift?.date || ''}"
                            class="shift-date w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                    </div>
                    <div>
                        <input type="time" value="${shift?.start_time || ''}" placeholder="Start"
                            class="shift-start w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                    </div>
                    <div>
                        <input type="time" value="${shift?.end_time || ''}" placeholder="Ende"
                            class="shift-end w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" min="1" value="${shift?.needed || 2}" placeholder="Anz."
                            class="shift-needed w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                        <button type="button" onclick="removeShiftRow(this)" class="text-red-500 hover:text-red-700 text-lg">&times;</button>
                    </div>
                </div>
                <div class="mt-2">
                    <input type="text" placeholder="Beschreibung (optional)" value="${shift?.description || ''}"
                        class="shift-description w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                </div>
            `;
            container.appendChild(row);
        }

        function removeShiftRow(button) {
            const row = button.closest('.shift-row');
            row.remove();
        }

        function collectShiftsData() {
            const shifts = [];
            document.querySelectorAll('.shift-row').forEach(row => {
                const shiftId = row.dataset.shiftId;
                shifts.push({
                    id: shiftId.startsWith('new-') ? null : shiftId,
                    name: row.querySelector('.shift-name').value,
                    date: row.querySelector('.shift-date').value,
                    start_time: row.querySelector('.shift-start').value,
                    end_time: row.querySelector('.shift-end').value,
                    needed: parseInt(row.querySelector('.shift-needed').value) || 2,
                    description: row.querySelector('.shift-description').value
                });
            });
            return shifts.filter(s => s.name && s.date);
        }

        function formatDateTimeLocal(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const offset = date.getTimezoneOffset();
            const localDate = new Date(date.getTime() - (offset * 60 * 1000));
            return localDate.toISOString().slice(0, 16);
        }

        async function saveEvent(e) {
            e.preventDefault();

            const id = document.getElementById('event-id').value;
            const data = {
                slug: document.getElementById('event-slug').value,
                title: document.getElementById('event-title').value,
                subtitle: document.getElementById('event-subtitle').value || null,
                category: document.getElementById('event-category').value,
                status: document.getElementById('event-status').value,
                start_date: document.getElementById('event-start-date').value,
                end_date: document.getElementById('event-end-date').value || null,
                location: document.getElementById('event-location').value || null,
                description: document.getElementById('event-description').value || null,
                registration_required: document.getElementById('event-registration-required').checked,
                registration_deadline: document.getElementById('event-registration-deadline').value || null,
                max_participants: document.getElementById('event-max-participants').value ? parseInt(document.getElementById('event-max-participants').value) : null,
                cost: document.getElementById('event-cost').value || null
            };

            try {
                const url = id ? `${API_BASE}/events/${id}` : `${API_BASE}/events`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to save event');

                const savedEvent = await response.json();
                const eventId = savedEvent.id;

                // Save shifts
                const shiftsData = collectShiftsData();
                await saveEventShifts(eventId, shiftsData);

                document.getElementById('event-modal').classList.add('hidden');
                await loadEvents();
            } catch (error) {
                console.error('Error saving event:', error);
                alert('Fehler beim Speichern');
            }
        }

        async function saveEventShifts(eventId, shifts) {
            // Get existing shifts to compare
            const existingResponse = await fetch(`${API_BASE}/events/${eventId}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const existingEvent = await existingResponse.json();
            const existingShiftIds = (existingEvent.shifts || []).map(s => s.id);

            // Collect shift IDs that are still present
            const currentShiftIds = shifts.filter(s => s.id).map(s => s.id);

            // Delete removed shifts
            for (const oldId of existingShiftIds) {
                if (!currentShiftIds.includes(oldId)) {
                    await fetch(`${API_BASE}/shifts/${oldId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                }
            }

            // Create or update shifts
            for (const shift of shifts) {
                if (shift.id) {
                    // Update existing shift
                    await fetch(`${API_BASE}/shifts/${shift.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            name: shift.name,
                            description: shift.description,
                            date: shift.date,
                            start_time: shift.start_time,
                            end_time: shift.end_time,
                            needed: shift.needed
                        })
                    });
                } else {
                    // Create new shift
                    await fetch(`${API_BASE}/shifts`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            event_id: eventId,
                            name: shift.name,
                            description: shift.description,
                            date: shift.date,
                            start_time: shift.start_time,
                            end_time: shift.end_time,
                            needed: shift.needed
                        })
                    });
                }
            }
        }

        async function deleteEvent() {
            const id = document.getElementById('event-id').value;
            if (!id) return;
            if (!confirm('Event wirklich loeschen?')) return;

            try {
                const response = await fetch(`${API_BASE}/events/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to delete event');

                document.getElementById('event-modal').classList.add('hidden');
                await loadEvents();
            } catch (error) {
                console.error('Error deleting event:', error);
                alert('Fehler beim Loeschen');
            }
        }

        // ============================================
        // AUDIT LOG
        // ============================================

        async function loadAuditLog(filters = {}) {
            try {
                document.getElementById('audit-loading-state').classList.remove('hidden');

                const params = new URLSearchParams(filters);
                const response = await fetch(`${API_BASE}/audit?${params}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to load audit log');

                auditLog = await response.json();
                renderAuditLog();
            } catch (error) {
                console.error('Error loading audit log:', error);
            } finally {
                document.getElementById('audit-loading-state').classList.add('hidden');
            }
        }

        function renderAuditLog() {
            const tbody = document.getElementById('audit-tbody');

            if (auditLog.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Keine Eintraege gefunden</td></tr>';
                return;
            }

            tbody.innerHTML = auditLog.map(entry => {
                const date = new Date(entry.created_at);
                const details = entry.details ? JSON.stringify(entry.details, null, 2) : '-';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${date.toLocaleDateString('de-CH')}</div>
                            <div class="text-xs text-gray-500">${date.toLocaleTimeString('de-CH')}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getAuditActionClass(entry.action)}">
                                ${entry.action}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">${entry.email || '-'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">${entry.ip_address || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-xs text-gray-500 max-w-xs truncate" title="${details}">
                                ${details}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getAuditActionClass(action) {
            if (action.includes('FAILED') || action.includes('ERROR')) return 'bg-red-100 text-red-800';
            if (action.includes('DELETE')) return 'bg-orange-100 text-orange-800';
            if (action.includes('CREATE')) return 'bg-green-100 text-green-800';
            if (action.includes('UPDATE')) return 'bg-blue-100 text-blue-800';
            if (action.includes('LOGIN_SUCCESS')) return 'bg-green-100 text-green-800';
            return 'bg-gray-100 text-gray-800';
        }

        // ============================================
        // TAB SWITCHING
        // ============================================

        function switchTab(tab) {
            currentTab = tab;

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-fire-500', 'text-fire-600');
                btn.classList.add('border-transparent', 'text-gray-600');
            });

            document.getElementById('members-section').classList.add('hidden');
            document.getElementById('events-section').classList.add('hidden');
            document.getElementById('audit-section').classList.add('hidden');

            if (tab === 'members') {
                document.getElementById('tab-members').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('members-section').classList.remove('hidden');
            } else if (tab === 'events') {
                document.getElementById('tab-events').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('events-section').classList.remove('hidden');
                loadEvents();
            } else if (tab === 'audit') {
                document.getElementById('tab-audit').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('audit-section').classList.remove('hidden');
                loadAuditLog();
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        // Tabs
        document.getElementById('tab-members').addEventListener('click', () => switchTab('members'));
        document.getElementById('tab-events').addEventListener('click', () => switchTab('events'));
        document.getElementById('tab-audit').addEventListener('click', () => switchTab('audit'));

        // Members
        document.getElementById('add-member-btn').addEventListener('click', openNewMemberModal);
        document.getElementById('member-form').addEventListener('submit', saveMember);
        document.getElementById('delete-member-btn').addEventListener('click', deleteMember);
        document.getElementById('close-modal').addEventListener('click', () => document.getElementById('member-modal').classList.add('hidden'));
        document.getElementById('cancel-btn').addEventListener('click', () => document.getElementById('member-modal').classList.add('hidden'));
        document.getElementById('search-input').addEventListener('input', (e) => loadMembers({ search: e.target.value, status: document.getElementById('status-filter').value }));
        document.getElementById('status-filter').addEventListener('change', (e) => loadMembers({ search: document.getElementById('search-input').value, status: e.target.value }));
        document.getElementById('export-btn').addEventListener('click', exportCSV);

        // Auto-set Eintrittsdatum when Feuerwehr Raurica is selected
        document.getElementById('feuerwehr-zugehoerigkeit').addEventListener('change', (e) => {
            if (e.target.value === 'feuerwehr_raurica') {
                const today = new Date().toISOString().split('T')[0];
                const eintrittsdatum = document.getElementById('eintrittsdatum');
                if (!eintrittsdatum.value) {
                    eintrittsdatum.value = today;
                }
            }
        });

        // Events
        document.getElementById('add-event-btn').addEventListener('click', openNewEventModal);
        document.getElementById('event-form').addEventListener('submit', saveEvent);
        document.getElementById('delete-event-btn').addEventListener('click', deleteEvent);
        document.getElementById('close-event-modal').addEventListener('click', () => document.getElementById('event-modal').classList.add('hidden'));
        document.getElementById('cancel-event-btn').addEventListener('click', () => document.getElementById('event-modal').classList.add('hidden'));

        // Audit
        document.getElementById('audit-action-filter').addEventListener('change', (e) => loadAuditLog({ action: e.target.value }));
        document.getElementById('refresh-audit-btn').addEventListener('click', () => loadAuditLog({ action: document.getElementById('audit-action-filter').value }));

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('vorstand_token');
            window.location.href = '/';
        });

        // ============================================
        // INITIALIZE
        // ============================================

        (async () => {
            if (await checkAuth()) {
                await loadStats();
                await loadMembers();
            }
        })();
    </script>
</body>
</html>
