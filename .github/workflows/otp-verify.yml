name: OTP Verify

on:
  workflow_dispatch:
    inputs:
      email:
        description: 'E-Mail-Adresse des Mitglieds'
        required: true
        type: string
      otp:
        description: 'OTP Code (6 Ziffern)'
        required: true
        type: string

permissions:
  contents: write
  actions: write

jobs:
  verify-otp:
    runs-on: ubuntu-latest
    outputs:
      token: ${{ steps.verify.outputs.token }}
      role: ${{ steps.verify.outputs.role }}
      result: ${{ steps.verify.outputs.result }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all branches

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Verify OTP and generate JWT
        id: verify
        env:
          MEMBER_EMAIL: ${{ inputs.email }}
          OTP_CODE: ${{ inputs.otp }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          node scripts/otp-verify.js

      - name: Display result
        run: |
          echo "âœ… Authentifizierung erfolgreich!"
          echo "ðŸŽ« Token: ${{ steps.verify.outputs.token }}"
          echo "ðŸ‘¤ Rolle: ${{ steps.verify.outputs.role }}"
