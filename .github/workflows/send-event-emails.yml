name: Send Event Email Invitations

on:
  push:
    branches:
      - main
    paths:
      - 'events/*.md'
  workflow_dispatch:
    inputs:
      event_file:
        description: 'Event file to send email for (e.g., events/weihnachtshock2025.md)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  send-emails:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect new files

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install nodemailer handlebars

      - name: Detect new event files
        id: detect-new-events
        if: github.event_name == 'push'
        run: |
          echo "ðŸ” Suche nach neuen Event-Dateien..."

          # Get list of changed files in events/ directory
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD | grep '^events/.*\.md$' | grep -v 'README.md' | grep -v '\-assignments.md' || true)

          if [ -z "$NEW_FILES" ]; then
            echo "â„¹ï¸  Keine neuen Event-Dateien gefunden"
            echo "has_new_events=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Neue Event-Dateien gefunden:"
            echo "$NEW_FILES"
            # Only process the first new event file
            FIRST_FILE=$(echo "$NEW_FILES" | head -n 1)
            echo "event_file=$FIRST_FILE" >> $GITHUB_OUTPUT
            echo "has_new_events=true" >> $GITHUB_OUTPUT
          fi

      - name: Send event invitation emails
        if: |
          (github.event_name == 'workflow_dispatch' || steps.detect-new-events.outputs.has_new_events == 'true')
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          FROM_NAME: 'Feuerwehrverein Raura Kaiseraugst'
          EMAIL_RECIPIENTS_TO: ${{ secrets.EMAIL_RECIPIENTS_TO }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            EVENT_FILE="${{ github.event.inputs.event_file }}"
          else
            EVENT_FILE="${{ steps.detect-new-events.outputs.event_file }}"
          fi

          echo "ðŸ“§ Versende E-Mail-Einladungen fÃ¼r: $EVENT_FILE"
          node scripts/send-event-email.js "$EVENT_FILE"
