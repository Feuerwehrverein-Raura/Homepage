name: Build Members Page

on:
  push:
    branches:
      - main
    paths:
      - 'mitglieder/**'
      - '.github/workflows/build-members-page.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      
      - name: Build members page with password from secret
        run: |
          echo "ğŸ” Baue Mitgliederseite mit Secret-Passwort..."
          
          # Ersetze Platzhalter durch echtes Passwort
          sed "s/MEMBERS_PASSWORD_PLACEHOLDER/${{ secrets.MEMBERS_PASSWORD }}/g" \
            mitglieder/mitglieder-template.html > mitglieder.html
          
          echo "âœ… Mitgliederseite erfolgreich gebaut"
      
      - name: Copy data file
        run: |
          cp mitglieder/mitglieder_data.json mitglieder_data.json
          echo "âœ… Datendatei kopiert"
      
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n $(git status --porcelain mitglieder.html mitglieder_data.json) ]]; then
            git add mitglieder.html mitglieder_data.json
            git commit -m "ğŸ¤– Auto-build: Mitgliederseite aktualisiert"
            git push
            echo "âœ… Ã„nderungen gepusht"
          else
            echo "â„¹ï¸ Keine Ã„nderungen"
          fi
