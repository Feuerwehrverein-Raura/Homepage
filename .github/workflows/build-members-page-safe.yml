name: Build Members Page

on:
  push:
    branches:
      - main
    paths:
      - 'mitglieder/**'
      - '.github/workflows/build-members-page.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      
      - name: Build members page with password from secret
        env:
          MEMBERS_PASSWORD: ${{ secrets.MEMBERS_PASSWORD }}
        run: |
          echo "üîê Baue Mitgliederseite mit Secret-Passwort..."
          
          python3 -c '
import os
import sys

try:
    with open("mitglieder/mitglieder-template.html", "r", encoding="utf-8") as f:
        content = f.read()
except FileNotFoundError:
    print("‚ùå FEHLER: Template nicht gefunden!")
    sys.exit(1)

password = os.environ.get("MEMBERS_PASSWORD", "")
if not password:
    print("‚ùå FEHLER: Secret nicht gesetzt!")
    sys.exit(1)

content = content.replace("MEMBERS_PASSWORD_PLACEHOLDER", password)

with open("mitglieder.html", "w", encoding="utf-8") as f:
    f.write(content)

print("‚úÖ Build erfolgreich")
print(f"‚úÖ Passwort-L√§nge: {len(password)} Zeichen")
'
      
      - name: Copy data file
        run: |
          cp mitglieder/mitglieder_data.json mitglieder_data.json
          echo "‚úÖ Datendatei kopiert"
      
      - name: Verify build
        run: |
          echo "üîç Verifiziere Build..."
          
          if grep -q "MEMBERS_PASSWORD_PLACEHOLDER" mitglieder.html; then
            echo "‚ùå FEHLER: Platzhalter nicht ersetzt!"
            exit 1
          fi
          
          if [ ! -s mitglieder.html ]; then
            echo "‚ùå FEHLER: Datei leer!"
            exit 1
          fi
          
          echo "‚úÖ Verifikation erfolgreich"
      
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n $(git status --porcelain mitglieder.html mitglieder_data.json) ]]; then
            git add mitglieder.html mitglieder_data.json
            git commit -m "ü§ñ Auto-build: Mitgliederseite aktualisiert"
            git push
            echo "‚úÖ √Ñnderungen gepusht"
          else
            echo "‚ÑπÔ∏è Keine √Ñnderungen"
          fi
