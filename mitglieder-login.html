<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitgliederbereich Login - Feuerwehrverein Raura</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .auth-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .auth-step {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
        }
        .auth-step.active {
            border-color: #dc2626;
            background: #fef2f2;
        }
        .auth-step h3 {
            margin-top: 0;
            color: #dc2626;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 16px;
        }
        .btn {
            background: #dc2626;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover {
            background: #b91c1c;
        }
        .btn-secondary {
            background: #6b7280;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .info-box {
            background: #f3f4f6;
            padding: 15px;
            border-left: 4px solid #3b82f6;
            margin: 15px 0;
        }
        .success-box {
            background: #ecfdf5;
            padding: 15px;
            border-left: 4px solid #10b981;
            margin: 15px 0;
        }
        .code-display {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üîê Mitgliederbereich Login</h1>
            <nav>
                <a href="index.html">Zur√ºck zur Startseite</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="auth-container">
            <!-- Step 1: Request OTP -->
            <div class="auth-step active" id="step1">
                <h3>Schritt 1: Login-Code anfordern</h3>
                <p>Geben Sie Ihre E-Mail-Adresse ein, um einen Login-Code per E-Mail zu erhalten.</p>

                <div class="form-group">
                    <label for="email">E-Mail-Adresse:</label>
                    <input type="email" id="email" placeholder="ihre.email@example.com" required>
                </div>

                <button class="btn" onclick="requestOTP()">Code anfordern</button>

                <div class="info-box" style="margin-top: 20px;">
                    <strong>‚ÑπÔ∏è Hinweis:</strong> Dies √∂ffnet die GitHub Actions Seite in einem neuen Tab.
                    Dort m√ºssen Sie auf "Run workflow" klicken und Ihre E-Mail-Adresse eingeben.
                </div>
            </div>

            <!-- Step 2: Verify OTP -->
            <div class="auth-step" id="step2">
                <h3>Schritt 2: Login-Code eingeben</h3>
                <p>Pr√ºfen Sie Ihre E-Mails und geben Sie den 6-stelligen Code ein.</p>

                <div class="form-group">
                    <label for="otp">Login-Code:</label>
                    <input type="text" id="otp" placeholder="123456" maxlength="6" pattern="[0-9]{6}" required>
                </div>

                <button class="btn" onclick="verifyOTP()">Code verifizieren</button>
                <button class="btn btn-secondary" onclick="requestOTP()">Neuen Code anfordern</button>

                <div class="info-box" style="margin-top: 20px;">
                    <strong>‚ÑπÔ∏è Hinweis:</strong> Der Code ist 10 Minuten g√ºltig.
                </div>
            </div>

            <!-- Step 3: Token received -->
            <div class="auth-step" id="step3">
                <h3>Schritt 3: Token erhalten</h3>
                <p>Kopieren Sie den JWT Token aus den Workflow-Logs.</p>

                <div class="info-box">
                    <strong>üìã Anleitung:</strong>
                    <ol style="margin: 10px 0;">
                        <li>Warten Sie bis der Workflow abgeschlossen ist (‚úÖ gr√ºn)</li>
                        <li>Klicken Sie auf "Verify OTP and generate JWT"</li>
                        <li>Suchen Sie nach "RESULT_JSON"</li>
                        <li>Kopieren Sie den "token" Wert</li>
                        <li>F√ºgen Sie ihn unten ein</li>
                    </ol>
                </div>

                <div class="form-group">
                    <label for="token">JWT Token:</label>
                    <input type="text" id="token" placeholder="eyJhbGc..." required>
                </div>

                <button class="btn" onclick="saveToken()">Token speichern & weiter</button>
            </div>

            <!-- Step 4: Success -->
            <div class="auth-step" id="step4" style="display: none;">
                <h3>‚úÖ Erfolgreich angemeldet!</h3>

                <div class="success-box">
                    <p><strong>Willkommen!</strong></p>
                    <p>Sie sind jetzt f√ºr 1 Stunde angemeldet.</p>
                </div>

                <p><strong>N√§chste Schritte:</strong></p>
                <ul>
                    <li><a href="mitglieder-profil.html" class="btn">Mein Profil bearbeiten</a></li>
                    <li><a href="mitglieder-admin.html" class="btn" id="adminLink" style="display: none;">Vorstand Admin-Bereich</a></li>
                </ul>
            </div>
        </div>
    </main>

    <script>
        // GitHub repository info
        const REPO_OWNER = 'Feuerwehrverein-Raura';
        const REPO_NAME = 'Homepage';

        function requestOTP() {
            const email = document.getElementById('email').value;
            if (!email) {
                alert('Bitte geben Sie Ihre E-Mail-Adresse ein.');
                return;
            }

            // Store email in localStorage
            localStorage.setItem('member_email', email);

            // Open GitHub Actions workflow
            const workflowUrl = `https://github.com/${REPO_OWNER}/${REPO_NAME}/actions/workflows/otp-request.yml`;
            window.open(workflowUrl, '_blank');

            // Activate step 2
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');

            alert(`GitHub Actions Seite wird ge√∂ffnet.\n\n1. Klicken Sie auf "Run workflow"\n2. Geben Sie Ihre E-Mail ein: ${email}\n3. Klicken Sie auf "Run workflow" (gr√ºner Button)\n4. Warten Sie auf die E-Mail mit dem Code`);
        }

        function verifyOTP() {
            const email = localStorage.getItem('member_email') || document.getElementById('email').value;
            const otp = document.getElementById('otp').value;

            if (!email || !otp) {
                alert('Bitte geben Sie Ihre E-Mail-Adresse und den Code ein.');
                return;
            }

            if (otp.length !== 6) {
                alert('Der Code muss 6 Ziffern haben.');
                return;
            }

            // Open GitHub Actions workflow
            const workflowUrl = `https://github.com/${REPO_OWNER}/${REPO_NAME}/actions/workflows/otp-verify.yml`;
            window.open(workflowUrl, '_blank');

            // Activate step 3
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.add('active');

            alert(`GitHub Actions Seite wird ge√∂ffnet.\n\n1. Klicken Sie auf "Run workflow"\n2. E-Mail: ${email}\n3. OTP: ${otp}\n4. Klicken Sie auf "Run workflow"\n5. Warten Sie bis der Workflow fertig ist\n6. Kopieren Sie den Token aus den Logs`);
        }

        function saveToken() {
            const token = document.getElementById('token').value;

            if (!token) {
                alert('Bitte f√ºgen Sie den JWT Token ein.');
                return;
            }

            // Store token in localStorage
            localStorage.setItem('jwt_token', token);
            localStorage.setItem('jwt_expires', Date.now() + 3600000); // 1 hour

            // Try to decode token to get role
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                localStorage.setItem('member_role', payload.role);
                localStorage.setItem('member_name', payload.member.name);

                // Show success
                document.getElementById('step3').classList.remove('active');
                document.getElementById('step4').style.display = 'block';

                // Show admin link if Vorstand
                if (payload.role === 'vorstand') {
                    document.getElementById('adminLink').style.display = 'inline-block';
                }
            } catch (error) {
                alert('Ung√ºltiger Token. Bitte √ºberpr√ºfen Sie den kopierten Wert.');
            }
        }

        // Check if already logged in
        window.addEventListener('load', function() {
            const token = localStorage.getItem('jwt_token');
            const expires = localStorage.getItem('jwt_expires');

            if (token && expires && Date.now() < parseInt(expires)) {
                // Already logged in
                const role = localStorage.getItem('member_role');
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step4').style.display = 'block';

                if (role === 'vorstand') {
                    document.getElementById('adminLink').style.display = 'inline-block';
                }
            }
        });
    </script>

    <footer>
        <div class="container">
            <p>&copy; 2025 Feuerwehrverein Raura Kaiseraugst</p>
        </div>
    </footer>
</body>
</html>
