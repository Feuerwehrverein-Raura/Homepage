# Production docker-compose mit Images aus GitHub Container Registry
# Watchtower aktualisiert Container automatisch bei neuen Images
# Traefik + Authentik laufen bereits auf dem Server

services:
  # ============================================
  # DATABASE
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: fwv-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-fwv}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-fwv_raura}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - proxy
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U ${POSTGRES_USER:-fwv}
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - com.centurylinklabs.watchtower.enable=false

  # ============================================
  # BACKENDS (APIs) - Images from ghcr.io
  # ============================================

  # Mitgliederverwaltung API
  api-members:
    image: ghcr.io/feuerwehrverein-raura/fwv-raura-api-members:latest
    container_name: fwv-api-members
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}
      JWT_SECRET: ${JWT_SECRET}
      API_KEY: ${API_KEY}
      AUTHENTIK_URL: https://auth.fwv-raura.ch
      AUTHENTIK_CLIENT_ID: ${AUTHENTIK_CLIENT_ID}
      AUTHENTIK_CLIENT_SECRET: ${AUTHENTIK_CLIENT_SECRET}
      AUTHENTIK_CLIENT_ID_VORSTAND: ${AUTHENTIK_CLIENT_ID_VORSTAND}
      AUTHENTIK_CLIENT_SECRET_VORSTAND: ${AUTHENTIK_CLIENT_SECRET_VORSTAND}
      AUTHENTIK_API_TOKEN: ${AUTHENTIK_API_TOKEN}
      IMAP_HOST: ${IMAP_HOST:-mail.test.juroct.net}
      IMAP_PORT: ${IMAP_PORT:-993}
      VORSTAND_EMAILS: ${VORSTAND_EMAILS:-praesident@fwv-raura.ch,aktuar@fwv-raura.ch,kassier@fwv-raura.ch,materialwart@fwv-raura.ch,beisitzer@fwv-raura.ch}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@fwv-raura.ch}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    volumes:
      - member_uploads:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - proxy
    healthcheck:
      test: [CMD, wget, -q, --spider, http://localhost:3000/health]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.api-members.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/members`) || PathPrefix(`/auth`) || PathPrefix(`/roles`) || PathPrefix(`/audit`) || PathPrefix(`/vorstand`) || PathPrefix(`/uploads`) || PathPrefix(`/member-registrations`) || PathPrefix(`/funktionen`))
      - traefik.http.routers.api-members.entrypoints=https
      - traefik.http.routers.api-members.tls=true
      - traefik.http.routers.api-members.tls.certresolver=letsencrypt
      - traefik.http.services.api-members.loadbalancer.server.port=3000
      - com.centurylinklabs.watchtower.enable=true

  # Events API
  api-events:
    image: ghcr.io/feuerwehrverein-raura/fwv-raura-api-events:latest
    container_name: fwv-api-events
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}
      JWT_SECRET: ${JWT_SECRET}
      MEMBERS_API_URL: http://api-members:3000
      DISPATCH_API_URL: http://api-dispatch:3000
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - proxy
    healthcheck:
      test: [CMD, wget, -q, --spider, http://localhost:3000/health]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.api-events.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/events`) || PathPrefix(`/shifts`) || PathPrefix(`/calendar`) || PathPrefix(`/arbeitsplan`) || PathPrefix(`/registrations`) || PathPrefix(`/teilnehmerliste`))
      - traefik.http.routers.api-events.entrypoints=https
      - traefik.http.routers.api-events.tls=true
      - traefik.http.routers.api-events.tls.certresolver=letsencrypt
      - traefik.http.services.api-events.loadbalancer.server.port=3000
      - com.centurylinklabs.watchtower.enable=true

  # Buchhaltung API
  api-accounting:
    image: ghcr.io/feuerwehrverein-raura/fwv-raura-api-accounting:latest
    container_name: fwv-api-accounting
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}
      JWT_SECRET: ${JWT_SECRET}
      MEMBERS_API_URL: http://api-members:3000
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - proxy
    healthcheck:
      test: [CMD, wget, -q, --spider, http://localhost:3000/health]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.api-accounting.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/invoices`) || PathPrefix(`/payments`) || PathPrefix(`/reports`) || PathPrefix(`/accounts`))
      - traefik.http.routers.api-accounting.entrypoints=https
      - traefik.http.routers.api-accounting.tls=true
      - traefik.http.routers.api-accounting.tls.certresolver=letsencrypt
      - traefik.http.services.api-accounting.loadbalancer.server.port=3000
      - com.centurylinklabs.watchtower.enable=true

  # Versand API (Email, Pingen, SMS)
  api-dispatch:
    image: ghcr.io/feuerwehrverein-raura/fwv-raura-api-dispatch:latest
    container_name: fwv-api-dispatch
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}
      JWT_SECRET: ${JWT_SECRET}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      PINGEN_CLIENT_ID: ${PINGEN_CLIENT_ID}
      PINGEN_CLIENT_SECRET: ${PINGEN_CLIENT_SECRET}
      PINGEN_ORGANISATION_ID: ${PINGEN_ORGANISATION_ID}
      PINGEN_STAGING: ${PINGEN_STAGING:-false}
      MEMBERS_API_URL: http://api-members:3000
      EVENTS_API_URL: http://api-events:3000
      MAILCOW_API_URL: ${MAILCOW_API_URL:-https://mail.test.juroct.net}
      MAILCOW_API_KEY: ${MAILCOW_API_KEY}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - proxy
    healthcheck:
      test: [CMD, wget, -q, --spider, http://localhost:3000/health]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.api-dispatch.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/email`) || PathPrefix(`/pingen`) || PathPrefix(`/sms`) || PathPrefix(`/templates`) || PathPrefix(`/letters`) || PathPrefix(`/contact`) || PathPrefix(`/newsletter`) || PathPrefix(`/dispatch-log`) || PathPrefix(`/mailcow`) || PathPrefix(`/arbeitsplan`) || PathPrefix(`/pdf-templates`) || PathPrefix(`/organisation-settings`) || PathPrefix(`/dispatch`))
      - traefik.http.routers.api-dispatch.entrypoints=https
      - traefik.http.routers.api-dispatch.tls=true
      - traefik.http.routers.api-dispatch.tls.certresolver=letsencrypt
      - traefik.http.services.api-dispatch.loadbalancer.server.port=3000
      - com.centurylinklabs.watchtower.enable=true

  # ============================================
  # FRONTENDS
  # ============================================

  # Oeffentliche Website
  frontend-website:
    image: ghcr.io/feuerwehrverein-raura/fwv-raura-frontend:latest
    container_name: fwv-frontend-website
    restart: unless-stopped
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.website.rule=Host(`fwv-raura.ch`) || Host(`www.fwv-raura.ch`)
      - traefik.http.routers.website.entrypoints=https
      - traefik.http.routers.website.tls=true
      - traefik.http.routers.website.tls.certresolver=letsencrypt
      - traefik.http.services.website.loadbalancer.server.port=80
      - com.centurylinklabs.watchtower.enable=true

  # PDF-Designer (pdfme)
  pdf-designer:
    image: ghcr.io/feuerwehrverein-raura/fwv-raura-pdf-designer:latest
    container_name: fwv-pdf-designer
    restart: unless-stopped
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.pdf-designer.rule=Host(`pdf.fwv-raura.ch`)
      - traefik.http.routers.pdf-designer.entrypoints=https
      - traefik.http.routers.pdf-designer.tls=true
      - traefik.http.routers.pdf-designer.tls.certresolver=letsencrypt
      - traefik.http.services.pdf-designer.loadbalancer.server.port=80
      - com.centurylinklabs.watchtower.enable=true

  # Wiki / Dokumentation
  wiki:
    image: ghcr.io/feuerwehrverein-raura/fwv-raura-wiki:latest
    container_name: fwv-wiki
    restart: unless-stopped
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.wiki.rule=Host(`wiki.fwv-raura.ch`)
      - traefik.http.routers.wiki.entrypoints=https
      - traefik.http.routers.wiki.tls=true
      - traefik.http.routers.wiki.tls.certresolver=letsencrypt
      - traefik.http.services.wiki.loadbalancer.server.port=80
      - com.centurylinklabs.watchtower.enable=true

networks:
  proxy:
    external: true

volumes:
  postgres_data:
  member_uploads:
