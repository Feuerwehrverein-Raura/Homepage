# DEUTSCH: Docker-Compose für PRODUKTION (Hetzner VPS)
# Unterschied zu docker-compose.yml: Zieht fertige Images von GitHub Container Registry (ghcr.io)
# statt lokal zu bauen. Watchtower aktualisiert Container automatisch bei neuen Images.
# Voraussetzung: Traefik + Authentik laufen bereits auf dem Server.

services:
  # ============================================
  # DEUTSCH: DATENBANK — PostgreSQL 16
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: fwv-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-fwv}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-fwv_raura}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - proxy
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U ${POSTGRES_USER:-fwv}
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - com.centurylinklabs.watchtower.enable=false    # DEUTSCH: DB-Container NICHT automatisch updaten (Datenverlust-Risiko!)

  # ============================================
  # DEUTSCH: BACKEND APIs — Fertige Images von GitHub Container Registry
  # CI/CD Pipeline baut Images bei Push auf main, Watchtower zieht sie automatisch
  # ============================================

  # DEUTSCH: Mitgliederverwaltung API — Members, Auth, Rollen, Audit, Fotos
  api-members:
    image: ghcr.io/feuerwehrverein-raura/fwv-raura-api-members:latest   # DEUTSCH: Image von ghcr.io (nicht lokal gebaut)
    container_name: fwv-api-members
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}
      JWT_SECRET: ${JWT_SECRET}
      API_KEY: ${API_KEY}
      AUTHENTIK_URL: https://auth.fwv-raura.ch
      AUTHENTIK_CLIENT_ID: ${AUTHENTIK_CLIENT_ID}
      AUTHENTIK_CLIENT_SECRET: ${AUTHENTIK_CLIENT_SECRET}
      AUTHENTIK_CLIENT_ID_VORSTAND: ${AUTHENTIK_CLIENT_ID_VORSTAND}
      AUTHENTIK_CLIENT_SECRET_VORSTAND: ${AUTHENTIK_CLIENT_SECRET_VORSTAND}
      AUTHENTIK_CLIENT_ID_ORDER: ${AUTHENTIK_CLIENT_ID_ORDER}
      AUTHENTIK_CLIENT_SECRET_ORDER: ${AUTHENTIK_CLIENT_SECRET_ORDER}
      AUTHENTIK_API_TOKEN: ${AUTHENTIK_API_TOKEN}
      IMAP_HOST: ${IMAP_HOST:-mail.test.juroct.net}
      IMAP_PORT: ${IMAP_PORT:-993}
      VORSTAND_EMAILS: ${VORSTAND_EMAILS:-praesident@fwv-raura.ch,aktuar@fwv-raura.ch,kassier@fwv-raura.ch,materialwart@fwv-raura.ch,beisitzer@fwv-raura.ch}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@fwv-raura.ch}     # DEUTSCH: Admin-E-Mail für Systembenachrichtigungen
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    volumes:
      - ./data/uploads:/app/uploads    # DEUTSCH: Persistenter Speicher für hochgeladene Mitglieder-Fotos
      - /opt/docker/data/smb-credentials.json:/app/smb-credentials.json:ro  # DEUTSCH: SMB-Passwörter für Mitglieder-Dashboard
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - proxy
    healthcheck:                 # DEUTSCH: Docker prüft alle 30s ob der Service antwortet
      test: [CMD, wget, -q, --spider, http://localhost:3000/health]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      # DEUTSCH: Traefik routet diese Pfade zum Members-Backend
      - traefik.http.routers.api-members.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/members`) || PathPrefix(`/auth`) || PathPrefix(`/roles`) || PathPrefix(`/audit`) || PathPrefix(`/vorstand`) || PathPrefix(`/uploads`) || PathPrefix(`/member-registrations`) || PathPrefix(`/funktionen`))
      - traefik.http.routers.api-members.entrypoints=https
      - traefik.http.routers.api-members.tls=true
      - traefik.http.routers.api-members.tls.certresolver=letsencrypt
      - traefik.http.services.api-members.loadbalancer.server.port=3000
      - com.centurylinklabs.watchtower.enable=true     # DEUTSCH: Watchtower darf diesen Container automatisch updaten

  # DEUTSCH: Events API — Events, Schichten, Kalender, Anmeldungen, Arbeitsplan
  api-events:
    image: ghcr.io/feuerwehrverein-raura/fwv-raura-api-events:latest
    container_name: fwv-api-events
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}
      JWT_SECRET: ${JWT_SECRET}
      API_KEY: ${API_KEY}
      AUTHENTIK_URL: https://auth.fwv-raura.ch
      MEMBERS_API_URL: http://api-members:3000
      DISPATCH_API_URL: http://api-dispatch:3000
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - proxy
    healthcheck:
      test: [CMD, wget, -q, --spider, http://localhost:3000/health]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.api-events.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/events`) || PathPrefix(`/shifts`) || PathPrefix(`/calendar`) || PathPrefix(`/arbeitsplan`) || PathPrefix(`/registrations`) || PathPrefix(`/event-groups`) || PathPrefix(`/reminders`) || PathPrefix(`/teilnehmerliste`))
      - traefik.http.routers.api-events.entrypoints=https
      - traefik.http.routers.api-events.tls=true
      - traefik.http.routers.api-events.tls.certresolver=letsencrypt
      - traefik.http.services.api-events.loadbalancer.server.port=3000
      - com.centurylinklabs.watchtower.enable=true

  # DEUTSCH: Buchhaltung API — Kontenplan, Buchungen, Rechnungen, Berichte
  api-accounting:
    image: ghcr.io/feuerwehrverein-raura/fwv-raura-api-accounting:latest
    container_name: fwv-api-accounting
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}
      JWT_SECRET: ${JWT_SECRET}
      MEMBERS_API_URL: http://api-members:3000
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - proxy
    healthcheck:
      test: [CMD, wget, -q, --spider, http://localhost:3000/health]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.api-accounting.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/invoices`) || PathPrefix(`/payments`) || PathPrefix(`/reports`) || PathPrefix(`/accounts`))
      - traefik.http.routers.api-accounting.entrypoints=https
      - traefik.http.routers.api-accounting.tls=true
      - traefik.http.routers.api-accounting.tls.certresolver=letsencrypt
      - traefik.http.services.api-accounting.loadbalancer.server.port=3000
      - com.centurylinklabs.watchtower.enable=true

  # DEUTSCH: Versand API (Dispatch) — E-Mail, Briefversand (Pingen), PDF-Templates, Newsletter, Kontakt
  api-dispatch:
    image: ghcr.io/feuerwehrverein-raura/fwv-raura-api-dispatch:latest
    container_name: fwv-api-dispatch
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}
      JWT_SECRET: ${JWT_SECRET}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      PINGEN_CLIENT_ID: ${PINGEN_CLIENT_ID}
      PINGEN_CLIENT_SECRET: ${PINGEN_CLIENT_SECRET}
      PINGEN_ORGANISATION_ID: ${PINGEN_ORGANISATION_ID}
      PINGEN_STAGING: ${PINGEN_STAGING:-false}
      MEMBERS_API_URL: http://api-members:3000
      EVENTS_API_URL: http://api-events:3000
      MAILCOW_API_URL: ${MAILCOW_API_URL:-https://mail.test.juroct.net}
      MAILCOW_API_KEY: ${MAILCOW_API_KEY}
      API_KEY: ${API_KEY}
      AUTHENTIK_URL: https://auth.fwv-raura.ch
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - proxy
    healthcheck:
      test: [CMD, wget, -q, --spider, http://localhost:3000/health]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.api-dispatch.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/email`) || PathPrefix(`/pingen`) || PathPrefix(`/sms`) || PathPrefix(`/templates`) || PathPrefix(`/letters`) || PathPrefix(`/contact`) || PathPrefix(`/newsletter`) || PathPrefix(`/dispatch-log`) || PathPrefix(`/mailcow`) || PathPrefix(`/pdf-templates`) || PathPrefix(`/organisation-settings`) || PathPrefix(`/dispatch`))
      - traefik.http.routers.api-dispatch.entrypoints=https
      - traefik.http.routers.api-dispatch.tls=true
      - traefik.http.routers.api-dispatch.tls.certresolver=letsencrypt
      - traefik.http.services.api-dispatch.loadbalancer.server.port=3000
      - com.centurylinklabs.watchtower.enable=true

  # ============================================
  # DEUTSCH: FRONTENDS — Weboberflächen
  # ============================================

  # DEUTSCH: Öffentliche Website — fwv-raura.ch (Hauptseite, Vorstand-Dashboard, Mitgliederbereich)
  frontend-website:
    image: ghcr.io/feuerwehrverein-raura/fwv-raura-frontend:latest
    container_name: fwv-frontend-website
    restart: unless-stopped
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.website.rule=Host(`fwv-raura.ch`) || Host(`www.fwv-raura.ch`)
      - traefik.http.routers.website.entrypoints=https
      - traefik.http.routers.website.tls=true
      - traefik.http.routers.website.tls.certresolver=letsencrypt
      - traefik.http.services.website.loadbalancer.server.port=80
      - com.centurylinklabs.watchtower.enable=true

  # DEUTSCH: PDF-Designer — Visueller Editor für PDF-Vorlagen (Briefe, Rechnungen etc.)
  # Erreichbar unter: pdf.fwv-raura.ch
  pdf-designer:
    image: ghcr.io/feuerwehrverein-raura/fwv-raura-pdf-designer:latest
    container_name: fwv-pdf-designer
    restart: unless-stopped
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.pdf-designer.rule=Host(`pdf.fwv-raura.ch`)
      - traefik.http.routers.pdf-designer.entrypoints=https
      - traefik.http.routers.pdf-designer.tls=true
      - traefik.http.routers.pdf-designer.tls.certresolver=letsencrypt
      - traefik.http.services.pdf-designer.loadbalancer.server.port=80
      - com.centurylinklabs.watchtower.enable=true

  # DEUTSCH: Wiki / Dokumentation — Interne Vereinsdokumentation mit Docusaurus
  # Erreichbar unter: wiki.fwv-raura.ch
  wiki:
    image: ghcr.io/feuerwehrverein-raura/fwv-raura-wiki:latest
    container_name: fwv-wiki
    restart: unless-stopped
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.wiki.rule=Host(`wiki.fwv-raura.ch`)
      - traefik.http.routers.wiki.entrypoints=https
      - traefik.http.routers.wiki.tls=true
      - traefik.http.routers.wiki.tls.certresolver=letsencrypt
      - traefik.http.services.wiki.loadbalancer.server.port=80
      - com.centurylinklabs.watchtower.enable=true

# DEUTSCH: Externes Docker-Netzwerk — wird von Traefik verwaltet
networks:
  proxy:
    external: true   # DEUTSCH: Muss vorher existieren (docker network create proxy)
