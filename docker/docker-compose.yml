version: '3.8'

services:
  # ============================================
  # DATABASE
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: fwv-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-fwv}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-fwv_raura}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - proxy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-fwv}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # BACKENDS (APIs)
  # ============================================

  # Mitgliederverwaltung API
  api-members:
    build: ./backend-members
    container_name: fwv-api-members
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}
      JWT_SECRET: ${JWT_SECRET}
      API_KEY: ${API_KEY}
      AUTHENTIK_URL: https://auth.fwv-raura.ch
      AUTHENTIK_CLIENT_ID: ${AUTHENTIK_CLIENT_ID}
      AUTHENTIK_CLIENT_SECRET: ${AUTHENTIK_CLIENT_SECRET}
      AUTHENTIK_CLIENT_ID_VORSTAND: ${AUTHENTIK_CLIENT_ID_VORSTAND}
      AUTHENTIK_CLIENT_SECRET_VORSTAND: ${AUTHENTIK_CLIENT_SECRET_VORSTAND}
      AUTHENTIK_API_TOKEN: ${AUTHENTIK_API_TOKEN}
      # IMAP settings for Vorstand authentication
      IMAP_HOST: ${IMAP_HOST:-mail.test.juroct.net}
      IMAP_PORT: ${IMAP_PORT:-993}
      VORSTAND_EMAILS: ${VORSTAND_EMAILS:-praesident@fwv-raura.ch,aktuar@fwv-raura.ch,kassier@fwv-raura.ch,vizepraesident@fwv-raura.ch,beisitzer@fwv-raura.ch}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.api-members.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/members`) || PathPrefix(`/auth`) || PathPrefix(`/roles`) || PathPrefix(`/audit`) || PathPrefix(`/vorstand`))"
      - "traefik.http.routers.api-members.entrypoints=https"
      - "traefik.http.routers.api-members.tls=true"
      - "traefik.http.routers.api-members.tls.certresolver=letsencrypt"
      - "traefik.http.services.api-members.loadbalancer.server.port=3000"

  # Events API
  api-events:
    build: ./backend-events
    container_name: fwv-api-events
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}
      JWT_SECRET: ${JWT_SECRET}
      MEMBERS_API_URL: http://api-members:3000
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.api-events.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/events`) || PathPrefix(`/shifts`) || PathPrefix(`/registrations`) || PathPrefix(`/calendar`))"
      - "traefik.http.routers.api-events.entrypoints=https"
      - "traefik.http.routers.api-events.tls=true"
      - "traefik.http.routers.api-events.tls.certresolver=letsencrypt"
      - "traefik.http.services.api-events.loadbalancer.server.port=3000"

  # Buchhaltung API
  api-accounting:
    build: ./backend-accounting
    container_name: fwv-api-accounting
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}
      JWT_SECRET: ${JWT_SECRET}
      MEMBERS_API_URL: http://api-members:3000
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.api-accounting.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/invoices`) || PathPrefix(`/payments`) || PathPrefix(`/reports`) || PathPrefix(`/accounts`))"
      - "traefik.http.routers.api-accounting.entrypoints=https"
      - "traefik.http.routers.api-accounting.tls=true"
      - "traefik.http.routers.api-accounting.tls.certresolver=letsencrypt"
      - "traefik.http.services.api-accounting.loadbalancer.server.port=3000"

  # Versand API (Email, Pingen, SMS)
  api-dispatch:
    build: ./backend-dispatch
    container_name: fwv-api-dispatch
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}
      JWT_SECRET: ${JWT_SECRET}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      PINGEN_CLIENT_ID: ${PINGEN_CLIENT_ID}
      PINGEN_CLIENT_SECRET: ${PINGEN_CLIENT_SECRET}
      PINGEN_ORGANISATION_ID: ${PINGEN_ORGANISATION_ID}
      PINGEN_STAGING: ${PINGEN_STAGING:-false}
      MEMBERS_API_URL: http://api-members:3000
      EVENTS_API_URL: http://api-events:3000
      MAILCOW_API_URL: ${MAILCOW_API_URL:-https://mail.fwv-raura.ch}
      MAILCOW_API_KEY: ${MAILCOW_API_KEY}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.api-dispatch.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/email`) || PathPrefix(`/pingen`) || PathPrefix(`/sms`) || PathPrefix(`/templates`) || PathPrefix(`/letters`) || PathPrefix(`/contact`) || PathPrefix(`/newsletter`) || PathPrefix(`/dispatch-log`) || PathPrefix(`/mailcow`))"
      - "traefik.http.routers.api-dispatch.entrypoints=https"
      - "traefik.http.routers.api-dispatch.tls=true"
      - "traefik.http.routers.api-dispatch.tls.certresolver=letsencrypt"
      - "traefik.http.services.api-dispatch.loadbalancer.server.port=3000"

  # ============================================
  # FRONTENDS
  # ============================================

  # Ã–ffentliche Website
  frontend-website:
    build:
      context: ..
      dockerfile: docker/frontend-website/Dockerfile
    container_name: fwv-frontend-website
    restart: unless-stopped
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.website.rule=Host(`fwv-raura.ch`) || Host(`www.fwv-raura.ch`)"
      - "traefik.http.routers.website.entrypoints=https"
      - "traefik.http.routers.website.tls=true"
      - "traefik.http.routers.website.tls.certresolver=letsencrypt"
      - "traefik.http.services.website.loadbalancer.server.port=80"

networks:
  proxy:
    external: true

volumes:
  postgres_data:
