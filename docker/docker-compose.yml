# DEUTSCH: Docker-Compose für ENTWICKLUNG
# Baut Container lokal aus den Dockerfiles (kein Image-Pull von ghcr.io)
# Für Produktion siehe: docker-compose.prod.yml

services:
  # ============================================
  # DEUTSCH: DATENBANK — PostgreSQL 16 (Alpine-Image für kleine Grösse)
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: fwv-postgres
    restart: unless-stopped      # DEUTSCH: Startet automatisch neu (ausser manuell gestoppt)
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-fwv}           # DEUTSCH: DB-Benutzer (Standard: fwv)
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}         # DEUTSCH: DB-Passwort (aus .env)
      POSTGRES_DB: ${POSTGRES_DB:-fwv_raura}          # DEUTSCH: Datenbankname (Standard: fwv_raura)
    volumes:
      - ./data/postgres:/var/lib/postgresql/data                       # DEUTSCH: Persistenter Datenspeicher
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro    # DEUTSCH: Initiales Schema (nur beim ersten Start)
    networks:
      - proxy                    # DEUTSCH: Traefik-Netzwerk für Service-Kommunikation
    healthcheck:                 # DEUTSCH: Gesundheitsprüfung — alle 10s prüfen ob DB erreichbar
      test:
        - CMD-SHELL
        - pg_isready -U ${POSTGRES_USER:-fwv}
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # DEUTSCH: BACKEND APIs — Werden lokal aus Dockerfiles gebaut
  # ============================================

  # DEUTSCH: Mitgliederverwaltung API — Verwaltet Mitglieder, Auth, Rollen, Audit, Fotos
  # Erreichbar unter: api.fwv-raura.ch/members, /auth, /roles, /audit, /vorstand, /uploads, /member-registrations
  api-members:
    build: ./backend-members     # DEUTSCH: Lokaler Build aus backend-members/Dockerfile
    container_name: fwv-api-members
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}           # DEUTSCH: PostgreSQL Connection-String
      JWT_SECRET: ${JWT_SECRET}                        # DEUTSCH: Geheimschlüssel für Vorstand-JWT (HS256)
      API_KEY: ${API_KEY}                              # DEUTSCH: API-Key für interne Service-Aufrufe
      AUTHENTIK_URL: https://auth.fwv-raura.ch         # DEUTSCH: Authentik Identity Provider
      AUTHENTIK_CLIENT_ID: ${AUTHENTIK_CLIENT_ID}                      # DEUTSCH: OIDC Client für Mitglieder
      AUTHENTIK_CLIENT_SECRET: ${AUTHENTIK_CLIENT_SECRET}
      AUTHENTIK_CLIENT_ID_VORSTAND: ${AUTHENTIK_CLIENT_ID_VORSTAND}    # DEUTSCH: OIDC Client für Vorstand
      AUTHENTIK_CLIENT_SECRET_VORSTAND: ${AUTHENTIK_CLIENT_SECRET_VORSTAND}
      AUTHENTIK_API_TOKEN: ${AUTHENTIK_API_TOKEN}                      # DEUTSCH: API-Token für Authentik Admin-Operationen
      # DEUTSCH: IMAP-Einstellungen für Vorstand-Login (E-Mail als Passwort-Prüfung)
      IMAP_HOST: ${IMAP_HOST:-mail.test.juroct.net}
      IMAP_PORT: ${IMAP_PORT:-993}
      VORSTAND_EMAILS: ${VORSTAND_EMAILS:-praesident@fwv-raura.ch,aktuar@fwv-raura.ch,kassier@fwv-raura.ch,materialwart@fwv-raura.ch,beisitzer@fwv-raura.ch}
    depends_on:
      postgres:
        condition: service_healthy   # DEUTSCH: Wartet bis PostgreSQL bereit ist
    networks:
      - proxy
    # DEUTSCH: Traefik-Labels — konfigurieren das Routing vom Reverse-Proxy zum Container
    labels:
      - traefik.enable=true                            # DEUTSCH: Traefik erkennt diesen Container
      - traefik.docker.network=proxy                   # DEUTSCH: Netzwerk für Traefik-Kommunikation
      # DEUTSCH: URL-Routing — welche Pfade zu diesem Backend geroutet werden
      - traefik.http.routers.api-members.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/members`) || PathPrefix(`/auth`) || PathPrefix(`/roles`) || PathPrefix(`/audit`) || PathPrefix(`/vorstand`) || PathPrefix(`/funktionen`) || PathPrefix(`/uploads`) || PathPrefix(`/member-registrations`))
      - traefik.http.routers.api-members.entrypoints=https       # DEUTSCH: Nur HTTPS
      - traefik.http.routers.api-members.tls=true                # DEUTSCH: TLS aktiviert
      - traefik.http.routers.api-members.tls.certresolver=letsencrypt  # DEUTSCH: Let's Encrypt Zertifikat
      - traefik.http.services.api-members.loadbalancer.server.port=3000  # DEUTSCH: Container-Port

  # DEUTSCH: Events API — Verwaltet Events, Schichten, Kalender, Anmeldungen, Arbeitsplan
  # Erreichbar unter: api.fwv-raura.ch/events, /shifts, /calendar, /registrations, /arbeitsplan
  api-events:
    build: ./backend-events      # DEUTSCH: Lokaler Build
    container_name: fwv-api-events
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}
      JWT_SECRET: ${JWT_SECRET}
      API_KEY: ${API_KEY}
      AUTHENTIK_URL: https://auth.fwv-raura.ch
      MEMBERS_API_URL: http://api-members:3000     # DEUTSCH: Interne URL zum Members-Backend (Docker-Netzwerk)
      DISPATCH_API_URL: http://api-dispatch:3000   # DEUTSCH: Interne URL zum Dispatch-Backend
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.api-events.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/events`) || PathPrefix(`/shifts`) || PathPrefix(`/calendar`) || PathPrefix(`/registrations`) || PathPrefix(`/arbeitsplan`) || PathPrefix(`/event-groups`) || PathPrefix(`/reminders`) || PathPrefix(`/teilnehmerliste`))
      - traefik.http.routers.api-events.entrypoints=https
      - traefik.http.routers.api-events.tls=true
      - traefik.http.routers.api-events.tls.certresolver=letsencrypt
      - traefik.http.services.api-events.loadbalancer.server.port=3000

  # DEUTSCH: Buchhaltung API — Kontenplan, Buchungen, Rechnungen, Finanzberichte
  # Erreichbar unter: api.fwv-raura.ch/invoices, /payments, /reports, /accounts
  api-accounting:
    build: ./backend-accounting   # DEUTSCH: Lokaler Build
    container_name: fwv-api-accounting
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}
      JWT_SECRET: ${JWT_SECRET}
      MEMBERS_API_URL: http://api-members:3000
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.api-accounting.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/invoices`) || PathPrefix(`/payments`) || PathPrefix(`/reports`) || PathPrefix(`/accounts`))
      - traefik.http.routers.api-accounting.entrypoints=https
      - traefik.http.routers.api-accounting.tls=true
      - traefik.http.routers.api-accounting.tls.certresolver=letsencrypt
      - traefik.http.services.api-accounting.loadbalancer.server.port=3000

  # DEUTSCH: Versand API (Dispatch) — E-Mail, Briefversand via Pingen, PDF-Templates, Newsletter, Kontaktformular
  # Erreichbar unter: api.fwv-raura.ch/email, /pingen, /templates, /contact, /newsletter, /dispatch-log, /mailcow, /pdf-templates
  api-dispatch:
    build: ./backend-dispatch     # DEUTSCH: Lokaler Build
    container_name: fwv-api-dispatch
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL_ENCODED}
      JWT_SECRET: ${JWT_SECRET}
      SMTP_HOST: ${SMTP_HOST}                          # DEUTSCH: Mailserver für E-Mail-Versand
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      PINGEN_CLIENT_ID: ${PINGEN_CLIENT_ID}              # DEUTSCH: Pingen API — Schweizer Briefversand-Service
      PINGEN_CLIENT_SECRET: ${PINGEN_CLIENT_SECRET}
      PINGEN_ORGANISATION_ID: ${PINGEN_ORGANISATION_ID}
      PINGEN_STAGING: ${PINGEN_STAGING:-false}            # DEUTSCH: false=Produktion, true=Testmodus
      MEMBERS_API_URL: http://api-members:3000
      EVENTS_API_URL: http://api-events:3000
      MAILCOW_API_URL: ${MAILCOW_API_URL:-https://mail.test.juroct.net}   # DEUTSCH: Mailcow E-Mail-Server API
      MAILCOW_API_KEY: ${MAILCOW_API_KEY}                                # DEUTSCH: Mailcow API-Schlüssel
      AUTHENTIK_URL: https://auth.fwv-raura.ch
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      # Main dispatch routes
      - traefik.http.routers.api-dispatch.rule=Host(`api.fwv-raura.ch`) && (PathPrefix(`/email`) || PathPrefix(`/pingen`) || PathPrefix(`/templates`) || PathPrefix(`/contact`) || PathPrefix(`/newsletter`) || PathPrefix(`/dispatch-log`) || PathPrefix(`/dispatch`) || PathPrefix(`/mailcow`) || PathPrefix(`/pdf-templates`) || PathPrefix(`/organisation-settings`) || PathPrefix(`/health`))
      - traefik.http.routers.api-dispatch.entrypoints=https
      - traefik.http.routers.api-dispatch.tls=true
      - traefik.http.routers.api-dispatch.tls.certresolver=letsencrypt
      - traefik.http.services.api-dispatch.loadbalancer.server.port=3000
      # DEUTSCH: Höhere Priorität für /invoices/generate — Dispatch (nicht Accounting) generiert PDF-Rechnungen
      - traefik.http.routers.api-dispatch-invoices.rule=Host(`api.fwv-raura.ch`) && PathPrefix(`/invoices/generate`)
      - traefik.http.routers.api-dispatch-invoices.entrypoints=https
      - traefik.http.routers.api-dispatch-invoices.tls=true
      - traefik.http.routers.api-dispatch-invoices.tls.certresolver=letsencrypt
      - traefik.http.routers.api-dispatch-invoices.service=api-dispatch
      - traefik.http.routers.api-dispatch-invoices.priority=200       # DEUTSCH: Priorität 200 > Standard, fängt /invoices/generate VOR Accounting ab
      # DEUTSCH: Höhere Priorität für /arbeitsplan/pdf — Dispatch generiert Arbeitsplan-PDFs
      - traefik.http.routers.api-dispatch-arbeitsplan.rule=Host(`api.fwv-raura.ch`) && PathPrefix(`/arbeitsplan/pdf`)
      - traefik.http.routers.api-dispatch-arbeitsplan.entrypoints=https
      - traefik.http.routers.api-dispatch-arbeitsplan.tls=true
      - traefik.http.routers.api-dispatch-arbeitsplan.tls.certresolver=letsencrypt
      - traefik.http.routers.api-dispatch-arbeitsplan.service=api-dispatch
      - traefik.http.routers.api-dispatch-arbeitsplan.priority=200

  # ============================================
  # DEUTSCH: FRONTENDS — Statische Webseiten in Nginx-Containern
  # ============================================

  # DEUTSCH: Öffentliche Website — Hauptseite, Mitgliederbereich, Vorstand-Dashboard
  # Erreichbar unter: fwv-raura.ch / www.fwv-raura.ch
  frontend-website:
    build:
      context: ..
      dockerfile: docker/frontend-website/Dockerfile
    container_name: fwv-frontend-website
    restart: unless-stopped
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.website.rule=Host(`fwv-raura.ch`) || Host(`www.fwv-raura.ch`)
      - traefik.http.routers.website.entrypoints=https
      - traefik.http.routers.website.tls=true
      - traefik.http.routers.website.tls.certresolver=letsencrypt
      - traefik.http.services.website.loadbalancer.server.port=80

# DEUTSCH: Externes Docker-Netzwerk — wird von Traefik verwaltet, alle Services kommunizieren darüber
networks:
  proxy:
    external: true   # DEUTSCH: Muss vorher mit "docker network create proxy" erstellt werden
