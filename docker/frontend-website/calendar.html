<!DOCTYPE html>
<html lang="de" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalender - Feuerwehrverein Raura Kaiseraugst</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fire: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d'
                        }
                    }
                }
            }
        }
    </script>
    <script src="scripts/config.js"></script>
</head>
<body class="font-sans antialiased bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-fire-700 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-fire-300 shadow-lg bg-white">
                        <img src="images/logo.png" alt="Feuerwehrverein Raura Logo" class="w-full h-full object-contain p-1">
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Feuerwehrverein Raura</h1>
                        <p class="text-fire-200 text-sm">Kaiseraugst</p>
                    </div>
                </div>
                <div class="flex space-x-6">
                    <a href="index.html" class="hover:text-fire-200 transition-colors">Home</a>
                    <a href="calendar.html" class="text-fire-200 font-semibold">Kalender</a>
                    <a href="events.html" class="hover:text-fire-200 transition-colors">Veranstaltungen</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <section class="bg-gradient-to-r from-fire-600 to-fire-700 text-white py-12">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl font-bold mb-4">Vereinskalender</h2>
            <p class="text-fire-100 text-lg mb-6">Alle wichtigen Termine auf einen Blick</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="subscribe-btn" class="bg-white text-fire-700 px-6 py-3 rounded-lg font-semibold hover:bg-fire-50 transition-colors flex items-center justify-center space-x-2">
                    <span>üìÖ</span>
                    <span>Kalender abonnieren</span>
                </button>
                <button id="download-ics-btn" class="border-2 border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-white hover:text-fire-700 transition-colors flex items-center justify-center space-x-2">
                    <span>‚¨áÔ∏è</span>
                    <span>ICS herunterladen</span>
                </button>
            </div>
        </div>
    </section>

    <!-- Calendar Controls -->
    <section class="bg-white shadow-sm py-4">
        <div class="container mx-auto px-4">
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <div class="flex items-center space-x-4">
                    <button id="prev-month" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <span class="text-xl">‚Üê</span>
                    </button>
                    <h3 id="current-month" class="text-xl font-bold text-gray-800"></h3>
                    <button id="next-month" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <span class="text-xl">‚Üí</span>
                    </button>
                </div>
                <div class="flex space-x-2">
                    <button id="today-btn" class="px-4 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600 transition-colors">
                        Heute
                    </button>
                    <select id="view-select" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                        <option value="month">Monatsansicht</option>
                        <option value="list">Listenansicht</option>
                    </select>
                </div>
            </div>
        </div>
    </section>

    <!-- Calendar View -->
    <section id="calendar-view" class="py-8">
        <div class="container mx-auto px-4">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <!-- Calendar Header -->
                <div class="grid grid-cols-7 bg-gray-100">
                    <div class="p-4 text-center font-semibold text-gray-700">Mo</div>
                    <div class="p-4 text-center font-semibold text-gray-700">Di</div>
                    <div class="p-4 text-center font-semibold text-gray-700">Mi</div>
                    <div class="p-4 text-center font-semibold text-gray-700">Do</div>
                    <div class="p-4 text-center font-semibold text-gray-700">Fr</div>
                    <div class="p-4 text-center font-semibold text-gray-700">Sa</div>
                    <div class="p-4 text-center font-semibold text-gray-700">So</div>
                </div>
                <!-- Calendar Body -->
                <div id="calendar-grid" class="grid grid-cols-7 gap-0">
                    <!-- Calendar days will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </section>

    <!-- List View -->
    <section id="list-view" class="py-8 hidden">
        <div class="container mx-auto px-4">
            <div id="events-list" class="space-y-4">
                <!-- Event list will be generated by JavaScript -->
            </div>
        </div>
    </section>

    <!-- Event Modal -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 id="modal-title" class="text-xl font-bold text-gray-800"></h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
                </div>
                <div id="modal-content" class="space-y-4">
                    <!-- Modal content will be populated by JavaScript -->
                </div>
                <div class="mt-6 flex space-x-3">
                    <button id="download-event-ics" class="flex-1 bg-fire-500 text-white px-4 py-2 rounded-lg hover:bg-fire-600 transition-colors">
                        ICS herunterladen
                    </button>
                    <button id="close-modal-btn" class="flex-1 border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                        Schlie√üen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-fire-500 mx-auto mb-4"></div>
            <p class="text-gray-600">Lade Veranstaltungen...</p>
        </div>
    </div>

    <script>
        class EventCalendar {
            constructor() {
                this.events = [];
                this.currentDate = new Date();
                this.selectedDate = new Date();
                this.viewMode = 'month';
                this.init();
            }

            async init() {
                console.log('üìÖ Kalender wird initialisiert...');
                await this.loadEvents();
                this.setupEventListeners();
                this.render();
                document.getElementById('loading').classList.add('hidden');
            }

            async loadEvents() {
                try {
                    // Lade Events von der API
                    console.log('üìÇ Lade Events von API...');
                    const response = await fetch('https://api.fwv-raura.ch/events');

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const apiEvents = await response.json();

                    // Map API format to internal format
                    this.events = apiEvents.map(e => ({
                        id: e.slug || e.id,
                        title: e.title || 'Unbenanntes Event',
                        subtitle: e.subtitle || '',
                        category: e.category || 'Sonstiges',
                        startDate: new Date(e.start_date),
                        endDate: new Date(e.end_date || e.start_date),
                        location: e.location || '',
                        organizer: e.organizer || '',
                        email: e.organizer_email || 'info@fwv-raura.ch',
                        cost: e.cost || 'Kostenlos',
                        registrationRequired: e.registration_required || false,
                        registrationDeadline: e.registration_deadline ? new Date(e.registration_deadline) : null,
                        status: e.status || 'confirmed',
                        description: e.description || '',
                        shifts: e.shifts || []
                    }));

                    console.log(`üéØ ${this.events.length} Events von API geladen:`,
                        this.events.map(e => `${e.title} (${e.startDate.toDateString()})`));

                } catch (error) {
                    console.error('‚ùå Fehler beim Laden der Events:', error);
                    this.events = [];
                }
            }

            parseMarkdownEvent(content, filename = '') {
                try {
                    // Parse Frontmatter
                    const frontmatterMatch = content.match(/^---\r?\n([\s\S]*?)\r?\n---\r?\n([\s\S]*)$/);
                    if (!frontmatterMatch) {
                        console.warn(`‚ö†Ô∏è ${filename}: Kein Frontmatter gefunden`);
                        return null;
                    }

                    const [, frontmatterStr, markdownContent] = frontmatterMatch;
                    const frontmatter = this.parseFrontmatter(frontmatterStr);
                    
                    if (!frontmatter.id || !frontmatter.title || !frontmatter.startDate || !frontmatter.endDate) {
                        console.warn(`‚ö†Ô∏è ${filename}: Pflichtfelder fehlen`);
                        return null;
                    }

                    return {
                        ...frontmatter,
                        description: markdownContent.trim(),
                        startDate: new Date(frontmatter.startDate),
                        endDate: new Date(frontmatter.endDate),
                        registrationDeadline: frontmatter.registrationDeadline ? 
                            new Date(frontmatter.registrationDeadline) : null,
                        _source: filename
                    };
                    
                } catch (error) {
                    console.error(`‚ùå ${filename}: Parse-Fehler:`, error);
                    return null;
                }
            }

            parseFrontmatter(frontmatterStr) {
                const result = {};
                const lines = frontmatterStr.split(/\r?\n/);
                
                let currentKey = null;
                let currentValue = '';
                let inArray = false;
                let inShifts = false;
                let currentShift = null;
                let shifts = [];

                for (const line of lines) {
                    const trimmedLine = line.trim();
                    
                    if (!trimmedLine || trimmedLine.startsWith('#')) continue;
                    
                    // Handle shifts array
                    if (trimmedLine === 'shifts:') {
                        inShifts = true;
                        shifts = [];
                        continue;
                    }
                    
                    if (inShifts) {
                        if (trimmedLine.startsWith('- id:')) {
                            // Save previous shift
                            if (currentShift) {
                                shifts.push(currentShift);
                            }
                            // Start new shift
                            currentShift = { id: trimmedLine.replace('- id:', '').trim() };
                        } else if (currentShift && trimmedLine.startsWith('- ')) {
                            const [key, ...valueParts] = trimmedLine.substring(2).split(':');
                            const value = valueParts.join(':').trim();
                            if (key && value) {
                                currentShift[key.trim()] = value;
                            }
                        } else if (!trimmedLine.startsWith(' ') && !trimmedLine.startsWith('-') && trimmedLine.includes(':')) {
                            // End of shifts array
                            if (currentShift) {
                                shifts.push(currentShift);
                                currentShift = null;
                            }
                            inShifts = false;
                            result.shifts = shifts;
                            
                            // Process current line as regular frontmatter
                            const colonIndex = trimmedLine.indexOf(':');
                            const key = trimmedLine.substring(0, colonIndex).trim();
                            let value = trimmedLine.substring(colonIndex + 1).trim();
                            
                            if (value.startsWith('[') && value.endsWith(']')) {
                                value = value.slice(1, -1).split(',').map(s => s.trim());
                            }
                            
                            if (value === 'true') value = true;
                            if (value === 'false') value = false;
                            
                            result[key] = value;
                        }
                        continue;
                    }
                    
                    // Handle regular frontmatter
                    const colonIndex = trimmedLine.indexOf(':');
                    if (colonIndex === -1) continue;
                    
                    const key = trimmedLine.substring(0, colonIndex).trim();
                    let value = trimmedLine.substring(colonIndex + 1).trim();
                    
                    if (!key) continue;
                    
                    // Handle arrays
                    if (value.startsWith('[') && value.endsWith(']')) {
                        value = value.slice(1, -1).split(',').map(s => s.trim());
                    }
                    
                    // Handle booleans
                    if (value === 'true') value = true;
                    if (value === 'false') value = false;
                    
                    result[key] = value;
                }
                
                // Don't forget the last shift if we were parsing shifts
                if (inShifts && currentShift) {
                    shifts.push(currentShift);
                    result.shifts = shifts;
                }
                
                return result;
            }

            setupEventListeners() {
                // Navigation
                document.getElementById('prev-month').addEventListener('click', () => this.previousMonth());
                document.getElementById('next-month').addEventListener('click', () => this.nextMonth());
                document.getElementById('today-btn').addEventListener('click', () => this.goToToday());
                
                // View mode
                document.getElementById('view-select').addEventListener('change', (e) => {
                    this.viewMode = e.target.value;
                    this.toggleView();
                });

                // Buttons
                document.getElementById('subscribe-btn').addEventListener('click', () => this.subscribeCalendar());
                document.getElementById('download-ics-btn').addEventListener('click', () => this.downloadAllICS());
                document.getElementById('download-event-ics').addEventListener('click', () => this.downloadEventICS());

                // Modal
                document.getElementById('close-modal').addEventListener('click', () => this.closeModal());
                document.getElementById('close-modal-btn').addEventListener('click', () => this.closeModal());
                document.getElementById('event-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'event-modal') this.closeModal();
                });
            }

            render() {
                this.updateMonthDisplay();
                if (this.viewMode === 'month') {
                    this.renderCalendarGrid();
                } else {
                    this.renderEventsList();
                }
            }

            updateMonthDisplay() {
                const monthNames = [
                    'Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni',
                    'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'
                ];
                document.getElementById('current-month').textContent = 
                    `${monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
            }

            renderCalendarGrid() {
                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = '';

                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - (firstDay.getDay() + 6) % 7);

                for (let i = 0; i < 42; i++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + i);
                    
                    const cell = this.createCalendarCell(cellDate, month);
                    grid.appendChild(cell);
                }
            }

            createCalendarCell(date, currentMonth) {
                const cell = document.createElement('div');
                const isCurrentMonth = date.getMonth() === currentMonth;
                const isToday = this.isToday(date);
                const dayEvents = this.getEventsForDate(date);

                cell.className = `min-h-24 p-2 border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors ${
                    !isCurrentMonth ? 'bg-gray-100 text-gray-400' : ''
                } ${isToday ? 'bg-fire-50 border-fire-300' : ''}`;

                cell.innerHTML = `
                    <div class="font-semibold text-sm mb-1 ${isToday ? 'text-fire-700' : ''}">${date.getDate()}</div>
                    <div class="space-y-1">
                        ${dayEvents.map(event => `
                            <div class="text-xs p-1 bg-fire-100 text-fire-800 rounded truncate cursor-pointer hover:bg-fire-200 transition-colors" 
                                 data-event-id="${event.id}">
                                ${event.title}
                            </div>
                        `).join('')}
                    </div>
                `;

                // Add event listeners for events
                cell.querySelectorAll('[data-event-id]').forEach(eventEl => {
                    eventEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const eventId = e.target.getAttribute('data-event-id');
                        this.showEventModal(eventId);
                    });
                });

                return cell;
            }

            renderEventsList() {
                const container = document.getElementById('events-list');
                const sortedEvents = [...this.events].sort((a, b) => a.startDate - b.startDate);

                container.innerHTML = sortedEvents.map(event => `
                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" data-event-id="${event.id}">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-2">${event.title}</h3>
                                <p class="text-gray-600 mb-3">${event.subtitle || ''}</p>
                                <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                                    <span>üìÖ ${this.formatDate(event.startDate)}</span>
                                    <span>‚è∞ ${this.formatTime(event.startDate)} - ${this.formatTime(event.endDate)}</span>
                                    <span>üìç ${event.location}</span>
                                </div>
                            </div>
                            <div class="mt-4 md:mt-0">
                                <span class="px-3 py-1 bg-fire-100 text-fire-800 rounded-full text-sm font-medium">
                                    ${event.category || 'Event'}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Add event listeners
                container.querySelectorAll('[data-event-id]').forEach(eventEl => {
                    eventEl.addEventListener('click', () => {
                        const eventId = eventEl.getAttribute('data-event-id');
                        this.showEventModal(eventId);
                    });
                });
            }

            getEventsForDate(date) {
                return this.events.filter(event => {
                    const eventStart = new Date(event.startDate);
                    const eventEnd = new Date(event.endDate);
                    
                    // Event l√§uft an diesem Tag
                    return (this.isSameDay(date, eventStart) || 
                            this.isSameDay(date, eventEnd) ||
                            (date >= eventStart && date <= eventEnd));
                });
            }

            showEventModal(eventId) {
                const event = this.events.find(e => e.id === eventId);
                if (!event) return;

                this.selectedEvent = event;
                document.getElementById('modal-title').textContent = event.title;
                document.getElementById('modal-content').innerHTML = `
                    <div class="space-y-3">
                        ${event.subtitle ? `<p class="text-fire-600 font-medium">${event.subtitle}</p>` : ''}
                        <p class="text-gray-600">${event.description.split('\n')[0]}</p>
                        <div class="grid grid-cols-1 gap-3 text-sm">
                            <div class="flex items-center">
                                <span class="font-semibold text-gray-700 w-20">Datum:</span>
                                <span>${this.formatDate(event.startDate)}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="font-semibold text-gray-700 w-20">Zeit:</span>
                                <span>${this.formatTime(event.startDate)} - ${this.formatTime(event.endDate)}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="font-semibold text-gray-700 w-20">Ort:</span>
                                <span>${event.location}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="font-semibold text-gray-700 w-20">Kategorie:</span>
                                <span class="px-2 py-1 bg-fire-100 text-fire-800 rounded text-xs">${event.category || 'Event'}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="font-semibold text-gray-700 w-20">Kontakt:</span>
                                <span>${event.organizer}</span>
                            </div>
                            ${event.cost ? `
                                <div class="flex items-center">
                                    <span class="font-semibold text-gray-700 w-20">Kosten:</span>
                                    <span>${event.cost}</span>
                                </div>
                            ` : ''}
                            ${event.registrationRequired ? `
                                <div class="flex items-center">
                                    <span class="font-semibold text-gray-700 w-20">Anmeldung:</span>
                                    <span class="text-fire-600">Erforderlich</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                document.getElementById('event-modal').classList.remove('hidden');
            }

            closeModal() {
                document.getElementById('event-modal').classList.add('hidden');
                this.selectedEvent = null;
            }

            toggleView() {
                const calendarView = document.getElementById('calendar-view');
                const listView = document.getElementById('list-view');

                if (this.viewMode === 'month') {
                    calendarView.classList.remove('hidden');
                    listView.classList.add('hidden');
                    this.renderCalendarGrid();
                } else {
                    calendarView.classList.add('hidden');
                    listView.classList.remove('hidden');
                    this.renderEventsList();
                }
            }

            previousMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                this.render();
            }

            nextMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                this.render();
            }

            goToToday() {
                this.currentDate = new Date();
                this.render();
            }

            subscribeCalendar() {
                // API-basierte URLs f√ºr dynamischen Kalender
                const webcalUrl = 'webcal://api.fwv-raura.ch/calendar/ics';
                const httpsUrl = 'https://api.fwv-raura.ch/calendar/ics';
                
                // Erstelle Modal-HTML
                const modalHTML = `
                    <div class="bg-white rounded-lg max-w-2xl w-full mx-4">
                        <div class="bg-gradient-to-r from-fire-500 to-fire-600 text-white p-6 rounded-t-lg">
                            <h3 class="text-xl font-bold flex items-center">
                                <span class="mr-2">üìÖ</span>
                                Kalender abonnieren
                            </h3>
                        </div>
                        <div class="p-6">
                            <p class="mb-4 text-gray-600">
                                W√§hlen Sie eine der folgenden Optionen, um den Feuerwehrverein Raura Kalender zu abonnieren:
                            </p>
                            
                            <div class="space-y-4">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 class="font-semibold text-blue-800 mb-2">üì± Automatisches Abonnement (empfohlen)</h4>
                                    <p class="text-sm text-blue-700 mb-3">Klicken Sie auf den Link um den Kalender automatisch zu abonnieren:</p>
                                    <a href="${webcalUrl}" class="inline-block bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                                        üìÖ Kalender automatisch abonnieren
                                    </a>
                                </div>
                                
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-800 mb-2">üîó Manuelle URL (zum Kopieren)</h4>
                                    <p class="text-sm text-gray-600 mb-3">Falls der automatische Link nicht funktioniert, kopieren Sie diese URL und f√ºgen Sie sie in Ihrem Kalender hinzu:</p>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" value="${webcalUrl}" readonly 
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm font-mono bg-white"
                                               id="calendar-url-input">
                                        <button onclick="const btn=this; navigator.clipboard.writeText('${webcalUrl}').then(() => btn.textContent = '‚úÖ Kopiert!').catch(() => btn.textContent = 'üìã Kopieren')"
                                                class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors text-sm">
                                            üìã Kopieren
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <h4 class="font-semibold text-green-800 mb-2">‚¨áÔ∏è ICS-Datei herunterladen</h4>
                                    <p class="text-sm text-green-700 mb-3">Laden Sie die ICS-Datei herunter und importieren Sie sie manuell in Ihren Kalender:</p>
                                    <a href="${httpsUrl}" download="fwv-raura-kalender.ics" 
                                       class="inline-block bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors">
                                        ‚¨áÔ∏è ICS-Datei herunterladen
                                    </a>
                                </div>
                            </div>
                            
                            <div class="mt-6 text-sm text-gray-500">
                                <p><strong>üí° Tipp:</strong> Nach dem Abonnieren werden neue Termine automatisch in Ihrem Kalender angezeigt.</p>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-6 py-3 rounded-b-lg flex justify-end">
                            <button onclick="event.target.closest('.fixed').remove()"
                                    class="px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                                Schlie√üen
                            </button>
                        </div>
                    </div>
                `;
                
                // Erstelle Modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = modalHTML;
                
                // Schlie√üen bei Klick auf Hintergrund
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
                document.body.appendChild(modal);
                
                // URL automatisch ausw√§hlen f√ºr einfaches Kopieren
                setTimeout(() => {
                    const input = document.getElementById('calendar-url-input');
                    if (input) {
                        input.select();
                        input.focus();
                    }
                }, 100);
            }

            downloadAllICS() {
                // Download direkt von der API f√ºr aktuelle Daten
                window.location.href = 'https://api.fwv-raura.ch/calendar/ics';
            }

            downloadEventICS() {
                if (!this.selectedEvent) return;
                const icsData = this.generateICS([this.selectedEvent]);
                this.downloadICS(icsData, `${this.selectedEvent.id}.ics`);
            }

            downloadICS(icsData, filename) {
                const blob = new Blob([icsData], { type: 'text/calendar;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }

            generateICS(events) {
                const now = new Date();
                let ics = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'PRODID:-//Feuerwehrverein Raura Kaiseraugst//Vereinskalender//DE',
                    'CALSCALE:GREGORIAN',
                    'METHOD:PUBLISH',
                    'X-WR-CALNAME:Feuerwehrverein Raura Kaiseraugst',
                    'X-WR-CALDESC:Termine und Veranstaltungen des Feuerwehrvereins Raura Kaiseraugst',
                    'X-WR-TIMEZONE:Europe/Zurich'
                ];

                events.forEach(event => {
                    const uid = `${event.id}@feuerwehrverein-raura.ch`;
                    const dtstart = this.formatDateForICS(event.startDate);
                    const dtend = this.formatDateForICS(event.endDate);
                    const dtstamp = this.formatDateForICS(now);
                    const description = event.description.replace(/\n/g, '\\n').replace(/,/g, '\\,');

                    ics.push(
                        'BEGIN:VEVENT',
                        `UID:${uid}`,
                        `DTSTAMP:${dtstamp}`,
                        `DTSTART:${dtstart}`,
                        `DTEND:${dtend}`,
                        `SUMMARY:${event.title}`,
                        `DESCRIPTION:${description}`,
                        `LOCATION:${event.location}`,
                        `ORGANIZER;CN=${event.organizer}:mailto:${event.email || FWV_CONFIG.kontakte.info.email}`,
                        `CATEGORIES:${event.category || 'Event'}`,
                        'STATUS:CONFIRMED',
                        'END:VEVENT'
                    );
                });

                ics.push('END:VCALENDAR');
                return ics.join('\r\n');
            }

            formatDateForICS(date) {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            }

            formatDate(date) {
                return new Intl.DateTimeFormat('de-DE', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }).format(date);
            }

            formatTime(date) {
                return new Intl.DateTimeFormat('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            }

            isToday(date) {
                const today = new Date();
                return this.isSameDay(date, today);
            }

            isSameDay(date1, date2) {
                return date1.getDate() === date2.getDate() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getFullYear() === date2.getFullYear();
            }
        }

        // Initialize calendar when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new EventCalendar();
        });
    </script>
</body>
</html>
