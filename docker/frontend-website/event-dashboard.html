<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Dashboard - Feuerwehrverein Raura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fire: {
                            50: '#fef3f2', 100: '#fee4e2', 200: '#fececa', 300: '#fcaba5',
                            400: '#f87171', 500: '#ef4444', 600: '#dc2626', 700: '#b91c1c',
                            800: '#991b1b', 900: '#7f1d1d'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Login Section -->
    <div id="login-section" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <img src="/images/logo.png" alt="FWV Raura" class="h-20 mx-auto mb-4">
                <h1 class="text-2xl font-bold text-gray-800">Event Dashboard</h1>
                <p class="text-gray-600 mt-2">Login fuer Event-Organisatoren</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Event E-Mail</label>
                    <input type="email" id="login-email" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500 focus:border-fire-500"
                        placeholder="event@fwv-raura.ch">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Passwort</label>
                    <input type="password" id="login-password" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500 focus:border-fire-500"
                        placeholder="••••••••">
                </div>
                <div id="login-error" class="text-red-600 text-sm hidden"></div>
                <button type="submit"
                    class="w-full py-3 bg-fire-500 text-white font-medium rounded-lg hover:bg-fire-600 transition-colors">
                    Anmelden
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <img src="/images/logo.png" alt="FWV Raura" class="h-10">
                    <div>
                        <h1 class="text-xl font-bold text-gray-800" id="event-title-header">Event Dashboard</h1>
                        <p class="text-sm text-gray-600" id="organizer-name-header"></p>
                    </div>
                </div>
                <button onclick="logout()" class="text-gray-600 hover:text-gray-800">
                    Abmelden
                </button>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8">
            <!-- Event Info Card -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4" id="event-title"></h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">Datum:</span>
                        <span class="font-medium" id="event-date"></span>
                    </div>
                    <div>
                        <span class="text-gray-500">Ort:</span>
                        <span class="font-medium" id="event-location"></span>
                    </div>
                    <div>
                        <span class="text-gray-500">Status:</span>
                        <span class="font-medium" id="event-status"></span>
                    </div>
                </div>
                <div class="mt-4" id="event-description"></div>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-gray-200 mb-6">
                <button onclick="showTab('shifts')" class="tab-btn px-6 py-3 font-medium text-fire-600 border-b-2 border-fire-500" data-tab="shifts">
                    Schichten
                </button>
                <button onclick="showTab('registrations')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-gray-700" data-tab="registrations">
                    Anmeldungen
                </button>
            </div>

            <!-- Shifts Tab -->
            <div id="shifts-tab" class="bg-white rounded-lg shadow-sm">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Schichten</h3>
                </div>
                <div id="shifts-container" class="divide-y">
                    <!-- Shifts will be loaded here -->
                </div>
            </div>

            <!-- Registrations Tab -->
            <div id="registrations-tab" class="bg-white rounded-lg shadow-sm hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Anmeldungen</h3>
                    <div class="flex space-x-2">
                        <button onclick="filterRegistrations('all')" class="px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300">Alle</button>
                        <button onclick="filterRegistrations('pending')" class="px-3 py-1 text-sm rounded-full bg-yellow-100 text-yellow-800 hover:bg-yellow-200">Ausstehend</button>
                        <button onclick="filterRegistrations('approved')" class="px-3 py-1 text-sm rounded-full bg-green-100 text-green-800 hover:bg-green-200">Genehmigt</button>
                    </div>
                </div>
                <div id="registrations-container" class="divide-y">
                    <!-- Registrations will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = 'https://api.fwv-raura.ch';
        let authToken = localStorage.getItem('eventAuthToken');
        let eventData = null;

        // Check if already logged in
        if (authToken) {
            loadDashboard();
        }

        // Login form handler
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');

            try {
                const response = await fetch(`${API_BASE}/events/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Login fehlgeschlagen');
                }

                authToken = data.token;
                localStorage.setItem('eventAuthToken', authToken);
                loadDashboard();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        });

        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/events/my-event`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                        return;
                    }
                    throw new Error('Fehler beim Laden der Daten');
                }

                eventData = await response.json();
                renderDashboard();
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.remove('hidden');
            } catch (error) {
                console.error('Dashboard load error:', error);
                logout();
            }
        }

        function renderDashboard() {
            // Header
            document.getElementById('event-title-header').textContent = eventData.title;
            document.getElementById('organizer-name-header').textContent = eventData.organizer_name || 'Organisator';

            // Event Info
            document.getElementById('event-title').textContent = eventData.title;
            document.getElementById('event-date').textContent = formatDate(eventData.start_date);
            document.getElementById('event-location').textContent = eventData.location || '-';
            document.getElementById('event-status').textContent = getStatusLabel(eventData.status);
            document.getElementById('event-description').textContent = eventData.description || '';

            renderShifts();
            renderRegistrations();
        }

        function renderShifts() {
            const container = document.getElementById('shifts-container');
            const shifts = eventData.shifts || [];

            if (shifts.length === 0) {
                container.innerHTML = '<p class="p-4 text-gray-500">Keine Schichten vorhanden.</p>';
                return;
            }

            // Group by date
            const byDate = {};
            shifts.forEach(shift => {
                const date = shift.date || 'Unbekannt';
                if (!byDate[date]) byDate[date] = [];
                byDate[date].push(shift);
            });

            container.innerHTML = Object.entries(byDate).map(([date, dateShifts]) => `
                <div class="p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">${formatDate(date)}</h4>
                    <div class="space-y-2">
                        ${dateShifts.map(shift => {
                            const regs = (eventData.registrations || []).filter(r =>
                                r.shift_ids && r.shift_ids.includes(shift.id) && r.status === 'approved'
                            );
                            return `
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <span class="font-medium">${shift.name}</span>
                                        <span class="text-gray-500 text-sm ml-2">${shift.start_time || ''} - ${shift.end_time || ''}</span>
                                        <span class="text-gray-400 text-xs ml-2">(${shift.bereich || 'Allgemein'})</span>
                                    </div>
                                    <div class="text-sm">
                                        <span class="text-green-600 font-medium">${regs.length}</span>
                                        <span class="text-gray-400">/ ${shift.needed}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderRegistrations(filter = 'all') {
            const container = document.getElementById('registrations-container');
            let registrations = eventData.registrations || [];

            if (filter !== 'all') {
                registrations = registrations.filter(r => r.status === filter);
            }

            if (registrations.length === 0) {
                container.innerHTML = '<p class="p-4 text-gray-500">Keine Anmeldungen vorhanden.</p>';
                return;
            }

            container.innerHTML = registrations.map(reg => {
                const name = reg.member_id ? `${reg.vorname} ${reg.nachname}` : reg.guest_name;
                const statusClass = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'approved': 'bg-green-100 text-green-800',
                    'rejected': 'bg-red-100 text-red-800'
                }[reg.status] || 'bg-gray-100 text-gray-800';

                return `
                    <div class="p-4 flex justify-between items-center">
                        <div>
                            <div class="font-medium">${name}</div>
                            <div class="text-sm text-gray-500">${reg.guest_email || ''}</div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="px-2 py-1 text-xs rounded-full ${statusClass}">${getStatusLabel(reg.status)}</span>
                            ${reg.status === 'pending' ? `
                                <button onclick="approveRegistration('${reg.id}')" class="text-green-600 hover:text-green-800 text-sm">Genehmigen</button>
                                <button onclick="rejectRegistration('${reg.id}')" class="text-red-600 hover:text-red-800 text-sm">Ablehnen</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterRegistrations(filter) {
            renderRegistrations(filter);
        }

        async function approveRegistration(id) {
            if (!confirm('Anmeldung genehmigen?')) return;
            try {
                const response = await fetch(`${API_BASE}/registrations/${id}/approve`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Fehler beim Genehmigen');
                await loadDashboard();
            } catch (error) {
                alert(error.message);
            }
        }

        async function rejectRegistration(id) {
            const reason = prompt('Grund fuer Ablehnung (optional):');
            try {
                const response = await fetch(`${API_BASE}/registrations/${id}/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });
                if (!response.ok) throw new Error('Fehler beim Ablehnen');
                await loadDashboard();
            } catch (error) {
                alert(error.message);
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-fire-600', 'border-b-2', 'border-fire-500');
                btn.classList.add('text-gray-500');
            });
            document.querySelector(`[data-tab="${tab}"]`).classList.add('text-fire-600', 'border-b-2', 'border-fire-500');
            document.querySelector(`[data-tab="${tab}"]`).classList.remove('text-gray-500');

            document.getElementById('shifts-tab').classList.toggle('hidden', tab !== 'shifts');
            document.getElementById('registrations-tab').classList.toggle('hidden', tab !== 'registrations');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('de-CH', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function getStatusLabel(status) {
            const labels = {
                'planned': 'Geplant',
                'confirmed': 'Bestaetigt',
                'cancelled': 'Abgesagt',
                'pending': 'Ausstehend',
                'approved': 'Genehmigt',
                'rejected': 'Abgelehnt'
            };
            return labels[status] || status;
        }

        function logout() {
            localStorage.removeItem('eventAuthToken');
            authToken = null;
            eventData = null;
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('login-form').reset();
            document.getElementById('login-error').classList.add('hidden');
        }
    </script>
</body>
</html>
