<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vorstand - Mitgliederverwaltung | FWV Raura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <style>
        /* Template Editor Quill customization */
        #template-editor-quill { height: 400px; background: white; }
        #template-editor-quill .ql-editor { font-family: Arial, sans-serif; font-size: 12pt; line-height: 1.6; }
        .variable-table { max-height: 300px; overflow-y: auto; }
        .variable-table table { width: 100%; font-size: 12px; }
        .variable-table td { padding: 4px 8px; cursor: pointer; }
        .variable-table tr:hover { background: #f3f4f6; }
        .variable-table .var-name { font-family: monospace; color: #2563eb; }
        .letter-preview-a4 {
            width: 210mm; max-width: 100%; aspect-ratio: 210/297;
            background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20mm; font-family: Arial, sans-serif; font-size: 11pt;
            position: relative; overflow: hidden;
        }
        .letter-address-zone-ch {
            position: absolute; right: 20mm; top: 45mm;
            width: 85mm; height: 45mm;
            border: 1px dashed #dc2626; background: rgba(220,38,38,0.05);
        }
        .letter-address-zone-de {
            position: absolute; left: 20mm; top: 45mm;
            width: 85mm; height: 45mm;
            border: 1px dashed #2563eb; background: rgba(37,99,235,0.05);
        }
    </style>
    <style>
        .ql-editor { min-height: 200px; font-size: 14px; }
        .ql-toolbar { background: #f9fafb; border-radius: 8px 8px 0 0; }
        .ql-container { border-radius: 0 0 8px 8px; }
        .dispatch-preview-html { font-family: Arial, sans-serif; line-height: 1.6; }
        .dispatch-preview-html h1 { font-size: 24px; font-weight: bold; margin: 16px 0 8px; }
        .dispatch-preview-html h2 { font-size: 20px; font-weight: bold; margin: 14px 0 6px; }
        .dispatch-preview-html h3 { font-size: 16px; font-weight: bold; margin: 12px 0 4px; }
        .dispatch-preview-html p { margin: 8px 0; }
        .dispatch-preview-html ul, .dispatch-preview-html ol { margin: 8px 0; padding-left: 24px; }
        .dispatch-preview-html a { color: #dc2626; text-decoration: underline; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fire: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="font-sans bg-gray-50">
    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gradient-to-br from-fire-600 to-fire-800 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-8 shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-20 h-20 rounded-full overflow-hidden bg-fire-100 p-2 mx-auto mb-4">
                    <img src="images/logo.png" alt="Logo" class="w-full h-full object-contain">
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Vorstand Login</h2>
                <p class="text-gray-600 text-sm mt-2">Melden Sie sich mit Ihrer Vorstand E-Mail an</p>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">E-Mail</label>
                    <input type="email" id="login-email" required
                        placeholder="vorstand@fwv-raura.ch"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500 focus:border-fire-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Passwort</label>
                    <input type="password" id="login-password" required autocomplete="current-password"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500 focus:border-fire-500">
                </div>
                <div id="login-error" class="hidden text-red-600 text-sm text-center"></div>
                <button type="submit" id="login-btn"
                    class="w-full bg-fire-600 text-white py-3 rounded-lg font-semibold hover:bg-fire-700 transition-colors">
                    Anmelden
                </button>
            </form>

            <p class="text-center text-gray-500 text-xs mt-6">
                Nur autorisierte Vorstandsmitglieder haben Zugang
            </p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-fire-700 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-3 md:py-4">
                <div class="flex items-center space-x-2 md:space-x-3">
                    <div class="w-8 h-8 md:w-10 md:h-10 rounded-full overflow-hidden bg-white p-1">
                        <img src="images/logo.png" alt="Logo" class="w-full h-full object-contain">
                    </div>
                    <div>
                        <span class="text-lg md:text-xl font-bold">FWV Raura</span>
                        <p class="text-fire-200 text-xs md:text-sm hidden sm:block">Vorstand-Portal</p>
                    </div>
                </div>
                <!-- Mobile menu button -->
                <button id="mobile-menu-btn" class="md:hidden p-2 rounded-lg hover:bg-fire-600 touch-manipulation">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <!-- Desktop nav -->
                <div class="hidden md:flex items-center space-x-6">
                    <span id="user-info" class="text-fire-200 text-sm"></span>
                    <a href="index.html" class="hover:text-fire-200 transition-colors">Website</a>
                    <a href="events.html" class="hover:text-fire-200 transition-colors">Veranstaltungen</a>
                    <button id="logout-btn" class="hover:text-fire-200 transition-colors">Abmelden</button>
                </div>
            </div>
            <!-- Mobile nav menu -->
            <div id="mobile-menu" class="hidden md:hidden pb-4 border-t border-fire-600 pt-3 space-y-2">
                <span id="user-info-mobile" class="block text-fire-200 text-sm px-2"></span>
                <a href="index.html" class="block py-2 px-2 rounded hover:bg-fire-600 touch-manipulation">Website</a>
                <a href="events.html" class="block py-2 px-2 rounded hover:bg-fire-600 touch-manipulation">Veranstaltungen</a>
                <button id="logout-btn-mobile" class="block w-full text-left py-2 px-2 rounded hover:bg-fire-600 touch-manipulation">Abmelden</button>
            </div>
        </div>
    </nav>

    <!-- Tabs -->
    <section class="bg-white border-b">
        <div class="container mx-auto px-4 overflow-x-auto">
            <div class="flex space-x-4 md:space-x-8 border-b min-w-max">
                <button id="tab-members" class="tab-btn py-3 md:py-4 px-2 font-semibold border-b-2 border-fire-500 text-fire-600 whitespace-nowrap text-sm md:text-base touch-manipulation">
                    Mitglieder
                </button>
                <button id="tab-events" class="tab-btn py-3 md:py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap text-sm md:text-base touch-manipulation">
                    Events
                </button>
                <button id="tab-audit" class="tab-btn py-3 md:py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap text-sm md:text-base touch-manipulation">
                    Audit
                </button>
                <button id="tab-dispatch" class="tab-btn py-3 md:py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap text-sm md:text-base touch-manipulation">
                    Nachricht
                </button>
                <button id="tab-email" class="tab-btn py-3 md:py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap text-sm md:text-base touch-manipulation">
                    E-Mail
                </button>
                <button id="tab-registrations" class="tab-btn py-3 md:py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800 relative whitespace-nowrap text-sm md:text-base touch-manipulation">
                    Antr√§ge
                    <span id="registrations-badge" class="hidden absolute -top-1 -right-2 bg-fire-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                </button>
                <button id="tab-pingen" class="tab-btn py-3 md:py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap text-sm md:text-base touch-manipulation">
                    Post
                </button>
                <button id="tab-whitelist" class="tab-btn py-3 md:py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap text-sm md:text-base touch-manipulation">
                    IP-Whitelist
                </button>
            </div>
        </div>
    </section>

    <!-- Members Section -->
    <div id="members-section">
        <!-- Header -->
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Mitgliederverwaltung</h1>
                        <p class="text-gray-600 mt-1">Mitglieder verwalten und Statistiken einsehen</p>
                    </div>
                    <button id="add-member-btn" class="bg-fire-500 text-white px-6 py-2 rounded-lg hover:bg-fire-600 transition-colors flex items-center space-x-2">
                        <span>+</span>
                        <span>Neues Mitglied</span>
                    </button>
                </div>
            </div>
        </section>

    <!-- Statistics -->
    <section class="bg-white border-b">
        <div class="container mx-auto px-4 py-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-fire-50 p-4 rounded-lg">
                    <div class="text-fire-600 text-sm font-medium">Gesamt</div>
                    <div id="stat-total" class="text-3xl font-bold text-gray-800">-</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-green-600 text-sm font-medium">Aktivmitglieder</div>
                    <div id="stat-aktiv" class="text-3xl font-bold text-gray-800">-</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-blue-600 text-sm font-medium">Passivmitglieder</div>
                    <div id="stat-passiv" class="text-3xl font-bold text-gray-800">-</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <div class="text-yellow-600 text-sm font-medium">Ehrenmitglieder</div>
                    <div id="stat-ehren" class="text-3xl font-bold text-gray-800">-</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Filters and Search -->
    <section class="bg-white border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                <div class="flex items-center space-x-4">
                    <input type="text" id="search-input" placeholder="Suche nach Name oder E-Mail..."
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500 w-full md:w-80">
                    <select id="status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                        <option value="">Alle Status</option>
                        <option value="Aktivmitglied">Aktivmitglied</option>
                        <option value="Passivmitglied">Passivmitglied</option>
                        <option value="Ehrenmitglied">Ehrenmitglied</option>
                    </select>
                </div>
                <!-- Export Dropdown -->
                <div class="relative inline-block text-left">
                    <button id="export-dropdown-btn" type="button" class="inline-flex items-center border border-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                        Export CSV
                        <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="export-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                        <div class="py-1">
                            <button id="export-all-btn" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                Alle Mitglieder
                            </button>
                            <button id="export-aktiv-btn" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                Nur Aktivmitglieder
                            </button>
                            <button id="export-post-btn" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                Post-Zustellung (zustellung_post)
                            </button>
                            <button id="export-email-btn" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                E-Mail-Zustellung (zustellung_email)
                            </button>
                            <hr class="my-1 border-gray-200">
                            <button id="export-pdf-telefonliste-btn" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                <svg class="w-4 h-4 mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path d="M4 18h12V6h-4V2H4v16zm8-15.5L14.5 5H12V2.5zM2 0h10l4 4v16H2V0z"/></svg>
                                Telefonliste (PDF)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Members Table -->
    <section class="py-8">
        <div class="container mx-auto px-4">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">E-Mail</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Telefon</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Funktion</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="members-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Members will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                <p class="mt-4 text-gray-600">Lade Mitglieder...</p>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="text-center py-12 hidden">
                <p class="text-gray-600">Keine Mitglieder gefunden.</p>
            </div>
        </div>
    </section>

    <!-- Member Modal -->
    <div id="member-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="modal-title" class="text-2xl font-bold text-gray-800">Mitglied bearbeiten</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>

                <form id="member-form" class="space-y-6">
                    <input type="hidden" id="member-id">

                    <!-- Foto -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Profilfoto</h4>
                        <div class="flex items-center space-x-4">
                            <div id="photo-preview" class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                                <span class="text-gray-400 text-3xl">?</span>
                            </div>
                            <div class="flex-1">
                                <input type="file" id="photo-upload" accept="image/*" class="hidden">
                                <button type="button" id="photo-upload-btn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                                    Foto hochladen
                                </button>
                                <button type="button" id="photo-delete-btn" class="ml-2 px-4 py-2 text-red-600 hover:text-red-800 hidden">
                                    Foto entfernen
                                </button>
                                <p class="text-sm text-gray-500 mt-1">Max. 5MB, JPG/PNG/GIF</p>
                            </div>
                        </div>
                    </div>

                    <!-- Persoenliche Daten -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Persoenliche Daten</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Anrede</label>
                                <select id="anrede" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    <option value="">-</option>
                                    <option value="Herr">Herr</option>
                                    <option value="Frau">Frau</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Geschlecht</label>
                                <select id="geschlecht" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    <option value="">-</option>
                                    <option value="M">Maennlich</option>
                                    <option value="W">Weiblich</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Vorname *</label>
                                <input type="text" id="vorname" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nachname *</label>
                                <input type="text" id="nachname" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Geburtstag</label>
                                <input type="date" id="geburtstag" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                        </div>
                    </div>

                    <!-- Adresse -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Adresse</h4>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Strasse</label>
                                <input type="text" id="strasse" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Adresszusatz</label>
                                <input type="text" id="adresszusatz" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">PLZ</label>
                                    <input type="text" id="plz" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ort</label>
                                    <input type="text" id="ort" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Kontakt -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Kontakt</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Telefon</label>
                                <input type="tel" id="telefon" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mobile</label>
                                <input type="tel" id="mobile" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">E-Mail</label>
                                <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                        </div>
                    </div>

                    <!-- Mitgliedschaft -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Mitgliedschaft</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    <option value="Aktivmitglied">Aktivmitglied</option>
                                    <option value="Passivmitglied">Passivmitglied</option>
                                    <option value="Ehrenmitglied">Ehrenmitglied</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Feuerwehr-Zugehoerigkeit</label>
                                <select id="feuerwehr-zugehoerigkeit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    <option value="keine">Keine</option>
                                    <option value="feuerwehr_raurica">Feuerwehr Raurica</option>
                                    <option value="externe_feuerwehr">Externe Feuerwehr</option>
                                    <option value="anderes">Anderes</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Funktionen (Mehrfachauswahl m√∂glich)</label>
                                <div class="grid grid-cols-2 gap-2 p-3 border border-gray-300 rounded-lg bg-gray-50">
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="funktion" value="Admin" class="mr-2 rounded text-fire-500">
                                        Admin (Volle Rechte)
                                    </label>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="funktion" value="Pr√§sident" class="mr-2 rounded text-fire-500">
                                        Pr√§sident (Vorstand)
                                    </label>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="funktion" value="Aktuar" class="mr-2 rounded text-fire-500">
                                        Aktuar (Vorstand)
                                    </label>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="funktion" value="Kassier" class="mr-2 rounded text-fire-500">
                                        Kassier (Vorstand)
                                    </label>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="funktion" value="Materialwart" class="mr-2 rounded text-fire-500">
                                        Materialwart (Vorstand)
                                    </label>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="funktion" value="Beisitzer" class="mr-2 rounded text-fire-500">
                                        Beisitzer (Vorstand)
                                    </label>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="funktion" value="Revisor" class="mr-2 rounded text-fire-500">
                                        Revisor
                                    </label>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="funktion" value="Social Media" class="mr-2 rounded text-fire-500">
                                        Social Media
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Eintrittsdatum</label>
                                <input type="date" id="eintrittsdatum" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                        </div>
                    </div>

                    <!-- Zustellung -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Zustellung</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="zustellung-email" class="mr-2 rounded">
                                <span class="text-sm text-gray-700">E-Mail-Zustellung</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="zustellung-post" class="mr-2 rounded">
                                <span class="text-sm text-gray-700">Post-Zustellung</span>
                            </label>
                        </div>
                    </div>

                    <!-- Cloud-Berechtigungen -->
                    <div id="cloud-permissions-section" class="hidden">
                        <h4 class="font-semibold text-gray-700 mb-3">Cloud-Berechtigungen</h4>
                        <p class="text-sm text-gray-500 mb-3">Werden automatisch basierend auf Funktionen vergeben.</p>
                        <div class="space-y-2">
                            <div class="flex items-center text-sm text-gray-600">
                                <span id="nextcloud-admin-status" class="mr-2">‚è≥</span>
                                <span>Nextcloud Admin</span>
                                <span class="ml-2 text-xs text-gray-400">(Admin-Funktion)</span>
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <span id="vorstand-group-status" class="mr-2">‚è≥</span>
                                <span>Vorstand-Gruppe</span>
                                <span class="ml-2 text-xs text-gray-400">(Vorstand-Funktionen)</span>
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <span id="social-media-group-status" class="mr-2">‚è≥</span>
                                <span>Social-Media-Gruppe</span>
                                <span class="ml-2 text-xs text-gray-400">(Social Media-Funktion)</span>
                            </div>
                        </div>
                        <div id="cloud-permissions-status" class="mt-2 text-sm text-gray-500"></div>
                    </div>

                    <!-- Bemerkungen -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bemerkungen</label>
                        <textarea id="bemerkungen" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500"></textarea>
                    </div>

                    <!-- Buttons -->
                    <div class="flex justify-between pt-4 border-t">
                        <button type="button" id="delete-member-btn" class="text-red-600 hover:text-red-700 font-medium hidden">
                            Loeschen
                        </button>
                        <div class="flex space-x-3">
                            <button type="button" id="cancel-btn" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                Abbrechen
                            </button>
                            <button type="submit" class="px-6 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">
                                Speichern
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    </div> <!-- End Members Section -->

    <!-- Events Section -->
    <div id="events-section" class="hidden">
        <!-- Header -->
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Veranstaltungsverwaltung</h1>
                        <p class="text-gray-600 mt-1">Events und Schichten verwalten</p>
                    </div>
                    <button id="add-event-btn" class="bg-fire-500 text-white px-6 py-2 rounded-lg hover:bg-fire-600 transition-colors flex items-center space-x-2">
                        <span>+</span>
                        <span>Neues Event</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Events List -->
        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Titel</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Datum</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Kategorie</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Organisator</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Schichten/Personen</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Anmeldungen</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="events-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Events will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div id="events-loading-state" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                    <p class="mt-4 text-gray-600">Lade Events...</p>
                </div>

                <!-- Empty State -->
                <div id="events-empty-state" class="text-center py-12 hidden">
                    <p class="text-gray-600">Keine Events gefunden.</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Audit Log Section -->
    <div id="audit-section" class="hidden">
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Audit-Log</h1>
                        <p class="text-gray-600 mt-1">Alle Aenderungen in der Mitgliederverwaltung</p>
                    </div>
                    <div class="flex space-x-4">
                        <select id="audit-action-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            <option value="">Alle Aktionen</option>
                            <option value="LOGIN_SUCCESS">Login erfolgreich</option>
                            <option value="LOGIN_FAILED">Login fehlgeschlagen</option>
                            <option value="MEMBER_CREATE">Mitglied erstellt</option>
                            <option value="MEMBER_UPDATE">Mitglied aktualisiert</option>
                            <option value="MEMBER_DELETE">Mitglied geloescht</option>
                            <option value="EVENT_CREATE">Event erstellt</option>
                            <option value="EVENT_UPDATE">Event aktualisiert</option>
                            <option value="EVENT_DELETE">Event geloescht</option>
                        </select>
                        <button id="refresh-audit-btn" class="border border-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-50">
                            Aktualisieren
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Zeitpunkt</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Aktion</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Benutzer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">IP-Adresse</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody id="audit-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Audit entries will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div id="audit-loading-state" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                    <p class="mt-4 text-gray-600">Lade Audit-Log...</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Email Management Section -->
    <div id="email-section" class="hidden">
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">E-Mail Verwaltung</h1>
                        <p class="text-gray-600 mt-1">Mailboxen und Aliase fuer fwv-raura.ch verwalten</p>
                    </div>
                    <div class="flex space-x-3">
                        <button id="add-mailbox-btn" class="bg-fire-500 text-white px-4 py-2 rounded-lg hover:bg-fire-600">
                            + Mailbox
                        </button>
                        <button id="add-alias-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                            + Alias
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Email Tabs -->
        <section class="bg-white border-b">
            <div class="container mx-auto px-4">
                <div class="flex space-x-6">
                    <button id="email-tab-mailboxes" class="email-tab-btn py-3 px-2 font-medium border-b-2 border-fire-500 text-fire-600">
                        Mailboxen
                    </button>
                    <button id="email-tab-aliases" class="email-tab-btn py-3 px-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                        Aliase
                    </button>
                    <button id="email-tab-quota" class="email-tab-btn py-3 px-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                        Speicherplatz
                    </button>
                    <button id="email-tab-zustellung" class="email-tab-btn py-3 px-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                        üìß Zustellliste
                    </button>
                </div>
            </div>
        </section>

        <!-- Mailboxes List -->
        <section id="mailboxes-panel" class="py-6">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">E-Mail</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Quota</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="mailboxes-tbody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="mailboxes-loading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                </div>
            </div>
        </section>

        <!-- Aliases List -->
        <section id="aliases-panel" class="py-6 hidden">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Alias</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Weiterleitung an</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="aliases-tbody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="aliases-loading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                </div>
            </div>
        </section>

        <!-- Quota Overview -->
        <section id="quota-panel" class="py-6 hidden">
            <div class="container mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="quota-cards"></div>
                <div id="quota-loading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                </div>
            </div>
        </section>

        <!-- Zustellliste Panel -->
        <section id="zustellung-panel" class="py-6 hidden">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">E-Mail Zustellliste</h2>
                            <p class="text-gray-600 text-sm">Alle Mitglieder mit aktivierter E-Mail-Zustellung</p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="copy-emails-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                                </svg>
                                Alle kopieren
                            </button>
                            <button id="refresh-emails-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                                ‚Üª Aktualisieren
                            </button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="text-3xl font-bold text-blue-600" id="zustellung-count">-</div>
                            <div class="text-sm text-blue-800">Mitglieder mit E-Mail-Zustellung</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="text-sm font-medium text-green-800 mb-1">Alias f√ºr Rundmail:</div>
                            <code class="text-green-600 font-mono">mitglieder@fwv-raura.ch</code>
                            <button id="sync-alias-btn" class="mt-2 w-full bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                ‚Üª Alias synchronisieren
                            </button>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <div class="text-sm font-medium text-purple-800 mb-1">Alias Status:</div>
                            <div id="alias-status" class="text-xs text-purple-700">Klicke "Synchronisieren" um den Alias zu aktualisieren</div>
                        </div>
                    </div>

                    <!-- Email List -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">E-Mail-Adressen (kommagetrennt)</label>
                        <textarea id="zustellung-emails" rows="4" readonly
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm"
                            placeholder="L√§dt..."></textarea>
                    </div>

                    <!-- Member Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase">Name</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase">E-Mail</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody id="zustellung-tbody" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Mailbox Modal -->
    <div id="mailbox-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="mailbox-modal-title" class="text-xl font-bold text-gray-800">Neue Mailbox</h3>
                    <button class="close-mailbox-modal text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <form id="mailbox-form" class="space-y-4">
                    <input type="hidden" id="mailbox-edit-email">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">E-Mail Adresse</label>
                        <div class="flex">
                            <input type="text" id="mailbox-local" required placeholder="name"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-fire-500">
                            <span class="px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg text-gray-600">@fwv-raura.ch</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <input type="text" id="mailbox-name" required placeholder="Max Muster"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Passwort</label>
                        <input type="password" id="mailbox-password" placeholder="Mindestens 8 Zeichen" autocomplete="new-password"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        <p class="text-xs text-gray-500 mt-1" id="mailbox-password-hint">Erforderlich fuer neue Mailbox</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Speicherplatz (MB)</label>
                        <input type="number" id="mailbox-quota" value="1024" min="100"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="mailbox-active" checked class="w-4 h-4 text-fire-600 rounded">
                        <label for="mailbox-active" class="ml-2 text-sm text-gray-700">Aktiv</label>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" class="close-mailbox-modal px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Abbrechen
                        </button>
                        <button type="submit" class="px-4 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">
                            Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Alias Modal -->
    <div id="alias-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="alias-modal-title" class="text-xl font-bold text-gray-800">Neuer Alias</h3>
                    <button class="close-alias-modal text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <form id="alias-form" class="space-y-4">
                    <input type="hidden" id="alias-edit-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Alias Adresse</label>
                        <div class="flex">
                            <input type="text" id="alias-address" required placeholder="info"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-fire-500">
                            <span class="px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg text-gray-600">@fwv-raura.ch</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Weiterleitung an</label>
                        <input type="text" id="alias-goto" required placeholder="mail@example.com, andere@mail.ch"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        <p class="text-xs text-gray-500 mt-1">Mehrere E-Mails mit Komma trennen</p>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="alias-active" checked class="w-4 h-4 text-fire-600 rounded">
                        <label for="alias-active" class="ml-2 text-sm text-gray-700">Aktiv</label>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" class="close-alias-modal px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Abbrechen
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Dispatch Section -->
    <div id="dispatch-section" class="hidden">
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Nachricht verfassen</h1>
                    <p class="text-gray-600 mt-1">E-Mail oder Brief an Mitglieder senden</p>
                </div>
            </div>
        </section>

        <section class="container mx-auto px-4 py-8">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <!-- Delivery Method -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Versandart</label>
                        <div class="flex gap-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="delivery-method" value="auto" checked class="mr-2">
                                <span>Automatisch (nach Mitglieder-Einstellung)</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="delivery-method" value="email" class="mr-2">
                                <span>Nur E-Mail (erzwingen)</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="delivery-method" value="post" class="mr-2">
                                <span>Nur Briefpost (erzwingen)</span>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            Bei "Automatisch" wird jedes Mitglied gem√§√ü seiner Zustellungs-Einstellung (E-Mail/Post) benachrichtigt.
                        </p>
                    </div>

                    <!-- Recipients Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Empf√§nger</label>
                        <div class="space-y-3">
                            <div>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="recipient-type" value="all" class="mr-2" checked>
                                    <span>Alle Mitglieder</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="recipient-type" value="filter" class="mr-2">
                                    <span>Gefilterte Mitglieder</span>
                                </label>
                                <div id="recipient-filter" class="ml-6 mt-2 hidden">
                                    <select id="dispatch-filter-status" class="px-3 py-2 border border-gray-300 rounded-lg mr-2">
                                        <option value="">Alle Status</option>
                                        <option value="aktiv">Aktiv</option>
                                        <option value="passiv">Passiv</option>
                                        <option value="ehrenmitglied">Ehrenmitglied</option>
                                    </select>
                                    <label class="inline-flex items-center ml-4">
                                        <input type="checkbox" id="dispatch-filter-email" class="mr-2" checked>
                                        <span class="text-sm">nur mit E-Mail-Zustellung</span>
                                    </label>
                                    <label class="inline-flex items-center ml-4">
                                        <input type="checkbox" id="dispatch-filter-post" class="mr-2">
                                        <span class="text-sm">nur mit Post-Zustellung</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="recipient-type" value="selected" class="mr-2">
                                    <span>Ausgew√§hlte Mitglieder</span>
                                </label>
                                <div id="recipient-selected" class="ml-6 mt-2 hidden">
                                    <button id="select-members-btn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">
                                        Mitglieder ausw√§hlen (<span id="selected-count">0</span>)
                                    </button>
                                    <div id="selected-members-list" class="mt-2 text-sm text-gray-600"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Template Selection -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">Vorlage</label>
                            <div class="flex gap-2">
                                <button type="button" onclick="openTemplateEditor()" class="text-xs px-3 py-1 bg-fire-100 text-fire-700 hover:bg-fire-200 rounded-lg flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                    E-Mail/Brief Templates
                                </button>
                                <a href="https://pdf.fwv-raura.ch" target="_blank" class="text-xs px-3 py-1 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-lg flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    PDF-Layouts
                                </a>
                            </div>
                        </div>
                        <select id="dispatch-template" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            <option value="">Freier Text (keine Vorlage)</option>
                        </select>
                    </div>

                    <!-- Subject (Email only) -->
                    <div id="dispatch-subject-container" class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Betreff</label>
                        <input type="text" id="dispatch-subject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500" placeholder="Betreff der E-Mail">
                    </div>

                    <!-- Message Body with Rich Text Editor -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">Nachricht</label>
                            <div class="flex gap-2">
                                <button type="button" id="toggle-editor-mode" class="text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded">
                                    Plain Text
                                </button>
                                <button type="button" id="insert-placeholder-btn" class="text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded">
                                    + Platzhalter
                                </button>
                            </div>
                        </div>
                        <!-- Rich Text Editor -->
                        <div id="dispatch-editor-container">
                            <div id="dispatch-editor"></div>
                        </div>
                        <!-- Plain Text Fallback (hidden by default) -->
                        <textarea id="dispatch-body-plain" rows="12" class="hidden w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500 font-mono text-sm" placeholder="Nachrichtentext..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">
                            Platzhalter: {{anrede}}, {{vorname}}, {{nachname}}, {{strasse}}, {{plz}}, {{ort}}, {{email}}
                        </p>
                    </div>

                    <!-- Placeholder Dropdown (hidden) -->
                    <div id="placeholder-dropdown" class="hidden absolute bg-white border border-gray-300 rounded-lg shadow-lg z-50 py-1">
                        <button type="button" class="w-full text-left px-3 py-1 hover:bg-gray-100 text-sm" data-placeholder="{{anrede}}">Anrede (Herr/Frau)</button>
                        <button type="button" class="w-full text-left px-3 py-1 hover:bg-gray-100 text-sm" data-placeholder="{{vorname}}">Vorname</button>
                        <button type="button" class="w-full text-left px-3 py-1 hover:bg-gray-100 text-sm" data-placeholder="{{nachname}}">Nachname</button>
                        <button type="button" class="w-full text-left px-3 py-1 hover:bg-gray-100 text-sm" data-placeholder="{{strasse}}">Strasse</button>
                        <button type="button" class="w-full text-left px-3 py-1 hover:bg-gray-100 text-sm" data-placeholder="{{plz}}">PLZ</button>
                        <button type="button" class="w-full text-left px-3 py-1 hover:bg-gray-100 text-sm" data-placeholder="{{ort}}">Ort</button>
                        <button type="button" class="w-full text-left px-3 py-1 hover:bg-gray-100 text-sm" data-placeholder="{{email}}">E-Mail</button>
                    </div>

                    <!-- File Attachments -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Anh√§nge (nur E-Mail)</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                            <input type="file" id="dispatch-attachments" multiple accept=".pdf,.jpg,.jpeg,.png" class="hidden">
                            <div class="text-center">
                                <button type="button" onclick="document.getElementById('dispatch-attachments').click()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">
                                    üìé Dateien ausw√§hlen
                                </button>
                                <p class="text-xs text-gray-500 mt-2">PDF, JPG, PNG (max. 10 MB pro Datei)</p>
                            </div>
                            <div id="attachment-list" class="mt-3 space-y-2"></div>
                        </div>
                    </div>

                    <!-- Template Variables (shown when template is selected) -->
                    <div id="dispatch-variables" class="mb-6 hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Vorlagen-Variablen</label>
                        <div id="dispatch-variables-inputs" class="space-y-3"></div>
                    </div>

                    <!-- Scheduled Sending -->
                    <div class="mb-6">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="dispatch-scheduled" class="mr-2">
                            <span class="text-sm font-medium text-gray-700">Zeitgesteuert senden</span>
                        </label>
                        <div id="dispatch-schedule-options" class="hidden mt-2 ml-6">
                            <input type="datetime-local" id="dispatch-schedule-date" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            <p class="text-xs text-gray-500 mt-1">Die Nachricht wird zum angegebenen Zeitpunkt versendet</p>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div class="mb-6 border rounded-lg overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b flex justify-between items-center">
                            <span class="font-medium text-sm">Vorschau</span>
                            <div class="flex gap-2">
                                <button type="button" id="preview-email-btn" class="text-xs px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                    üìß E-Mail
                                </button>
                                <button type="button" id="preview-letter-btn" class="text-xs px-3 py-1 bg-orange-100 text-orange-700 rounded hover:bg-orange-200">
                                    ‚úâÔ∏è Brief
                                </button>
                            </div>
                        </div>
                        <div id="dispatch-preview" class="p-4 bg-white min-h-[200px]">
                            <p class="text-gray-400 text-sm text-center py-8">Klicke auf "E-Mail" oder "Brief" um eine Vorschau zu sehen</p>
                        </div>
                    </div>

                    <!-- Cost Estimate (for Pingen) -->
                    <div id="pingen-cost-estimate" class="hidden mb-6 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="font-medium text-orange-800">üìÆ Briefversand via Pingen</span>
                                <p class="text-sm text-orange-600 mt-1">
                                    <span id="pingen-letter-count">0</span> Briefe √ó ca. CHF 1.00 = <strong>ca. CHF <span id="pingen-total-cost">0.00</span></strong>
                                </p>
                            </div>
                            <div class="text-xs text-orange-500">
                                Kosten werden dem Kassier gemeldet
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex justify-between items-center pt-4 border-t">
                        <div class="text-sm text-gray-600">
                            <span id="dispatch-recipient-count">0</span> Empf√§nger
                            (<span id="dispatch-email-count">0</span> E-Mail, <span id="dispatch-post-count">0</span> Post)
                        </div>
                        <div class="flex gap-3">
                            <button id="dispatch-save-draft-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                üíæ Entwurf speichern
                            </button>
                            <button id="dispatch-test-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                üß™ Test senden
                            </button>
                            <button id="dispatch-send-btn" class="px-6 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">
                                üì§ Senden
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Saved Drafts -->
                <div id="drafts-section" class="bg-white rounded-lg shadow-md p-6 mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">üìù Gespeicherte Entw√ºrfe</h2>
                        <button id="refresh-drafts-btn" class="text-sm text-gray-500 hover:text-gray-700">‚Üª Aktualisieren</button>
                    </div>
                    <div id="drafts-list" class="space-y-2">
                        <p class="text-gray-500 text-sm py-4 text-center">Keine Entw√ºrfe vorhanden</p>
                    </div>
                </div>

                <!-- Scheduled Messages -->
                <div id="scheduled-section" class="bg-white rounded-lg shadow-md p-6 mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">‚è∞ Geplante Nachrichten</h2>
                        <button id="refresh-scheduled-btn" class="text-sm text-gray-500 hover:text-gray-700">‚Üª Aktualisieren</button>
                    </div>
                    <div id="scheduled-list" class="space-y-2">
                        <p class="text-gray-500 text-sm py-4 text-center">Keine geplanten Nachrichten</p>
                    </div>
                </div>

                <!-- Send History -->
                <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üìã Versandhistorie</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Datum</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Typ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Betreff</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Empf√§nger</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody id="dispatch-history-tbody" class="divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">Keine Versandhistorie vorhanden</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Registrations Section -->
    <div id="registrations-section" class="hidden">
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Mitgliedschaftsantr√§ge</h1>
                        <p class="text-gray-600 mt-1">Neue Antr√§ge pr√ºfen und genehmigen</p>
                    </div>
                    <div class="flex space-x-2">
                        <select id="registrations-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            <option value="pending">Ausstehend</option>
                            <option value="approved">Genehmigt</option>
                            <option value="rejected">Abgelehnt</option>
                            <option value="all">Alle</option>
                        </select>
                        <button id="refresh-registrations-btn" class="border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50">
                            Aktualisieren
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">E-Mail</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Feuerwehr</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Datum</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="registrations-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>

                <div id="registrations-loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                    <p class="mt-4 text-gray-600">Lade Antr√§ge...</p>
                </div>

                <div id="registrations-empty" class="text-center py-12 hidden">
                    <p class="text-gray-600">Keine Antr√§ge vorhanden.</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Pingen Section -->
    <div id="pingen-section" class="hidden">
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Post-Versand (Pingen)</h1>
                        <p class="text-gray-600 mt-1">Briefe per Post versenden und verwalten</p>
                    </div>
                    <div class="flex space-x-3">
                        <button id="send-bulk-pdf-btn" class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition-colors flex items-center space-x-2">
                            <span>üìÑ</span>
                            <span>Massen-PDF versenden</span>
                        </button>
                        <button id="send-letter-btn" class="bg-fire-500 text-white px-6 py-2 rounded-lg hover:bg-fire-600 transition-colors flex items-center space-x-2">
                            <span>+</span>
                            <span>Brief senden</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pingen Stats -->
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-blue-600 text-sm font-medium">Guthaben</div>
                        <div id="pingen-balance" class="text-2xl font-bold text-gray-800">-</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-green-600 text-sm font-medium">Gesendet</div>
                        <div id="pingen-sent" class="text-2xl font-bold text-gray-800">-</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <div class="text-yellow-600 text-sm font-medium">In Bearbeitung</div>
                        <div id="pingen-pending" class="text-2xl font-bold text-gray-800">-</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <div class="text-red-600 text-sm font-medium">Fehlgeschlagen</div>
                        <div id="pingen-failed" class="text-2xl font-bold text-gray-800">-</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-purple-600 text-sm font-medium">Letzte 30 Tage</div>
                        <div id="pingen-30days" class="text-2xl font-bold text-gray-800">-</div>
                    </div>
                </div>
                <div id="pingen-staging-warning" class="hidden mt-4 bg-orange-100 border border-orange-400 text-orange-700 px-4 py-3 rounded">
                    <strong>Staging-Modus:</strong> Briefe werden nicht tats√§chlich gesendet (Testumgebung)
                </div>
            </div>
        </section>

        <!-- Filter -->
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center space-x-4">
                    <select id="pingen-event-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                        <option value="">Alle Events</option>
                    </select>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="pingen-staging-toggle" class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                        <span class="text-sm text-gray-700">Staging (Test-Modus)</span>
                    </label>
                    <button id="refresh-pingen-btn" class="border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50">
                        Aktualisieren
                    </button>
                </div>
            </div>
        </section>

        <!-- Letters Table -->
        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Empf√§nger</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Event</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Betreff</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Datum</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="pingen-letters-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>

                <div id="pingen-loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                    <p class="mt-4 text-gray-600">Lade Briefe...</p>
                </div>

                <div id="pingen-empty" class="text-center py-12 hidden">
                    <p class="text-gray-600">Keine Briefe vorhanden.</p>
                </div>
            </div>
        </section>

        <!-- Webhook Management -->
        <section class="bg-white border-t mt-8">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Webhook-Konfiguration</h2>
                        <p class="text-gray-600 text-sm">Automatische Status-Updates von Pingen</p>
                    </div>
                    <button id="register-webhook-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm">
                        Webhook registrieren
                    </button>
                </div>
                <div id="webhooks-list" class="bg-gray-50 rounded-lg p-4">
                    <p class="text-gray-500 text-sm">Lade Webhooks...</p>
                </div>
            </div>
        </section>
    </div>

    <!-- IP Whitelist Section -->
    <div id="whitelist-section" class="hidden">
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">IP-Whitelist</h1>
                        <p class="text-gray-600 mt-1">Zugelassene IP-Adressen f√ºr Kasse und Kitchen Display</p>
                    </div>
                    <button id="add-whitelist-btn" class="bg-fire-500 text-white px-6 py-2 rounded-lg hover:bg-fire-600 transition-colors flex items-center space-x-2">
                        <span>+</span>
                        <span>IP hinzuf√ºgen</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Whitelist Toggle -->
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg">
                    <div>
                        <div class="font-semibold text-gray-800">IP-Whitelist Schutz</div>
                        <p class="text-sm text-gray-600">Wenn aktiviert, k√∂nnen nur freigeschaltete IP-Adressen die Kasse und das Kitchen Display nutzen.</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="whitelist-enabled-toggle" class="sr-only peer">
                        <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-fire-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-fire-500"></div>
                    </label>
                </div>
            </div>
        </section>

        <!-- Register App Info -->
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-green-600 text-sm font-medium">Selbst-Registrierung f√ºr Mitglieder</div>
                            <div class="flex items-center space-x-2 mt-1">
                                <code class="text-lg font-bold text-gray-800 bg-white px-2 py-1 rounded">register.fwv-raura.ch</code>
                                <button id="copy-register-url-btn" class="text-green-600 hover:text-green-800" title="URL kopieren">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <p class="text-green-600 text-xs mt-2">Mitglieder k√∂nnen sich hier mit ihrem FWV-Konto (Authentik) anmelden und ihr Ger√§t f√ºr 24h freischalten</p>
                </div>
            </div>
        </section>

        <!-- Whitelist Table -->
        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">IP-Adresse</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Ger√§tename</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Erstellt von</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Erstellt am</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">G√ºltig bis</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="whitelist-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>

                <div id="whitelist-loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                    <p class="mt-4 text-gray-600">Lade IP-Whitelist...</p>
                </div>

                <div id="whitelist-empty" class="text-center py-12 hidden">
                    <p class="text-gray-600">Keine IP-Adressen in der Whitelist.</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Whitelist Add Modal -->
    <div id="whitelist-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">IP-Adresse hinzuf√ºgen</h3>
                    <button id="close-whitelist-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>

                <form id="whitelist-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">IP-Adresse *</label>
                        <input type="text" id="whitelist-ip" required
                            pattern="^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                            placeholder="z.B. 192.168.1.100"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ger√§tename</label>
                        <input type="text" id="whitelist-device-name"
                            placeholder="z.B. Kassen-Tablet"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-700">
                        <strong>Hinweis:</strong> Manuell hinzugef√ºgte IPs sind permanent g√ºltig (kein Ablaufdatum).
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="button" id="cancel-whitelist-btn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Abbrechen
                        </button>
                        <button type="submit" class="flex-1 bg-fire-500 text-white py-2 rounded-lg hover:bg-fire-600">
                            Hinzuf√ºgen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Pingen Send Letter Modal -->
    <div id="pingen-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Brief senden</h3>
                    <button id="close-pingen-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>

                <form id="pingen-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Empf√§nger (Mitglied) *</label>
                        <select id="pingen-member" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            <option value="">Mitglied ausw√§hlen...</option>
                        </select>
                    </div>
                    <div id="pingen-member-address" class="bg-gray-50 p-3 rounded-lg hidden">
                        <p class="text-sm text-gray-600">Adresse:</p>
                        <p id="pingen-address-preview" class="font-medium"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Event (optional)</label>
                        <select id="pingen-event" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            <option value="">Kein Event</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Betreff *</label>
                        <input type="text" id="pingen-subject" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Inhalt *</label>
                        <textarea id="pingen-body" required rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500"
                            placeholder="Schreiben Sie hier Ihren Brief..."></textarea>
                    </div>

                    <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-700">
                        <strong>Hinweis:</strong> Der Brief wird automatisch formatiert und per Post versendet.
                        Die Kosten werden vom Pingen-Guthaben abgezogen.
                    </div>

                    <div class="flex space-x-3 pt-4">
                        <button type="button" id="cancel-pingen-btn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Abbrechen
                        </button>
                        <button type="submit" class="flex-1 bg-fire-500 text-white py-2 rounded-lg hover:bg-fire-600">
                            Brief senden
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk PDF Modal -->
    <div id="bulk-pdf-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Massen-PDF versenden</h3>
                    <button id="close-bulk-pdf-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>

                <form id="bulk-pdf-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">PDF-Datei *</label>
                        <input type="file" id="bulk-pdf-file" accept=".pdf" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <p class="text-sm text-gray-500 mt-1">W√§hle eine PDF-Datei zum Versenden</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Betreff / Titel</label>
                        <input type="text" id="bulk-pdf-subject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            placeholder="z.B. Einladung GV 2026">
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">Empf√§nger</label>
                            <div class="flex items-center space-x-2">
                                <button type="button" id="select-all-recipients" class="text-sm text-purple-600 hover:text-purple-800">Alle ausw√§hlen</button>
                                <span class="text-gray-300">|</span>
                                <button type="button" id="deselect-all-recipients" class="text-sm text-purple-600 hover:text-purple-800">Keine ausw√§hlen</button>
                            </div>
                        </div>
                        <div id="bulk-pdf-recipients" class="border border-gray-300 rounded-lg max-h-60 overflow-y-auto p-3 space-y-2">
                            <div class="text-center text-gray-500 py-4">Lade Empf√§nger...</div>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">
                            <span id="bulk-pdf-selected-count">0</span> von <span id="bulk-pdf-total-count">0</span> Empf√§ngern ausgew√§hlt
                        </p>
                    </div>

                    <div class="bg-purple-50 p-3 rounded-lg text-sm text-purple-700">
                        <strong>Hinweis:</strong> Das PDF wird an alle ausgew√§hlten Mitglieder mit Post-Zustellung per Pingen versendet.
                        Die Kosten werden vom Pingen-Guthaben abgezogen.
                    </div>

                    <div class="flex space-x-3 pt-4">
                        <button type="button" id="cancel-bulk-pdf-btn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Abbrechen
                        </button>
                        <button type="submit" id="submit-bulk-pdf-btn" class="flex-1 bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600">
                            PDF versenden
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Registration Detail Modal -->
    <div id="registration-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Mitgliedschaftsantrag</h3>
                    <button id="close-registration-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>

                <div id="registration-details" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-500">Vorname</label>
                            <p id="reg-vorname" class="font-medium"></p>
                        </div>
                        <div>
                            <label class="text-sm text-gray-500">Nachname</label>
                            <p id="reg-nachname" class="font-medium"></p>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">Adresse</label>
                        <p id="reg-adresse" class="font-medium"></p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-500">Telefon</label>
                            <p id="reg-telefon" class="font-medium"></p>
                        </div>
                        <div>
                            <label class="text-sm text-gray-500">Mobile</label>
                            <p id="reg-mobile" class="font-medium"></p>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">E-Mail</label>
                        <p id="reg-email" class="font-medium"></p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">Feuerwehr-Status</label>
                        <p id="reg-feuerwehr" class="font-medium"></p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">Korrespondenz</label>
                        <p id="reg-korrespondenz" class="font-medium"></p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">Eingegangen am</label>
                        <p id="reg-datum" class="font-medium"></p>
                    </div>
                </div>

                <input type="hidden" id="registration-id">

                <div id="registration-actions" class="mt-6 space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Als Status aufnehmen:</label>
                        <select id="reg-member-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="Passivmitglied">Passivmitglied</option>
                            <option value="Aktivmitglied">Aktivmitglied</option>
                        </select>
                    </div>
                    <div class="flex space-x-3">
                        <button id="approve-registration-btn" class="flex-1 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">
                            Genehmigen
                        </button>
                        <button id="reject-registration-btn" class="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                            Ablehnen
                        </button>
                    </div>
                </div>

                <div id="registration-processed" class="mt-6 hidden">
                    <div class="bg-gray-100 rounded-lg p-4">
                        <p class="text-sm text-gray-600">Bearbeitet von: <span id="reg-processed-by"></span></p>
                        <p class="text-sm text-gray-600">Am: <span id="reg-processed-at"></span></p>
                        <p id="reg-rejection-reason" class="text-sm text-red-600 mt-2 hidden"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Modal (simplified) -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="event-modal-title" class="text-2xl font-bold text-gray-800">Event bearbeiten</h3>
                    <button id="close-event-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <form id="event-form" class="space-y-6">
                    <input type="hidden" id="event-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Basis-Informationen -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Titel *</label>
                            <input type="text" id="event-title" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Untertitel</label>
                            <input type="text" id="event-subtitle" placeholder="z.B. Roter Schopf" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Slug *</label>
                            <input type="text" id="event-slug" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kategorie</label>
                            <select id="event-category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                <option value="Dorffest">Dorffest</option>
                                <option value="Aufbau">Aufbau</option>
                                <option value="Abbau">Abbau</option>
                                <option value="Ausflug">Ausflug</option>
                                <option value="Ausflug mit Anmeldung">Ausflug mit Anmeldung</option>
                                <option value="Sonstiges">Sonstiges</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="event-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                <option value="planned">Geplant</option>
                                <option value="confirmed">Bestaetigt</option>
                                <option value="cancelled">Abgesagt</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Start-Datum *</label>
                            <input type="datetime-local" id="event-start-date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">End-Datum</label>
                            <input type="datetime-local" id="event-end-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ort</label>
                            <input type="text" id="event-location" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Organisator Name</label>
                            <input type="text" id="event-organizer-name" placeholder="z.B. Max Muster" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Organisator E-Mail</label>
                            <input type="email" id="event-organizer-email" placeholder="max@example.ch" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="event-create-access" class="rounded border-gray-300 text-fire-500 focus:ring-fire-500">
                                <span class="text-sm font-medium text-gray-700">Organisator-Zugang erstellen</span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1">Erstellt Login fuer Event-Dashboard und sendet Zugangsdaten per E-Mail</p>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Beschreibung</label>
                            <textarea id="event-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500"></textarea>
                        </div>

                        <!-- Anmeldung (fuer Teilnehmer-Events wie Ausfluege) -->
                        <div id="registration-section" class="md:col-span-2 border-t pt-4 mt-2 contents">
                            <div class="md:col-span-2">
                                <h4 class="font-medium text-gray-800 mb-3">Teilnehmer-Anmeldung</h4>
                                <p class="text-xs text-gray-500 mb-3">Fuer Ausfluege, Aufbau/Abbau und andere Events mit Teilnehmer-Anmeldung</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Anmeldeschluss</label>
                                <input type="datetime-local" id="event-registration-deadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Max. Teilnehmer</label>
                                <input type="number" id="event-max-participants" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kosten</label>
                                <input type="text" id="event-cost" placeholder="z.B. CHF 20.- oder Kostenlos" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <!-- Platzhalter -->
                            </div>
                        </div>

                        <!-- Schichten (fuer Dorffest/Helfer-Events) -->
                        <div id="shifts-section" class="md:col-span-2 border-t pt-4 mt-2">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-medium text-gray-800">Helfer-Schichten</h4>
                                <div class="flex gap-3">
                                    <button type="button" onclick="generateSpringerShifts()" class="text-sm text-blue-600 hover:text-blue-800" title="Erstellt Springer-Schichten fuer alle existierenden Zeitslots">Springer generieren</button>
                                    <button type="button" onclick="addShiftRow()" class="text-sm text-fire-600 hover:text-fire-800">+ Schicht hinzufuegen</button>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mb-3">Fuer Dorffeste und andere Events mit Helfer-Einsaetzen</p>
                            <div id="event-shifts-container" class="space-y-3">
                                <!-- Shifts will be added here dynamically -->
                            </div>
                        </div>

                        <!-- Hinweis wenn keine Anmeldung -->
                        <div id="no-registration-hint" class="md:col-span-2 border-t pt-4 mt-2 hidden">
                            <p class="text-sm text-gray-500 italic">Bei "Ausflug" ist keine Anmeldung erforderlich. Waehle "Ausflug mit Anmeldung" wenn eine Anmeldung benoetigt wird.</p>
                        </div>
                    </div>
                    <div class="flex justify-between pt-4 border-t">
                        <button type="button" id="delete-event-btn" class="text-red-600 hover:text-red-700 font-medium hidden">Loeschen</button>
                        <div class="flex space-x-3">
                            <button type="button" id="cancel-event-btn" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">Abbrechen</button>
                            <button type="submit" class="px-6 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">Speichern</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Event Registrations Modal -->
    <div id="event-registrations-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="event-reg-modal-title" class="text-2xl font-bold text-gray-800">Anmeldungen verwalten</h3>
                    <div class="flex items-center gap-3">
                        <button onclick="downloadTeilnehmerliste()" class="px-4 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            PDF
                        </button>
                        <button onclick="closeEventRegistrationsModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                    </div>
                </div>
                <div id="event-reg-content">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Alternative Schicht vorschlagen Modal -->
    <div id="suggest-alternative-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-lg w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Alternative Schicht vorschlagen</h3>
                    <button onclick="closeSuggestAlternativeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div class="space-y-4">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-sm text-gray-600">Anmeldung von:</p>
                        <p id="suggest-alt-person" class="font-semibold text-gray-800"></p>
                        <p id="suggest-alt-current-shift" class="text-sm text-gray-500"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Alternative Schicht *</label>
                        <select id="suggest-alt-shift" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            <option value="">Bitte waehlen...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nachricht an die Person</label>
                        <textarea id="suggest-alt-comment" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500" placeholder="z.B. Leider ist diese Schicht bereits voll besetzt. Waerst du bereit, stattdessen folgende Schicht zu uebernehmen?"></textarea>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button onclick="sendAlternativeSuggestion()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Vorschlag senden
                        </button>
                        <button onclick="closeSuggestAlternativeModal()" class="flex-1 border border-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors">
                            Abbrechen
                        </button>
                    </div>
                </div>
                <input type="hidden" id="suggest-alt-registration-id">
                <input type="hidden" id="suggest-alt-email">
            </div>
        </div>
    </div>

    <!-- Edit Registration Modal -->
    <div id="edit-registration-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Anmeldung bearbeiten</h3>
                    <button onclick="closeEditRegistrationModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                        <input type="text" id="edit-reg-name" autocomplete="new-password" data-lpignore="true" data-form-type="other" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">E-Mail</label>
                        <input type="email" id="edit-reg-email" autocomplete="new-password" data-lpignore="true" data-form-type="other" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefon</label>
                        <input type="text" id="edit-reg-phone" autocomplete="new-password" data-lpignore="true" data-form-type="other" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button onclick="saveRegistrationEdit()" class="flex-1 bg-fire-500 text-white py-2 px-4 rounded-lg hover:bg-fire-600 transition-colors">
                            Speichern
                        </button>
                        <button onclick="closeEditRegistrationModal()" class="flex-1 border border-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors">
                            Abbrechen
                        </button>
                    </div>
                </div>
                <input type="hidden" id="edit-reg-id">
            </div>
        </div>
    </div>

    <!-- Add Shift Modal -->
    <div id="add-shift-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Neue Schicht erstellen</h3>
                    <button onclick="closeAddShiftModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bereich *</label>
                        <select id="add-shift-bereich" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            <!-- Options werden via JavaScript aus SHIFT_TYPES generiert -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                        <input type="text" id="add-shift-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500" placeholder="z.B. Schicht 1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Datum *</label>
                        <input type="date" id="add-shift-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Von *</label>
                            <input type="time" id="add-shift-start" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bis *</label>
                            <input type="time" id="add-shift-end" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Benoetigte Personen</label>
                        <input type="number" id="add-shift-needed" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500" value="2" min="1">
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button onclick="saveNewShift()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                            Schicht erstellen
                        </button>
                        <button onclick="closeAddShiftModal()" class="flex-1 border border-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors">
                            Abbrechen
                        </button>
                    </div>
                </div>
                <input type="hidden" id="add-shift-event-id">
            </div>
        </div>
    </div>

    <!-- Add Person to Shift Modal -->
    <div id="add-person-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Person hinzufuegen</h3>
                    <button onclick="closeAddPersonModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div class="mb-4 text-sm text-gray-600" id="add-person-shift-info"></div>
                <div class="space-y-4">
                    <!-- Toggle between Member and Guest -->
                    <div class="flex border rounded-lg overflow-hidden">
                        <button id="add-person-tab-member" onclick="switchAddPersonTab('member')" class="flex-1 py-2 px-4 bg-fire-500 text-white font-medium">Mitglied</button>
                        <button id="add-person-tab-guest" onclick="switchAddPersonTab('guest')" class="flex-1 py-2 px-4 bg-gray-100 text-gray-700 font-medium">Gast</button>
                    </div>

                    <!-- Member Selection -->
                    <div id="add-person-member-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mitglied auswaehlen *</label>
                        <select id="add-person-member" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            <option value="">Bitte waehlen...</option>
                        </select>
                    </div>

                    <!-- Guest Input -->
                    <div id="add-person-guest-section" class="hidden space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                            <input type="text" id="add-person-name" autocomplete="new-password" data-lpignore="true" data-form-type="other" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">E-Mail</label>
                            <input type="email" id="add-person-email" autocomplete="new-password" data-lpignore="true" data-form-type="other" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefon</label>
                            <input type="text" id="add-person-phone" autocomplete="new-password" data-lpignore="true" data-form-type="other" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                        </div>
                    </div>

                    <div class="flex space-x-3 pt-4">
                        <button onclick="saveAddPerson()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                            Hinzufuegen
                        </button>
                        <button onclick="closeAddPersonModal()" class="flex-1 border border-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors">
                            Abbrechen
                        </button>
                    </div>
                </div>
                <input type="hidden" id="add-person-shift-id">
                <input type="hidden" id="add-person-mode" value="member">
            </div>
        </div>
    </div>

    <!-- Template Editor Modal -->
    <div id="template-editor-modal" class="fixed inset-0 bg-black/50 z-50 hidden">
        <div class="h-full w-full bg-white flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b bg-gray-50">
                <h2 class="text-xl font-bold text-gray-800">Template-Editor</h2>
                <div class="flex items-center gap-4">
                    <button onclick="saveCurrentTemplate()" class="px-4 py-2 bg-fire-600 text-white rounded-lg hover:bg-fire-700 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        Speichern
                    </button>
                    <button onclick="closeTemplateEditor()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 flex overflow-hidden">
                <!-- Left: Template List -->
                <div class="w-64 border-r bg-gray-50 flex flex-col">
                    <div class="p-4 border-b space-y-2">
                        <button onclick="createNewTemplate()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            Einzelnes Template
                        </button>
                        <button onclick="createTemplateGroup()" class="w-full px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                            Template-Gruppe (üìßüá®üá≠üá©üá™)
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2" id="template-list-container">
                        <!-- Templates werden hier geladen -->
                    </div>
                </div>

                <!-- Center: Editor -->
                <div class="flex-1 flex flex-col">
                    <!-- Template Meta -->
                    <div class="p-4 border-b bg-white grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                            <input type="text" id="template-edit-name" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-fire-500" placeholder="Template-Name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Typ</label>
                            <div class="text-sm text-gray-600 py-2">E-Mail Template</div>
                            <input type="hidden" id="template-edit-type" value="email">
                            <p class="text-xs text-gray-500">
                                F√ºr Brief/PDF-Templates: <a href="https://pdf.fwv-raura.ch" target="_blank" class="text-blue-600 hover:underline">PDF-Designer</a>
                            </p>
                        </div>
                        <div id="template-subject-row">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Betreff</label>
                            <input type="text" id="template-edit-subject" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-fire-500" placeholder="E-Mail Betreff">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bezug</label>
                            <select id="template-edit-context" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-fire-500" onchange="onTemplateContextChange()">
                                <option value="allgemein">Allgemein</option>
                                <option value="event">Event / Veranstaltung</option>
                                <option value="finanzen">Finanzen / Beitrag</option>
                                <option value="schicht">Schicht / Einsatz</option>
                                <option value="geburtstag">Geburtstag</option>
                            </select>
                        </div>
                    </div>

                    <!-- Quill Editor -->
                    <div class="flex-1 flex">
                        <!-- Editor Area -->
                        <div class="flex-1 p-4 flex flex-col">
                            <div id="template-editor-quill" class="flex-1 border rounded-lg"></div>
                        </div>

                        <!-- Variables Sidebar -->
                        <div class="w-64 border-l bg-gray-50 p-3 overflow-y-auto">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">Variablen einf√ºgen</h4>
                            <p class="text-xs text-gray-500 mb-3">Klicke auf eine Variable um sie einzuf√ºgen</p>

                            <!-- Mitglied -->
                            <div class="mb-3">
                                <div class="text-xs font-semibold text-blue-600 mb-1">Mitglied</div>
                                <div class="variable-table bg-white rounded border">
                                    <table>
                                        <tr onclick="insertPlaceholder('anrede')"><td class="var-name">{{anrede}}</td><td class="text-gray-500">Herr/Frau</td></tr>
                                        <tr onclick="insertPlaceholder('vorname')"><td class="var-name">{{vorname}}</td><td class="text-gray-500">Vorname</td></tr>
                                        <tr onclick="insertPlaceholder('nachname')"><td class="var-name">{{nachname}}</td><td class="text-gray-500">Nachname</td></tr>
                                        <tr onclick="insertPlaceholder('strasse')"><td class="var-name">{{strasse}}</td><td class="text-gray-500">Strasse</td></tr>
                                        <tr onclick="insertPlaceholder('plz')"><td class="var-name">{{plz}}</td><td class="text-gray-500">PLZ</td></tr>
                                        <tr onclick="insertPlaceholder('ort')"><td class="var-name">{{ort}}</td><td class="text-gray-500">Ort</td></tr>
                                        <tr onclick="insertPlaceholder('email')"><td class="var-name">{{email}}</td><td class="text-gray-500">E-Mail</td></tr>
                                    </table>
                                </div>
                            </div>

                            <!-- Event (collapsible) -->
                            <details class="mb-3" id="var-section-event">
                                <summary class="text-xs font-semibold text-green-600 cursor-pointer mb-1">Event</summary>
                                <div class="variable-table bg-white rounded border">
                                    <table>
                                        <tr onclick="insertPlaceholder('event_titel')"><td class="var-name">{{event_titel}}</td><td class="text-gray-500">Titel</td></tr>
                                        <tr onclick="insertPlaceholder('event_datum')"><td class="var-name">{{event_datum}}</td><td class="text-gray-500">Datum</td></tr>
                                        <tr onclick="insertPlaceholder('event_zeit')"><td class="var-name">{{event_zeit}}</td><td class="text-gray-500">Zeit</td></tr>
                                        <tr onclick="insertPlaceholder('event_ort')"><td class="var-name">{{event_ort}}</td><td class="text-gray-500">Ort</td></tr>
                                        <tr onclick="insertPlaceholder('event_beschreibung')"><td class="var-name">{{event_beschreibung}}</td><td class="text-gray-500">Beschreibung</td></tr>
                                    </table>
                                </div>
                            </details>

                            <!-- Finanzen (collapsible) -->
                            <details class="mb-3" id="var-section-finanzen">
                                <summary class="text-xs font-semibold text-amber-600 cursor-pointer mb-1">Finanzen</summary>
                                <div class="variable-table bg-white rounded border">
                                    <table>
                                        <tr onclick="insertPlaceholder('beitrag')"><td class="var-name">{{beitrag}}</td><td class="text-gray-500">Betrag</td></tr>
                                        <tr onclick="insertPlaceholder('beitragsjahr')"><td class="var-name">{{beitragsjahr}}</td><td class="text-gray-500">Jahr</td></tr>
                                        <tr onclick="insertPlaceholder('zahlungsfrist')"><td class="var-name">{{zahlungsfrist}}</td><td class="text-gray-500">Frist</td></tr>
                                        <tr onclick="insertPlaceholder('iban')"><td class="var-name">{{iban}}</td><td class="text-gray-500">IBAN</td></tr>
                                        <tr onclick="insertPlaceholder('qr_referenz')"><td class="var-name">{{qr_referenz}}</td><td class="text-gray-500">QR-Ref</td></tr>
                                        <tr onclick="insertPlaceholder('kassier_name')"><td class="var-name">{{kassier_name}}</td><td class="text-gray-500">Kassier</td></tr>
                                    </table>
                                </div>
                            </details>

                            <!-- Schicht (collapsible) -->
                            <details class="mb-3" id="var-section-schicht">
                                <summary class="text-xs font-semibold text-purple-600 cursor-pointer mb-1">Schicht</summary>
                                <div class="variable-table bg-white rounded border">
                                    <table>
                                        <tr onclick="insertPlaceholder('schicht_typ')"><td class="var-name">{{schicht_typ}}</td><td class="text-gray-500">Typ</td></tr>
                                        <tr onclick="insertPlaceholder('schicht_datum')"><td class="var-name">{{schicht_datum}}</td><td class="text-gray-500">Datum</td></tr>
                                        <tr onclick="insertPlaceholder('schicht_zeit')"><td class="var-name">{{schicht_zeit}}</td><td class="text-gray-500">Zeit</td></tr>
                                        <tr onclick="insertPlaceholder('schicht_event')"><td class="var-name">{{schicht_event}}</td><td class="text-gray-500">Event</td></tr>
                                    </table>
                                </div>
                            </details>

                            <!-- Geburtstag (collapsible) -->
                            <details class="mb-3" id="var-section-geburtstag">
                                <summary class="text-xs font-semibold text-pink-600 cursor-pointer mb-1">Geburtstag</summary>
                                <div class="variable-table bg-white rounded border">
                                    <table>
                                        <tr onclick="insertPlaceholder('geburtstag')"><td class="var-name">{{geburtstag}}</td><td class="text-gray-500">Datum</td></tr>
                                        <tr onclick="insertPlaceholder('alter')"><td class="var-name">{{alter}}</td><td class="text-gray-500">Alter</td></tr>
                                        <tr onclick="insertPlaceholder('mitglied_seit')"><td class="var-name">{{mitglied_seit}}</td><td class="text-gray-500">Seit</td></tr>
                                        <tr onclick="insertPlaceholder('mitgliedsjahre')"><td class="var-name">{{mitgliedsjahre}}</td><td class="text-gray-500">Jahre</td></tr>
                                    </table>
                                </div>
                            </details>

                            <button type="button" onclick="addCustomPlaceholder()" class="w-full text-xs px-2 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 mt-2">
                                + Eigene Variable...
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right: Preview Panel with Tabs -->
                <div class="w-[500px] border-l bg-gray-100 flex flex-col overflow-hidden">
                    <!-- Preview Tabs -->
                    <div class="flex border-b bg-white">
                        <button id="preview-tab-email" onclick="switchPreviewTab('email')" class="flex-1 px-4 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600 bg-blue-50 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            E-Mail
                        </button>
                        <button id="preview-tab-letter" onclick="switchPreviewTab('letter')" class="flex-1 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Brief
                        </button>
                    </div>

                    <!-- Email Preview Content -->
                    <div id="preview-content-email" class="flex-1 overflow-y-auto p-4">
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                            <div class="px-4 py-3 bg-gray-50 border-b">
                                <div class="text-sm text-gray-600"><strong>An:</strong> max.muster@example.ch</div>
                                <div class="text-sm text-gray-600"><strong>Betreff:</strong> <span id="preview-email-subject" class="text-gray-800">-</span></div>
                            </div>
                            <div id="preview-email-body" class="p-4 dispatch-preview-html min-h-[300px]"></div>
                        </div>
                    </div>

                    <!-- Letter Preview Content -->
                    <div id="preview-content-letter" class="flex-1 overflow-y-auto p-4 hidden">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-sm font-medium text-gray-700">Format:</span>
                            <select id="preview-letter-country" class="text-sm border rounded px-3 py-1" onchange="updateLetterPreview()">
                                <option value="CH">üá®üá≠ Schweiz</option>
                                <option value="DE">üá©üá™ Deutschland</option>
                            </select>
                        </div>
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                            <div class="letter-preview-a4 text-sm mx-auto" style="transform: scale(0.5); transform-origin: top center; height: 600px;">
                                <div id="letter-address-zone" class="letter-address-zone-ch">
                                    <div class="p-2 text-red-400 text-center text-xs font-medium">üìÆ Adressfeld<br>(automatisch)</div>
                                </div>
                                <div class="mt-[65mm]" id="preview-letter-body"></div>
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-amber-50 rounded-lg text-sm text-amber-800">
                            <strong>‚ÑπÔ∏è Hinweis:</strong> Die Empf√§ngeradresse wird beim Versand automatisch eingef√ºgt.<br>
                            <span class="text-xs">CH: rechts (Schweizer Fensterkuvert) | DE: links (DIN 5008)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        const API_BASE = 'https://api.fwv-raura.ch';
        const DISPATCH_API = 'https://api.fwv-raura.ch';

        // ============================================
        // ZENTRALE KONSTANTEN (Single Source of Truth)
        // ============================================

        const SHIFT_TYPES = [
            { value: 'Allgemein', label: 'Allgemein' },
            { value: 'Kueche', label: 'K√ºche' },
            { value: 'Bar', label: 'Bar' },
            { value: 'Service', label: 'Service' },
            { value: 'Kasse', label: 'Kasse' },
            { value: 'Springer', label: 'Springer' },
            { value: 'Vorbereitung', label: 'Vorbereitung' },
            { value: 'Aufbau', label: 'Aufbau' },
            { value: 'Abbau', label: 'Abbau' }
        ];

        const MEMBER_STATUS_TYPES = [
            { value: 'Aktivmitglied', label: 'Aktivmitglied', color: 'bg-green-100 text-green-800' },
            { value: 'Passivmitglied', label: 'Passivmitglied', color: 'bg-blue-100 text-blue-800' },
            { value: 'Ehrenmitglied', label: 'Ehrenmitglied', color: 'bg-yellow-100 text-yellow-800' }
        ];

        // Helper to safely escape strings for use in template literals and onclick handlers
        function escapeForOnclick(str) {
            if (!str) return '';
            return String(str)
                .replace(/\\/g, '\\\\')     // Escape backslashes first
                .replace(/`/g, '\\`')       // Escape backticks for template literals
                .replace(/\$/g, '\\$')      // Escape $ to prevent ${} interpolation
                .replace(/'/g, "\\'");      // Escape single quotes for onclick
        }

        const VORSTAND_ROLES = ['Pr√§sident', 'Aktuar', 'Kassier', 'Materialwart', 'Beisitzer'];

        // Toast notification function
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            toast.className = `${colors[type] || colors.info} text-white px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
            toast.textContent = message;

            container.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full');
            });

            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ============================================
        // TEMPLATE EDITOR (Quill)
        // ============================================

        let templateEditor = null;
        let currentEditingTemplate = null;
        let editorTemplates = [];

        const sampleMemberData = {
            // Mitglieder-Daten
            anrede: 'Herr',
            vorname: 'Max',
            nachname: 'Mustermann',
            strasse: 'Musterstrasse 1',
            plz: '6000',
            ort: 'Luzern',
            email: 'max.muster@example.ch',
            // Event-Daten
            event_titel: 'Generalversammlung 2026',
            event_datum: '15. M√§rz 2026',
            event_zeit: '19:00 Uhr',
            event_ort: 'Vereinslokal Raura',
            event_beschreibung: 'Jahresr√ºckblick und Wahlen',
            // Finanzen-Daten
            beitrag: 'CHF 50.00',
            beitragsjahr: '2026',
            zahlungsfrist: '31. M√§rz 2026',
            iban: 'CH93 0076 2011 6238 5295 7',
            qr_referenz: '00 00000 00000 00000 00000 00000',
            kassier_name: 'Hans Kassier',
            // Schicht-Daten
            schicht_typ: 'Bar',
            schicht_datum: '15. M√§rz 2026',
            schicht_zeit: '18:00 - 22:00',
            schicht_event: 'Generalversammlung 2026',
            // Geburtstag-Daten
            geburtstag: '15. Januar',
            alter: '45',
            mitglied_seit: '2010',
            mitgliedsjahre: '16'
        };

        function openTemplateEditor() {
            document.getElementById('template-editor-modal').classList.remove('hidden');
            loadEditorTemplates();
            if (!templateEditor) {
                initQuillEditor();
            }
        }

        function closeTemplateEditor() {
            document.getElementById('template-editor-modal').classList.add('hidden');
        }

        function initQuillEditor() {
            templateEditor = new Quill('#template-editor-quill', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        ['clean']
                    ]
                },
                placeholder: 'Schreiben Sie Ihren Text hier...'
            });

            // Set default content
            templateEditor.root.innerHTML = '<p>Sehr geehrte(r) {{anrede}} {{nachname}},</p><p><br></p><p>Ihr Text hier...</p><p><br></p><p>Freundliche Gr√ºsse</p><p>Feuerwehrverein Raura</p>';

            // Update preview on text change
            templateEditor.on('text-change', function() {
                updateTemplatePreview();
            });

            createNewTemplate();
        }

        async function loadEditorTemplates() {
            try {
                const response = await fetch(`${API_BASE}/templates`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                editorTemplates = await response.json();
                renderTemplateList();
            } catch (error) {
                showToast('Fehler beim Laden der Templates', 'error');
            }
        }

        function renderTemplateList() {
            const container = document.getElementById('template-list-container');

            // Group templates by base name (without _email, _brief_ch, _brief_de suffix)
            const groups = {};
            const standalone = [];

            editorTemplates.forEach(t => {
                const suffixMatch = t.name.match(/^(.+?)_(email|brief_ch|brief_de)$/);
                if (suffixMatch) {
                    const baseName = suffixMatch[1];
                    if (!groups[baseName]) groups[baseName] = [];
                    groups[baseName].push(t);
                } else {
                    standalone.push(t);
                }
            });

            let html = '';

            // Render grouped templates
            Object.keys(groups).sort().forEach(baseName => {
                const templates = groups[baseName];
                html += `<div class="mb-3">
                    <div class="text-xs font-semibold text-gray-500 uppercase px-2 py-1 bg-gray-100 rounded">${baseName}</div>
                    <div class="ml-2 border-l-2 border-gray-200 pl-2 mt-1">`;
                templates.sort((a, b) => a.name.localeCompare(b.name)).forEach(t => {
                    const suffix = t.name.replace(baseName + '_', '');
                    const icon = suffix === 'email' ? 'üìß' : (suffix === 'brief_ch' ? 'üá®üá≠' : 'üá©üá™');
                    const label = suffix === 'email' ? 'E-Mail' : (suffix === 'brief_ch' ? 'Brief CH' : 'Brief DE');
                    html += `<div class="p-2 rounded mb-1 cursor-pointer hover:bg-gray-200 ${currentEditingTemplate?.id === t.id ? 'bg-fire-100' : 'bg-white'}"
                         onclick="loadTemplateForEdit('${t.id}')">
                        <div class="flex justify-between items-center">
                            <span class="text-sm">${icon} ${label}</span>
                            <button onclick="event.stopPropagation(); deleteTemplate('${t.id}')" class="text-red-400 hover:text-red-600 p-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>`;
                });
                html += `</div></div>`;
            });

            // Render standalone templates
            standalone.forEach(t => {
                html += `<div class="p-2 rounded-lg mb-1 cursor-pointer hover:bg-gray-200 ${currentEditingTemplate?.id === t.id ? 'bg-fire-100' : 'bg-white'}"
                     onclick="loadTemplateForEdit('${t.id}')">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium text-sm">${t.name}</div>
                            <div class="text-xs text-gray-500">${t.type === 'email' ? 'üìß E-Mail' : 'üì¨ Brief'}</div>
                        </div>
                        <button onclick="event.stopPropagation(); deleteTemplate('${t.id}')" class="text-red-500 hover:text-red-700 p-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>`;
            });

            container.innerHTML = html || '<p class="text-sm text-gray-500 p-2">Keine Templates</p>';
        }

        function loadTemplateForEdit(templateId) {
            const template = editorTemplates.find(t => t.id === templateId);
            if (!template) return;
            currentEditingTemplate = template;
            document.getElementById('template-edit-name').value = template.name;
            document.getElementById('template-edit-type').value = template.type;
            document.getElementById('template-edit-subject').value = template.subject || '';

            // Check auto-address setting (default: true, unless _no_auto_address is in variables)
            const hasNoAutoAddress = template.variables && template.variables.includes('_no_auto_address');
            document.getElementById('template-edit-autoaddress').checked = !hasNoAutoAddress;

            // Convert plain text to HTML if needed
            let body = template.body || '';
            if (!body.includes('<') || !body.includes('>')) {
                // Plain text - convert to HTML
                body = body.split('\n').map(line => line.trim() ? `<p>${line}</p>` : '<p><br></p>').join('');
            }
            templateEditor.root.innerHTML = body;

            onTemplateTypeChange();
            renderTemplateList();
            updateTemplatePreview();
        }

        function createNewTemplate() {
            currentEditingTemplate = null;
            document.getElementById('template-edit-name').value = '';
            document.getElementById('template-edit-type').value = 'email';
            document.getElementById('template-edit-subject').value = '';
            document.getElementById('template-edit-autoaddress').checked = true;
            if (templateEditor) {
                templateEditor.root.innerHTML = '<p>Sehr geehrte(r) {{anrede}} {{nachname}},</p><p><br></p><p>Ihr Text hier...</p><p><br></p><p>Freundliche Gr√ºsse</p><p>Feuerwehrverein Raura</p>';
            }
            onTemplateTypeChange();
            renderTemplateList();
            updateTemplatePreview();
        }

        async function createTemplateGroup() {
            const baseName = prompt('Name der Template-Gruppe (z.B. "event_einladung"):');
            if (!baseName || !baseName.trim()) return;

            const name = baseName.trim().toLowerCase().replace(/\s+/g, '_');
            const defaultBody = '<div style="font-family:Arial,sans-serif;padding:20px;"><p>Sehr geehrte(r) {{anrede}} {{nachname}},</p><p>Ihr Text hier...</p><p style="margin-top:30px;">Freundliche Gr√ºsse<br>Feuerwehrverein Raura</p></div>';

            const templates = [
                { name: `${name}_email`, type: 'email', subject: '', body: defaultBody, variables: [] },
                { name: `${name}_brief_ch`, type: 'post', subject: '', body: defaultBody, variables: [] },
                { name: `${name}_brief_de`, type: 'post', subject: '', body: defaultBody, variables: [] }
            ];

            try {
                for (const tpl of templates) {
                    await fetch(`${API_BASE}/templates`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify(tpl)
                    });
                }
                showToast(`Template-Gruppe "${name}" erstellt!`, 'success');
                loadEditorTemplates();
                loadDispatchTemplates();
            } catch (error) {
                showToast('Fehler beim Erstellen', 'error');
            }
        }

        async function saveCurrentTemplate() {
            const name = document.getElementById('template-edit-name').value.trim();
            const type = document.getElementById('template-edit-type').value;
            const subject = document.getElementById('template-edit-subject').value.trim();
            const autoAddress = document.getElementById('template-edit-autoaddress').checked;
            const body = templateEditor.root.innerHTML;
            if (!name) { showToast('Bitte Template-Namen eingeben', 'error'); return; }

            const variableMatches = body.match(/\{\{(\w+)\}\}/g) || [];
            let variables = [...new Set(variableMatches.map(v => v.replace(/[{}]/g, '')))];

            // Add auto-address setting for post templates
            if (type === 'post' && !autoAddress) {
                variables.push('_no_auto_address');
            }

            try {
                const url = currentEditingTemplate ? `${API_BASE}/templates/${currentEditingTemplate.id}` : `${API_BASE}/templates`;
                const method = currentEditingTemplate ? 'PUT' : 'POST';
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ name, type, subject, body, variables })
                });
                if (!response.ok) throw new Error('Fehler');
                currentEditingTemplate = await response.json();
                showToast('Template gespeichert!', 'success');
                loadEditorTemplates();
                loadDispatchTemplates();
            } catch (error) {
                showToast('Fehler beim Speichern', 'error');
            }
        }

        async function deleteTemplate(templateId) {
            if (!confirm('Template wirklich l√∂schen?')) return;
            try {
                await fetch(`${API_BASE}/templates/${templateId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                showToast('Template gel√∂scht', 'success');
                if (currentEditingTemplate?.id === templateId) createNewTemplate();
                loadEditorTemplates();
                loadDispatchTemplates();
            } catch (error) {
                showToast('Fehler beim L√∂schen', 'error');
            }
        }

        function onTemplateTypeChange() {
            const type = document.getElementById('template-edit-type').value;
            document.getElementById('template-subject-row').style.display = type === 'email' ? 'block' : 'none';
            document.getElementById('template-autoaddress-row').style.display = type === 'post' ? 'block' : 'none';
            updateTemplatePreview();
        }

        function onTemplateContextChange() {
            const context = document.getElementById('template-edit-context').value;
            // Open relevant variable sections
            const sections = ['event', 'finanzen', 'schicht', 'geburtstag'];
            sections.forEach(s => {
                const el = document.getElementById(`var-section-${s}`);
                if (el) el.open = false;
            });
            if (context === 'event') document.getElementById('var-section-event').open = true;
            if (context === 'finanzen') document.getElementById('var-section-finanzen').open = true;
            if (context === 'schicht') {
                document.getElementById('var-section-schicht').open = true;
                document.getElementById('var-section-event').open = true;
            }
            if (context === 'geburtstag') document.getElementById('var-section-geburtstag').open = true;
        }

        function insertPlaceholder(name) {
            if (!templateEditor) return;
            const range = templateEditor.getSelection(true);
            templateEditor.insertText(range.index, `{{${name}}}`);
            templateEditor.setSelection(range.index + name.length + 4);
            updateTemplatePreview();
        }

        function addCustomPlaceholder() {
            const name = prompt('Name der Variable (ohne {{}}):');
            if (name && /^\w+$/.test(name)) insertPlaceholder(name);
            else if (name) showToast('Ung√ºltiger Name (nur Buchstaben, Zahlen, _)', 'error');
        }

        function updateTemplatePreview() {
            if (!templateEditor) return;
            let html = templateEditor.root.innerHTML;
            const subject = document.getElementById('template-edit-subject').value;

            // Replace with sample data
            Object.keys(sampleMemberData).forEach(key => {
                html = html.replace(new RegExp(`\\{\\{${key}\\}\\}`, 'g'), `<span style="background:#fef3c7;">${sampleMemberData[key]}</span>`);
            });
            html = html.replace(/\{\{(\w+)\}\}/g, '<span style="background:#fee2e2;">{{$1}}</span>');

            document.getElementById('preview-email-subject').textContent = subject || '(kein Betreff)';
            document.getElementById('preview-email-body').innerHTML = html;
            document.getElementById('preview-letter-body').innerHTML = html;
            updateLetterPreview();
        }

        function switchPreviewTab(tab) {
            const emailTab = document.getElementById('preview-tab-email');
            const letterTab = document.getElementById('preview-tab-letter');
            const emailContent = document.getElementById('preview-content-email');
            const letterContent = document.getElementById('preview-content-letter');

            if (tab === 'email') {
                emailTab.className = 'flex-1 px-4 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600 bg-blue-50 flex items-center justify-center gap-2';
                letterTab.className = 'flex-1 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 flex items-center justify-center gap-2';
                emailContent.classList.remove('hidden');
                letterContent.classList.add('hidden');
            } else {
                letterTab.className = 'flex-1 px-4 py-3 text-sm font-medium border-b-2 border-amber-500 text-amber-600 bg-amber-50 flex items-center justify-center gap-2';
                emailTab.className = 'flex-1 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 flex items-center justify-center gap-2';
                letterContent.classList.remove('hidden');
                emailContent.classList.add('hidden');
            }
        }

        function updateLetterPreview() {
            const country = document.getElementById('preview-letter-country').value;
            const zone = document.getElementById('letter-address-zone');
            zone.className = country === 'CH' ? 'letter-address-zone-ch' : 'letter-address-zone-de';
            zone.innerHTML = country === 'CH'
                ? '<div class="p-2 text-red-400 text-center text-xs">CH Adressfeld<br>(rechts)</div>'
                : '<div class="p-2 text-blue-400 text-center text-xs">DE Adressfeld<br>(links, DIN)</div>';
        }

        // Helper: Generate <option> tags from SHIFT_TYPES
        function generateShiftTypeOptions(selectedValue = 'Allgemein') {
            return SHIFT_TYPES.map(t =>
                `<option value="${t.value}" ${selectedValue === t.value ? 'selected' : ''}>${t.label}</option>`
            ).join('');
        }

        // Helper: Get member status color class
        function getMemberStatusColor(status) {
            const found = MEMBER_STATUS_TYPES.find(s => s.value === status);
            return found ? found.color : 'bg-gray-100 text-gray-800';
        }

        let members = [];
        let events = [];
        let auditLog = [];
        let authToken = null;
        let currentUser = null;
        let currentTab = 'members';
        let currentEventForRegistrations = null;

        // ============================================
        // AUTHENTICATION
        // ============================================

        // Helper to get cookie value
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        async function checkAuth() {
            // Check localStorage first, then cookie (for cross-subdomain auth)
            let token = localStorage.getItem('vorstand_token');
            if (!token) {
                token = getCookie('vorstand_token');
                // Sync cookie to localStorage for consistency
                if (token) {
                    localStorage.setItem('vorstand_token', token);
                }
            }
            if (!token) {
                showLoginModal();
                return false;
            }

            authToken = token;

            try {
                const response = await fetch(`${API_BASE}/auth/vorstand/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) {
                    localStorage.removeItem('vorstand_token');
                    showLoginModal();
                    return false;
                }
                currentUser = await response.json();
                document.getElementById('user-info').textContent = currentUser.name;
                const userInfoMobile = document.getElementById('user-info-mobile');
                if (userInfoMobile) userInfoMobile.textContent = currentUser.name;
                hideLoginModal();

                // Check for redirect parameter
                const urlParams = new URLSearchParams(window.location.search);
                const redirectUrl = urlParams.get('redirect');
                if (redirectUrl && redirectUrl.startsWith('https://') && redirectUrl.includes('fwv-raura.ch')) {
                    window.location.href = redirectUrl;
                    return true;
                }

                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                localStorage.removeItem('vorstand_token');
                showLoginModal();
                return false;
            }
        }

        function showLoginModal() {
            document.getElementById('login-modal').classList.remove('hidden');
        }

        function hideLoginModal() {
            document.getElementById('login-modal').classList.add('hidden');
        }

        async function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            const errorEl = document.getElementById('login-error');

            btn.disabled = true;
            btn.textContent = 'Anmelden...';
            errorEl.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE}/auth/vorstand/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                    credentials: 'include' // Required for cross-origin cookies
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Login fehlgeschlagen');
                }

                localStorage.setItem('vorstand_token', data.token);
                // Set cookie for cross-subdomain auth (pdf.fwv-raura.ch, etc.)
                const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toUTCString(); // 7 days
                document.cookie = `vorstand_token=${data.token}; domain=.fwv-raura.ch; path=/; expires=${expires}; secure; samesite=lax`;

                authToken = data.token;
                currentUser = data.user;
                document.getElementById('user-info').textContent = currentUser.name;
                const userInfoMobile = document.getElementById('user-info-mobile');
                if (userInfoMobile) userInfoMobile.textContent = currentUser.name;

                hideLoginModal();

                // Check for redirect parameter (cookie handles cross-subdomain auth)
                const urlParams = new URLSearchParams(window.location.search);
                const redirectUrl = urlParams.get('redirect');
                if (redirectUrl && redirectUrl.startsWith('https://') && redirectUrl.includes('fwv-raura.ch')) {
                    // Add token to URL as backup for cross-domain auth
                    const separator = redirectUrl.includes('?') ? '&' : '?';
                    window.location.href = `${redirectUrl}${separator}token=${data.token}`;
                    return;
                }

                await loadStats();
                await loadMembers();

            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Anmelden';
            }
        }

        document.getElementById('login-form').addEventListener('submit', handleLogin);

        // ============================================
        // MEMBERS
        // ============================================

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/members/stats/overview`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to load stats');
                const stats = await response.json();
                document.getElementById('stat-total').textContent = stats.total || 0;
                document.getElementById('stat-aktiv').textContent = stats.aktiv || 0;
                document.getElementById('stat-passiv').textContent = stats.passiv || 0;
                document.getElementById('stat-ehren').textContent = stats.ehren || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadMembers(filters = {}) {
            try {
                document.getElementById('loading-state').classList.remove('hidden');
                document.getElementById('empty-state').classList.add('hidden');

                const params = new URLSearchParams(filters);
                const response = await fetch(`${API_BASE}/members?${params}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('vorstand_token');
                        showLoginModal();
                        return;
                    }
                    throw new Error('Failed to load members');
                }

                members = await response.json();
                renderMembers();
            } catch (error) {
                console.error('Error loading members:', error);
            } finally {
                document.getElementById('loading-state').classList.add('hidden');
            }
        }

        function renderMembers() {
            const tbody = document.getElementById('members-tbody');

            if (members.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }

            document.getElementById('empty-state').classList.add('hidden');

            tbody.innerHTML = members.map(member => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${member.vorname} ${member.nachname}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-600">${member.email || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-600">${member.mobile || member.telefon || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusClass(member.status)}">
                            ${member.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-600">${member.funktion || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editMember('${member.id}')" class="text-fire-600 hover:text-fire-800">
                            Bearbeiten
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusClass(status) {
            return getMemberStatusColor(status);
        }

        function openNewMemberModal() {
            document.getElementById('modal-title').textContent = 'Neues Mitglied';
            document.getElementById('member-form').reset();
            document.getElementById('member-id').value = '';
            document.getElementById('delete-member-btn').classList.add('hidden');
            // Reset photo preview
            document.getElementById('photo-preview').innerHTML = '<span class="text-gray-400 text-3xl">?</span>';
            document.getElementById('photo-delete-btn').classList.add('hidden');
            document.getElementById('member-modal').classList.remove('hidden');
        }

        async function editMember(id) {
            try {
                const response = await fetch(`${API_BASE}/members/${id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to load member');
                const member = await response.json();

                document.getElementById('modal-title').textContent = 'Mitglied bearbeiten';
                document.getElementById('member-id').value = member.id;
                document.getElementById('anrede').value = member.anrede || '';
                document.getElementById('vorname').value = member.vorname;
                document.getElementById('nachname').value = member.nachname;
                document.getElementById('geschlecht').value = member.geschlecht || '';
                document.getElementById('geburtstag').value = member.geburtstag || '';
                document.getElementById('strasse').value = member.strasse || '';
                document.getElementById('adresszusatz').value = member.adresszusatz || '';
                document.getElementById('plz').value = member.plz || '';
                document.getElementById('ort').value = member.ort || '';
                document.getElementById('telefon').value = member.telefon || '';
                document.getElementById('mobile').value = member.mobile || '';
                document.getElementById('email').value = member.email || '';
                document.getElementById('status').value = member.status || 'Aktivmitglied';

                // Set multiple function checkboxes
                const funktionen = (member.funktion || '').split(',').map(f => f.trim()).filter(f => f);
                document.querySelectorAll('input[name="funktion"]').forEach(cb => {
                    cb.checked = funktionen.includes(cb.value);
                });

                document.getElementById('eintrittsdatum').value = member.eintrittsdatum || '';
                document.getElementById('zustellung-email').checked = member.zustellung_email !== false;
                document.getElementById('zustellung-post').checked = member.zustellung_post === true;
                document.getElementById('bemerkungen').value = member.bemerkungen || '';

                document.getElementById('feuerwehr-zugehoerigkeit').value = member.feuerwehr_zugehoerigkeit || 'keine';

                // Load photo
                if (member.foto) {
                    document.getElementById('photo-preview').innerHTML = `<img src="${API_BASE}${member.foto}" class="w-full h-full object-cover">`;
                    document.getElementById('photo-delete-btn').classList.remove('hidden');
                } else {
                    document.getElementById('photo-preview').innerHTML = '<span class="text-gray-400 text-3xl">?</span>';
                    document.getElementById('photo-delete-btn').classList.add('hidden');
                }

                document.getElementById('delete-member-btn').classList.remove('hidden');
                document.getElementById('member-modal').classList.remove('hidden');

                // Load cloud permissions if member has Authentik account
                loadCloudPermissions(member.id);
            } catch (error) {
                console.error('Error loading member:', error);
                alert('Fehler beim Laden des Mitglieds');
            }
        }

        // Load cloud permissions for a member
        async function loadCloudPermissions(memberId) {
            const section = document.getElementById('cloud-permissions-section');
            const statusEl = document.getElementById('cloud-permissions-status');
            const nextcloudAdminStatus = document.getElementById('nextcloud-admin-status');
            const vorstandGroupStatus = document.getElementById('vorstand-group-status');
            const socialMediaGroupStatus = document.getElementById('social-media-group-status');

            // Reset and show loading
            section.classList.add('hidden');
            statusEl.textContent = 'Lade Berechtigungen...';
            nextcloudAdminStatus.textContent = '‚è≥';
            vorstandGroupStatus.textContent = '‚è≥';
            socialMediaGroupStatus.textContent = '‚è≥';

            try {
                // Check Nextcloud admin status
                const ncResponse = await fetch(`${API_BASE}/members/${memberId}/nextcloud-admin`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!ncResponse.ok) {
                    statusEl.textContent = 'Fehler beim Laden der Berechtigungen';
                    return;
                }

                const ncData = await ncResponse.json();

                if (!ncData.has_authentik) {
                    statusEl.textContent = 'Kein Authentik-Account vorhanden';
                    section.classList.remove('hidden');
                    nextcloudAdminStatus.textContent = '‚ùå';
                    vorstandGroupStatus.textContent = '‚ùå';
                    socialMediaGroupStatus.textContent = '‚ùå';
                    return;
                }

                // Check Vorstand group status
                const vsResponse = await fetch(`${API_BASE}/members/${memberId}/vorstand-group`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const vsData = vsResponse.ok ? await vsResponse.json() : { vorstand_group: false };

                // Check Social Media group status
                const smResponse = await fetch(`${API_BASE}/members/${memberId}/social-media-group`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const smData = smResponse.ok ? await smResponse.json() : { social_media_group: false };

                // Set status values
                nextcloudAdminStatus.textContent = ncData.nextcloud_admin ? '‚úÖ' : '‚ùå';
                vorstandGroupStatus.textContent = vsData.vorstand_group ? '‚úÖ' : '‚ùå';
                socialMediaGroupStatus.textContent = smData.social_media_group ? '‚úÖ' : '‚ùå';

                // Show section
                section.classList.remove('hidden');
                statusEl.textContent = '';
            } catch (error) {
                console.error('Error loading cloud permissions:', error);
                statusEl.textContent = 'Fehler beim Laden';
            }
        }

        // Sync cloud permissions based on functions
        async function syncCloudPermissions(memberId, funktionen) {
            const funktionenList = funktionen.split(',').map(f => f.trim());

            const isAdmin = funktionenList.includes('Admin');
            const isVorstand = funktionenList.some(f => VORSTAND_ROLES.includes(f));
            const isSocialMedia = funktionenList.includes('Social Media');

            const statusEl = document.getElementById('cloud-permissions-status');
            statusEl.textContent = 'Synchronisiere Cloud-Berechtigungen...';

            try {
                // Sync Nextcloud Admin
                await fetch(`${API_BASE}/members/${memberId}/nextcloud-admin`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled: isAdmin })
                });

                // Sync Vorstand group
                await fetch(`${API_BASE}/members/${memberId}/vorstand-group`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled: isVorstand })
                });

                // Sync Social Media group
                await fetch(`${API_BASE}/members/${memberId}/social-media-group`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled: isSocialMedia })
                });

                statusEl.textContent = 'Cloud-Berechtigungen synchronisiert';
                setTimeout(() => statusEl.textContent = '', 3000);

                // Reload permissions display
                loadCloudPermissions(memberId);
            } catch (error) {
                console.error('Error syncing cloud permissions:', error);
                statusEl.textContent = 'Fehler beim Synchronisieren';
            }
        }

        // Helper to get selected functions as comma-separated string
        function getSelectedFunktionen() {
            const checked = Array.from(document.querySelectorAll('input[name="funktion"]:checked'))
                .map(cb => cb.value);
            return checked.join(', ');
        }

        // Validate function selection (Revisor cannot be combined with Vorstand)
        function validateFunktionen() {
            const checked = Array.from(document.querySelectorAll('input[name="funktion"]:checked'))
                .map(cb => cb.value);
            const hasVorstand = checked.some(f => VORSTAND_ROLES.includes(f));
            const hasRevisor = checked.includes('Revisor');

            if (hasVorstand && hasRevisor) {
                alert('Revisor kann nicht mit Vorstand-Positionen kombiniert werden.');
                return false;
            }
            return true;
        }

        // Add event listener for Revisor validation
        document.querySelectorAll('input[name="funktion"]').forEach(cb => {
            cb.addEventListener('change', function() {
                const revisorCb = document.querySelector('input[name="funktion"][value="Revisor"]');
                const checked = Array.from(document.querySelectorAll('input[name="funktion"]:checked'))
                    .map(c => c.value);

                if (this.value === 'Revisor' && this.checked) {
                    // Uncheck all Vorstand roles when Revisor is selected
                    VORSTAND_ROLES.forEach(role => {
                        const cb = document.querySelector(`input[name="funktion"][value="${role}"]`);
                        if (cb) cb.checked = false;
                    });
                } else if (VORSTAND_ROLES.includes(this.value) && this.checked && revisorCb?.checked) {
                    // Uncheck Revisor when a Vorstand role is selected
                    revisorCb.checked = false;
                }
            });
        });

        async function saveMember(e) {
            e.preventDefault();

            // Validate function selection
            if (!validateFunktionen()) {
                return;
            }

            const id = document.getElementById('member-id').value;
            const data = {
                anrede: document.getElementById('anrede').value,
                vorname: document.getElementById('vorname').value,
                nachname: document.getElementById('nachname').value,
                geschlecht: document.getElementById('geschlecht').value,
                geburtstag: document.getElementById('geburtstag').value || null,
                strasse: document.getElementById('strasse').value,
                adresszusatz: document.getElementById('adresszusatz').value,
                plz: document.getElementById('plz').value,
                ort: document.getElementById('ort').value,
                telefon: document.getElementById('telefon').value,
                mobile: document.getElementById('mobile').value,
                email: document.getElementById('email').value,
                status: document.getElementById('status').value,
                funktion: getSelectedFunktionen(),
                eintrittsdatum: document.getElementById('eintrittsdatum').value || null,
                zustellung_email: document.getElementById('zustellung-email').checked,
                zustellung_post: document.getElementById('zustellung-post').checked,
                bemerkungen: document.getElementById('bemerkungen').value,
                feuerwehr_zugehoerigkeit: document.getElementById('feuerwehr-zugehoerigkeit').value
            };

            console.log('Saving member data:', data);

            try {
                const url = id ? `${API_BASE}/members/${id}` : `${API_BASE}/members`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Save member failed:', response.status, errorData);
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const savedMember = await response.json();

                // Sync cloud permissions based on functions (in background)
                if (savedMember.id) {
                    syncCloudPermissions(savedMember.id, data.funktion).catch(err => {
                        console.error('Cloud permissions sync failed:', err);
                    });
                }

                document.getElementById('member-modal').classList.add('hidden');
                await loadMembers();
                await loadStats();

            } catch (error) {
                console.error('Error saving member:', error);
                alert('Fehler beim Speichern: ' + error.message);
            }
        }

        async function deleteMember() {
            const id = document.getElementById('member-id').value;
            if (!id) return;
            if (!confirm('Mitglied wirklich loeschen?')) return;

            try {
                const response = await fetch(`${API_BASE}/members/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to delete member');

                document.getElementById('member-modal').classList.add('hidden');
                await loadMembers();
                await loadStats();
            } catch (error) {
                console.error('Error deleting member:', error);
                alert('Fehler beim Loeschen');
            }
        }

        // Photo upload handling
        async function uploadMemberPhoto(file) {
            const memberId = document.getElementById('member-id').value;
            if (!memberId) {
                alert('Bitte speichern Sie zuerst das Mitglied');
                return;
            }

            const formData = new FormData();
            formData.append('photo', file);

            try {
                const response = await fetch(`${API_BASE}/members/${memberId}/photo`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                if (!response.ok) throw new Error('Failed to upload photo');

                const data = await response.json();
                document.getElementById('photo-preview').innerHTML = `<img src="${API_BASE}${data.photo_url}" class="w-full h-full object-cover">`;
                document.getElementById('photo-delete-btn').classList.remove('hidden');
                await loadMembers();
            } catch (error) {
                console.error('Error uploading photo:', error);
                alert('Fehler beim Hochladen des Fotos');
            }
        }

        async function deleteMemberPhoto() {
            const memberId = document.getElementById('member-id').value;
            if (!memberId) return;
            if (!confirm('Foto wirklich entfernen?')) return;

            try {
                const response = await fetch(`${API_BASE}/members/${memberId}/photo`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to delete photo');

                document.getElementById('photo-preview').innerHTML = '<span class="text-gray-400 text-3xl">?</span>';
                document.getElementById('photo-delete-btn').classList.add('hidden');
                await loadMembers();
            } catch (error) {
                console.error('Error deleting photo:', error);
                alert('Fehler beim Entfernen des Fotos');
            }
        }

        function exportCSV(filter = 'all') {
            // CSV-Escape-Funktion fuer Felder mit Kommas oder Anfuehrungszeichen
            const escapeCSV = (value) => {
                if (!value) return '';
                const str = String(value);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };

            // Filter anwenden
            let filteredMembers = members.filter(m =>
                m.status !== 'Ausgetreten' && m.status !== 'Verstorben'
            );
            let filename = 'mitglieder';

            switch(filter) {
                case 'aktiv':
                    filteredMembers = filteredMembers.filter(m => m.status === 'Aktivmitglied');
                    filename = 'aktivmitglieder';
                    break;
                case 'post':
                    filteredMembers = filteredMembers.filter(m => m.zustellung_post === true);
                    filename = 'post-zustellung';
                    break;
                case 'email':
                    filteredMembers = filteredMembers.filter(m => m.zustellung_email === true);
                    filename = 'email-zustellung';
                    break;
            }

            // Alle Felder fuer Serienbriefe
            const headers = [
                'Anrede', 'Vorname', 'Nachname',
                'Strasse', 'Adresszusatz', 'PLZ', 'Ort',
                'E-Mail', 'Telefon', 'Mobile',
                'Status', 'Funktion', 'Feuerwehr-Zugehoerigkeit',
                'Geburtstag', 'Eintrittsdatum'
            ];

            const rows = filteredMembers.map(m => [
                escapeCSV(m.anrede),
                escapeCSV(m.vorname),
                escapeCSV(m.nachname),
                escapeCSV(m.strasse),
                escapeCSV(m.adresszusatz),
                escapeCSV(m.plz),
                escapeCSV(m.ort),
                escapeCSV(m.email),
                escapeCSV(m.telefon),
                escapeCSV(m.mobile),
                escapeCSV(m.status),
                escapeCSV(m.funktion),
                escapeCSV(m.feuerwehr_zugehoerigkeit),
                escapeCSV(m.geburtstag),
                escapeCSV(m.eintrittsdatum)
            ].join(';'));  // Semikolon fuer bessere Excel-Kompatibilitaet

            // BOM fuer UTF-8 (damit Excel Umlaute richtig anzeigt)
            const BOM = '\uFEFF';
            const csv = BOM + headers.join(';') + '\n' + rows.join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ============================================
        // EVENTS
        // ============================================

        async function loadEvents() {
            try {
                document.getElementById('events-loading-state').classList.remove('hidden');
                document.getElementById('events-empty-state').classList.add('hidden');

                const response = await fetch(`${API_BASE}/events`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to load events');

                events = await response.json();
                renderEvents();
            } catch (error) {
                console.error('Error loading events:', error);
            } finally {
                document.getElementById('events-loading-state').classList.add('hidden');
            }
        }

        function renderEvents() {
            const tbody = document.getElementById('events-tbody');

            if (events.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('events-empty-state').classList.remove('hidden');
                return;
            }

            document.getElementById('events-empty-state').classList.add('hidden');

            tbody.innerHTML = events.map(event => {
                const startDate = new Date(event.start_date);

                // Z√§hle Registrierungen aus allen Schichten + direkte Registrierungen
                let pendingCount = 0;
                let approvedCount = 0;
                let totalShiftCapacity = 0;
                let totalShiftRegistered = 0;
                let shiftsWithRegistrations = 0;
                if (event.shifts && event.shifts.length > 0) {
                    event.shifts.forEach(shift => {
                        if (shift.registrations) {
                            pendingCount += shift.registrations.pendingCount || 0;
                            approvedCount += shift.registrations.approvedCount || 0;
                            totalShiftRegistered += (shift.registrations.approvedCount || 0);
                            if ((shift.registrations.approvedCount || 0) > 0) {
                                shiftsWithRegistrations++;
                            }
                        }
                        totalShiftCapacity += shift.needed || 0;
                    });
                }
                // Direkte Teilnehmer-Registrierungen (ohne Schichten)
                if (event.directRegistrations) {
                    pendingCount += event.directRegistrations.pendingCount || 0;
                    approvedCount += event.directRegistrations.approvedCount || 0;
                }

                // Schichten/Personen Display: "4/16" oder bei Events ohne Schichten die direkten Anmeldungen
                const shiftCount = event.shifts?.length || 0;
                const directApprovedCount = event.directRegistrations?.approvedCount || 0;
                let shiftsDisplay = '-';
                if (shiftCount > 0) {
                    shiftsDisplay = `${totalShiftRegistered}/${totalShiftCapacity > 0 ? totalShiftCapacity : shiftCount}`;
                } else if (directApprovedCount > 0) {
                    // Keine Schichten, aber direkte Anmeldungen vorhanden
                    shiftsDisplay = `${directApprovedCount} Pers.`;
                }

                const hasPending = pendingCount > 0;
                const hasAny = pendingCount > 0 || approvedCount > 0;
                const registrationsDisplay = hasPending
                    ? `<span class="text-fire-600 font-semibold">${pendingCount} offen</span> / ${approvedCount} best.`
                    : (approvedCount > 0 ? `${approvedCount} best√§tigt` : '-');

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">${event.title}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">${startDate.toLocaleDateString('de-CH')}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">${event.category || '-'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">${event.organizer_name || '-'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getEventStatusClass(event.status)}">
                                ${event.status || 'planned'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm text-gray-600">${shiftsDisplay}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm">${registrationsDisplay}</span>
                            ${hasAny ? `<button onclick="openEventRegistrations('${event.id}')" class="ml-2 text-fire-600 hover:text-fire-800 text-xs underline">verwalten</button>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                            <button onclick="generateEventInvitation('${event.id}')" class="text-green-600 hover:text-green-800" title="Einladung generieren">
                                Einladung
                            </button>
                            <button onclick="editEvent('${event.id}')" class="text-fire-600 hover:text-fire-800">
                                Bearbeiten
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getEventStatusClass(status) {
            const classes = {
                'planned': 'bg-blue-100 text-blue-800',
                'confirmed': 'bg-green-100 text-green-800',
                'cancelled': 'bg-red-100 text-red-800',
                'completed': 'bg-gray-100 text-gray-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        async function generateEventInvitation(eventId) {
            try {
                // Load event data
                const response = await fetch(`${API_BASE}/events/${eventId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Event nicht gefunden');
                const event = await response.json();

                // Format date and time
                const startDate = new Date(event.start_date);
                const endDate = event.end_date ? new Date(event.end_date) : null;
                const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const timeOptions = { hour: '2-digit', minute: '2-digit' };

                const formattedDate = startDate.toLocaleDateString('de-CH', dateOptions);
                const formattedTime = startDate.toLocaleTimeString('de-CH', timeOptions) + ' Uhr';

                let dateRange = formattedDate;
                if (endDate && endDate.toDateString() !== startDate.toDateString()) {
                    dateRange += ` bis ${endDate.toLocaleDateString('de-CH', dateOptions)}`;
                }

                // Build invitation text
                const anmeldungInfo = event.registration_required
                    ? `\nAnmeldung: Erforderlich${event.registration_deadline ? ` bis ${new Date(event.registration_deadline).toLocaleDateString('de-CH')}` : ''}`
                    : '\nAnmeldung: Nicht erforderlich';

                const kostenInfo = event.cost ? `\nKosten: ${event.cost}` : '';

                // Absender: Organisator falls vorhanden, sonst Vorstand
                const hasOrganizer = event.organizer_name && event.organizer_name.trim();
                const einladungVon = hasOrganizer
                    ? `${event.organizer_name} l√§dt euch herzlich ein:`
                    : 'Der Vorstand m√∂chte euch herzlich einladen:';
                const grussformel = hasOrganizer
                    ? `Mit freundlichen Gr√ºssen\n\n${event.organizer_name}`
                    : `Mit freundlichen Gr√ºssen\nDer Vorstand`;

                const invitationSubject = `Einladung: ${event.title}`;
                const invitationBody = `Liebe Mitglieder

${einladungVon}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${event.title}${event.subtitle ? '\n' + event.subtitle : ''}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Was:      ${event.title}
Wann:     ${formattedDate}, ${formattedTime}
Wo:       ${event.location || 'Wird noch bekannt gegeben'}${anmeldungInfo}${kostenInfo}

${event.description || ''}

Wir freuen uns √ºber zahlreiches Erscheinen!

${grussformel}`;

                // Switch to dispatch tab and fill in the data
                switchTab('dispatch');

                // Wait a moment for the tab to load
                await new Promise(resolve => setTimeout(resolve, 100));

                // Fill in the dispatch form
                document.getElementById('dispatch-subject').value = invitationSubject;
                document.getElementById('dispatch-body').value = invitationBody;

                // Reset template selection (using free text)
                document.getElementById('dispatch-template').value = '';
                document.getElementById('dispatch-variables').classList.add('hidden');

                // Set delivery method to auto
                document.querySelector('input[name="delivery-method"][value="auto"]').checked = true;

                // Update recipient count
                updateRecipientCount();

                // Show preview automatically
                await new Promise(resolve => setTimeout(resolve, 150));
                showDispatchPreview();

            } catch (error) {
                console.error('Error generating invitation:', error);
                alert('Fehler beim Generieren der Einladung: ' + error.message);
            }
        }

        // Felder je nach Event-Kategorie ein-/ausblenden
        function updateEventFormByCategory() {
            const category = document.getElementById('event-category').value;
            const registrationSection = document.getElementById('registration-section');
            const shiftsSection = document.getElementById('shifts-section');
            const noRegHint = document.getElementById('no-registration-hint');

            // Alle verstecken
            registrationSection.classList.add('hidden');
            registrationSection.classList.remove('contents');
            shiftsSection.classList.add('hidden');
            noRegHint.classList.add('hidden');

            if (category === 'Dorffest') {
                // Dorffest: Nur Schichten
                shiftsSection.classList.remove('hidden');
            } else if (category === 'Aufbau' || category === 'Abbau' || category === 'Ausflug mit Anmeldung') {
                // Teilnehmer-Anmeldung ohne Schichten
                registrationSection.classList.remove('hidden');
                registrationSection.classList.add('contents');
            } else if (category === 'Ausflug') {
                // Keine Anmeldung
                noRegHint.classList.remove('hidden');
            } else if (category === 'Sonstiges') {
                // Beides zeigen - User entscheidet
                registrationSection.classList.remove('hidden');
                registrationSection.classList.add('contents');
                shiftsSection.classList.remove('hidden');
            }
        }

        function openNewEventModal() {
            document.getElementById('event-modal-title').textContent = 'Neues Event';
            document.getElementById('event-form').reset();
            document.getElementById('event-id').value = '';
            document.getElementById('event-shifts-container').innerHTML = '';
            document.getElementById('event-organizer-name').value = '';
            document.getElementById('event-organizer-email').value = '';
            document.getElementById('event-create-access').checked = false;
            document.getElementById('delete-event-btn').classList.add('hidden');
            updateEventFormByCategory();
            document.getElementById('event-modal').classList.remove('hidden');
        }

        async function editEvent(id) {
            try {
                const response = await fetch(`${API_BASE}/events/${id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to load event');

                const event = await response.json();

                document.getElementById('event-modal-title').textContent = 'Event bearbeiten';
                document.getElementById('event-id').value = event.id;
                document.getElementById('event-title').value = event.title || '';
                document.getElementById('event-subtitle').value = event.subtitle || '';
                document.getElementById('event-slug').value = event.slug || '';
                document.getElementById('event-category').value = event.category || 'Sonstiges';
                document.getElementById('event-status').value = event.status || 'planned';
                document.getElementById('event-start-date').value = formatDateTimeLocal(event.start_date);
                document.getElementById('event-end-date').value = event.end_date ? formatDateTimeLocal(event.end_date) : '';
                document.getElementById('event-location').value = event.location || '';
                document.getElementById('event-description').value = event.description || '';
                document.getElementById('event-registration-deadline').value = event.registration_deadline ? formatDateTimeLocal(event.registration_deadline) : '';
                document.getElementById('event-max-participants').value = event.max_participants || '';
                document.getElementById('event-cost').value = event.cost || '';

                // Organisator-Felder
                document.getElementById('event-organizer-name').value = event.organizer_name || '';
                document.getElementById('event-organizer-email').value = event.organizer_email || '';
                document.getElementById('event-create-access').checked = false; // Immer unchecked beim Bearbeiten

                // Load shifts
                loadEventShifts(event.shifts || []);

                // Felder je nach Kategorie aktualisieren
                updateEventFormByCategory();

                document.getElementById('delete-event-btn').classList.remove('hidden');
                document.getElementById('event-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading event:', error);
                alert('Fehler beim Laden des Events');
            }
        }

        function loadEventShifts(shifts) {
            const container = document.getElementById('event-shifts-container');
            container.innerHTML = '';
            shifts.forEach(shift => {
                addShiftRow(shift);
            });
        }

        // Format time for HTML input (HH:MM format, no seconds)
        function formatTimeForInput(time) {
            if (!time) return '';
            // Handle "HH:MM:SS" or "HH:MM" format
            return time.substring(0, 5);
        }

        // Format date for HTML input (YYYY-MM-DD)
        function formatDateForInput(date) {
            if (!date) return '';
            // Handle ISO date strings like "2026-01-18T00:00:00.000Z"
            if (date.includes('T')) {
                return date.split('T')[0];
            }
            // Handle PostgreSQL timestamp "2026-01-18 19:00:00"
            if (date.includes(' ')) {
                return date.split(' ')[0];
            }
            return date;
        }

        function addShiftRow(shift = null) {
            const container = document.getElementById('event-shifts-container');
            const shiftId = shift?.id || 'new-' + Date.now();
            const row = document.createElement('div');
            row.className = 'shift-row border rounded-lg p-3 bg-gray-50';
            row.dataset.shiftId = shiftId;

            const bereichValue = shift?.bereich || 'Allgemein';
            const dateValue = formatDateForInput(shift?.date);
            const startTimeValue = formatTimeForInput(shift?.start_time);
            const endTimeValue = formatTimeForInput(shift?.end_time);

            row.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-7 gap-2">
                    <div>
                        <select class="shift-bereich w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                            ${generateShiftTypeOptions(bereichValue)}
                        </select>
                    </div>
                    <div>
                        <input type="text" placeholder="Name (z.B. Schicht 1)" value="${shift?.name || ''}"
                            class="shift-name w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                    </div>
                    <div>
                        <input type="date" value="${dateValue}"
                            class="shift-date w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                    </div>
                    <div>
                        <input type="time" value="${startTimeValue}" placeholder="Start"
                            class="shift-start w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                    </div>
                    <div>
                        <input type="time" value="${endTimeValue}" placeholder="Ende"
                            class="shift-end w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" min="1" value="${shift?.needed || 2}" placeholder="Anz."
                            class="shift-needed w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                        <button type="button" onclick="removeShiftRow(this)" class="text-red-500 hover:text-red-700 text-lg">&times;</button>
                    </div>
                </div>
                <div class="mt-2">
                    <input type="text" placeholder="Beschreibung (optional)" value="${shift?.description || ''}"
                        class="shift-description w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                </div>
            `;
            container.appendChild(row);
        }

        function removeShiftRow(button) {
            const row = button.closest('.shift-row');
            row.remove();
        }

        function generateSpringerShifts() {
            // Collect all existing shifts
            const existingShifts = [];
            document.querySelectorAll('.shift-row').forEach(row => {
                existingShifts.push({
                    bereich: row.querySelector('.shift-bereich').value,
                    date: row.querySelector('.shift-date').value,
                    start_time: row.querySelector('.shift-start').value,
                    end_time: row.querySelector('.shift-end').value
                });
            });

            // Find unique time slots from non-Springer/non-Vorbereitung shifts
            const timeSlots = new Map();
            existingShifts.forEach(shift => {
                if (shift.bereich !== 'Springer' && shift.bereich !== 'Vorbereitung' && shift.date && shift.start_time) {
                    const key = `${shift.date}|${shift.start_time}|${shift.end_time}`;
                    if (!timeSlots.has(key)) {
                        timeSlots.set(key, {
                            date: shift.date,
                            start_time: shift.start_time,
                            end_time: shift.end_time
                        });
                    }
                }
            });

            // Check which time slots already have Springer shifts
            const existingSpringerSlots = new Set();
            existingShifts.forEach(shift => {
                if (shift.bereich === 'Springer') {
                    existingSpringerSlots.add(`${shift.date}|${shift.start_time}|${shift.end_time}`);
                }
            });

            // Create Springer shifts for missing time slots
            let created = 0;
            timeSlots.forEach((slot, key) => {
                if (!existingSpringerSlots.has(key)) {
                    addShiftRow({
                        bereich: 'Springer',
                        name: 'Springer',
                        date: slot.date,
                        start_time: slot.start_time,
                        end_time: slot.end_time,
                        needed: 1
                    });
                    created++;
                }
            });

            if (created > 0) {
                alert(`${created} Springer-Schicht(en) erstellt basierend auf existierenden Zeitslots.`);
            } else if (timeSlots.size === 0) {
                alert('Keine Zeitslots gefunden. Bitte zuerst andere Schichten (Bar, Kueche, etc.) anlegen.');
            } else {
                alert('Alle Zeitslots haben bereits Springer-Schichten.');
            }
        }

        function collectShiftsData() {
            const shifts = [];
            document.querySelectorAll('.shift-row').forEach(row => {
                const shiftId = row.dataset.shiftId;
                shifts.push({
                    id: shiftId.startsWith('new-') ? null : shiftId,
                    bereich: row.querySelector('.shift-bereich').value,
                    name: row.querySelector('.shift-name').value,
                    date: row.querySelector('.shift-date').value,
                    start_time: row.querySelector('.shift-start').value,
                    end_time: row.querySelector('.shift-end').value,
                    needed: parseInt(row.querySelector('.shift-needed').value) || 2,
                    description: row.querySelector('.shift-description').value
                });
            });
            return shifts.filter(s => s.name && s.date);
        }

        function formatDateTimeLocal(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const offset = date.getTimezoneOffset();
            const localDate = new Date(date.getTime() - (offset * 60 * 1000));
            return localDate.toISOString().slice(0, 16);
        }

        async function saveEvent(e) {
            e.preventDefault();

            const id = document.getElementById('event-id').value;
            const data = {
                slug: document.getElementById('event-slug').value,
                title: document.getElementById('event-title').value,
                subtitle: document.getElementById('event-subtitle').value || null,
                category: document.getElementById('event-category').value,
                status: document.getElementById('event-status').value,
                start_date: document.getElementById('event-start-date').value,
                end_date: document.getElementById('event-end-date').value || null,
                location: document.getElementById('event-location').value || null,
                description: document.getElementById('event-description').value || null,
                // registration_required basierend auf Kategorie
                registration_required: ['Dorffest', 'Aufbau', 'Abbau', 'Ausflug mit Anmeldung'].includes(document.getElementById('event-category').value),
                registration_deadline: document.getElementById('event-registration-deadline').value || null,
                max_participants: document.getElementById('event-max-participants').value ? parseInt(document.getElementById('event-max-participants').value) : null,
                cost: document.getElementById('event-cost').value || null,
                organizer_name: document.getElementById('event-organizer-name').value || null,
                organizer_email: document.getElementById('event-organizer-email').value || null,
                create_access: document.getElementById('event-create-access').checked
            };

            console.log('Saving event data:', data);

            try {
                const url = id ? `${API_BASE}/events/${id}` : `${API_BASE}/events`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Save event failed:', response.status, errorData);
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const savedEvent = await response.json();
                const eventId = savedEvent.id;

                // Save shifts
                const shiftsData = collectShiftsData();
                await saveEventShifts(eventId, shiftsData);

                document.getElementById('event-modal').classList.add('hidden');
                await loadEvents();
            } catch (error) {
                console.error('Error saving event:', error);
                alert('Fehler beim Speichern: ' + error.message);
            }
        }

        async function saveEventShifts(eventId, shifts) {
            // Get existing shifts to compare
            const existingResponse = await fetch(`${API_BASE}/events/${eventId}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const existingEvent = await existingResponse.json();
            const existingShiftIds = (existingEvent.shifts || []).map(s => s.id);

            // Collect shift IDs that are still present
            const currentShiftIds = shifts.filter(s => s.id).map(s => s.id);

            // Delete removed shifts
            for (const oldId of existingShiftIds) {
                if (!currentShiftIds.includes(oldId)) {
                    await fetch(`${API_BASE}/shifts/${oldId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                }
            }

            // Create or update shifts
            for (const shift of shifts) {
                if (shift.id) {
                    // Update existing shift
                    await fetch(`${API_BASE}/shifts/${shift.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            name: shift.name,
                            description: shift.description,
                            date: shift.date,
                            start_time: shift.start_time,
                            end_time: shift.end_time,
                            needed: shift.needed,
                            bereich: shift.bereich
                        })
                    });
                } else {
                    // Create new shift
                    await fetch(`${API_BASE}/shifts`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            event_id: eventId,
                            name: shift.name,
                            description: shift.description,
                            date: shift.date,
                            start_time: shift.start_time,
                            end_time: shift.end_time,
                            needed: shift.needed,
                            bereich: shift.bereich
                        })
                    });
                }
            }
        }

        async function deleteEvent() {
            const id = document.getElementById('event-id').value;
            if (!id) return;
            if (!confirm('Event wirklich loeschen?')) return;

            try {
                const response = await fetch(`${API_BASE}/events/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to delete event');

                document.getElementById('event-modal').classList.add('hidden');
                await loadEvents();
            } catch (error) {
                console.error('Error deleting event:', error);
                alert('Fehler beim Loeschen');
            }
        }

        // ============================================
        // EVENT REGISTRATIONS MODAL
        // ============================================

        function openEventRegistrations(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            currentEventForRegistrations = event;
            document.getElementById('event-reg-modal-title').textContent = `Anmeldungen: ${event.title}`;

            renderEventRegistrations();
            document.getElementById('event-registrations-modal').classList.remove('hidden');
        }

        function closeEventRegistrationsModal() {
            document.getElementById('event-registrations-modal').classList.add('hidden');
            currentEventForRegistrations = null;
        }

        function renderEventRegistrations() {
            const event = currentEventForRegistrations;
            if (!event || !event.shifts) return;

            const container = document.getElementById('event-reg-content');

            // Group by shift
            let html = '<div class="space-y-6">';

            for (const shift of event.shifts) {
                const regs = shift.registrations || { pending: [], approved: [] };
                const pending = regs.pending || [];
                const approved = regs.approved || [];
                const all = [...pending.map(r => ({...r, status: 'pending'})), ...approved.map(r => ({...r, status: 'approved'}))];

                const shiftDisplayName = `${shift.bereich || ''} - ${shift.name}: ${shift.date} ${shift.start_time}-${shift.end_time}`;

                html += `
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-gray-800">
                                ${shiftDisplayName}
                            </h4>
                            <button onclick="openAddPersonModal('${shift.id}', '${escapeForOnclick(shiftDisplayName)}')" class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Person
                            </button>
                        </div>
                `;

                if (all.length === 0) {
                    html += `<p class="text-gray-400 text-sm italic">Keine Anmeldungen</p>`;
                } else {
                    html += `
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Name</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Status</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">Aktionen</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                    `;

                for (const reg of all) {
                    const statusBadge = reg.status === 'approved'
                        ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Bestaetigt</span>'
                        : '<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">Offen</span>';

                    const shiftInfo = JSON.stringify({
                        bereich: shift.bereich || '',
                        name: shift.name,
                        date: shift.date,
                        time: `${shift.start_time}-${shift.end_time}`
                    }).replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$').replace(/'/g, "\\'").replace(/"/g, '&quot;');

                    const editBtn = `<button onclick="openEditRegistrationModal('${reg.id}', '${escapeForOnclick(reg.name)}', '${escapeForOnclick(reg.email)}', '${escapeForOnclick(reg.phone)}')" class="text-gray-600 hover:text-gray-800 mr-2">Bearbeiten</button>`;

                    const actions = reg.status === 'pending'
                        ? `${editBtn}<button onclick="approveEventRegistration('${reg.id}')" class="text-green-600 hover:text-green-800 mr-2">Bestaetigen</button>
                           <button onclick="openSuggestAlternativeModal('${reg.id}', '${escapeForOnclick(reg.name)}', '${escapeForOnclick(reg.email)}', '${shiftInfo}')" class="text-blue-600 hover:text-blue-800 mr-2">Alternative</button>
                           <button onclick="rejectEventRegistration('${reg.id}')" class="text-red-600 hover:text-red-800">Ablehnen</button>`
                        : `${editBtn}<button onclick="rejectEventRegistration('${reg.id}')" class="text-red-600 hover:text-red-800">Entfernen</button>`;

                    html += `
                        <tr>
                            <td class="px-4 py-2 text-sm text-gray-900">${reg.name || 'Unbekannt'}</td>
                            <td class="px-4 py-2">${statusBadge}</td>
                            <td class="px-4 py-2 text-right text-sm">${actions}</td>
                        </tr>
                    `;
                    }

                    html += `
                                </tbody>
                            </table>
                    `;
                }

                html += `</div>`;
            }

            // Direkte Teilnehmer-Registrierungen (ohne Schichten)
            if (event.directRegistrations) {
                const direct = event.directRegistrations;
                const directPending = direct.pending || [];
                const directApproved = direct.approved || [];
                const allDirect = [...directPending.map(r => ({...r, status: 'pending'})), ...directApproved.map(r => ({...r, status: 'approved'}))];

                if (allDirect.length > 0) {
                    html += `
                        <div class="border rounded-lg p-4 bg-purple-50">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-semibold text-gray-800">
                                    üìß Teilnehmer-Anmeldungen (${allDirect.length})
                                </h4>
                                <button onclick="downloadTeilnehmerliste()"
                                        class="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    PDF
                                </button>
                            </div>
                            <table class="min-w-full">
                                <thead class="bg-purple-100">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Name</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">E-Mail</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Status</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                    `;

                    for (const reg of allDirect) {
                        const statusBadge = reg.status === 'approved'
                            ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Bestaetigt</span>'
                            : '<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">Offen</span>';

                        const editBtn = `<button onclick="openEditRegistrationModal('${reg.id}', '${escapeForOnclick(reg.name)}', '${escapeForOnclick(reg.email)}', '${escapeForOnclick(reg.phone)}')" class="text-gray-600 hover:text-gray-800 mr-2">Bearbeiten</button>`;

                        const actions = reg.status === 'pending'
                            ? `${editBtn}<button onclick="approveEventRegistration('${reg.id}')" class="text-green-600 hover:text-green-800 mr-2">Bestaetigen</button>
                               <button onclick="rejectEventRegistration('${reg.id}')" class="text-red-600 hover:text-red-800">Ablehnen</button>`
                            : `${editBtn}<button onclick="rejectEventRegistration('${reg.id}')" class="text-red-600 hover:text-red-800">Entfernen</button>`;

                        // Parse notes for extra info
                        let extraInfo = '';
                        try {
                            const notes = typeof reg.notes === 'string' ? JSON.parse(reg.notes) : reg.notes;
                            if (notes?.participants) extraInfo += ` (${notes.participants} Pers.)`;
                            if (notes?.phone) extraInfo += ` Tel: ${notes.phone}`;
                        } catch(e) {}

                        html += `
                            <tr>
                                <td class="px-4 py-2 text-sm text-gray-900">${reg.name || 'Unbekannt'}${extraInfo}</td>
                                <td class="px-4 py-2 text-sm text-gray-600">${reg.email || '-'}</td>
                                <td class="px-4 py-2">${statusBadge}</td>
                                <td class="px-4 py-2 text-right text-sm">${actions}</td>
                            </tr>
                        `;
                    }

                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            }

            html += '</div>';

            // Check if any registrations exist
            const hasShiftRegs = event.shifts?.some(s => {
                const regs = s.registrations || {};
                return (regs.pending?.length || 0) + (regs.approved?.length || 0) > 0;
            });
            const hasDirectRegs = (event.directRegistrations?.pendingCount || 0) + (event.directRegistrations?.approvedCount || 0) > 0;

            if (!hasShiftRegs && !hasDirectRegs) {
                html = '<p class="text-center text-gray-500 py-8">Keine Anmeldungen vorhanden</p>';
            }

            container.innerHTML = html;
        }

        async function approveEventRegistration(regId) {
            try {
                const response = await fetch(`${API_BASE}/registrations/${regId}/approve`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Fehler beim Bestaetigen');
                await loadEvents();
                currentEventForRegistrations = events.find(e => e.id === currentEventForRegistrations.id);
                renderEventRegistrations();
            } catch (error) {
                alert(error.message);
            }
        }

        async function rejectEventRegistration(regId) {
            if (!confirm('Anmeldung wirklich ablehnen/entfernen?')) return;
            try {
                const response = await fetch(`${API_BASE}/registrations/${regId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({})
                });
                if (!response.ok) throw new Error('Fehler beim Ablehnen');
                await loadEvents();
                currentEventForRegistrations = events.find(e => e.id === currentEventForRegistrations.id);
                renderEventRegistrations();
            } catch (error) {
                alert(error.message);
            }
        }

        // ============================================
        // EDIT REGISTRATION
        // ============================================

        function openEditRegistrationModal(regId, name, email, phone) {
            document.getElementById('edit-reg-id').value = regId;
            document.getElementById('edit-reg-name').value = name || '';
            document.getElementById('edit-reg-email').value = email || '';
            document.getElementById('edit-reg-phone').value = phone || '';
            document.getElementById('edit-registration-modal').classList.remove('hidden');
        }

        function closeEditRegistrationModal() {
            document.getElementById('edit-registration-modal').classList.add('hidden');
        }

        async function saveRegistrationEdit() {
            const id = document.getElementById('edit-reg-id').value;
            const guest_name = document.getElementById('edit-reg-name').value.trim();
            const guest_email = document.getElementById('edit-reg-email').value.trim();
            const phone = document.getElementById('edit-reg-phone').value.trim();

            if (!guest_name) {
                alert('Name ist erforderlich');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/registrations/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ guest_name, guest_email, phone })
                });

                if (!response.ok) throw new Error('Fehler beim Speichern');

                closeEditRegistrationModal();
                await loadEvents();
                currentEventForRegistrations = events.find(e => e.id === currentEventForRegistrations.id);
                renderEventRegistrations();
            } catch (error) {
                alert(error.message);
            }
        }

        // ============================================
        // ADD PERSON TO SHIFT
        // ============================================

        function openAddPersonModal(shiftId, shiftDisplayName) {
            document.getElementById('add-person-shift-id').value = shiftId;
            document.getElementById('add-person-shift-info').textContent = `Schicht: ${shiftDisplayName}`;
            document.getElementById('add-person-mode').value = 'member';
            document.getElementById('add-person-name').value = '';
            document.getElementById('add-person-email').value = '';
            document.getElementById('add-person-phone').value = '';
            document.getElementById('add-person-member').value = '';

            // Populate member dropdown
            const select = document.getElementById('add-person-member');
            select.innerHTML = '<option value="">Bitte waehlen...</option>';
            const sortedMembers = [...members].sort((a, b) =>
                `${a.nachname} ${a.vorname}`.localeCompare(`${b.nachname} ${b.vorname}`)
            );
            for (const member of sortedMembers) {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.nachname}, ${member.vorname}`;
                option.dataset.email = member.email || '';
                select.appendChild(option);
            }

            switchAddPersonTab('member');
            document.getElementById('add-person-modal').classList.remove('hidden');
        }

        function closeAddPersonModal() {
            document.getElementById('add-person-modal').classList.add('hidden');
        }

        function switchAddPersonTab(mode) {
            document.getElementById('add-person-mode').value = mode;
            if (mode === 'member') {
                document.getElementById('add-person-tab-member').classList.add('bg-fire-500', 'text-white');
                document.getElementById('add-person-tab-member').classList.remove('bg-gray-100', 'text-gray-700');
                document.getElementById('add-person-tab-guest').classList.remove('bg-fire-500', 'text-white');
                document.getElementById('add-person-tab-guest').classList.add('bg-gray-100', 'text-gray-700');
                document.getElementById('add-person-member-section').classList.remove('hidden');
                document.getElementById('add-person-guest-section').classList.add('hidden');
            } else {
                document.getElementById('add-person-tab-guest').classList.add('bg-fire-500', 'text-white');
                document.getElementById('add-person-tab-guest').classList.remove('bg-gray-100', 'text-gray-700');
                document.getElementById('add-person-tab-member').classList.remove('bg-fire-500', 'text-white');
                document.getElementById('add-person-tab-member').classList.add('bg-gray-100', 'text-gray-700');
                document.getElementById('add-person-guest-section').classList.remove('hidden');
                document.getElementById('add-person-member-section').classList.add('hidden');
            }
        }

        async function saveAddPerson() {
            const shiftId = document.getElementById('add-person-shift-id').value;
            const mode = document.getElementById('add-person-mode').value;
            const event = currentEventForRegistrations;

            if (!event || !shiftId) {
                alert('Fehler: Event oder Schicht nicht gefunden');
                return;
            }

            let payload = {
                event_id: event.id,
                shift_ids: [shiftId],
                status: 'approved'
            };

            if (mode === 'member') {
                const memberId = document.getElementById('add-person-member').value;
                if (!memberId) {
                    alert('Bitte ein Mitglied auswaehlen');
                    return;
                }
                const memberOption = document.getElementById('add-person-member').selectedOptions[0];
                payload.member_id = memberId;
                payload.guest_name = memberOption.textContent;
                payload.guest_email = memberOption.dataset.email || '';
            } else {
                const name = document.getElementById('add-person-name').value.trim();
                const email = document.getElementById('add-person-email').value.trim();
                const phone = document.getElementById('add-person-phone').value.trim();

                if (!name) {
                    alert('Bitte einen Namen eingeben');
                    return;
                }
                payload.guest_name = name;
                payload.guest_email = email;
                payload.notes = JSON.stringify({ phone });
            }

            try {
                const response = await fetch(`${API_BASE}/registrations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Fehler beim Hinzufuegen');

                closeAddPersonModal();
                await loadEvents();
                currentEventForRegistrations = events.find(e => e.id === currentEventForRegistrations.id);
                renderEventRegistrations();
            } catch (error) {
                alert(error.message);
            }
        }

        // ============================================
        // ADD SHIFT
        // ============================================

        function openAddShiftModal() {
            const event = currentEventForRegistrations;
            if (!event) return;

            document.getElementById('add-shift-event-id').value = event.id;
            // Pre-fill date with event date if available
            if (event.date) {
                document.getElementById('add-shift-date').value = event.date;
            }
            document.getElementById('add-shift-name').value = '';
            document.getElementById('add-shift-start').value = '';
            document.getElementById('add-shift-end').value = '';
            document.getElementById('add-shift-needed').value = '2';
            // Populate shift type options from central constants
            document.getElementById('add-shift-bereich').innerHTML = generateShiftTypeOptions('Bar');
            document.getElementById('add-shift-modal').classList.remove('hidden');
        }

        function closeAddShiftModal() {
            document.getElementById('add-shift-modal').classList.add('hidden');
        }

        async function saveNewShift() {
            const event_id = document.getElementById('add-shift-event-id').value;
            const name = document.getElementById('add-shift-name').value.trim();
            const date = document.getElementById('add-shift-date').value;
            const start_time = document.getElementById('add-shift-start').value;
            const end_time = document.getElementById('add-shift-end').value;
            const needed = parseInt(document.getElementById('add-shift-needed').value) || 2;
            const bereich = document.getElementById('add-shift-bereich').value;

            if (!name || !date || !start_time || !end_time) {
                alert('Bitte alle Pflichtfelder ausfuellen');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/shifts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ event_id, name, date, start_time, end_time, needed, bereich })
                });

                if (!response.ok) throw new Error('Fehler beim Erstellen der Schicht');

                closeAddShiftModal();
                await loadEvents();
                currentEventForRegistrations = events.find(e => e.id === currentEventForRegistrations.id);
                renderEventRegistrations();
                alert('Schicht erfolgreich erstellt!');
            } catch (error) {
                alert(error.message);
            }
        }

        // ============================================
        // ALTERNATIVE SCHICHT VORSCHLAGEN
        // ============================================

        function openSuggestAlternativeModal(regId, personName, personEmail, currentShiftJson) {
            const event = currentEventForRegistrations;
            if (!event || !event.shifts) return;

            let currentShift;
            try {
                // Decode HTML entities that were escaped for the onclick attribute
                const decodedJson = currentShiftJson.replace(/&quot;/g, '"');
                currentShift = JSON.parse(decodedJson);
            } catch(e) {
                currentShift = { name: 'Unbekannt' };
            }

            document.getElementById('suggest-alt-registration-id').value = regId;
            document.getElementById('suggest-alt-email').value = personEmail;
            document.getElementById('suggest-alt-person').textContent = personName;
            document.getElementById('suggest-alt-current-shift').textContent =
                `Aktuelle Schicht: ${currentShift.bereich ? currentShift.bereich + ' - ' : ''}${currentShift.name} (${currentShift.date} ${currentShift.time})`;

            // Populate alternative shifts dropdown
            const select = document.getElementById('suggest-alt-shift');
            select.innerHTML = '<option value="">Bitte waehlen...</option>';

            for (const shift of event.shifts) {
                const regs = shift.registrations || { approved: [] };
                const approvedCount = regs.approved?.length || 0;
                const maxHelpers = shift.max_helpers || 999;
                const isFull = approvedCount >= maxHelpers;
                const freeSlots = maxHelpers - approvedCount;

                const label = `${shift.bereich ? shift.bereich + ' - ' : ''}${shift.name}: ${shift.date} ${shift.start_time}-${shift.end_time}` +
                    (shift.max_helpers ? ` (${freeSlots}/${maxHelpers} frei)` : '');

                const option = document.createElement('option');
                option.value = shift.id;
                option.textContent = label;
                option.dataset.shiftInfo = JSON.stringify({
                    id: shift.id,
                    bereich: shift.bereich || '',
                    name: shift.name,
                    date: shift.date,
                    time: `${shift.start_time}-${shift.end_time}`
                });
                if (isFull) {
                    option.textContent += ' [VOLL]';
                    option.style.color = '#999';
                }
                select.appendChild(option);
            }

            // Set default comment
            document.getElementById('suggest-alt-comment').value =
                'Leider ist die von dir gewaehlte Schicht bereits voll besetzt. Waerst du bereit, stattdessen die folgende Schicht zu uebernehmen?';

            document.getElementById('suggest-alternative-modal').classList.remove('hidden');
        }

        function closeSuggestAlternativeModal() {
            document.getElementById('suggest-alternative-modal').classList.add('hidden');
        }

        async function sendAlternativeSuggestion() {
            const regId = document.getElementById('suggest-alt-registration-id').value;
            const email = document.getElementById('suggest-alt-email').value;
            const shiftSelect = document.getElementById('suggest-alt-shift');
            const newShiftId = shiftSelect.value;
            const comment = document.getElementById('suggest-alt-comment').value;

            if (!newShiftId) {
                alert('Bitte waehle eine alternative Schicht aus');
                return;
            }

            if (!email) {
                alert('Keine E-Mail-Adresse vorhanden');
                return;
            }

            const selectedOption = shiftSelect.options[shiftSelect.selectedIndex];
            let shiftInfo;
            try {
                shiftInfo = JSON.parse(selectedOption.dataset.shiftInfo);
            } catch(e) {
                shiftInfo = { name: selectedOption.textContent };
            }

            try {
                const response = await fetch(`${API_BASE}/registrations/${regId}/suggest-alternative`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        newShiftId,
                        shiftInfo,
                        comment,
                        email
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Fehler beim Senden');
                }

                alert('Vorschlag wurde per E-Mail gesendet');
                closeSuggestAlternativeModal();
            } catch (error) {
                alert(error.message);
            }
        }

        async function downloadTeilnehmerliste() {
            try {
                const event = currentEventForRegistrations;
                if (!event) {
                    alert('Keine Eventdaten vorhanden');
                    return;
                }

                // Collect all participants: direct registrations + shift registrations
                const participants = [];
                const shifts = [];

                // Shift registrations
                if (event.shifts && event.shifts.length > 0) {
                    for (const shift of event.shifts) {
                        const regs = shift.registrations || { pending: [], approved: [] };
                        const shiftParticipants = [
                            ...(regs.pending || []).map(r => ({...r, status: 'pending', shiftId: shift.id})),
                            ...(regs.approved || []).map(r => ({...r, status: 'approved', shiftId: shift.id}))
                        ];

                        if (shiftParticipants.length > 0) {
                            shifts.push({
                                id: shift.id,
                                name: shift.name,
                                bereich: shift.bereich || '',
                                date: shift.date,
                                startTime: shift.start_time,
                                endTime: shift.end_time,
                                participants: shiftParticipants
                            });
                            participants.push(...shiftParticipants);
                        }
                    }
                }

                // Direct registrations (without shifts)
                if (event.directRegistrations) {
                    const direct = event.directRegistrations;
                    const directParticipants = [
                        ...(direct.pending || []).map(r => ({...r, status: 'pending', shiftId: null})),
                        ...(direct.approved || []).map(r => ({...r, status: 'approved', shiftId: null}))
                    ];
                    if (directParticipants.length > 0) {
                        shifts.push({
                            id: null,
                            name: 'Teilnehmer (ohne Schicht)',
                            bereich: '',
                            date: null,
                            startTime: null,
                            endTime: null,
                            participants: directParticipants
                        });
                        participants.push(...directParticipants);
                    }
                }

                if (participants.length === 0) {
                    alert('Keine Teilnehmer zum Exportieren');
                    return;
                }

                const response = await fetch(`${API_BASE}/teilnehmerliste/pdf`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        eventId: event.id,
                        eventTitle: event.title,
                        participants: participants,
                        shifts: shifts
                    })
                });

                if (!response.ok) {
                    throw new Error('PDF konnte nicht generiert werden');
                }

                // Download the PDF
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Teilnehmerliste_${event.title.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Fehler beim PDF-Download:', error);
                alert('Fehler beim Erstellen der Teilnehmerliste: ' + error.message);
            }
        }

        // ============================================
        // AUDIT LOG
        // ============================================

        async function loadAuditLog(filters = {}) {
            try {
                document.getElementById('audit-loading-state').classList.remove('hidden');

                const params = new URLSearchParams(filters);
                const response = await fetch(`${API_BASE}/audit?${params}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to load audit log');

                auditLog = await response.json();
                renderAuditLog();
            } catch (error) {
                console.error('Error loading audit log:', error);
            } finally {
                document.getElementById('audit-loading-state').classList.add('hidden');
            }
        }

        function formatAuditDetails(entry) {
            const action = entry.action;
            const details = entry.details || {};
            const newValues = entry.new_values || {};

            // Combine details and new_values for display
            const data = { ...details, ...newValues };

            // Format based on action type
            if (action === 'LOGIN_SUCCESS') {
                return `<span class="text-green-700">Erfolgreich angemeldet</span>`;
            }
            if (action === 'LOGIN_FAILED') {
                return `<span class="text-red-700">Anmeldung fehlgeschlagen${data.reason ? ': ' + data.reason : ''}</span>`;
            }
            if (action === 'MEMBER_CREATE') {
                const name = [data.vorname, data.nachname].filter(Boolean).join(' ');
                return name ? `<span class="text-green-700">Neues Mitglied: <strong>${name}</strong></span>` : 'Neues Mitglied erstellt';
            }
            if (action === 'MEMBER_UPDATE') {
                const changes = [];
                if (data.vorname || data.nachname) {
                    const name = [data.vorname, data.nachname].filter(Boolean).join(' ');
                    changes.push(`Name: ${name}`);
                }
                if (data.email) changes.push(`E-Mail: ${data.email}`);
                if (data.telefon) changes.push(`Tel: ${data.telefon}`);
                if (data.status) changes.push(`Status: ${data.status}`);
                if (data.funktion) changes.push(`Funktion: ${data.funktion}`);
                if (data.strasse) changes.push(`Adresse aktualisiert`);
                return changes.length > 0
                    ? `<span class="text-blue-700">${changes.join(', ')}</span>`
                    : '<span class="text-blue-700">Mitglied aktualisiert</span>';
            }
            if (action === 'MEMBER_DELETE') {
                const name = [data.vorname, data.nachname].filter(Boolean).join(' ');
                return name ? `<span class="text-orange-700">Geloescht: <strong>${name}</strong></span>` : 'Mitglied geloescht';
            }
            if (action === 'EVENT_CREATE') {
                return data.title
                    ? `<span class="text-green-700">Neues Event: <strong>${data.title}</strong></span>`
                    : 'Neues Event erstellt';
            }
            if (action === 'EVENT_UPDATE') {
                return data.title
                    ? `<span class="text-blue-700">Event aktualisiert: <strong>${data.title}</strong></span>`
                    : 'Event aktualisiert';
            }
            if (action === 'EVENT_DELETE') {
                return data.title
                    ? `<span class="text-orange-700">Event geloescht: <strong>${data.title}</strong></span>`
                    : 'Event geloescht';
            }
            if (action === 'DISPATCH_EMAIL') {
                const recipients = data.recipientCount || data.recipients?.length || '?';
                return `<span class="text-purple-700">E-Mail an ${recipients} Empfaenger${data.subject ? ': ' + data.subject : ''}</span>`;
            }
            if (action === 'DISPATCH_LETTER' || action === 'PINGEN_SEND') {
                return `<span class="text-purple-700">Brief versendet${data.recipient ? ' an ' + data.recipient : ''}</span>`;
            }
            if (action === 'AUDIT_VIEW') {
                return '<span class="text-gray-500">Audit-Log eingesehen</span>';
            }
            if (action === 'REGISTRATION_APPROVE') {
                const name = [data.vorname, data.nachname].filter(Boolean).join(' ');
                return name
                    ? `<span class="text-green-700">Anmeldung genehmigt: <strong>${name}</strong></span>`
                    : 'Anmeldung genehmigt';
            }
            if (action === 'REGISTRATION_REJECT') {
                const name = [data.vorname, data.nachname].filter(Boolean).join(' ');
                return name
                    ? `<span class="text-red-700">Anmeldung abgelehnt: <strong>${name}</strong></span>`
                    : 'Anmeldung abgelehnt';
            }

            // Fallback: Show raw data if we have any
            if (Object.keys(data).length > 0) {
                const items = [];
                for (const [key, value] of Object.entries(data)) {
                    if (value && typeof value !== 'object') {
                        items.push(`${key}: ${value}`);
                    }
                }
                return items.length > 0 ? items.slice(0, 3).join(', ') : '-';
            }

            return '-';
        }

        function renderAuditLog() {
            const tbody = document.getElementById('audit-tbody');

            if (auditLog.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Keine Eintraege gefunden</td></tr>';
                return;
            }

            tbody.innerHTML = auditLog.map(entry => {
                const date = new Date(entry.created_at);
                const formattedDetails = formatAuditDetails(entry);
                const rawDetails = JSON.stringify({ ...entry.details, ...entry.new_values }, null, 2);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${date.toLocaleDateString('de-CH')}</div>
                            <div class="text-xs text-gray-500">${date.toLocaleTimeString('de-CH')}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getAuditActionClass(entry.action)}">
                                ${getAuditActionLabel(entry.action)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">${entry.email || '-'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">${entry.ip_address || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm max-w-md" title="${rawDetails.replace(/"/g, '&quot;')}">
                                ${formattedDetails}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getAuditActionLabel(action) {
            const labels = {
                'LOGIN_SUCCESS': 'Anmeldung',
                'LOGIN_FAILED': 'Fehlgeschlagen',
                'MEMBER_CREATE': 'Mitglied+',
                'MEMBER_UPDATE': 'Mitglied~',
                'MEMBER_DELETE': 'Mitglied-',
                'EVENT_CREATE': 'Event+',
                'EVENT_UPDATE': 'Event~',
                'EVENT_DELETE': 'Event-',
                'DISPATCH_EMAIL': 'E-Mail',
                'DISPATCH_LETTER': 'Brief',
                'PINGEN_SEND': 'Pingen',
                'AUDIT_VIEW': 'Log-Ansicht',
                'REGISTRATION_APPROVE': 'Genehmigt',
                'REGISTRATION_REJECT': 'Abgelehnt',
                'SYSTEM_START': 'System'
            };
            return labels[action] || action;
        }

        function getAuditActionClass(action) {
            if (action.includes('FAILED') || action.includes('ERROR')) return 'bg-red-100 text-red-800';
            if (action.includes('DELETE')) return 'bg-orange-100 text-orange-800';
            if (action.includes('CREATE')) return 'bg-green-100 text-green-800';
            if (action.includes('UPDATE')) return 'bg-blue-100 text-blue-800';
            if (action.includes('LOGIN_SUCCESS')) return 'bg-green-100 text-green-800';
            return 'bg-gray-100 text-gray-800';
        }

        // ============================================
        // DISPATCH
        // ============================================

        let dispatchTemplates = [];
        let selectedMembersForDispatch = [];
        let currentTemplate = null;
        let quillEditor = null;
        let isPlainTextMode = false;
        let dispatchAttachments = [];
        let dispatchDrafts = [];

        // Initialize Quill Rich Text Editor
        function initQuillEditor() {
            if (quillEditor) return;

            quillEditor = new Quill('#dispatch-editor', {
                theme: 'snow',
                placeholder: 'Nachrichtentext eingeben...',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link'],
                        ['clean']
                    ]
                }
            });

            // Sync editor content changes
            quillEditor.on('text-change', function() {
                updatePingenCostEstimate();
            });
        }

        // Toggle between Rich Text and Plain Text mode
        function toggleEditorMode() {
            isPlainTextMode = !isPlainTextMode;
            const btn = document.getElementById('toggle-editor-mode');
            const editorContainer = document.getElementById('dispatch-editor-container');
            const plainTextArea = document.getElementById('dispatch-body-plain');

            if (isPlainTextMode) {
                // Switch to plain text
                btn.textContent = 'Rich Text';
                editorContainer.classList.add('hidden');
                plainTextArea.classList.remove('hidden');
                // Convert HTML to plain text
                if (quillEditor) {
                    plainTextArea.value = quillEditor.getText();
                }
            } else {
                // Switch to rich text
                btn.textContent = 'Plain Text';
                editorContainer.classList.remove('hidden');
                plainTextArea.classList.add('hidden');
                // Set plain text content to editor
                if (quillEditor && plainTextArea.value) {
                    quillEditor.setText(plainTextArea.value);
                }
            }
        }

        // Get message content (works for both modes)
        function getDispatchContent() {
            if (isPlainTextMode) {
                return {
                    html: null,
                    text: document.getElementById('dispatch-body-plain').value
                };
            } else if (quillEditor) {
                const html = quillEditor.root.innerHTML;
                const text = quillEditor.getText();
                return { html, text };
            }
            return { html: null, text: '' };
        }

        // Set message content (works for both modes)
        function setDispatchContent(html, text) {
            if (isPlainTextMode) {
                document.getElementById('dispatch-body-plain').value = text || '';
            } else if (quillEditor) {
                if (html && html !== '<p><br></p>') {
                    quillEditor.root.innerHTML = html;
                } else if (text) {
                    quillEditor.setText(text);
                } else {
                    quillEditor.setText('');
                }
            }
        }

        // Convert HTML to plain text for letters
        function htmlToPlainText(html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;

            // Convert headers
            temp.querySelectorAll('h1, h2, h3').forEach(h => {
                h.innerHTML = h.textContent.toUpperCase() + '\n';
            });

            // Convert lists
            temp.querySelectorAll('ul li').forEach(li => {
                li.innerHTML = '‚Ä¢ ' + li.textContent;
            });
            temp.querySelectorAll('ol li').forEach((li, i) => {
                li.innerHTML = (i + 1) + '. ' + li.textContent;
            });

            // Convert links
            temp.querySelectorAll('a').forEach(a => {
                a.innerHTML = a.textContent + ' (' + a.href + ')';
            });

            // Get text and clean up
            let text = temp.textContent || temp.innerText || '';
            text = text.replace(/\n{3,}/g, '\n\n'); // Max 2 newlines
            return text.trim();
        }

        // Placeholder dropdown
        function setupPlaceholderDropdown() {
            const btn = document.getElementById('insert-placeholder-btn');
            const dropdown = document.getElementById('placeholder-dropdown');

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const rect = btn.getBoundingClientRect();
                dropdown.style.top = (rect.bottom + 5) + 'px';
                dropdown.style.left = rect.left + 'px';
                dropdown.classList.toggle('hidden');
            });

            dropdown.querySelectorAll('button[data-placeholder]').forEach(b => {
                b.addEventListener('click', () => {
                    const placeholder = b.dataset.placeholder;
                    if (isPlainTextMode) {
                        const textarea = document.getElementById('dispatch-body-plain');
                        const pos = textarea.selectionStart;
                        textarea.value = textarea.value.slice(0, pos) + placeholder + textarea.value.slice(pos);
                        textarea.focus();
                        textarea.selectionStart = textarea.selectionEnd = pos + placeholder.length;
                    } else if (quillEditor) {
                        const range = quillEditor.getSelection(true);
                        quillEditor.insertText(range.index, placeholder);
                    }
                    dropdown.classList.add('hidden');
                });
            });

            document.addEventListener('click', () => dropdown.classList.add('hidden'));
        }

        // File attachments handling
        function setupAttachments() {
            const input = document.getElementById('dispatch-attachments');
            const list = document.getElementById('attachment-list');

            input.addEventListener('change', () => {
                Array.from(input.files).forEach(file => {
                    if (file.size > 10 * 1024 * 1024) {
                        alert(`Datei "${file.name}" ist zu gross (max 10 MB)`);
                        return;
                    }
                    dispatchAttachments.push(file);
                });
                renderAttachmentList();
                input.value = '';
            });
        }

        function renderAttachmentList() {
            const list = document.getElementById('attachment-list');
            if (dispatchAttachments.length === 0) {
                list.innerHTML = '';
                return;
            }

            list.innerHTML = dispatchAttachments.map((file, i) => `
                <div class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded">
                    <span class="text-sm">üìé ${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                    <button type="button" onclick="removeAttachment(${i})" class="text-red-500 hover:text-red-700 text-sm">‚úï</button>
                </div>
            `).join('');
        }

        function removeAttachment(index) {
            dispatchAttachments.splice(index, 1);
            renderAttachmentList();
        }

        // Scheduled sending
        function setupScheduledSending() {
            const checkbox = document.getElementById('dispatch-scheduled');
            const options = document.getElementById('dispatch-schedule-options');

            checkbox.addEventListener('change', () => {
                options.classList.toggle('hidden', !checkbox.checked);
                if (checkbox.checked) {
                    // Set default to tomorrow 9:00
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(9, 0, 0, 0);
                    document.getElementById('dispatch-schedule-date').value =
                        tomorrow.toISOString().slice(0, 16);
                }
            });
        }

        // Update recipient counts (email vs post)
        function updateRecipientCounts() {
            const recipients = getFilteredRecipients();
            const deliveryMethod = document.querySelector('input[name="delivery-method"]:checked').value;

            let emailCount = 0;
            let postCount = 0;

            recipients.forEach(m => {
                if (deliveryMethod === 'email') {
                    emailCount++;
                } else if (deliveryMethod === 'post') {
                    postCount++;
                } else {
                    // Auto: based on member preference
                    if (m.zustellung_email && m.email) {
                        emailCount++;
                    } else if (m.zustellung_post) {
                        postCount++;
                    } else if (m.email) {
                        emailCount++; // Fallback to email
                    } else {
                        postCount++; // Last resort: post
                    }
                }
            });

            document.getElementById('dispatch-recipient-count').textContent = recipients.length;
            document.getElementById('dispatch-email-count').textContent = emailCount;
            document.getElementById('dispatch-post-count').textContent = postCount;

            // Show/hide Pingen cost estimate
            const costEstimate = document.getElementById('pingen-cost-estimate');
            if (postCount > 0) {
                costEstimate.classList.remove('hidden');
                document.getElementById('pingen-letter-count').textContent = postCount;
                document.getElementById('pingen-total-cost').textContent = postCount.toFixed(2);
            } else {
                costEstimate.classList.add('hidden');
            }
        }

        function updatePingenCostEstimate() {
            // Trigger recipient count update which handles Pingen costs
            updateRecipientCounts();
        }

        function getFilteredRecipients() {
            const recipientType = document.querySelector('input[name="recipient-type"]:checked').value;

            if (recipientType === 'all') {
                return members;
            } else if (recipientType === 'filter') {
                const status = document.getElementById('dispatch-filter-status').value;
                const emailOnly = document.getElementById('dispatch-filter-email').checked;
                const postOnly = document.getElementById('dispatch-filter-post').checked;

                return members.filter(m => {
                    if (status && m.status !== status) return false;
                    if (emailOnly && !m.zustellung_email) return false;
                    if (postOnly && !m.zustellung_post) return false;
                    return true;
                });
            } else if (recipientType === 'selected') {
                return members.filter(m => selectedMembersForDispatch.includes(m.id));
            }
            return [];
        }

        // Preview functions
        function showEmailPreview() {
            const subject = document.getElementById('dispatch-subject').value;
            const content = getDispatchContent();

            const sampleMember = members[0] || {
                anrede: 'Herr', vorname: 'Max', nachname: 'Mustermann',
                strasse: 'Musterstrasse 1', plz: '4303', ort: 'Kaiseraugst',
                email: 'max@example.com'
            };

            let html = content.html || content.text.replace(/\n/g, '<br>');
            html = replacePlaceholders(html, sampleMember);

            const previewDiv = document.getElementById('dispatch-preview');
            previewDiv.innerHTML = `
                <div class="border rounded-lg overflow-hidden">
                    <div class="bg-blue-50 px-4 py-2 border-b">
                        <div class="text-xs text-gray-500">An: ${sampleMember.email}</div>
                        <div class="font-semibold">${replacePlaceholders(subject, sampleMember) || '(kein Betreff)'}</div>
                    </div>
                    <div class="p-4 dispatch-preview-html">
                        ${html}
                    </div>
                    ${dispatchAttachments.length > 0 ? `
                        <div class="border-t px-4 py-2 bg-gray-50">
                            <span class="text-xs text-gray-500">Anh√§nge:</span>
                            ${dispatchAttachments.map(f => `<span class="ml-2 text-xs">üìé ${f.name}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function showLetterPreview() {
            const content = getDispatchContent();

            const sampleMember = members[0] || {
                anrede: 'Herr', vorname: 'Max', nachname: 'Mustermann',
                strasse: 'Musterstrasse 1', plz: '4303', ort: 'Kaiseraugst'
            };

            let text = content.text || htmlToPlainText(content.html);
            text = replacePlaceholders(text, sampleMember);

            const previewDiv = document.getElementById('dispatch-preview');
            previewDiv.innerHTML = `
                <div class="border rounded-lg overflow-hidden bg-white" style="max-width: 600px; margin: 0 auto;">
                    <div class="p-8 font-serif text-sm" style="min-height: 400px;">
                        <div class="text-right text-gray-500 text-xs mb-8">
                            Feuerwehrverein Raura<br>
                            Datum: ${new Date().toLocaleDateString('de-CH')}
                        </div>
                        <div class="mb-8">
                            <strong>${sampleMember.anrede} ${sampleMember.vorname} ${sampleMember.nachname}</strong><br>
                            ${sampleMember.strasse}<br>
                            ${sampleMember.plz} ${sampleMember.ort}
                        </div>
                        <div class="whitespace-pre-wrap">${text}</div>
                    </div>
                    <div class="border-t px-4 py-2 bg-orange-50 text-xs text-orange-700">
                        üìÆ Wird via Pingen als Brief versendet (ca. CHF 1.00)
                    </div>
                </div>
            `;
        }

        function replacePlaceholders(text, member) {
            if (!text) return '';
            return text
                .replace(/\{\{anrede\}\}/g, member.anrede || '')
                .replace(/\{\{vorname\}\}/g, member.vorname || '')
                .replace(/\{\{nachname\}\}/g, member.nachname || '')
                .replace(/\{\{strasse\}\}/g, member.strasse || '')
                .replace(/\{\{plz\}\}/g, member.plz || '')
                .replace(/\{\{ort\}\}/g, member.ort || '')
                .replace(/\{\{email\}\}/g, member.email || '');
        }

        // Draft functions
        async function saveDraft() {
            const subject = document.getElementById('dispatch-subject').value;
            const content = getDispatchContent();
            const recipientType = document.querySelector('input[name="recipient-type"]:checked').value;
            const deliveryMethod = document.querySelector('input[name="delivery-method"]:checked').value;

            if (!subject && !content.text) {
                alert('Bitte gib mindestens einen Betreff oder Nachrichtentext ein');
                return;
            }

            const draft = {
                id: 'draft_' + Date.now(),
                subject,
                html: content.html,
                text: content.text,
                recipientType,
                deliveryMethod,
                filterStatus: document.getElementById('dispatch-filter-status').value,
                selectedMembers: selectedMembersForDispatch,
                createdAt: new Date().toISOString()
            };

            // Save to localStorage
            const drafts = JSON.parse(localStorage.getItem('dispatchDrafts') || '[]');
            drafts.unshift(draft);
            localStorage.setItem('dispatchDrafts', JSON.stringify(drafts.slice(0, 20))); // Max 20 drafts

            alert('Entwurf gespeichert');
            loadDrafts();
        }

        function loadDrafts() {
            dispatchDrafts = JSON.parse(localStorage.getItem('dispatchDrafts') || '[]');
            const container = document.getElementById('drafts-list');

            if (dispatchDrafts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm py-4 text-center">Keine Entw√ºrfe vorhanden</p>';
                return;
            }

            container.innerHTML = dispatchDrafts.map((d, i) => `
                <div class="flex items-center justify-between bg-gray-50 px-4 py-3 rounded-lg">
                    <div class="flex-1">
                        <div class="font-medium">${d.subject || '(kein Betreff)'}</div>
                        <div class="text-xs text-gray-500">${new Date(d.createdAt).toLocaleString('de-CH')}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadDraft(${i})" class="text-sm text-blue-600 hover:text-blue-800">Laden</button>
                        <button onclick="deleteDraft(${i})" class="text-sm text-red-600 hover:text-red-800">L√∂schen</button>
                    </div>
                </div>
            `).join('');
        }

        function loadDraft(index) {
            const draft = dispatchDrafts[index];
            if (!draft) return;

            document.getElementById('dispatch-subject').value = draft.subject || '';
            setDispatchContent(draft.html, draft.text);

            // Set recipient type
            document.querySelector(`input[name="recipient-type"][value="${draft.recipientType}"]`).checked = true;
            document.querySelectorAll('input[name="recipient-type"]').forEach(r => r.dispatchEvent(new Event('change')));

            // Set delivery method
            document.querySelector(`input[name="delivery-method"][value="${draft.deliveryMethod}"]`).checked = true;

            if (draft.filterStatus) {
                document.getElementById('dispatch-filter-status').value = draft.filterStatus;
            }
            if (draft.selectedMembers) {
                selectedMembersForDispatch = draft.selectedMembers;
            }

            updateRecipientCounts();
            alert('Entwurf geladen');
        }

        function deleteDraft(index) {
            if (!confirm('Entwurf wirklich l√∂schen?')) return;
            dispatchDrafts.splice(index, 1);
            localStorage.setItem('dispatchDrafts', JSON.stringify(dispatchDrafts));
            loadDrafts();
        }

        // Scheduled messages
        function loadScheduledMessages() {
            // For now, just show placeholder - would need backend support
            const container = document.getElementById('scheduled-list');
            container.innerHTML = '<p class="text-gray-500 text-sm py-4 text-center">Keine geplanten Nachrichten</p>';
        }

        async function loadDispatchTemplates() {
            try {
                const response = await fetch(`${API_BASE}/templates`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    dispatchTemplates = await response.json();
                    const select = document.getElementById('dispatch-template');
                    select.innerHTML = '<option value="">Freier Text (keine Vorlage)</option>';
                    dispatchTemplates.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t.id;
                        option.textContent = `${t.name} (${t.type === 'email' ? 'E-Mail' : 'Post'})`;
                        select.appendChild(option);
                    });
                } else {
                    console.error('Failed to load templates:', response.status);
                }
            } catch (error) {
                console.error('Error loading dispatch templates:', error);
            }
        }

        function onTemplateSelected() {
            const templateId = document.getElementById('dispatch-template').value;
            const variablesContainer = document.getElementById('dispatch-variables');
            const variablesInputs = document.getElementById('dispatch-variables-inputs');
            const subjectInput = document.getElementById('dispatch-subject');

            if (!templateId) {
                currentTemplate = null;
                variablesContainer.classList.add('hidden');
                subjectInput.value = '';
                setDispatchContent('', '');
                return;
            }

            currentTemplate = dispatchTemplates.find(t => t.id === templateId);
            if (!currentTemplate) return;

            // Fill subject and body from template
            subjectInput.value = currentTemplate.subject || '';
            setDispatchContent(null, currentTemplate.body || '');

            // Show template variables if any
            const variables = currentTemplate.variables || [];
            const memberVars = ['anrede', 'vorname', 'nachname', 'strasse', 'plz', 'ort', 'email'];
            const customVars = variables.filter(v => !memberVars.includes(v));

            if (customVars.length > 0) {
                variablesInputs.innerHTML = customVars.map(v => `
                    <div class="flex items-center gap-2">
                        <label class="w-40 text-sm text-gray-600">{{${v}}}</label>
                        <input type="text" data-var="${v}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="${v}">
                    </div>
                `).join('');
                variablesContainer.classList.remove('hidden');
            } else {
                variablesContainer.classList.add('hidden');
            }
        }

        function updateRecipientCount() {
            const recipientType = document.querySelector('input[name="recipient-type"]:checked').value;
            let count = 0;

            if (recipientType === 'all') {
                count = members.length;
            } else if (recipientType === 'filter') {
                const status = document.getElementById('dispatch-filter-status').value;
                const emailOnly = document.getElementById('dispatch-filter-email').checked;
                const postOnly = document.getElementById('dispatch-filter-post').checked;

                count = members.filter(m => {
                    if (status && m.status !== status) return false;
                    if (emailOnly && !m.zustellung_email) return false;
                    if (postOnly && !m.zustellung_post) return false;
                    return true;
                }).length;
            } else if (recipientType === 'selected') {
                count = selectedMembersForDispatch.length;
            }

            document.getElementById('dispatch-recipient-count').textContent = count;
        }

        async function sendDispatch() {
            const deliveryMethod = document.querySelector('input[name="delivery-method"]:checked').value;
            const recipientType = document.querySelector('input[name="recipient-type"]:checked').value;
            const templateId = document.getElementById('dispatch-template').value;
            const subject = document.getElementById('dispatch-subject').value;
            const content = getDispatchContent();
            const isScheduled = document.getElementById('dispatch-scheduled').checked;
            const scheduleDate = document.getElementById('dispatch-schedule-date').value;

            if (!subject && deliveryMethod !== 'post') {
                alert('Bitte Betreff eingeben');
                return;
            }

            if (!content.text && !templateId) {
                alert('Bitte Nachricht oder Vorlage ausw√§hlen');
                return;
            }

            if (isScheduled && !scheduleDate) {
                alert('Bitte Versanddatum ausw√§hlen');
                return;
            }

            // For scheduled messages, save and return
            if (isScheduled) {
                alert('Zeitgesteuerter Versand wird noch nicht unterst√ºtzt.\nBitte Entwurf speichern und sp√§ter manuell senden.');
                return;
            }

            // Get recipients
            let recipients = [];
            if (recipientType === 'all') {
                recipients = members;
            } else if (recipientType === 'filter') {
                const status = document.getElementById('dispatch-filter-status').value;
                const emailOnly = document.getElementById('dispatch-filter-email').checked;
                const postOnly = document.getElementById('dispatch-filter-post').checked;

                recipients = members.filter(m => {
                    if (status && m.status !== status) return false;
                    if (emailOnly && !m.zustellung_email) return false;
                    if (postOnly && !m.zustellung_post) return false;
                    return true;
                });
            } else if (recipientType === 'selected') {
                recipients = selectedMembersForDispatch;
            }

            if (recipients.length === 0) {
                alert('Keine Empf√§nger ausgew√§hlt');
                return;
            }

            // For auto mode, split recipients by their preference
            let emailRecipients = [];
            let postRecipients = [];

            if (deliveryMethod === 'auto') {
                emailRecipients = recipients.filter(m => m.zustellung_email && m.email);
                postRecipients = recipients.filter(m => m.zustellung_post && m.strasse && m.plz && m.ort);

                const totalToSend = emailRecipients.length + postRecipients.length;
                const message = `Versand an ${totalToSend} Empf√§nger:\n- ${emailRecipients.length} per E-Mail\n- ${postRecipients.length} per Post`;
                if (!confirm(message)) return;
            } else if (deliveryMethod === 'email') {
                emailRecipients = recipients.filter(m => m.email);
                if (!confirm(`E-Mail an ${emailRecipients.length} Empf√§nger senden?`)) return;
            } else {
                postRecipients = recipients.filter(m => m.strasse && m.plz && m.ort);
                if (!confirm(`Brief an ${postRecipients.length} Empf√§nger senden?`)) return;
            }

            try {
                let emailSuccess = 0;
                let postSuccess = 0;

                // Send emails (with HTML support)
                if (emailRecipients.length > 0) {
                    const response = await fetch(`${API_BASE}/email/bulk`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            member_ids: emailRecipients.map(m => m.id),
                            template_id: templateId || null,
                            subject,
                            body: content.text,
                            html: content.html,
                            variables: {},
                            // TODO: Add attachments support
                            attachments: []
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        emailSuccess = result.success || 0;
                    } else {
                        throw new Error(`Email API error: ${response.status}`);
                    }
                }

                // Send post (convert HTML to plain text for letters)
                if (postRecipients.length > 0) {
                    const letterText = content.html ? htmlToPlainText(content.html) : content.text;

                    for (const member of postRecipients) {
                        // Replace placeholders for this member
                        const personalizedText = replacePlaceholders(letterText, member);

                        const recipient = {
                            name: `${member.vorname} ${member.nachname}`,
                            street: member.strasse,
                            zip: member.plz,
                            city: member.ort
                        };

                        const response = await fetch(`${API_BASE}/pingen/send`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                text: personalizedText,
                                recipient,
                                member_id: member.id
                            })
                        });

                        if (response.ok) {
                            postSuccess++;
                        }
                    }
                }

                let message = 'Versand erfolgreich:';
                if (emailSuccess > 0) message += `\n- ${emailSuccess} E-Mails`;
                if (postSuccess > 0) message += `\n- ${postSuccess} Briefe`;
                alert(message);
                loadDispatchHistory();
            } catch (error) {
                console.error('Error sending dispatch:', error);
                alert(`Fehler beim Versand: ${error.message}`);
            }
        }

        async function loadDispatchHistory() {
            try {
                const response = await fetch(`${API_BASE}/dispatch-log?limit=50`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const logs = await response.json();
                    const tbody = document.getElementById('dispatch-history-tbody');

                    if (logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Keine Versandhistorie vorhanden</td></tr>';
                        return;
                    }

                    tbody.innerHTML = logs.map(log => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${new Date(log.sent_at).toLocaleString('de-CH')}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${log.type === 'email' ? 'E-Mail' : 'Post'}</td>
                            <td class="px-6 py-4 text-sm">${log.subject || '-'}</td>
                            <td class="px-6 py-4 text-sm">${log.recipient_email || log.recipient_name || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-2 py-1 rounded-full text-xs ${log.status === 'sent' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${log.status}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading dispatch history:', error);
            }
        }

        // ============================================
        // REGISTRATIONS
        // ============================================

        let registrations = [];

        async function loadRegistrationCount() {
            try {
                const response = await fetch(`${API_BASE}/member-registrations/count/pending`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('registrations-badge');
                    if (data.count > 0) {
                        badge.textContent = data.count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Error loading registration count:', error);
            }
        }

        async function loadRegistrations() {
            try {
                document.getElementById('registrations-loading').classList.remove('hidden');
                document.getElementById('registrations-empty').classList.add('hidden');

                const status = document.getElementById('registrations-filter').value;
                const response = await fetch(`${API_BASE}/member-registrations?status=${status}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to load registrations');

                registrations = await response.json();
                renderRegistrations();
                loadRegistrationCount();
            } catch (error) {
                console.error('Error loading registrations:', error);
            } finally {
                document.getElementById('registrations-loading').classList.add('hidden');
            }
        }

        function renderRegistrations() {
            const tbody = document.getElementById('registrations-tbody');

            if (registrations.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('registrations-empty').classList.remove('hidden');
                return;
            }

            document.getElementById('registrations-empty').classList.add('hidden');

            tbody.innerHTML = registrations.map(reg => {
                const date = new Date(reg.created_at).toLocaleDateString('de-CH');
                const feuerwehrStatus = {
                    'active': 'Aktiv',
                    'former': 'Ehemalig',
                    'no': 'Nein'
                }[reg.feuerwehr_status] || reg.feuerwehr_status || '-';

                const statusClass = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'approved': 'bg-green-100 text-green-800',
                    'rejected': 'bg-red-100 text-red-800'
                }[reg.status] || 'bg-gray-100 text-gray-800';

                const statusText = {
                    'pending': 'Ausstehend',
                    'approved': 'Genehmigt',
                    'rejected': 'Abgelehnt'
                }[reg.status] || reg.status;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">${reg.vorname} ${reg.nachname}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-600">${reg.email}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-600">${feuerwehrStatus}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-600">${date}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${statusText}</span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="viewRegistration('${reg.id}')" class="text-fire-600 hover:text-fire-800">
                                Anzeigen
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function viewRegistration(id) {
            try {
                const response = await fetch(`${API_BASE}/member-registrations/${id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to load registration');

                const reg = await response.json();

                document.getElementById('registration-id').value = reg.id;
                document.getElementById('reg-vorname').textContent = reg.vorname;
                document.getElementById('reg-nachname').textContent = reg.nachname;
                document.getElementById('reg-adresse').textContent = `${reg.strasse || ''}, ${reg.plz || ''} ${reg.ort || ''}`;
                document.getElementById('reg-telefon').textContent = reg.telefon || '-';
                document.getElementById('reg-mobile').textContent = reg.mobile || '-';
                document.getElementById('reg-email').textContent = reg.email;

                const feuerwehrStatus = {
                    'active': 'Aktives Feuerwehr-Mitglied',
                    'former': 'Ehemaliges Feuerwehr-Mitglied',
                    'no': 'Kein Feuerwehr-Mitglied'
                }[reg.feuerwehr_status] || reg.feuerwehr_status || '-';
                document.getElementById('reg-feuerwehr').textContent = feuerwehrStatus;

                const korrespondenz = {
                    'email': 'E-Mail',
                    'post': 'Post'
                }[reg.korrespondenz_methode] || reg.korrespondenz_methode || '-';
                document.getElementById('reg-korrespondenz').textContent = korrespondenz;

                document.getElementById('reg-datum').textContent = new Date(reg.created_at).toLocaleString('de-CH');

                // Show/hide actions based on status
                if (reg.status === 'pending') {
                    document.getElementById('registration-actions').classList.remove('hidden');
                    document.getElementById('registration-processed').classList.add('hidden');
                } else {
                    document.getElementById('registration-actions').classList.add('hidden');
                    document.getElementById('registration-processed').classList.remove('hidden');
                    document.getElementById('reg-processed-by').textContent = reg.processed_by || '-';
                    document.getElementById('reg-processed-at').textContent = reg.processed_at
                        ? new Date(reg.processed_at).toLocaleString('de-CH')
                        : '-';

                    if (reg.rejection_reason) {
                        document.getElementById('reg-rejection-reason').textContent = `Grund: ${reg.rejection_reason}`;
                        document.getElementById('reg-rejection-reason').classList.remove('hidden');
                    } else {
                        document.getElementById('reg-rejection-reason').classList.add('hidden');
                    }
                }

                document.getElementById('registration-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading registration:', error);
                alert('Fehler beim Laden des Antrags');
            }
        }

        async function approveRegistration() {
            const id = document.getElementById('registration-id').value;
            const memberStatus = document.getElementById('reg-member-status').value;

            if (!confirm('M√∂chten Sie diesen Antrag genehmigen?')) return;

            try {
                const response = await fetch(`${API_BASE}/member-registrations/${id}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ memberStatus })
                });

                if (!response.ok) throw new Error('Failed to approve registration');

                alert('Antrag wurde genehmigt und Mitglied erstellt.');
                document.getElementById('registration-modal').classList.add('hidden');
                loadRegistrations();
            } catch (error) {
                console.error('Error approving registration:', error);
                alert('Fehler beim Genehmigen des Antrags');
            }
        }

        async function rejectRegistration() {
            const id = document.getElementById('registration-id').value;
            const reason = prompt('Grund f√ºr die Ablehnung (optional):');

            if (!confirm('M√∂chten Sie diesen Antrag wirklich ablehnen?')) return;

            try {
                const response = await fetch(`${API_BASE}/member-registrations/${id}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ reason })
                });

                if (!response.ok) throw new Error('Failed to reject registration');

                alert('Antrag wurde abgelehnt.');
                document.getElementById('registration-modal').classList.add('hidden');
                loadRegistrations();
            } catch (error) {
                console.error('Error rejecting registration:', error);
                alert('Fehler beim Ablehnen des Antrags');
            }
        }

        // ============================================
        // TAB SWITCHING
        // ============================================

        function switchTab(tab) {
            currentTab = tab;

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-fire-500', 'text-fire-600');
                btn.classList.add('border-transparent', 'text-gray-600');
            });

            document.getElementById('members-section').classList.add('hidden');
            document.getElementById('events-section').classList.add('hidden');
            document.getElementById('audit-section').classList.add('hidden');
            document.getElementById('dispatch-section').classList.add('hidden');
            document.getElementById('email-section').classList.add('hidden');
            document.getElementById('registrations-section').classList.add('hidden');
            document.getElementById('pingen-section').classList.add('hidden');
            document.getElementById('whitelist-section').classList.add('hidden');

            if (tab === 'members') {
                document.getElementById('tab-members').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('members-section').classList.remove('hidden');
            } else if (tab === 'events') {
                document.getElementById('tab-events').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('events-section').classList.remove('hidden');
                loadEvents();
            } else if (tab === 'audit') {
                document.getElementById('tab-audit').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('audit-section').classList.remove('hidden');
                loadAuditLog();
            } else if (tab === 'dispatch') {
                document.getElementById('tab-dispatch').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('dispatch-section').classList.remove('hidden');
                initQuillEditor();
                loadDispatchTemplates();
                loadDispatchHistory();
                loadDrafts();
                loadScheduledMessages();
                updateRecipientCount();
                updateRecipientCounts();
            } else if (tab === 'email') {
                document.getElementById('tab-email').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('email-section').classList.remove('hidden');
                loadMailboxes();
            } else if (tab === 'registrations') {
                document.getElementById('tab-registrations').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('registrations-section').classList.remove('hidden');
                loadRegistrations();
            } else if (tab === 'pingen') {
                document.getElementById('tab-pingen').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('pingen-section').classList.remove('hidden');
                loadPingenData();
            } else if (tab === 'whitelist') {
                document.getElementById('tab-whitelist').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('whitelist-section').classList.remove('hidden');
                loadWhitelist();
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        // Tabs
        document.getElementById('tab-members').addEventListener('click', () => switchTab('members'));
        document.getElementById('tab-events').addEventListener('click', () => switchTab('events'));
        document.getElementById('tab-audit').addEventListener('click', () => switchTab('audit'));
        document.getElementById('tab-dispatch').addEventListener('click', () => switchTab('dispatch'));
        document.getElementById('tab-email').addEventListener('click', () => switchTab('email'));
        document.getElementById('tab-registrations').addEventListener('click', () => switchTab('registrations'));
        document.getElementById('tab-pingen').addEventListener('click', () => switchTab('pingen'));
        document.getElementById('tab-whitelist').addEventListener('click', () => switchTab('whitelist'));

        // Members
        document.getElementById('add-member-btn').addEventListener('click', openNewMemberModal);
        document.getElementById('member-form').addEventListener('submit', saveMember);
        document.getElementById('delete-member-btn').addEventListener('click', deleteMember);
        document.getElementById('close-modal').addEventListener('click', () => document.getElementById('member-modal').classList.add('hidden'));
        document.getElementById('cancel-btn').addEventListener('click', () => document.getElementById('member-modal').classList.add('hidden'));
        document.getElementById('search-input').addEventListener('input', (e) => loadMembers({ search: e.target.value, status: document.getElementById('status-filter').value }));
        document.getElementById('status-filter').addEventListener('change', (e) => loadMembers({ search: document.getElementById('search-input').value, status: e.target.value }));

        // Export dropdown
        const exportDropdownBtn = document.getElementById('export-dropdown-btn');
        const exportDropdown = document.getElementById('export-dropdown');
        exportDropdownBtn.addEventListener('click', () => {
            exportDropdown.classList.toggle('hidden');
        });
        document.addEventListener('click', (e) => {
            if (!exportDropdownBtn.contains(e.target) && !exportDropdown.contains(e.target)) {
                exportDropdown.classList.add('hidden');
            }
        });
        document.getElementById('export-all-btn').addEventListener('click', () => {
            exportCSV('all');
            exportDropdown.classList.add('hidden');
        });
        document.getElementById('export-aktiv-btn').addEventListener('click', () => {
            exportCSV('aktiv');
            exportDropdown.classList.add('hidden');
        });
        document.getElementById('export-post-btn').addEventListener('click', () => {
            exportCSV('post');
            exportDropdown.classList.add('hidden');
        });
        document.getElementById('export-email-btn').addEventListener('click', () => {
            exportCSV('email');
            exportDropdown.classList.add('hidden');
        });
        document.getElementById('export-pdf-telefonliste-btn').addEventListener('click', async () => {
            exportDropdown.classList.add('hidden');
            try {
                const response = await fetch(`${API_BASE}/members/pdf/telefonliste`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('PDF konnte nicht erstellt werden');
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Telefonliste_Mitglieder.pdf';
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('PDF error:', error);
                alert('Fehler beim Erstellen der PDF');
            }
        });

        // Photo upload
        document.getElementById('photo-upload-btn').addEventListener('click', () => {
            document.getElementById('photo-upload').click();
        });
        document.getElementById('photo-upload').addEventListener('change', (e) => {
            if (e.target.files[0]) {
                uploadMemberPhoto(e.target.files[0]);
                e.target.value = ''; // Reset for next upload
            }
        });
        document.getElementById('photo-delete-btn').addEventListener('click', deleteMemberPhoto);

        // Auto-set Eintrittsdatum when Feuerwehr Raurica is selected
        document.getElementById('feuerwehr-zugehoerigkeit').addEventListener('change', (e) => {
            if (e.target.value === 'feuerwehr_raurica') {
                const today = new Date().toISOString().split('T')[0];
                const eintrittsdatum = document.getElementById('eintrittsdatum');
                if (!eintrittsdatum.value) {
                    eintrittsdatum.value = today;
                }
            }
        });

        // Events
        document.getElementById('add-event-btn').addEventListener('click', openNewEventModal);
        document.getElementById('event-form').addEventListener('submit', saveEvent);
        document.getElementById('delete-event-btn').addEventListener('click', deleteEvent);
        document.getElementById('close-event-modal').addEventListener('click', () => document.getElementById('event-modal').classList.add('hidden'));
        document.getElementById('cancel-event-btn').addEventListener('click', () => document.getElementById('event-modal').classList.add('hidden'));
        document.getElementById('event-category').addEventListener('change', updateEventFormByCategory);

        // Audit
        document.getElementById('audit-action-filter').addEventListener('change', (e) => loadAuditLog({ action: e.target.value }));
        document.getElementById('refresh-audit-btn').addEventListener('click', () => loadAuditLog({ action: document.getElementById('audit-action-filter').value }));

        // Email Management
        document.getElementById('add-mailbox-btn').addEventListener('click', openNewMailboxModal);
        document.getElementById('add-alias-btn').addEventListener('click', openNewAliasModal);
        document.getElementById('mailbox-form').addEventListener('submit', saveMailbox);
        document.getElementById('alias-form').addEventListener('submit', saveAlias);
        document.querySelectorAll('.close-mailbox-modal').forEach(btn => btn.addEventListener('click', () => document.getElementById('mailbox-modal').classList.add('hidden')));
        document.querySelectorAll('.close-alias-modal').forEach(btn => btn.addEventListener('click', () => document.getElementById('alias-modal').classList.add('hidden')));

        // Email Sub-Tabs
        document.getElementById('email-tab-mailboxes').addEventListener('click', () => switchEmailTab('mailboxes'));
        document.getElementById('email-tab-aliases').addEventListener('click', () => switchEmailTab('aliases'));
        document.getElementById('email-tab-quota').addEventListener('click', () => switchEmailTab('quota'));
        document.getElementById('email-tab-zustellung').addEventListener('click', () => switchEmailTab('zustellung'));

        // Zustellung Emails
        document.getElementById('copy-emails-btn').addEventListener('click', copyZustellungEmails);
        document.getElementById('refresh-emails-btn').addEventListener('click', loadZustellungEmails);
        document.getElementById('sync-alias-btn').addEventListener('click', syncMitgliederAlias);

        // Dispatch
        document.querySelectorAll('input[name="delivery-method"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const method = document.querySelector('input[name="delivery-method"]:checked').value;
                // Show subject field for email or auto mode (since auto can send emails)
                const showSubject = method === 'email' || method === 'auto';
                document.getElementById('dispatch-subject-container').style.display = showSubject ? 'block' : 'none';
            });
        });

        document.querySelectorAll('input[name="recipient-type"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const recipientType = document.querySelector('input[name="recipient-type"]:checked').value;
                document.getElementById('recipient-filter').classList.toggle('hidden', recipientType !== 'filter');
                document.getElementById('recipient-selected').classList.toggle('hidden', recipientType !== 'selected');
                updateRecipientCount();
            });
        });

        document.getElementById('dispatch-filter-status').addEventListener('change', updateRecipientCount);
        document.getElementById('dispatch-filter-email').addEventListener('change', updateRecipientCount);
        document.getElementById('dispatch-filter-post').addEventListener('change', updateRecipientCount);
        document.getElementById('dispatch-template').addEventListener('change', onTemplateSelected);
        document.getElementById('dispatch-send-btn').addEventListener('click', sendDispatch);

        // New dispatch features
        document.getElementById('toggle-editor-mode').addEventListener('click', toggleEditorMode);
        document.getElementById('preview-email-btn').addEventListener('click', showEmailPreview);
        document.getElementById('preview-letter-btn').addEventListener('click', showLetterPreview);
        document.getElementById('dispatch-save-draft-btn').addEventListener('click', saveDraft);
        document.getElementById('refresh-drafts-btn').addEventListener('click', loadDrafts);
        document.getElementById('refresh-scheduled-btn').addEventListener('click', loadScheduledMessages);
        document.querySelectorAll('input[name="delivery-method"]').forEach(r => {
            r.addEventListener('change', updateRecipientCounts);
        });

        // Initialize Quill editor when dispatch tab is shown
        setupPlaceholderDropdown();
        setupAttachments();
        setupScheduledSending();

        // Registrations
        document.getElementById('registrations-filter').addEventListener('change', () => loadRegistrations());
        document.getElementById('refresh-registrations-btn').addEventListener('click', () => loadRegistrations());
        document.getElementById('close-registration-modal').addEventListener('click', () => document.getElementById('registration-modal').classList.add('hidden'));
        document.getElementById('approve-registration-btn').addEventListener('click', approveRegistration);
        document.getElementById('reject-registration-btn').addEventListener('click', rejectRegistration);

        // Pingen
        document.getElementById('send-letter-btn').addEventListener('click', openPingenModal);
        document.getElementById('send-bulk-pdf-btn').addEventListener('click', openBulkPdfModal);
        document.getElementById('refresh-pingen-btn').addEventListener('click', loadPingenData);
        document.getElementById('pingen-event-filter').addEventListener('change', loadPingenLetters);
        document.getElementById('pingen-staging-toggle').addEventListener('change', loadPingenData);
        document.getElementById('close-pingen-modal').addEventListener('click', () => document.getElementById('pingen-modal').classList.add('hidden'));
        document.getElementById('cancel-pingen-btn').addEventListener('click', () => document.getElementById('pingen-modal').classList.add('hidden'));
        document.getElementById('pingen-form').addEventListener('submit', sendPingenLetter);
        document.getElementById('pingen-member').addEventListener('change', showPingenMemberAddress);
        document.getElementById('register-webhook-btn').addEventListener('click', registerPingenWebhook);

        // Bulk PDF
        document.getElementById('close-bulk-pdf-modal').addEventListener('click', () => document.getElementById('bulk-pdf-modal').classList.add('hidden'));
        document.getElementById('cancel-bulk-pdf-btn').addEventListener('click', () => document.getElementById('bulk-pdf-modal').classList.add('hidden'));
        document.getElementById('bulk-pdf-form').addEventListener('submit', sendBulkPdf);
        document.getElementById('select-all-recipients').addEventListener('click', selectAllRecipients);
        document.getElementById('deselect-all-recipients').addEventListener('click', deselectAllRecipients);

        function switchEmailTab(tab) {
            document.querySelectorAll('.email-tab-btn').forEach(btn => {
                btn.classList.remove('border-fire-500', 'text-fire-600');
                btn.classList.add('border-transparent', 'text-gray-600');
            });
            document.getElementById('mailboxes-panel').classList.add('hidden');
            document.getElementById('aliases-panel').classList.add('hidden');
            document.getElementById('quota-panel').classList.add('hidden');
            document.getElementById('zustellung-panel').classList.add('hidden');

            if (tab === 'mailboxes') {
                document.getElementById('email-tab-mailboxes').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('mailboxes-panel').classList.remove('hidden');
                loadMailboxes();
            } else if (tab === 'aliases') {
                document.getElementById('email-tab-aliases').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('aliases-panel').classList.remove('hidden');
                loadAliases();
            } else if (tab === 'quota') {
                document.getElementById('email-tab-quota').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('quota-panel').classList.remove('hidden');
                loadQuota();
            } else if (tab === 'zustellung') {
                document.getElementById('email-tab-zustellung').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('zustellung-panel').classList.remove('hidden');
                loadZustellungEmails();
            }
        }

        async function loadMailboxes() {
            document.getElementById('mailboxes-loading').classList.remove('hidden');
            try {
                const response = await fetch(`${API_BASE}/mailcow/mailboxes`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const mailboxes = await response.json();
                const tbody = document.getElementById('mailboxes-tbody');
                tbody.innerHTML = mailboxes.map(mb => `
                    <tr>
                        <td class="px-6 py-4 font-medium">${mb.username}</td>
                        <td class="px-6 py-4">${mb.name || '-'}</td>
                        <td class="px-6 py-4">${Math.round(mb.quota_used / 1024 / 1024)} / ${mb.quota} MB</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${mb.active == 1 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${mb.active == 1 ? 'Aktiv' : 'Inaktiv'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="editMailbox('${mb.username}')" class="text-blue-600 hover:text-blue-800 mr-3">Bearbeiten</button>
                            <button onclick="deleteMailbox('${mb.username}')" class="text-red-600 hover:text-red-800">Loeschen</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading mailboxes:', error);
            }
            document.getElementById('mailboxes-loading').classList.add('hidden');
        }

        async function loadAliases() {
            document.getElementById('aliases-loading').classList.remove('hidden');
            try {
                const response = await fetch(`${API_BASE}/mailcow/aliases`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const aliases = await response.json();
                const tbody = document.getElementById('aliases-tbody');
                tbody.innerHTML = aliases.map(a => `
                    <tr>
                        <td class="px-6 py-4 font-medium">${a.address}</td>
                        <td class="px-6 py-4">${a.goto}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${a.active == 1 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${a.active == 1 ? 'Aktiv' : 'Inaktiv'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="editAlias(${a.id}, '${a.address}', '${a.goto}', ${a.active})" class="text-blue-600 hover:text-blue-800 mr-3">Bearbeiten</button>
                            <button onclick="deleteAlias(${a.id})" class="text-red-600 hover:text-red-800">Loeschen</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading aliases:', error);
            }
            document.getElementById('aliases-loading').classList.add('hidden');
        }

        async function loadQuota() {
            document.getElementById('quota-loading').classList.remove('hidden');
            try {
                const response = await fetch(`${API_BASE}/mailcow/quota`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const quotaData = await response.json();
                const container = document.getElementById('quota-cards');
                container.innerHTML = quotaData.map(q => `
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="font-medium text-gray-800">${q.email}</div>
                        <div class="text-sm text-gray-600 mb-2">${q.name || ''}</div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-1">
                            <div class="h-3 rounded-full ${q.percent_used > 90 ? 'bg-red-500' : q.percent_used > 70 ? 'bg-yellow-500' : 'bg-green-500'}"
                                 style="width: ${Math.min(q.percent_used, 100)}%"></div>
                        </div>
                        <div class="text-xs text-gray-500">${Math.round(q.quota_used / 1024 / 1024)} / ${q.quota} MB (${q.percent_used}%)</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading quota:', error);
            }
            document.getElementById('quota-loading').classList.add('hidden');
        }

        // Zustellung Email List Functions
        async function loadZustellungEmails() {
            try {
                const response = await fetch(`${API_BASE}/members/emails/zustellung`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                // Update count
                document.getElementById('zustellung-count').textContent = data.count;

                // Update textarea with formatted emails
                document.getElementById('zustellung-emails').value = data.formatted;

                // Update table
                const tbody = document.getElementById('zustellung-tbody');
                tbody.innerHTML = data.members.map(m => `
                    <tr>
                        <td class="px-4 py-2 font-medium">${m.vorname} ${m.nachname}</td>
                        <td class="px-4 py-2 font-mono text-sm">${m.email}</td>
                        <td class="px-4 py-2">
                            <span class="px-2 py-1 rounded text-xs ${getMemberStatusColor(m.status)}">${m.status}</span>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading zustellung emails:', error);
                showToast('Fehler beim Laden der E-Mail-Liste', 'error');
            }
        }

        function copyZustellungEmails() {
            const emails = document.getElementById('zustellung-emails').value;
            if (!emails) {
                showToast('Keine E-Mails zum Kopieren', 'error');
                return;
            }
            navigator.clipboard.writeText(emails).then(() => {
                showToast('E-Mail-Adressen kopiert!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                document.getElementById('zustellung-emails').select();
                document.execCommand('copy');
                showToast('E-Mail-Adressen kopiert!', 'success');
            });
        }

        async function syncMitgliederAlias() {
            const btn = document.getElementById('sync-alias-btn');
            const statusEl = document.getElementById('alias-status');

            btn.disabled = true;
            btn.textContent = '‚è≥ Synchronisiere...';
            statusEl.textContent = 'Synchronisiere Alias...';

            try {
                const response = await fetch(`${API_BASE}/members/emails/sync-alias`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (response.ok) {
                    statusEl.innerHTML = `‚úÖ Alias ${data.action === 'created' ? 'erstellt' : 'aktualisiert'} mit <strong>${data.recipients}</strong> Empf√§ngern`;
                    showToast(`Alias erfolgreich ${data.action === 'created' ? 'erstellt' : 'aktualisiert'}!`, 'success');
                } else {
                    statusEl.textContent = `‚ùå Fehler: ${data.error}`;
                    showToast('Fehler beim Synchronisieren: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Alias sync error:', error);
                statusEl.textContent = '‚ùå Verbindungsfehler';
                showToast('Fehler beim Synchronisieren', 'error');
            }

            btn.disabled = false;
            btn.textContent = '‚Üª Alias synchronisieren';
        }

        function openNewMailboxModal() {
            document.getElementById('mailbox-modal-title').textContent = 'Neue Mailbox';
            document.getElementById('mailbox-edit-email').value = '';
            document.getElementById('mailbox-local').value = '';
            document.getElementById('mailbox-local').disabled = false;
            document.getElementById('mailbox-name').value = '';
            document.getElementById('mailbox-password').value = '';
            document.getElementById('mailbox-password').required = true;
            document.getElementById('mailbox-password-hint').textContent = 'Erforderlich fuer neue Mailbox';
            document.getElementById('mailbox-quota').value = '1024';
            document.getElementById('mailbox-active').checked = true;
            document.getElementById('mailbox-modal').classList.remove('hidden');
        }

        async function editMailbox(email) {
            const response = await fetch(`${API_BASE}/mailcow/mailboxes/${email}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const mb = await response.json();

            document.getElementById('mailbox-modal-title').textContent = 'Mailbox bearbeiten';
            document.getElementById('mailbox-edit-email').value = email;
            document.getElementById('mailbox-local').value = email.split('@')[0];
            document.getElementById('mailbox-local').disabled = true;
            document.getElementById('mailbox-name').value = mb.name || '';
            document.getElementById('mailbox-password').value = '';
            document.getElementById('mailbox-password').required = false;
            document.getElementById('mailbox-password-hint').textContent = 'Leer lassen um Passwort nicht zu aendern';
            document.getElementById('mailbox-quota').value = mb.quota || 1024;
            document.getElementById('mailbox-active').checked = mb.active == 1;
            document.getElementById('mailbox-modal').classList.remove('hidden');
        }

        async function saveMailbox(e) {
            e.preventDefault();
            const editEmail = document.getElementById('mailbox-edit-email').value;
            const isEdit = !!editEmail;

            const data = {
                name: document.getElementById('mailbox-name').value,
                quota: parseInt(document.getElementById('mailbox-quota').value),
                active: document.getElementById('mailbox-active').checked ? 1 : 0
            };

            if (!isEdit) {
                data.local_part = document.getElementById('mailbox-local').value;
                data.password = document.getElementById('mailbox-password').value;
            } else if (document.getElementById('mailbox-password').value) {
                data.password = document.getElementById('mailbox-password').value;
            }

            try {
                const response = await fetch(`${API_BASE}/mailcow/mailboxes${isEdit ? '/' + editEmail : ''}`, {
                    method: isEdit ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Fehler beim Speichern');
                document.getElementById('mailbox-modal').classList.add('hidden');
                loadMailboxes();
            } catch (error) {
                alert('Fehler: ' + error.message);
            }
        }

        async function deleteMailbox(email) {
            if (!confirm(`Mailbox ${email} wirklich loeschen? Alle E-Mails gehen verloren!`)) return;
            try {
                await fetch(`${API_BASE}/mailcow/mailboxes/${email}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                loadMailboxes();
            } catch (error) {
                alert('Fehler beim Loeschen');
            }
        }

        function openNewAliasModal() {
            document.getElementById('alias-modal-title').textContent = 'Neuer Alias';
            document.getElementById('alias-edit-id').value = '';
            document.getElementById('alias-address').value = '';
            document.getElementById('alias-address').disabled = false;
            document.getElementById('alias-goto').value = '';
            document.getElementById('alias-active').checked = true;
            document.getElementById('alias-modal').classList.remove('hidden');
        }

        function editAlias(id, address, goto, active) {
            document.getElementById('alias-modal-title').textContent = 'Alias bearbeiten';
            document.getElementById('alias-edit-id').value = id;
            document.getElementById('alias-address').value = address.split('@')[0];
            document.getElementById('alias-address').disabled = true;
            document.getElementById('alias-goto').value = goto;
            document.getElementById('alias-active').checked = active == 1;
            document.getElementById('alias-modal').classList.remove('hidden');
        }

        async function saveAlias(e) {
            e.preventDefault();
            const editId = document.getElementById('alias-edit-id').value;
            const isEdit = !!editId;

            const data = {
                goto: document.getElementById('alias-goto').value,
                active: document.getElementById('alias-active').checked ? 1 : 0
            };

            if (!isEdit) {
                data.address = document.getElementById('alias-address').value;
            }

            try {
                const response = await fetch(`${API_BASE}/mailcow/aliases${isEdit ? '/' + editId : ''}`, {
                    method: isEdit ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Fehler beim Speichern');
                document.getElementById('alias-modal').classList.add('hidden');
                loadAliases();
            } catch (error) {
                alert('Fehler: ' + error.message);
            }
        }

        async function deleteAlias(id) {
            if (!confirm('Alias wirklich loeschen?')) return;
            try {
                await fetch(`${API_BASE}/mailcow/aliases/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                loadAliases();
            } catch (error) {
                alert('Fehler beim Loeschen');
            }
        }

        // ============================================
        // PINGEN FUNCTIONS
        // ============================================

        function isPingenStaging() {
            return document.getElementById('pingen-staging-toggle')?.checked || false;
        }

        async function loadPingenData() {
            await Promise.all([
                loadPingenAccount(),
                loadPingenStats(),
                loadPingenLetters(),
                loadPingenEventFilter(),
                loadPingenWebhooks()
            ]);
        }

        async function loadPingenAccount() {
            try {
                const staging = isPingenStaging();
                const response = await fetch(`${DISPATCH_API}/pingen/account?staging=${staging}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('pingen-balance').textContent =
                        data.balance !== undefined ? `${data.balance.toFixed(2)} ${data.currency}` : '-';

                    // Staging-Warnung anzeigen
                    if (staging) {
                        document.getElementById('pingen-staging-warning').classList.remove('hidden');
                    } else {
                        document.getElementById('pingen-staging-warning').classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Error loading Pingen account:', error);
            }
        }

        async function loadPingenStats() {
            try {
                const response = await fetch(`${DISPATCH_API}/pingen/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('pingen-sent').textContent = stats.sent || '0';
                    document.getElementById('pingen-pending').textContent = stats.pending || '0';
                    document.getElementById('pingen-failed').textContent = stats.failed || '0';
                    document.getElementById('pingen-30days').textContent = stats.last_30_days || '0';
                }
            } catch (error) {
                console.error('Error loading Pingen stats:', error);
            }
        }

        async function loadPingenLetters() {
            document.getElementById('pingen-loading').classList.remove('hidden');
            document.getElementById('pingen-empty').classList.add('hidden');

            try {
                const eventFilter = document.getElementById('pingen-event-filter').value;
                const url = eventFilter
                    ? `${DISPATCH_API}/pingen/letters?event_id=${eventFilter}`
                    : `${DISPATCH_API}/pingen/letters`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const letters = await response.json();

                document.getElementById('pingen-loading').classList.add('hidden');

                const tbody = document.getElementById('pingen-letters-tbody');
                if (letters.length === 0) {
                    tbody.innerHTML = '';
                    document.getElementById('pingen-empty').classList.remove('hidden');
                    return;
                }

                tbody.innerHTML = letters.map(letter => {
                    // Parse recipient address
                    let recipientName = '-';
                    try {
                        const addr = JSON.parse(letter.recipient_address);
                        recipientName = addr.name || '-';
                    } catch (e) {
                        recipientName = letter.vorname && letter.nachname ? `${letter.vorname} ${letter.nachname}` : '-';
                    }

                    // Status badge
                    const statusColors = {
                        'sent': 'bg-green-100 text-green-800',
                        'processing': 'bg-yellow-100 text-yellow-800',
                        'ready': 'bg-blue-100 text-blue-800',
                        'sending': 'bg-blue-100 text-blue-800',
                        'failed': 'bg-red-100 text-red-800',
                        'cancelled': 'bg-gray-100 text-gray-800'
                    };
                    const statusLabels = {
                        'sent': 'Gesendet',
                        'processing': 'Verarbeitung',
                        'ready': 'Bereit',
                        'sending': 'Wird gesendet',
                        'failed': 'Fehlgeschlagen',
                        'cancelled': 'Abgebrochen'
                    };
                    const statusColor = statusColors[letter.status] || 'bg-gray-100 text-gray-800';
                    const statusLabel = statusLabels[letter.status] || letter.status;

                    // Format date
                    const sentDate = letter.sent_at ? new Date(letter.sent_at).toLocaleDateString('de-CH', {
                        day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
                    }) : '-';

                    return `
                        <tr>
                            <td class="px-6 py-4 font-medium">${recipientName}</td>
                            <td class="px-6 py-4">${letter.event_title || '-'}</td>
                            <td class="px-6 py-4">${letter.subject || 'Arbeitsplan'}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">${sentDate}</td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor}">${statusLabel}</span>
                            </td>
                            <td class="px-6 py-4 text-right">
                                ${letter.external_id ? `
                                    <button onclick="checkPingenStatus('${letter.external_id}')"
                                        class="text-blue-600 hover:text-blue-800 text-sm">
                                        Status pr√ºfen
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading Pingen letters:', error);
                document.getElementById('pingen-loading').classList.add('hidden');
            }
        }

        async function loadPingenEventFilter() {
            try {
                const response = await fetch(`${API_BASE}/events`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const events = await response.json();

                const select = document.getElementById('pingen-event-filter');
                const currentValue = select.value;

                // Clear existing options except first
                select.innerHTML = '<option value="">Alle Events</option>';

                events.forEach(event => {
                    const option = document.createElement('option');
                    option.value = event.id;
                    option.textContent = event.title;
                    if (event.id === currentValue) option.selected = true;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading events for filter:', error);
            }
        }

        async function checkPingenStatus(letterId) {
            try {
                const response = await fetch(`${DISPATCH_API}/pingen/letters/${letterId}/status`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const status = await response.json();

                alert(`Brief-Status: ${status.status}\nSeiten: ${status.pages || '-'}\nPreis: ${status.price ? (status.price / 100).toFixed(2) + ' CHF' : '-'}`);

                // Refresh letters to show updated status
                loadPingenLetters();
            } catch (error) {
                console.error('Error checking Pingen status:', error);
                alert('Fehler beim Abrufen des Status');
            }
        }

        async function openPingenModal() {
            // Load members for dropdown
            try {
                const response = await fetch(`${API_BASE}/members?has_address=true`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const members = await response.json();

                const select = document.getElementById('pingen-member');
                select.innerHTML = '<option value="">Mitglied ausw√§hlen...</option>';

                // Filter members with complete addresses and sort by name
                const membersWithAddress = members.filter(m => m.strasse && m.plz && m.ort);
                membersWithAddress.sort((a, b) => `${a.nachname} ${a.vorname}`.localeCompare(`${b.nachname} ${b.vorname}`));

                membersWithAddress.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = `${member.nachname}, ${member.vorname}`;
                    option.dataset.address = JSON.stringify({
                        name: `${member.vorname} ${member.nachname}`,
                        strasse: member.strasse,
                        plz: member.plz,
                        ort: member.ort
                    });
                    select.appendChild(option);
                });

                // Load events for dropdown
                const eventsResponse = await fetch(`${API_BASE}/events`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const events = await eventsResponse.json();

                const eventSelect = document.getElementById('pingen-event');
                eventSelect.innerHTML = '<option value="">Kein Event</option>';

                events.forEach(event => {
                    const option = document.createElement('option');
                    option.value = event.id;
                    option.textContent = event.title;
                    eventSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading data for Pingen modal:', error);
            }

            // Reset form
            document.getElementById('pingen-form').reset();
            document.getElementById('pingen-member-address').classList.add('hidden');

            // Show modal
            document.getElementById('pingen-modal').classList.remove('hidden');
        }

        function showPingenMemberAddress() {
            const select = document.getElementById('pingen-member');
            const selectedOption = select.options[select.selectedIndex];
            const addressPreview = document.getElementById('pingen-address-preview');
            const addressContainer = document.getElementById('pingen-member-address');

            if (selectedOption && selectedOption.dataset.address) {
                const addr = JSON.parse(selectedOption.dataset.address);
                addressPreview.innerHTML = `${addr.name}<br>${addr.strasse}<br>${addr.plz} ${addr.ort}`;
                addressContainer.classList.remove('hidden');
            } else {
                addressContainer.classList.add('hidden');
            }
        }

        async function sendPingenLetter(e) {
            e.preventDefault();

            const memberId = document.getElementById('pingen-member').value;
            const eventId = document.getElementById('pingen-event').value;
            const subject = document.getElementById('pingen-subject').value;
            const body = document.getElementById('pingen-body').value;
            const staging = isPingenStaging();

            if (!memberId || !subject || !body) {
                alert('Bitte alle Pflichtfelder ausf√ºllen');
                return;
            }

            const modeText = staging ? ' (STAGING - kein echter Versand!)' : '';
            if (!confirm(`Brief wirklich senden${modeText}?${staging ? '' : ' Die Kosten werden vom Pingen-Guthaben abgezogen.'}`)) {
                return;
            }

            try {
                const response = await fetch(`${DISPATCH_API}/pingen/send-manual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        member_id: memberId,
                        event_id: eventId || null,
                        subject,
                        body,
                        staging
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Fehler beim Senden');
                }

                const result = await response.json();
                const stagingNote = result.staging ? ' (STAGING)' : '';
                alert(`Brief erfolgreich gesendet an ${result.recipient}${stagingNote}!\nPingen-ID: ${result.letterId}`);

                document.getElementById('pingen-modal').classList.add('hidden');
                loadPingenData();
            } catch (error) {
                console.error('Error sending Pingen letter:', error);
                alert('Fehler beim Senden: ' + error.message);
            }
        }

        async function loadPingenWebhooks() {
            const container = document.getElementById('webhooks-list');
            const staging = isPingenStaging();
            try {
                const response = await fetch(`${DISPATCH_API}/pingen/webhooks?staging=${staging}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    container.innerHTML = '<p class="text-red-500 text-sm">Fehler beim Laden der Webhooks</p>';
                    return;
                }

                const webhooks = await response.json();

                if (webhooks.length === 0) {
                    container.innerHTML = `
                        <p class="text-gray-500 text-sm">Kein Webhook registriert.</p>
                        <p class="text-gray-400 text-xs mt-1">Registrieren Sie einen Webhook um automatische Status-Updates zu erhalten.</p>
                    `;
                    return;
                }

                container.innerHTML = webhooks.map(wh => `
                    <div class="flex justify-between items-center bg-white p-3 rounded border mb-2">
                        <div>
                            <p class="font-medium text-sm">${wh.attributes?.url || 'Unbekannte URL'}</p>
                            <p class="text-xs text-gray-500">Event: ${wh.attributes?.event_category || 'letters'}</p>
                        </div>
                        <button onclick="deletePingenWebhook('${wh.id}')" class="text-red-600 hover:text-red-800 text-sm">
                            L√∂schen
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading webhooks:', error);
                container.innerHTML = '<p class="text-red-500 text-sm">Fehler beim Laden der Webhooks</p>';
            }
        }

        async function registerPingenWebhook() {
            const staging = isPingenStaging();
            const modeText = staging ? ' (STAGING)' : '';
            if (!confirm(`Webhook bei Pingen${modeText} registrieren? Pingen wird dann automatisch Status-Updates senden.`)) {
                return;
            }

            try {
                const response = await fetch(`${DISPATCH_API}/pingen/webhooks/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ staging })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Registrierung fehlgeschlagen');
                }

                const result = await response.json();
                alert(`Webhook erfolgreich registriert!\nURL: ${result.url}`);
                loadPingenWebhooks();
            } catch (error) {
                console.error('Error registering webhook:', error);
                alert('Fehler: ' + error.message);
            }
        }

        async function deletePingenWebhook(webhookId) {
            if (!confirm('Webhook wirklich l√∂schen?')) {
                return;
            }

            try {
                const staging = isPingenStaging();
                const response = await fetch(`${DISPATCH_API}/pingen/webhooks/${webhookId}?staging=${staging}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error('L√∂schen fehlgeschlagen');
                }

                alert('Webhook gel√∂scht');
                loadPingenWebhooks();
            } catch (error) {
                console.error('Error deleting webhook:', error);
                alert('Fehler: ' + error.message);
            }
        }

        // ============================================
        // BULK PDF FUNCTIONS
        // ============================================

        let bulkPdfRecipients = [];

        async function openBulkPdfModal() {
            document.getElementById('bulk-pdf-form').reset();
            document.getElementById('bulk-pdf-recipients').innerHTML = '<div class="text-center text-gray-500 py-4">Lade Empf√§nger...</div>';

            try {
                const response = await fetch(`${DISPATCH_API}/pingen/post-members`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                bulkPdfRecipients = data.members || [];

                document.getElementById('bulk-pdf-total-count').textContent = bulkPdfRecipients.length;

                if (bulkPdfRecipients.length === 0) {
                    document.getElementById('bulk-pdf-recipients').innerHTML =
                        '<div class="text-center text-gray-500 py-4">Keine Mitglieder mit Post-Zustellung gefunden.</div>';
                } else {
                    renderBulkPdfRecipients();
                    // Select all by default
                    selectAllRecipients();
                }
            } catch (error) {
                console.error('Error loading post members:', error);
                document.getElementById('bulk-pdf-recipients').innerHTML =
                    '<div class="text-center text-red-500 py-4">Fehler beim Laden der Empf√§nger</div>';
            }

            document.getElementById('bulk-pdf-modal').classList.remove('hidden');
        }

        function renderBulkPdfRecipients() {
            const container = document.getElementById('bulk-pdf-recipients');
            container.innerHTML = bulkPdfRecipients.map(m => `
                <label class="flex items-start space-x-3 p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" class="bulk-pdf-checkbox mt-1 w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"
                           data-member-id="${m.id}" onchange="updateBulkPdfCount()">
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">${m.name}</div>
                        <div class="text-sm text-gray-500">${m.address}</div>
                    </div>
                </label>
            `).join('');
        }

        function selectAllRecipients() {
            document.querySelectorAll('.bulk-pdf-checkbox').forEach(cb => cb.checked = true);
            updateBulkPdfCount();
        }

        function deselectAllRecipients() {
            document.querySelectorAll('.bulk-pdf-checkbox').forEach(cb => cb.checked = false);
            updateBulkPdfCount();
        }

        function updateBulkPdfCount() {
            const selected = document.querySelectorAll('.bulk-pdf-checkbox:checked').length;
            document.getElementById('bulk-pdf-selected-count').textContent = selected;
        }

        async function sendBulkPdf(e) {
            e.preventDefault();

            const fileInput = document.getElementById('bulk-pdf-file');
            const subject = document.getElementById('bulk-pdf-subject').value.trim();
            const staging = isPingenStaging();

            const selectedIds = Array.from(document.querySelectorAll('.bulk-pdf-checkbox:checked'))
                .map(cb => cb.dataset.memberId);

            if (selectedIds.length === 0) {
                alert('Bitte mindestens einen Empf√§nger ausw√§hlen');
                return;
            }

            if (!fileInput.files[0]) {
                alert('Bitte eine PDF-Datei ausw√§hlen');
                return;
            }

            const file = fileInput.files[0];
            if (file.type !== 'application/pdf') {
                alert('Bitte nur PDF-Dateien hochladen');
                return;
            }

            const modeText = staging ? ' (STAGING - Test)' : '';
            if (!confirm(`PDF an ${selectedIds.length} Empf√§nger versenden${modeText}?`)) {
                return;
            }

            const submitBtn = document.getElementById('submit-bulk-pdf-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Wird gesendet...';

            try {
                // File to base64
                const base64 = await fileToBase64(file);

                const response = await fetch(`${DISPATCH_API}/pingen/send-bulk-pdf`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        pdf_base64: base64,
                        subject: subject || file.name.replace('.pdf', ''),
                        member_ids: selectedIds,
                        staging
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Fehler beim Versenden');
                }

                // Show results
                let message = `Versand abgeschlossen${staging ? ' (Staging)' : ''}:\n\n`;
                message += `‚úì Erfolgreich: ${result.successCount}\n`;

                if (result.failedCount > 0) {
                    message += `‚úó Fehlgeschlagen: ${result.failedCount}\n\n`;
                    message += 'Fehler:\n';
                    result.failed.forEach(f => {
                        message += `  - ${f.name}: ${f.error}\n`;
                    });
                }

                alert(message);
                document.getElementById('bulk-pdf-modal').classList.add('hidden');
                loadPingenData();
            } catch (error) {
                console.error('Error sending bulk PDF:', error);
                alert('Fehler: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'PDF versenden';
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Remove data:application/pdf;base64, prefix
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Mobile Menu Toggle
        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });

        // Logout (both desktop and mobile)
        function performLogout() {
            localStorage.removeItem('vorstand_token');
            // Clear cross-subdomain cookie
            document.cookie = 'vorstand_token=; domain=.fwv-raura.ch; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; secure; samesite=lax';
            window.location.href = '/';
        }
        document.getElementById('logout-btn').addEventListener('click', performLogout);
        document.getElementById('logout-btn-mobile').addEventListener('click', performLogout);

        // ============================================
        // IP WHITELIST
        // ============================================

        const ORDER_API = 'https://order.fwv-raura.ch/api';

        async function loadWhitelist() {
            document.getElementById('whitelist-loading').classList.remove('hidden');
            document.getElementById('whitelist-empty').classList.add('hidden');
            document.getElementById('whitelist-tbody').innerHTML = '';

            try {
                const [listRes, enabledRes] = await Promise.all([
                    fetch(`${ORDER_API}/whitelist`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch(`${ORDER_API}/whitelist/enabled`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);

                if (!listRes.ok) throw new Error('Failed to load whitelist');

                const whitelist = await listRes.json();
                if (enabledRes.ok) {
                    const enabledData = await enabledRes.json();
                    document.getElementById('whitelist-enabled-toggle').checked = enabledData.enabled;
                }

                document.getElementById('whitelist-loading').classList.add('hidden');

                if (whitelist.length === 0) {
                    document.getElementById('whitelist-empty').classList.remove('hidden');
                    return;
                }

                const tbody = document.getElementById('whitelist-tbody');
                tbody.innerHTML = whitelist.map(entry => {
                    const createdAt = new Date(entry.created_at).toLocaleString('de-CH');
                    const expiresAt = entry.expires_at
                        ? new Date(entry.expires_at).toLocaleString('de-CH')
                        : '<span class="text-green-600">Permanent</span>';
                    const isExpired = entry.expires_at && new Date(entry.expires_at) < new Date();

                    return `
                        <tr class="${isExpired ? 'bg-red-50' : ''}">
                            <td class="px-6 py-4 whitespace-nowrap font-mono">${entry.ip_address}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${entry.device_name || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${entry.created_by || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${createdAt}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${isExpired ? 'text-red-600 font-semibold' : 'text-gray-500'}">${isExpired ? 'Abgelaufen' : expiresAt}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <button onclick="deleteWhitelistEntry(${entry.id})" class="text-red-600 hover:text-red-800">
                                    Entfernen
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading whitelist:', error);
                document.getElementById('whitelist-loading').classList.add('hidden');
                document.getElementById('whitelist-empty').classList.remove('hidden');
            }
        }

        async function deleteWhitelistEntry(id) {
            if (!confirm('Diese IP-Adresse wirklich aus der Whitelist entfernen?')) return;

            try {
                const res = await fetch(`${ORDER_API}/whitelist/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!res.ok) throw new Error('Failed to delete');
                loadWhitelist();
            } catch (error) {
                console.error('Error deleting whitelist entry:', error);
                alert('Fehler beim Entfernen der IP-Adresse');
            }
        }

        async function addWhitelistEntry(e) {
            e.preventDefault();
            const ip = document.getElementById('whitelist-ip').value;
            const deviceName = document.getElementById('whitelist-device-name').value;

            try {
                const res = await fetch(`${ORDER_API}/whitelist`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ ip_address: ip, device_name: deviceName })
                });

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed to add');
                }

                document.getElementById('whitelist-modal').classList.add('hidden');
                document.getElementById('whitelist-form').reset();
                loadWhitelist();
            } catch (error) {
                console.error('Error adding whitelist entry:', error);
                alert('Fehler: ' + error.message);
            }
        }

        // Whitelist Event Listeners
        document.getElementById('add-whitelist-btn').addEventListener('click', () => {
            document.getElementById('whitelist-modal').classList.remove('hidden');
        });
        document.getElementById('close-whitelist-modal').addEventListener('click', () => {
            document.getElementById('whitelist-modal').classList.add('hidden');
        });
        document.getElementById('cancel-whitelist-btn').addEventListener('click', () => {
            document.getElementById('whitelist-modal').classList.add('hidden');
        });
        document.getElementById('whitelist-form').addEventListener('submit', addWhitelistEntry);

        document.getElementById('copy-register-url-btn').addEventListener('click', () => {
            navigator.clipboard.writeText('https://register.fwv-raura.ch');
            alert('URL in die Zwischenablage kopiert!');
        });

        document.getElementById('whitelist-enabled-toggle').addEventListener('change', async (e) => {
            try {
                const enabled = e.target.checked;
                const res = await fetch(`${ORDER_API}/whitelist/enabled`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ enabled })
                });
                if (!res.ok) throw new Error('Failed to update');
                alert(enabled ? 'IP-Whitelist Schutz aktiviert' : 'IP-Whitelist Schutz deaktiviert');
            } catch (error) {
                console.error('Error toggling whitelist:', error);
                e.target.checked = !e.target.checked; // Revert on error
                alert('Fehler beim √Ñndern des Status');
            }
        });

        // ============================================
        // INITIALIZE
        // ============================================

        (async () => {
            if (await checkAuth()) {
                await loadStats();
                await loadMembers();
                loadRegistrationCount(); // Load badge count for pending registrations
            }
        })();
    </script>
</body>
</html>
