<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vorstand - Mitgliederverwaltung | FWV Raura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fire: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="font-sans bg-gray-50">
    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gradient-to-br from-fire-600 to-fire-800 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-8 shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-20 h-20 rounded-full overflow-hidden bg-fire-100 p-2 mx-auto mb-4">
                    <img src="images/logo.png" alt="Logo" class="w-full h-full object-contain">
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Vorstand Login</h2>
                <p class="text-gray-600 text-sm mt-2">Melden Sie sich mit Ihrer Vorstand E-Mail an</p>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">E-Mail</label>
                    <input type="email" id="login-email" required
                        placeholder="vorstand@fwv-raura.ch"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500 focus:border-fire-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Passwort</label>
                    <input type="password" id="login-password" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500 focus:border-fire-500">
                </div>
                <div id="login-error" class="hidden text-red-600 text-sm text-center"></div>
                <button type="submit" id="login-btn"
                    class="w-full bg-fire-600 text-white py-3 rounded-lg font-semibold hover:bg-fire-700 transition-colors">
                    Anmelden
                </button>
            </form>

            <p class="text-center text-gray-500 text-xs mt-6">
                Nur autorisierte Vorstandsmitglieder haben Zugang
            </p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-fire-700 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full overflow-hidden bg-white p-1">
                        <img src="images/logo.png" alt="Logo" class="w-full h-full object-contain">
                    </div>
                    <div>
                        <span class="text-xl font-bold">FWV Raura</span>
                        <p class="text-fire-200 text-sm">Vorstand-Portal</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <span id="user-info" class="text-fire-200 text-sm"></span>
                    <a href="index.html" class="hover:text-fire-200 transition-colors">Website</a>
                    <a href="events.html" class="hover:text-fire-200 transition-colors">Veranstaltungen</a>
                    <button id="logout-btn" class="hover:text-fire-200 transition-colors">Abmelden</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Tabs -->
    <section class="bg-white border-b">
        <div class="container mx-auto px-4">
            <div class="flex space-x-8 border-b">
                <button id="tab-members" class="tab-btn py-4 px-2 font-semibold border-b-2 border-fire-500 text-fire-600">
                    Mitglieder
                </button>
                <button id="tab-events" class="tab-btn py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                    Veranstaltungen
                </button>
                <button id="tab-audit" class="tab-btn py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                    Audit-Log
                </button>
                <button id="tab-dispatch" class="tab-btn py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                    Nachricht
                </button>
                <button id="tab-email" class="tab-btn py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                    E-Mail
                </button>
                <button id="tab-registrations" class="tab-btn py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800 relative">
                    Anträge
                    <span id="registrations-badge" class="hidden absolute -top-1 -right-2 bg-fire-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                </button>
            </div>
        </div>
    </section>

    <!-- Members Section -->
    <div id="members-section">
        <!-- Header -->
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Mitgliederverwaltung</h1>
                        <p class="text-gray-600 mt-1">Mitglieder verwalten und Statistiken einsehen</p>
                    </div>
                    <button id="add-member-btn" class="bg-fire-500 text-white px-6 py-2 rounded-lg hover:bg-fire-600 transition-colors flex items-center space-x-2">
                        <span>+</span>
                        <span>Neues Mitglied</span>
                    </button>
                </div>
            </div>
        </section>

    <!-- Statistics -->
    <section class="bg-white border-b">
        <div class="container mx-auto px-4 py-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-fire-50 p-4 rounded-lg">
                    <div class="text-fire-600 text-sm font-medium">Gesamt</div>
                    <div id="stat-total" class="text-3xl font-bold text-gray-800">-</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-green-600 text-sm font-medium">Aktivmitglieder</div>
                    <div id="stat-aktiv" class="text-3xl font-bold text-gray-800">-</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-blue-600 text-sm font-medium">Passivmitglieder</div>
                    <div id="stat-passiv" class="text-3xl font-bold text-gray-800">-</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <div class="text-yellow-600 text-sm font-medium">Ehrenmitglieder</div>
                    <div id="stat-ehren" class="text-3xl font-bold text-gray-800">-</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Filters and Search -->
    <section class="bg-white border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                <div class="flex items-center space-x-4">
                    <input type="text" id="search-input" placeholder="Suche nach Name oder E-Mail..."
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500 w-full md:w-80">
                    <select id="status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                        <option value="">Alle Status</option>
                        <option value="Aktivmitglied">Aktivmitglied</option>
                        <option value="Passivmitglied">Passivmitglied</option>
                        <option value="Ehrenmitglied">Ehrenmitglied</option>
                    </select>
                </div>
                <button id="export-btn" class="border border-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                    Export CSV
                </button>
            </div>
        </div>
    </section>

    <!-- Members Table -->
    <section class="py-8">
        <div class="container mx-auto px-4">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">E-Mail</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Telefon</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Funktion</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="members-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Members will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                <p class="mt-4 text-gray-600">Lade Mitglieder...</p>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="text-center py-12 hidden">
                <p class="text-gray-600">Keine Mitglieder gefunden.</p>
            </div>
        </div>
    </section>

    <!-- Member Modal -->
    <div id="member-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="modal-title" class="text-2xl font-bold text-gray-800">Mitglied bearbeiten</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>

                <form id="member-form" class="space-y-6">
                    <input type="hidden" id="member-id">

                    <!-- Foto -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Profilfoto</h4>
                        <div class="flex items-center space-x-4">
                            <div id="photo-preview" class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                                <span class="text-gray-400 text-3xl">?</span>
                            </div>
                            <div class="flex-1">
                                <input type="file" id="photo-upload" accept="image/*" class="hidden">
                                <button type="button" id="photo-upload-btn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                                    Foto hochladen
                                </button>
                                <button type="button" id="photo-delete-btn" class="ml-2 px-4 py-2 text-red-600 hover:text-red-800 hidden">
                                    Foto entfernen
                                </button>
                                <p class="text-sm text-gray-500 mt-1">Max. 5MB, JPG/PNG/GIF</p>
                            </div>
                        </div>
                    </div>

                    <!-- Persoenliche Daten -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Persoenliche Daten</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Anrede</label>
                                <select id="anrede" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    <option value="">-</option>
                                    <option value="Herr">Herr</option>
                                    <option value="Frau">Frau</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Geschlecht</label>
                                <select id="geschlecht" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    <option value="">-</option>
                                    <option value="M">Maennlich</option>
                                    <option value="W">Weiblich</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Vorname *</label>
                                <input type="text" id="vorname" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nachname *</label>
                                <input type="text" id="nachname" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Geburtstag</label>
                                <input type="date" id="geburtstag" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                        </div>
                    </div>

                    <!-- Adresse -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Adresse</h4>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Strasse</label>
                                <input type="text" id="strasse" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Adresszusatz</label>
                                <input type="text" id="adresszusatz" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">PLZ</label>
                                    <input type="text" id="plz" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ort</label>
                                    <input type="text" id="ort" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Kontakt -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Kontakt</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Telefon</label>
                                <input type="tel" id="telefon" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mobile</label>
                                <input type="tel" id="mobile" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">E-Mail</label>
                                <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                        </div>
                    </div>

                    <!-- Mitgliedschaft -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Mitgliedschaft</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    <option value="Aktivmitglied">Aktivmitglied</option>
                                    <option value="Passivmitglied">Passivmitglied</option>
                                    <option value="Ehrenmitglied">Ehrenmitglied</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Feuerwehr-Zugehoerigkeit</label>
                                <select id="feuerwehr-zugehoerigkeit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    <option value="keine">Keine</option>
                                    <option value="feuerwehr_raurica">Feuerwehr Raurica</option>
                                    <option value="externe_feuerwehr">Externe Feuerwehr</option>
                                    <option value="anderes">Anderes</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Funktion</label>
                                <select id="funktion" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    <option value="">Keine Funktion</option>
                                    <option value="Admin">Admin (Volle Rechte)</option>
                                    <option value="Präsident">Präsident (Vorstand)</option>
                                    <option value="Vizepräsident">Vizepräsident (Vorstand)</option>
                                    <option value="Aktuar">Aktuar (Vorstand)</option>
                                    <option value="Kassier">Kassier (Vorstand)</option>
                                    <option value="Materialwart">Materialwart (Vorstand)</option>
                                    <option value="Beisitzer">Beisitzer (Vorstand)</option>
                                    <option value="Revisor">Revisor</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Eintrittsdatum</label>
                                <input type="date" id="eintrittsdatum" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            </div>
                        </div>
                    </div>

                    <!-- Zustellung -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Zustellung</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="zustellung-email" class="mr-2 rounded">
                                <span class="text-sm text-gray-700">E-Mail-Zustellung</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="zustellung-post" class="mr-2 rounded">
                                <span class="text-sm text-gray-700">Post-Zustellung</span>
                            </label>
                        </div>
                    </div>

                    <!-- Bemerkungen -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bemerkungen</label>
                        <textarea id="bemerkungen" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500"></textarea>
                    </div>

                    <!-- Buttons -->
                    <div class="flex justify-between pt-4 border-t">
                        <button type="button" id="delete-member-btn" class="text-red-600 hover:text-red-700 font-medium hidden">
                            Loeschen
                        </button>
                        <div class="flex space-x-3">
                            <button type="button" id="cancel-btn" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                Abbrechen
                            </button>
                            <button type="submit" class="px-6 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">
                                Speichern
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    </div> <!-- End Members Section -->

    <!-- Events Section -->
    <div id="events-section" class="hidden">
        <!-- Header -->
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Veranstaltungsverwaltung</h1>
                        <p class="text-gray-600 mt-1">Events und Schichten verwalten</p>
                    </div>
                    <button id="add-event-btn" class="bg-fire-500 text-white px-6 py-2 rounded-lg hover:bg-fire-600 transition-colors flex items-center space-x-2">
                        <span>+</span>
                        <span>Neues Event</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Events List -->
        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Titel</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Datum</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Kategorie</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Schichten</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="events-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Events will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div id="events-loading-state" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                    <p class="mt-4 text-gray-600">Lade Events...</p>
                </div>

                <!-- Empty State -->
                <div id="events-empty-state" class="text-center py-12 hidden">
                    <p class="text-gray-600">Keine Events gefunden.</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Audit Log Section -->
    <div id="audit-section" class="hidden">
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Audit-Log</h1>
                        <p class="text-gray-600 mt-1">Alle Aenderungen in der Mitgliederverwaltung</p>
                    </div>
                    <div class="flex space-x-4">
                        <select id="audit-action-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            <option value="">Alle Aktionen</option>
                            <option value="LOGIN_SUCCESS">Login erfolgreich</option>
                            <option value="LOGIN_FAILED">Login fehlgeschlagen</option>
                            <option value="MEMBER_CREATE">Mitglied erstellt</option>
                            <option value="MEMBER_UPDATE">Mitglied aktualisiert</option>
                            <option value="MEMBER_DELETE">Mitglied geloescht</option>
                            <option value="EVENT_CREATE">Event erstellt</option>
                            <option value="EVENT_UPDATE">Event aktualisiert</option>
                            <option value="EVENT_DELETE">Event geloescht</option>
                        </select>
                        <button id="refresh-audit-btn" class="border border-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-50">
                            Aktualisieren
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Zeitpunkt</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Aktion</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Benutzer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">IP-Adresse</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody id="audit-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Audit entries will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div id="audit-loading-state" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                    <p class="mt-4 text-gray-600">Lade Audit-Log...</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Email Management Section -->
    <div id="email-section" class="hidden">
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">E-Mail Verwaltung</h1>
                        <p class="text-gray-600 mt-1">Mailboxen und Aliase fuer fwv-raura.ch verwalten</p>
                    </div>
                    <div class="flex space-x-3">
                        <button id="add-mailbox-btn" class="bg-fire-500 text-white px-4 py-2 rounded-lg hover:bg-fire-600">
                            + Mailbox
                        </button>
                        <button id="add-alias-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                            + Alias
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Email Tabs -->
        <section class="bg-white border-b">
            <div class="container mx-auto px-4">
                <div class="flex space-x-6">
                    <button id="email-tab-mailboxes" class="email-tab-btn py-3 px-2 font-medium border-b-2 border-fire-500 text-fire-600">
                        Mailboxen
                    </button>
                    <button id="email-tab-aliases" class="email-tab-btn py-3 px-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                        Aliase
                    </button>
                    <button id="email-tab-quota" class="email-tab-btn py-3 px-2 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                        Speicherplatz
                    </button>
                </div>
            </div>
        </section>

        <!-- Mailboxes List -->
        <section id="mailboxes-panel" class="py-6">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">E-Mail</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Quota</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="mailboxes-tbody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="mailboxes-loading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                </div>
            </div>
        </section>

        <!-- Aliases List -->
        <section id="aliases-panel" class="py-6 hidden">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Alias</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Weiterleitung an</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="aliases-tbody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="aliases-loading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                </div>
            </div>
        </section>

        <!-- Quota Overview -->
        <section id="quota-panel" class="py-6 hidden">
            <div class="container mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="quota-cards"></div>
                <div id="quota-loading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Mailbox Modal -->
    <div id="mailbox-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="mailbox-modal-title" class="text-xl font-bold text-gray-800">Neue Mailbox</h3>
                    <button class="close-mailbox-modal text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <form id="mailbox-form" class="space-y-4">
                    <input type="hidden" id="mailbox-edit-email">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">E-Mail Adresse</label>
                        <div class="flex">
                            <input type="text" id="mailbox-local" required placeholder="name"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-fire-500">
                            <span class="px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg text-gray-600">@fwv-raura.ch</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <input type="text" id="mailbox-name" required placeholder="Max Muster"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Passwort</label>
                        <input type="password" id="mailbox-password" placeholder="Mindestens 8 Zeichen"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        <p class="text-xs text-gray-500 mt-1" id="mailbox-password-hint">Erforderlich fuer neue Mailbox</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Speicherplatz (MB)</label>
                        <input type="number" id="mailbox-quota" value="1024" min="100"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="mailbox-active" checked class="w-4 h-4 text-fire-600 rounded">
                        <label for="mailbox-active" class="ml-2 text-sm text-gray-700">Aktiv</label>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" class="close-mailbox-modal px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Abbrechen
                        </button>
                        <button type="submit" class="px-4 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">
                            Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Alias Modal -->
    <div id="alias-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="alias-modal-title" class="text-xl font-bold text-gray-800">Neuer Alias</h3>
                    <button class="close-alias-modal text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <form id="alias-form" class="space-y-4">
                    <input type="hidden" id="alias-edit-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Alias Adresse</label>
                        <div class="flex">
                            <input type="text" id="alias-address" required placeholder="info"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-fire-500">
                            <span class="px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg text-gray-600">@fwv-raura.ch</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Weiterleitung an</label>
                        <input type="text" id="alias-goto" required placeholder="mail@example.com, andere@mail.ch"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        <p class="text-xs text-gray-500 mt-1">Mehrere E-Mails mit Komma trennen</p>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="alias-active" checked class="w-4 h-4 text-fire-600 rounded">
                        <label for="alias-active" class="ml-2 text-sm text-gray-700">Aktiv</label>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" class="close-alias-modal px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Abbrechen
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Dispatch Section -->
    <div id="dispatch-section" class="hidden">
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Nachricht verfassen</h1>
                    <p class="text-gray-600 mt-1">E-Mail oder Brief an Mitglieder senden</p>
                </div>
            </div>
        </section>

        <section class="container mx-auto px-4 py-8">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <!-- Delivery Method -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Versandart</label>
                        <div class="flex gap-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="delivery-method" value="auto" checked class="mr-2">
                                <span>Automatisch (nach Mitglieder-Einstellung)</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="delivery-method" value="email" class="mr-2">
                                <span>Nur E-Mail (erzwingen)</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="delivery-method" value="post" class="mr-2">
                                <span>Nur Briefpost (erzwingen)</span>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            Bei "Automatisch" wird jedes Mitglied gemäß seiner Zustellungs-Einstellung (E-Mail/Post) benachrichtigt.
                        </p>
                    </div>

                    <!-- Recipients Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Empfänger</label>
                        <div class="space-y-3">
                            <div>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="recipient-type" value="all" class="mr-2" checked>
                                    <span>Alle Mitglieder</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="recipient-type" value="filter" class="mr-2">
                                    <span>Gefilterte Mitglieder</span>
                                </label>
                                <div id="recipient-filter" class="ml-6 mt-2 hidden">
                                    <select id="dispatch-filter-status" class="px-3 py-2 border border-gray-300 rounded-lg mr-2">
                                        <option value="">Alle Status</option>
                                        <option value="aktiv">Aktiv</option>
                                        <option value="passiv">Passiv</option>
                                        <option value="ehrenmitglied">Ehrenmitglied</option>
                                    </select>
                                    <label class="inline-flex items-center ml-4">
                                        <input type="checkbox" id="dispatch-filter-email" class="mr-2" checked>
                                        <span class="text-sm">nur mit E-Mail-Zustellung</span>
                                    </label>
                                    <label class="inline-flex items-center ml-4">
                                        <input type="checkbox" id="dispatch-filter-post" class="mr-2">
                                        <span class="text-sm">nur mit Post-Zustellung</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="recipient-type" value="selected" class="mr-2">
                                    <span>Ausgewählte Mitglieder</span>
                                </label>
                                <div id="recipient-selected" class="ml-6 mt-2 hidden">
                                    <button id="select-members-btn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">
                                        Mitglieder auswählen (<span id="selected-count">0</span>)
                                    </button>
                                    <div id="selected-members-list" class="mt-2 text-sm text-gray-600"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Template Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Vorlage</label>
                        <select id="dispatch-template" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                            <option value="">Freier Text (keine Vorlage)</option>
                        </select>
                    </div>

                    <!-- Subject (Email only) -->
                    <div id="dispatch-subject-container" class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Betreff</label>
                        <input type="text" id="dispatch-subject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500" placeholder="Betreff der E-Mail">
                    </div>

                    <!-- Message Body -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nachricht</label>
                        <textarea id="dispatch-body" rows="12" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500 font-mono text-sm" placeholder="Nachrichtentext..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">
                            Verfügbare Platzhalter: {{anrede}}, {{vorname}}, {{nachname}}, {{strasse}}, {{plz}}, {{ort}}
                        </p>
                    </div>

                    <!-- Template Variables (shown when template is selected) -->
                    <div id="dispatch-variables" class="mb-6 hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Vorlagen-Variablen</label>
                        <div id="dispatch-variables-inputs" class="space-y-3"></div>
                    </div>

                    <!-- Preview -->
                    <div class="mb-6">
                        <button id="dispatch-preview-btn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">
                            Vorschau anzeigen
                        </button>
                    </div>

                    <!-- Actions -->
                    <div class="flex justify-between items-center pt-4 border-t">
                        <div class="text-sm text-gray-600">
                            <span id="dispatch-recipient-count">0</span> Empfänger
                        </div>
                        <div class="flex gap-3">
                            <button id="dispatch-test-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Test senden
                            </button>
                            <button id="dispatch-send-btn" class="px-6 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">
                                Senden
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Send History -->
                <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Versandhistorie</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Datum</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Typ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Betreff</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Empfänger</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody id="dispatch-history-tbody" class="divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">Keine Versandhistorie vorhanden</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Registrations Section -->
    <div id="registrations-section" class="hidden">
        <section class="bg-white border-b">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Mitgliedschaftsanträge</h1>
                        <p class="text-gray-600 mt-1">Neue Anträge prüfen und genehmigen</p>
                    </div>
                    <div class="flex space-x-2">
                        <select id="registrations-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fire-500">
                            <option value="pending">Ausstehend</option>
                            <option value="approved">Genehmigt</option>
                            <option value="rejected">Abgelehnt</option>
                            <option value="all">Alle</option>
                        </select>
                        <button id="refresh-registrations-btn" class="border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50">
                            Aktualisieren
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">E-Mail</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Feuerwehr</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Datum</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="registrations-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>

                <div id="registrations-loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                    <p class="mt-4 text-gray-600">Lade Anträge...</p>
                </div>

                <div id="registrations-empty" class="text-center py-12 hidden">
                    <p class="text-gray-600">Keine Anträge vorhanden.</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Registration Detail Modal -->
    <div id="registration-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Mitgliedschaftsantrag</h3>
                    <button id="close-registration-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>

                <div id="registration-details" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-500">Vorname</label>
                            <p id="reg-vorname" class="font-medium"></p>
                        </div>
                        <div>
                            <label class="text-sm text-gray-500">Nachname</label>
                            <p id="reg-nachname" class="font-medium"></p>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">Adresse</label>
                        <p id="reg-adresse" class="font-medium"></p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-500">Telefon</label>
                            <p id="reg-telefon" class="font-medium"></p>
                        </div>
                        <div>
                            <label class="text-sm text-gray-500">Mobile</label>
                            <p id="reg-mobile" class="font-medium"></p>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">E-Mail</label>
                        <p id="reg-email" class="font-medium"></p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">Feuerwehr-Status</label>
                        <p id="reg-feuerwehr" class="font-medium"></p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">Korrespondenz</label>
                        <p id="reg-korrespondenz" class="font-medium"></p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">Eingegangen am</label>
                        <p id="reg-datum" class="font-medium"></p>
                    </div>
                </div>

                <input type="hidden" id="registration-id">

                <div id="registration-actions" class="mt-6 space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Als Status aufnehmen:</label>
                        <select id="reg-member-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="Passivmitglied">Passivmitglied</option>
                            <option value="Aktivmitglied">Aktivmitglied</option>
                        </select>
                    </div>
                    <div class="flex space-x-3">
                        <button id="approve-registration-btn" class="flex-1 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">
                            Genehmigen
                        </button>
                        <button id="reject-registration-btn" class="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                            Ablehnen
                        </button>
                    </div>
                </div>

                <div id="registration-processed" class="mt-6 hidden">
                    <div class="bg-gray-100 rounded-lg p-4">
                        <p class="text-sm text-gray-600">Bearbeitet von: <span id="reg-processed-by"></span></p>
                        <p class="text-sm text-gray-600">Am: <span id="reg-processed-at"></span></p>
                        <p id="reg-rejection-reason" class="text-sm text-red-600 mt-2 hidden"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Modal (simplified) -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="event-modal-title" class="text-2xl font-bold text-gray-800">Event bearbeiten</h3>
                    <button id="close-event-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <form id="event-form" class="space-y-6">
                    <input type="hidden" id="event-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Basis-Informationen -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Titel *</label>
                            <input type="text" id="event-title" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Untertitel</label>
                            <input type="text" id="event-subtitle" placeholder="z.B. Roter Schopf" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Slug *</label>
                            <input type="text" id="event-slug" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kategorie</label>
                            <select id="event-category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                <option value="Dorffest">Dorffest</option>
                                <option value="Aufbau">Aufbau</option>
                                <option value="Abbau">Abbau</option>
                                <option value="Ausflug">Ausflug</option>
                                <option value="Ausflug mit Anmeldung">Ausflug mit Anmeldung</option>
                                <option value="Sonstiges">Sonstiges</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="event-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                <option value="planned">Geplant</option>
                                <option value="confirmed">Bestaetigt</option>
                                <option value="cancelled">Abgesagt</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Start-Datum *</label>
                            <input type="datetime-local" id="event-start-date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">End-Datum</label>
                            <input type="datetime-local" id="event-end-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ort</label>
                            <input type="text" id="event-location" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Beschreibung</label>
                            <textarea id="event-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500"></textarea>
                        </div>

                        <!-- Anmeldung -->
                        <div class="md:col-span-2 border-t pt-4 mt-2">
                            <h4 class="font-medium text-gray-800 mb-3">Anmeldung</h4>
                        </div>
                        <div>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="event-registration-required" class="rounded border-gray-300 text-fire-500 focus:ring-fire-500">
                                <span class="text-sm font-medium text-gray-700">Anmeldung erforderlich</span>
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Anmeldeschluss</label>
                            <input type="datetime-local" id="event-registration-deadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Max. Teilnehmer</label>
                            <input type="number" id="event-max-participants" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kosten</label>
                            <input type="text" id="event-cost" placeholder="z.B. CHF 20.- oder Kostenlos" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                        </div>

                        <!-- Schichten -->
                        <div class="md:col-span-2 border-t pt-4 mt-2">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-medium text-gray-800">Schichten</h4>
                                <button type="button" onclick="addShiftRow()" class="text-sm text-fire-600 hover:text-fire-800">+ Schicht hinzufuegen</button>
                            </div>
                            <div id="event-shifts-container" class="space-y-3">
                                <!-- Shifts will be added here dynamically -->
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Schichten werden bei Helfer-Events verwendet (z.B. Fasnacht)</p>
                        </div>
                    </div>
                    <div class="flex justify-between pt-4 border-t">
                        <button type="button" id="delete-event-btn" class="text-red-600 hover:text-red-700 font-medium hidden">Loeschen</button>
                        <div class="flex space-x-3">
                            <button type="button" id="cancel-event-btn" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">Abbrechen</button>
                            <button type="submit" class="px-6 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">Speichern</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://api.fwv-raura.ch';

        let members = [];
        let events = [];
        let auditLog = [];
        let authToken = null;
        let currentUser = null;
        let currentTab = 'members';

        // ============================================
        // AUTHENTICATION
        // ============================================

        async function checkAuth() {
            const token = localStorage.getItem('vorstand_token');
            if (!token) {
                showLoginModal();
                return false;
            }

            authToken = token;

            try {
                const response = await fetch(`${API_BASE}/auth/vorstand/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) {
                    localStorage.removeItem('vorstand_token');
                    showLoginModal();
                    return false;
                }
                currentUser = await response.json();
                document.getElementById('user-info').textContent = currentUser.name;
                hideLoginModal();
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                localStorage.removeItem('vorstand_token');
                showLoginModal();
                return false;
            }
        }

        function showLoginModal() {
            document.getElementById('login-modal').classList.remove('hidden');
        }

        function hideLoginModal() {
            document.getElementById('login-modal').classList.add('hidden');
        }

        async function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            const errorEl = document.getElementById('login-error');

            btn.disabled = true;
            btn.textContent = 'Anmelden...';
            errorEl.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE}/auth/vorstand/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Login fehlgeschlagen');
                }

                localStorage.setItem('vorstand_token', data.token);
                authToken = data.token;
                currentUser = data.user;
                document.getElementById('user-info').textContent = currentUser.name;

                hideLoginModal();
                await loadStats();
                await loadMembers();

            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Anmelden';
            }
        }

        document.getElementById('login-form').addEventListener('submit', handleLogin);

        // ============================================
        // MEMBERS
        // ============================================

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/members/stats/overview`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to load stats');
                const stats = await response.json();
                document.getElementById('stat-total').textContent = stats.total || 0;
                document.getElementById('stat-aktiv').textContent = stats.aktiv || 0;
                document.getElementById('stat-passiv').textContent = stats.passiv || 0;
                document.getElementById('stat-ehren').textContent = stats.ehren || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadMembers(filters = {}) {
            try {
                document.getElementById('loading-state').classList.remove('hidden');
                document.getElementById('empty-state').classList.add('hidden');

                const params = new URLSearchParams(filters);
                const response = await fetch(`${API_BASE}/members?${params}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('vorstand_token');
                        showLoginModal();
                        return;
                    }
                    throw new Error('Failed to load members');
                }

                members = await response.json();
                renderMembers();
            } catch (error) {
                console.error('Error loading members:', error);
            } finally {
                document.getElementById('loading-state').classList.add('hidden');
            }
        }

        function renderMembers() {
            const tbody = document.getElementById('members-tbody');

            if (members.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }

            document.getElementById('empty-state').classList.add('hidden');

            tbody.innerHTML = members.map(member => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${member.vorname} ${member.nachname}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-600">${member.email || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-600">${member.mobile || member.telefon || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusClass(member.status)}">
                            ${member.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-600">${member.funktion || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editMember('${member.id}')" class="text-fire-600 hover:text-fire-800">
                            Bearbeiten
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusClass(status) {
            const classes = {
                'Aktivmitglied': 'bg-green-100 text-green-800',
                'Passivmitglied': 'bg-blue-100 text-blue-800',
                'Ehrenmitglied': 'bg-yellow-100 text-yellow-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function openNewMemberModal() {
            document.getElementById('modal-title').textContent = 'Neues Mitglied';
            document.getElementById('member-form').reset();
            document.getElementById('member-id').value = '';
            document.getElementById('delete-member-btn').classList.add('hidden');
            // Reset photo preview
            document.getElementById('photo-preview').innerHTML = '<span class="text-gray-400 text-3xl">?</span>';
            document.getElementById('photo-delete-btn').classList.add('hidden');
            document.getElementById('member-modal').classList.remove('hidden');
        }

        async function editMember(id) {
            try {
                const response = await fetch(`${API_BASE}/members/${id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to load member');
                const member = await response.json();

                document.getElementById('modal-title').textContent = 'Mitglied bearbeiten';
                document.getElementById('member-id').value = member.id;
                document.getElementById('anrede').value = member.anrede || '';
                document.getElementById('vorname').value = member.vorname;
                document.getElementById('nachname').value = member.nachname;
                document.getElementById('geschlecht').value = member.geschlecht || '';
                document.getElementById('geburtstag').value = member.geburtstag || '';
                document.getElementById('strasse').value = member.strasse || '';
                document.getElementById('adresszusatz').value = member.adresszusatz || '';
                document.getElementById('plz').value = member.plz || '';
                document.getElementById('ort').value = member.ort || '';
                document.getElementById('telefon').value = member.telefon || '';
                document.getElementById('mobile').value = member.mobile || '';
                document.getElementById('email').value = member.email || '';
                document.getElementById('status').value = member.status || 'Aktivmitglied';
                document.getElementById('funktion').value = member.funktion || '';
                document.getElementById('eintrittsdatum').value = member.eintrittsdatum || '';
                document.getElementById('zustellung-email').checked = member.zustellung_email !== false;
                document.getElementById('zustellung-post').checked = member.zustellung_post === true;
                document.getElementById('bemerkungen').value = member.bemerkungen || '';

                document.getElementById('feuerwehr-zugehoerigkeit').value = member.feuerwehr_zugehoerigkeit || 'keine';

                // Load photo
                if (member.foto) {
                    document.getElementById('photo-preview').innerHTML = `<img src="${API_BASE}${member.foto}" class="w-full h-full object-cover">`;
                    document.getElementById('photo-delete-btn').classList.remove('hidden');
                } else {
                    document.getElementById('photo-preview').innerHTML = '<span class="text-gray-400 text-3xl">?</span>';
                    document.getElementById('photo-delete-btn').classList.add('hidden');
                }

                document.getElementById('delete-member-btn').classList.remove('hidden');
                document.getElementById('member-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading member:', error);
                alert('Fehler beim Laden des Mitglieds');
            }
        }

        async function saveMember(e) {
            e.preventDefault();

            const id = document.getElementById('member-id').value;
            const data = {
                anrede: document.getElementById('anrede').value,
                vorname: document.getElementById('vorname').value,
                nachname: document.getElementById('nachname').value,
                geschlecht: document.getElementById('geschlecht').value,
                geburtstag: document.getElementById('geburtstag').value || null,
                strasse: document.getElementById('strasse').value,
                adresszusatz: document.getElementById('adresszusatz').value,
                plz: document.getElementById('plz').value,
                ort: document.getElementById('ort').value,
                telefon: document.getElementById('telefon').value,
                mobile: document.getElementById('mobile').value,
                email: document.getElementById('email').value,
                status: document.getElementById('status').value,
                funktion: document.getElementById('funktion').value,
                eintrittsdatum: document.getElementById('eintrittsdatum').value || null,
                zustellung_email: document.getElementById('zustellung-email').checked,
                zustellung_post: document.getElementById('zustellung-post').checked,
                bemerkungen: document.getElementById('bemerkungen').value,
                feuerwehr_zugehoerigkeit: document.getElementById('feuerwehr-zugehoerigkeit').value
            };

            console.log('Saving member data:', data);

            try {
                const url = id ? `${API_BASE}/members/${id}` : `${API_BASE}/members`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Save member failed:', response.status, errorData);
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                document.getElementById('member-modal').classList.add('hidden');
                await loadMembers();
                await loadStats();

            } catch (error) {
                console.error('Error saving member:', error);
                alert('Fehler beim Speichern: ' + error.message);
            }
        }

        async function deleteMember() {
            const id = document.getElementById('member-id').value;
            if (!id) return;
            if (!confirm('Mitglied wirklich loeschen?')) return;

            try {
                const response = await fetch(`${API_BASE}/members/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to delete member');

                document.getElementById('member-modal').classList.add('hidden');
                await loadMembers();
                await loadStats();
            } catch (error) {
                console.error('Error deleting member:', error);
                alert('Fehler beim Loeschen');
            }
        }

        // Photo upload handling
        async function uploadMemberPhoto(file) {
            const memberId = document.getElementById('member-id').value;
            if (!memberId) {
                alert('Bitte speichern Sie zuerst das Mitglied');
                return;
            }

            const formData = new FormData();
            formData.append('photo', file);

            try {
                const response = await fetch(`${API_BASE}/members/${memberId}/photo`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                if (!response.ok) throw new Error('Failed to upload photo');

                const data = await response.json();
                document.getElementById('photo-preview').innerHTML = `<img src="${API_BASE}${data.photo_url}" class="w-full h-full object-cover">`;
                document.getElementById('photo-delete-btn').classList.remove('hidden');
                await loadMembers();
            } catch (error) {
                console.error('Error uploading photo:', error);
                alert('Fehler beim Hochladen des Fotos');
            }
        }

        async function deleteMemberPhoto() {
            const memberId = document.getElementById('member-id').value;
            if (!memberId) return;
            if (!confirm('Foto wirklich entfernen?')) return;

            try {
                const response = await fetch(`${API_BASE}/members/${memberId}/photo`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to delete photo');

                document.getElementById('photo-preview').innerHTML = '<span class="text-gray-400 text-3xl">?</span>';
                document.getElementById('photo-delete-btn').classList.add('hidden');
                await loadMembers();
            } catch (error) {
                console.error('Error deleting photo:', error);
                alert('Fehler beim Entfernen des Fotos');
            }
        }

        function exportCSV() {
            // CSV-Escape-Funktion fuer Felder mit Kommas oder Anfuehrungszeichen
            const escapeCSV = (value) => {
                if (!value) return '';
                const str = String(value);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };

            // Alle Felder fuer Serienbriefe
            const headers = [
                'Anrede', 'Vorname', 'Nachname',
                'Strasse', 'Adresszusatz', 'PLZ', 'Ort',
                'E-Mail', 'Telefon', 'Mobile',
                'Status', 'Funktion', 'Feuerwehr-Zugehoerigkeit',
                'Geburtstag', 'Eintrittsdatum'
            ];

            const rows = members.map(m => [
                escapeCSV(m.anrede),
                escapeCSV(m.vorname),
                escapeCSV(m.nachname),
                escapeCSV(m.strasse),
                escapeCSV(m.adresszusatz),
                escapeCSV(m.plz),
                escapeCSV(m.ort),
                escapeCSV(m.email),
                escapeCSV(m.telefon),
                escapeCSV(m.mobile),
                escapeCSV(m.status),
                escapeCSV(m.funktion),
                escapeCSV(m.feuerwehr_zugehoerigkeit),
                escapeCSV(m.geburtstag),
                escapeCSV(m.eintrittsdatum)
            ].join(';'));  // Semikolon fuer bessere Excel-Kompatibilitaet

            // BOM fuer UTF-8 (damit Excel Umlaute richtig anzeigt)
            const BOM = '\uFEFF';
            const csv = BOM + headers.join(';') + '\n' + rows.join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mitglieder-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ============================================
        // EVENTS
        // ============================================

        async function loadEvents() {
            try {
                document.getElementById('events-loading-state').classList.remove('hidden');
                document.getElementById('events-empty-state').classList.add('hidden');

                const response = await fetch(`${API_BASE}/events`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to load events');

                events = await response.json();
                renderEvents();
            } catch (error) {
                console.error('Error loading events:', error);
            } finally {
                document.getElementById('events-loading-state').classList.add('hidden');
            }
        }

        function renderEvents() {
            const tbody = document.getElementById('events-tbody');

            if (events.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('events-empty-state').classList.remove('hidden');
                return;
            }

            document.getElementById('events-empty-state').classList.add('hidden');

            tbody.innerHTML = events.map(event => {
                const startDate = new Date(event.start_date);
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">${event.title}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">${startDate.toLocaleDateString('de-CH')}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">${event.category || '-'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getEventStatusClass(event.status)}">
                                ${event.status || 'planned'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm text-gray-600">${event.shifts?.length || 0}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                            <button onclick="generateEventInvitation('${event.id}')" class="text-green-600 hover:text-green-800" title="Einladung generieren">
                                Einladung
                            </button>
                            <button onclick="editEvent('${event.id}')" class="text-fire-600 hover:text-fire-800">
                                Bearbeiten
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getEventStatusClass(status) {
            const classes = {
                'planned': 'bg-blue-100 text-blue-800',
                'confirmed': 'bg-green-100 text-green-800',
                'cancelled': 'bg-red-100 text-red-800',
                'completed': 'bg-gray-100 text-gray-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        async function generateEventInvitation(eventId) {
            try {
                // Load event data
                const response = await fetch(`${API_BASE}/events/${eventId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Event nicht gefunden');
                const event = await response.json();

                // Format date and time
                const startDate = new Date(event.start_date);
                const endDate = event.end_date ? new Date(event.end_date) : null;
                const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const timeOptions = { hour: '2-digit', minute: '2-digit' };

                const formattedDate = startDate.toLocaleDateString('de-CH', dateOptions);
                const formattedTime = startDate.toLocaleTimeString('de-CH', timeOptions) + ' Uhr';

                let dateRange = formattedDate;
                if (endDate && endDate.toDateString() !== startDate.toDateString()) {
                    dateRange += ` bis ${endDate.toLocaleDateString('de-CH', dateOptions)}`;
                }

                // Build invitation text
                const anmeldungInfo = event.registration_required
                    ? `\nAnmeldung: Erforderlich${event.registration_deadline ? ` bis ${new Date(event.registration_deadline).toLocaleDateString('de-CH')}` : ''}`
                    : '\nAnmeldung: Nicht erforderlich';

                const kostenInfo = event.cost ? `\nKosten: ${event.cost}` : '';

                const invitationSubject = `Einladung: ${event.title}`;
                const invitationBody = `Liebe Mitglieder

Der Vorstand möchte euch herzlich einladen:

═══════════════════════════════════════════
${event.title}${event.subtitle ? '\n' + event.subtitle : ''}
═══════════════════════════════════════════

Was:      ${event.title}
Wann:     ${formattedDate}, ${formattedTime}
Wo:       ${event.location || 'Wird noch bekannt gegeben'}${anmeldungInfo}${kostenInfo}

${event.description || ''}

Wir freuen uns über zahlreiches Erscheinen!

Mit freundlichen Grüssen
Im Namen des Vorstandes

René Käslin
Präsident`;

                // Switch to dispatch tab and fill in the data
                switchTab('dispatch');

                // Wait a moment for the tab to load
                await new Promise(resolve => setTimeout(resolve, 100));

                // Fill in the dispatch form
                document.getElementById('dispatch-subject').value = invitationSubject;
                document.getElementById('dispatch-body').value = invitationBody;

                // Reset template selection (using free text)
                document.getElementById('dispatch-template').value = '';
                document.getElementById('dispatch-variables').classList.add('hidden');

                // Set delivery method to auto
                document.querySelector('input[name="delivery-method"][value="auto"]').checked = true;

                // Update recipient count
                updateRecipientCount();

                alert(`Einladung für "${event.title}" wurde generiert.\n\nBitte prüfen und bei Bedarf anpassen, dann auf "Senden" klicken.`);

            } catch (error) {
                console.error('Error generating invitation:', error);
                alert('Fehler beim Generieren der Einladung: ' + error.message);
            }
        }

        function openNewEventModal() {
            document.getElementById('event-modal-title').textContent = 'Neues Event';
            document.getElementById('event-form').reset();
            document.getElementById('event-id').value = '';
            document.getElementById('event-shifts-container').innerHTML = '';
            document.getElementById('event-registration-required').checked = false;
            document.getElementById('delete-event-btn').classList.add('hidden');
            document.getElementById('event-modal').classList.remove('hidden');
        }

        async function editEvent(id) {
            try {
                const response = await fetch(`${API_BASE}/events/${id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to load event');

                const event = await response.json();

                document.getElementById('event-modal-title').textContent = 'Event bearbeiten';
                document.getElementById('event-id').value = event.id;
                document.getElementById('event-title').value = event.title || '';
                document.getElementById('event-subtitle').value = event.subtitle || '';
                document.getElementById('event-slug').value = event.slug || '';
                document.getElementById('event-category').value = event.category || 'Jahresanlass';
                document.getElementById('event-status').value = event.status || 'planned';
                document.getElementById('event-start-date').value = formatDateTimeLocal(event.start_date);
                document.getElementById('event-end-date').value = event.end_date ? formatDateTimeLocal(event.end_date) : '';
                document.getElementById('event-location').value = event.location || '';
                document.getElementById('event-description').value = event.description || '';
                document.getElementById('event-registration-required').checked = event.registration_required || false;
                document.getElementById('event-registration-deadline').value = event.registration_deadline ? formatDateTimeLocal(event.registration_deadline) : '';
                document.getElementById('event-max-participants').value = event.max_participants || '';
                document.getElementById('event-cost').value = event.cost || '';

                // Load shifts
                loadEventShifts(event.shifts || []);

                document.getElementById('delete-event-btn').classList.remove('hidden');
                document.getElementById('event-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading event:', error);
                alert('Fehler beim Laden des Events');
            }
        }

        function loadEventShifts(shifts) {
            const container = document.getElementById('event-shifts-container');
            container.innerHTML = '';
            shifts.forEach(shift => {
                addShiftRow(shift);
            });
        }

        // Format time for HTML input (HH:MM format, no seconds)
        function formatTimeForInput(time) {
            if (!time) return '';
            // Handle "HH:MM:SS" or "HH:MM" format
            return time.substring(0, 5);
        }

        // Format date for HTML input (YYYY-MM-DD)
        function formatDateForInput(date) {
            if (!date) return '';
            // Handle ISO date strings like "2026-01-18T00:00:00.000Z"
            if (date.includes('T')) {
                return date.split('T')[0];
            }
            // Handle PostgreSQL timestamp "2026-01-18 19:00:00"
            if (date.includes(' ')) {
                return date.split(' ')[0];
            }
            return date;
        }

        function addShiftRow(shift = null) {
            const container = document.getElementById('event-shifts-container');
            const shiftId = shift?.id || 'new-' + Date.now();
            const row = document.createElement('div');
            row.className = 'shift-row border rounded-lg p-3 bg-gray-50';
            row.dataset.shiftId = shiftId;

            const bereichValue = shift?.bereich || 'Allgemein';
            const dateValue = formatDateForInput(shift?.date);
            const startTimeValue = formatTimeForInput(shift?.start_time);
            const endTimeValue = formatTimeForInput(shift?.end_time);

            row.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-7 gap-2">
                    <div>
                        <select class="shift-bereich w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                            <option value="Allgemein" ${bereichValue === 'Allgemein' ? 'selected' : ''}>Allgemein</option>
                            <option value="Kueche" ${bereichValue === 'Kueche' ? 'selected' : ''}>Küche</option>
                            <option value="Bar" ${bereichValue === 'Bar' ? 'selected' : ''}>Bar</option>
                            <option value="Service" ${bereichValue === 'Service' ? 'selected' : ''}>Service</option>
                            <option value="Kasse" ${bereichValue === 'Kasse' ? 'selected' : ''}>Kasse</option>
                        </select>
                    </div>
                    <div>
                        <input type="text" placeholder="Name (z.B. Schicht 1)" value="${shift?.name || ''}"
                            class="shift-name w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                    </div>
                    <div>
                        <input type="date" value="${dateValue}"
                            class="shift-date w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                    </div>
                    <div>
                        <input type="time" value="${startTimeValue}" placeholder="Start"
                            class="shift-start w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                    </div>
                    <div>
                        <input type="time" value="${endTimeValue}" placeholder="Ende"
                            class="shift-end w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" min="1" value="${shift?.needed || 2}" placeholder="Anz."
                            class="shift-needed w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                        <button type="button" onclick="removeShiftRow(this)" class="text-red-500 hover:text-red-700 text-lg">&times;</button>
                    </div>
                </div>
                <div class="mt-2">
                    <input type="text" placeholder="Beschreibung (optional)" value="${shift?.description || ''}"
                        class="shift-description w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-fire-500">
                </div>
            `;
            container.appendChild(row);
        }

        function removeShiftRow(button) {
            const row = button.closest('.shift-row');
            row.remove();
        }

        function collectShiftsData() {
            const shifts = [];
            document.querySelectorAll('.shift-row').forEach(row => {
                const shiftId = row.dataset.shiftId;
                shifts.push({
                    id: shiftId.startsWith('new-') ? null : shiftId,
                    bereich: row.querySelector('.shift-bereich').value,
                    name: row.querySelector('.shift-name').value,
                    date: row.querySelector('.shift-date').value,
                    start_time: row.querySelector('.shift-start').value,
                    end_time: row.querySelector('.shift-end').value,
                    needed: parseInt(row.querySelector('.shift-needed').value) || 2,
                    description: row.querySelector('.shift-description').value
                });
            });
            return shifts.filter(s => s.name && s.date);
        }

        function formatDateTimeLocal(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const offset = date.getTimezoneOffset();
            const localDate = new Date(date.getTime() - (offset * 60 * 1000));
            return localDate.toISOString().slice(0, 16);
        }

        async function saveEvent(e) {
            e.preventDefault();

            const id = document.getElementById('event-id').value;
            const data = {
                slug: document.getElementById('event-slug').value,
                title: document.getElementById('event-title').value,
                subtitle: document.getElementById('event-subtitle').value || null,
                category: document.getElementById('event-category').value,
                status: document.getElementById('event-status').value,
                start_date: document.getElementById('event-start-date').value,
                end_date: document.getElementById('event-end-date').value || null,
                location: document.getElementById('event-location').value || null,
                description: document.getElementById('event-description').value || null,
                registration_required: document.getElementById('event-registration-required').checked,
                registration_deadline: document.getElementById('event-registration-deadline').value || null,
                max_participants: document.getElementById('event-max-participants').value ? parseInt(document.getElementById('event-max-participants').value) : null,
                cost: document.getElementById('event-cost').value || null
            };

            console.log('Saving event data:', data);

            try {
                const url = id ? `${API_BASE}/events/${id}` : `${API_BASE}/events`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Save event failed:', response.status, errorData);
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const savedEvent = await response.json();
                const eventId = savedEvent.id;

                // Save shifts
                const shiftsData = collectShiftsData();
                await saveEventShifts(eventId, shiftsData);

                document.getElementById('event-modal').classList.add('hidden');
                await loadEvents();
            } catch (error) {
                console.error('Error saving event:', error);
                alert('Fehler beim Speichern: ' + error.message);
            }
        }

        async function saveEventShifts(eventId, shifts) {
            // Get existing shifts to compare
            const existingResponse = await fetch(`${API_BASE}/events/${eventId}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const existingEvent = await existingResponse.json();
            const existingShiftIds = (existingEvent.shifts || []).map(s => s.id);

            // Collect shift IDs that are still present
            const currentShiftIds = shifts.filter(s => s.id).map(s => s.id);

            // Delete removed shifts
            for (const oldId of existingShiftIds) {
                if (!currentShiftIds.includes(oldId)) {
                    await fetch(`${API_BASE}/shifts/${oldId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                }
            }

            // Create or update shifts
            for (const shift of shifts) {
                if (shift.id) {
                    // Update existing shift
                    await fetch(`${API_BASE}/shifts/${shift.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            name: shift.name,
                            description: shift.description,
                            date: shift.date,
                            start_time: shift.start_time,
                            end_time: shift.end_time,
                            needed: shift.needed,
                            bereich: shift.bereich
                        })
                    });
                } else {
                    // Create new shift
                    await fetch(`${API_BASE}/shifts`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            event_id: eventId,
                            name: shift.name,
                            description: shift.description,
                            date: shift.date,
                            start_time: shift.start_time,
                            end_time: shift.end_time,
                            needed: shift.needed,
                            bereich: shift.bereich
                        })
                    });
                }
            }
        }

        async function deleteEvent() {
            const id = document.getElementById('event-id').value;
            if (!id) return;
            if (!confirm('Event wirklich loeschen?')) return;

            try {
                const response = await fetch(`${API_BASE}/events/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to delete event');

                document.getElementById('event-modal').classList.add('hidden');
                await loadEvents();
            } catch (error) {
                console.error('Error deleting event:', error);
                alert('Fehler beim Loeschen');
            }
        }

        // ============================================
        // AUDIT LOG
        // ============================================

        async function loadAuditLog(filters = {}) {
            try {
                document.getElementById('audit-loading-state').classList.remove('hidden');

                const params = new URLSearchParams(filters);
                const response = await fetch(`${API_BASE}/audit?${params}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to load audit log');

                auditLog = await response.json();
                renderAuditLog();
            } catch (error) {
                console.error('Error loading audit log:', error);
            } finally {
                document.getElementById('audit-loading-state').classList.add('hidden');
            }
        }

        function renderAuditLog() {
            const tbody = document.getElementById('audit-tbody');

            if (auditLog.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Keine Eintraege gefunden</td></tr>';
                return;
            }

            tbody.innerHTML = auditLog.map(entry => {
                const date = new Date(entry.created_at);
                const details = entry.details ? JSON.stringify(entry.details, null, 2) : '-';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${date.toLocaleDateString('de-CH')}</div>
                            <div class="text-xs text-gray-500">${date.toLocaleTimeString('de-CH')}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getAuditActionClass(entry.action)}">
                                ${entry.action}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">${entry.email || '-'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">${entry.ip_address || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-xs text-gray-500 max-w-xs truncate" title="${details}">
                                ${details}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getAuditActionClass(action) {
            if (action.includes('FAILED') || action.includes('ERROR')) return 'bg-red-100 text-red-800';
            if (action.includes('DELETE')) return 'bg-orange-100 text-orange-800';
            if (action.includes('CREATE')) return 'bg-green-100 text-green-800';
            if (action.includes('UPDATE')) return 'bg-blue-100 text-blue-800';
            if (action.includes('LOGIN_SUCCESS')) return 'bg-green-100 text-green-800';
            return 'bg-gray-100 text-gray-800';
        }

        // ============================================
        // DISPATCH
        // ============================================

        let dispatchTemplates = [];
        let selectedMembersForDispatch = [];
        let currentTemplate = null;

        async function loadDispatchTemplates() {
            try {
                const response = await fetch(`${API_BASE}/templates`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    dispatchTemplates = await response.json();
                    const select = document.getElementById('dispatch-template');
                    select.innerHTML = '<option value="">Freier Text (keine Vorlage)</option>';
                    dispatchTemplates.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t.id;
                        option.textContent = `${t.name} (${t.type === 'email' ? 'E-Mail' : 'Post'})`;
                        select.appendChild(option);
                    });
                } else {
                    console.error('Failed to load templates:', response.status);
                }
            } catch (error) {
                console.error('Error loading dispatch templates:', error);
            }
        }

        function onTemplateSelected() {
            const templateId = document.getElementById('dispatch-template').value;
            const variablesContainer = document.getElementById('dispatch-variables');
            const variablesInputs = document.getElementById('dispatch-variables-inputs');
            const subjectInput = document.getElementById('dispatch-subject');
            const bodyInput = document.getElementById('dispatch-body');

            if (!templateId) {
                currentTemplate = null;
                variablesContainer.classList.add('hidden');
                subjectInput.value = '';
                bodyInput.value = '';
                return;
            }

            currentTemplate = dispatchTemplates.find(t => t.id === templateId);
            if (!currentTemplate) return;

            // Fill subject and body from template
            subjectInput.value = currentTemplate.subject || '';
            bodyInput.value = currentTemplate.body || '';

            // Show template variables if any
            const variables = currentTemplate.variables || [];
            // Filter out member variables that are auto-filled
            const memberVars = ['anrede', 'vorname', 'nachname', 'strasse', 'plz', 'ort', 'email'];
            const customVars = variables.filter(v => !memberVars.includes(v));

            if (customVars.length > 0) {
                variablesInputs.innerHTML = customVars.map(v => `
                    <div class="flex items-center gap-2">
                        <label class="w-40 text-sm text-gray-600">{{${v}}}</label>
                        <input type="text" data-var="${v}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="${v}">
                    </div>
                `).join('');
                variablesContainer.classList.remove('hidden');
            } else {
                variablesContainer.classList.add('hidden');
            }
        }

        function showDispatchPreview() {
            const subject = document.getElementById('dispatch-subject').value;
            let body = document.getElementById('dispatch-body').value;

            // Replace template variables with sample data
            const sampleMember = members[0] || {
                anrede: 'Herr',
                vorname: 'Max',
                nachname: 'Mustermann',
                strasse: 'Musterstrasse 1',
                plz: '4303',
                ort: 'Kaiseraugst',
                email: 'max@example.com'
            };

            // Replace member variables
            body = body.replace(/\{\{anrede\}\}/g, sampleMember.anrede || '');
            body = body.replace(/\{\{vorname\}\}/g, sampleMember.vorname || '');
            body = body.replace(/\{\{nachname\}\}/g, sampleMember.nachname || '');
            body = body.replace(/\{\{strasse\}\}/g, sampleMember.strasse || '');
            body = body.replace(/\{\{plz\}\}/g, sampleMember.plz || '');
            body = body.replace(/\{\{ort\}\}/g, sampleMember.ort || '');
            body = body.replace(/\{\{email\}\}/g, sampleMember.email || '');

            // Replace custom variables from inputs
            document.querySelectorAll('#dispatch-variables-inputs input[data-var]').forEach(input => {
                const varName = input.dataset.var;
                const value = input.value || `[${varName}]`;
                body = body.replace(new RegExp(`\\{\\{${varName}\\}\\}`, 'g'), value);
            });

            // Show preview in modal
            const previewHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="text-lg font-bold">Vorschau</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">&times;</button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[60vh]">
                            <div class="mb-4">
                                <label class="text-sm font-medium text-gray-500">Betreff:</label>
                                <p class="font-semibold">${subject || '(kein Betreff)'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-500">Nachricht:</label>
                                <div class="mt-2 p-4 bg-gray-50 rounded-lg whitespace-pre-wrap font-mono text-sm">${body}</div>
                            </div>
                        </div>
                        <div class="p-4 border-t text-right">
                            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Schliessen</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', previewHtml);
        }

        function updateRecipientCount() {
            const recipientType = document.querySelector('input[name="recipient-type"]:checked').value;
            let count = 0;

            if (recipientType === 'all') {
                count = members.length;
            } else if (recipientType === 'filter') {
                const status = document.getElementById('dispatch-filter-status').value;
                const emailOnly = document.getElementById('dispatch-filter-email').checked;
                const postOnly = document.getElementById('dispatch-filter-post').checked;

                count = members.filter(m => {
                    if (status && m.status !== status) return false;
                    if (emailOnly && !m.zustellung_email) return false;
                    if (postOnly && !m.zustellung_post) return false;
                    return true;
                }).length;
            } else if (recipientType === 'selected') {
                count = selectedMembersForDispatch.length;
            }

            document.getElementById('dispatch-recipient-count').textContent = count;
        }

        async function sendDispatch() {
            const deliveryMethod = document.querySelector('input[name="delivery-method"]:checked').value;
            const recipientType = document.querySelector('input[name="recipient-type"]:checked').value;
            const templateId = document.getElementById('dispatch-template').value;
            const subject = document.getElementById('dispatch-subject').value;
            const body = document.getElementById('dispatch-body').value;

            if (!subject && deliveryMethod === 'email') {
                alert('Bitte Betreff eingeben');
                return;
            }

            if (!body && !templateId) {
                alert('Bitte Nachricht oder Vorlage auswählen');
                return;
            }

            // Get recipients
            let recipients = [];
            if (recipientType === 'all') {
                recipients = members;
            } else if (recipientType === 'filter') {
                const status = document.getElementById('dispatch-filter-status').value;
                const emailOnly = document.getElementById('dispatch-filter-email').checked;
                const postOnly = document.getElementById('dispatch-filter-post').checked;

                recipients = members.filter(m => {
                    if (status && m.status !== status) return false;
                    if (emailOnly && !m.zustellung_email) return false;
                    if (postOnly && !m.zustellung_post) return false;
                    return true;
                });
            } else if (recipientType === 'selected') {
                recipients = selectedMembersForDispatch;
            }

            if (recipients.length === 0) {
                alert('Keine Empfänger ausgewählt');
                return;
            }

            // For auto mode, split recipients by their preference
            let emailRecipients = [];
            let postRecipients = [];

            if (deliveryMethod === 'auto') {
                emailRecipients = recipients.filter(m => m.zustellung_email && m.email);
                postRecipients = recipients.filter(m => m.zustellung_post && m.strasse && m.plz && m.ort);

                const totalToSend = emailRecipients.length + postRecipients.length;
                const message = `Versand an ${totalToSend} Empfänger:\n- ${emailRecipients.length} per E-Mail\n- ${postRecipients.length} per Post`;
                if (!confirm(message)) return;
            } else if (deliveryMethod === 'email') {
                emailRecipients = recipients.filter(m => m.email);
                if (!confirm(`E-Mail an ${emailRecipients.length} Empfänger senden?`)) return;
            } else {
                postRecipients = recipients.filter(m => m.strasse && m.plz && m.ort);
                if (!confirm(`Brief an ${postRecipients.length} Empfänger senden?`)) return;
            }

            try {
                let emailSuccess = 0;
                let postSuccess = 0;

                // Send emails
                if (emailRecipients.length > 0) {
                    const response = await fetch(`${API_BASE}/email/bulk`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            member_ids: emailRecipients.map(m => m.id),
                            template_id: templateId || null,
                            subject,
                            body,
                            variables: {}
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        emailSuccess = result.success || 0;
                    } else {
                        throw new Error(`Email API error: ${response.status}`);
                    }
                }

                // Send post
                if (postRecipients.length > 0) {
                    for (const member of postRecipients) {
                        const html = body; // Should use template if selected
                        const recipient = {
                            name: `${member.vorname} ${member.nachname}`,
                            street: member.strasse,
                            zip: member.plz,
                            city: member.ort
                        };

                        const response = await fetch(`${API_BASE}/pingen/send`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                html,
                                recipient,
                                member_id: member.id
                            })
                        });

                        if (response.ok) {
                            postSuccess++;
                        }
                    }
                }

                let message = 'Versand erfolgreich:';
                if (emailSuccess > 0) message += `\n- ${emailSuccess} E-Mails`;
                if (postSuccess > 0) message += `\n- ${postSuccess} Briefe`;
                alert(message);
                loadDispatchHistory();
            } catch (error) {
                console.error('Error sending dispatch:', error);
                alert(`Fehler beim Versand: ${error.message}`);
            }
        }

        async function loadDispatchHistory() {
            try {
                const response = await fetch(`${API_BASE}/dispatch-log?limit=50`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const logs = await response.json();
                    const tbody = document.getElementById('dispatch-history-tbody');

                    if (logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Keine Versandhistorie vorhanden</td></tr>';
                        return;
                    }

                    tbody.innerHTML = logs.map(log => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${new Date(log.sent_at).toLocaleString('de-CH')}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${log.type === 'email' ? 'E-Mail' : 'Post'}</td>
                            <td class="px-6 py-4 text-sm">${log.subject || '-'}</td>
                            <td class="px-6 py-4 text-sm">${log.recipient_email || log.recipient_name || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-2 py-1 rounded-full text-xs ${log.status === 'sent' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${log.status}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading dispatch history:', error);
            }
        }

        // ============================================
        // REGISTRATIONS
        // ============================================

        let registrations = [];

        async function loadRegistrationCount() {
            try {
                const response = await fetch(`${API_BASE}/registrations/count/pending`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('registrations-badge');
                    if (data.count > 0) {
                        badge.textContent = data.count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Error loading registration count:', error);
            }
        }

        async function loadRegistrations() {
            try {
                document.getElementById('registrations-loading').classList.remove('hidden');
                document.getElementById('registrations-empty').classList.add('hidden');

                const status = document.getElementById('registrations-filter').value;
                const response = await fetch(`${API_BASE}/registrations?status=${status}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to load registrations');

                registrations = await response.json();
                renderRegistrations();
                loadRegistrationCount();
            } catch (error) {
                console.error('Error loading registrations:', error);
            } finally {
                document.getElementById('registrations-loading').classList.add('hidden');
            }
        }

        function renderRegistrations() {
            const tbody = document.getElementById('registrations-tbody');

            if (registrations.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('registrations-empty').classList.remove('hidden');
                return;
            }

            document.getElementById('registrations-empty').classList.add('hidden');

            tbody.innerHTML = registrations.map(reg => {
                const date = new Date(reg.created_at).toLocaleDateString('de-CH');
                const feuerwehrStatus = {
                    'active': 'Aktiv',
                    'former': 'Ehemalig',
                    'no': 'Nein'
                }[reg.feuerwehr_status] || reg.feuerwehr_status || '-';

                const statusClass = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'approved': 'bg-green-100 text-green-800',
                    'rejected': 'bg-red-100 text-red-800'
                }[reg.status] || 'bg-gray-100 text-gray-800';

                const statusText = {
                    'pending': 'Ausstehend',
                    'approved': 'Genehmigt',
                    'rejected': 'Abgelehnt'
                }[reg.status] || reg.status;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">${reg.vorname} ${reg.nachname}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-600">${reg.email}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-600">${feuerwehrStatus}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-600">${date}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${statusText}</span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="viewRegistration('${reg.id}')" class="text-fire-600 hover:text-fire-800">
                                Anzeigen
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function viewRegistration(id) {
            try {
                const response = await fetch(`${API_BASE}/registrations/${id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to load registration');

                const reg = await response.json();

                document.getElementById('registration-id').value = reg.id;
                document.getElementById('reg-vorname').textContent = reg.vorname;
                document.getElementById('reg-nachname').textContent = reg.nachname;
                document.getElementById('reg-adresse').textContent = `${reg.strasse || ''}, ${reg.plz || ''} ${reg.ort || ''}`;
                document.getElementById('reg-telefon').textContent = reg.telefon || '-';
                document.getElementById('reg-mobile').textContent = reg.mobile || '-';
                document.getElementById('reg-email').textContent = reg.email;

                const feuerwehrStatus = {
                    'active': 'Aktives Feuerwehr-Mitglied',
                    'former': 'Ehemaliges Feuerwehr-Mitglied',
                    'no': 'Kein Feuerwehr-Mitglied'
                }[reg.feuerwehr_status] || reg.feuerwehr_status || '-';
                document.getElementById('reg-feuerwehr').textContent = feuerwehrStatus;

                const korrespondenz = {
                    'email': 'E-Mail',
                    'post': 'Post'
                }[reg.korrespondenz_methode] || reg.korrespondenz_methode || '-';
                document.getElementById('reg-korrespondenz').textContent = korrespondenz;

                document.getElementById('reg-datum').textContent = new Date(reg.created_at).toLocaleString('de-CH');

                // Show/hide actions based on status
                if (reg.status === 'pending') {
                    document.getElementById('registration-actions').classList.remove('hidden');
                    document.getElementById('registration-processed').classList.add('hidden');
                } else {
                    document.getElementById('registration-actions').classList.add('hidden');
                    document.getElementById('registration-processed').classList.remove('hidden');
                    document.getElementById('reg-processed-by').textContent = reg.processed_by || '-';
                    document.getElementById('reg-processed-at').textContent = reg.processed_at
                        ? new Date(reg.processed_at).toLocaleString('de-CH')
                        : '-';

                    if (reg.rejection_reason) {
                        document.getElementById('reg-rejection-reason').textContent = `Grund: ${reg.rejection_reason}`;
                        document.getElementById('reg-rejection-reason').classList.remove('hidden');
                    } else {
                        document.getElementById('reg-rejection-reason').classList.add('hidden');
                    }
                }

                document.getElementById('registration-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading registration:', error);
                alert('Fehler beim Laden des Antrags');
            }
        }

        async function approveRegistration() {
            const id = document.getElementById('registration-id').value;
            const memberStatus = document.getElementById('reg-member-status').value;

            if (!confirm('Möchten Sie diesen Antrag genehmigen?')) return;

            try {
                const response = await fetch(`${API_BASE}/registrations/${id}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ memberStatus })
                });

                if (!response.ok) throw new Error('Failed to approve registration');

                alert('Antrag wurde genehmigt und Mitglied erstellt.');
                document.getElementById('registration-modal').classList.add('hidden');
                loadRegistrations();
            } catch (error) {
                console.error('Error approving registration:', error);
                alert('Fehler beim Genehmigen des Antrags');
            }
        }

        async function rejectRegistration() {
            const id = document.getElementById('registration-id').value;
            const reason = prompt('Grund für die Ablehnung (optional):');

            if (!confirm('Möchten Sie diesen Antrag wirklich ablehnen?')) return;

            try {
                const response = await fetch(`${API_BASE}/registrations/${id}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ reason })
                });

                if (!response.ok) throw new Error('Failed to reject registration');

                alert('Antrag wurde abgelehnt.');
                document.getElementById('registration-modal').classList.add('hidden');
                loadRegistrations();
            } catch (error) {
                console.error('Error rejecting registration:', error);
                alert('Fehler beim Ablehnen des Antrags');
            }
        }

        // ============================================
        // TAB SWITCHING
        // ============================================

        function switchTab(tab) {
            currentTab = tab;

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-fire-500', 'text-fire-600');
                btn.classList.add('border-transparent', 'text-gray-600');
            });

            document.getElementById('members-section').classList.add('hidden');
            document.getElementById('events-section').classList.add('hidden');
            document.getElementById('audit-section').classList.add('hidden');
            document.getElementById('dispatch-section').classList.add('hidden');
            document.getElementById('email-section').classList.add('hidden');
            document.getElementById('registrations-section').classList.add('hidden');

            if (tab === 'members') {
                document.getElementById('tab-members').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('members-section').classList.remove('hidden');
            } else if (tab === 'events') {
                document.getElementById('tab-events').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('events-section').classList.remove('hidden');
                loadEvents();
            } else if (tab === 'audit') {
                document.getElementById('tab-audit').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('audit-section').classList.remove('hidden');
                loadAuditLog();
            } else if (tab === 'dispatch') {
                document.getElementById('tab-dispatch').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('dispatch-section').classList.remove('hidden');
                loadDispatchTemplates();
                loadDispatchHistory();
                updateRecipientCount();
            } else if (tab === 'email') {
                document.getElementById('tab-email').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('email-section').classList.remove('hidden');
                loadMailboxes();
            } else if (tab === 'registrations') {
                document.getElementById('tab-registrations').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('registrations-section').classList.remove('hidden');
                loadRegistrations();
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        // Tabs
        document.getElementById('tab-members').addEventListener('click', () => switchTab('members'));
        document.getElementById('tab-events').addEventListener('click', () => switchTab('events'));
        document.getElementById('tab-audit').addEventListener('click', () => switchTab('audit'));
        document.getElementById('tab-dispatch').addEventListener('click', () => switchTab('dispatch'));
        document.getElementById('tab-email').addEventListener('click', () => switchTab('email'));
        document.getElementById('tab-registrations').addEventListener('click', () => switchTab('registrations'));

        // Members
        document.getElementById('add-member-btn').addEventListener('click', openNewMemberModal);
        document.getElementById('member-form').addEventListener('submit', saveMember);
        document.getElementById('delete-member-btn').addEventListener('click', deleteMember);
        document.getElementById('close-modal').addEventListener('click', () => document.getElementById('member-modal').classList.add('hidden'));
        document.getElementById('cancel-btn').addEventListener('click', () => document.getElementById('member-modal').classList.add('hidden'));
        document.getElementById('search-input').addEventListener('input', (e) => loadMembers({ search: e.target.value, status: document.getElementById('status-filter').value }));
        document.getElementById('status-filter').addEventListener('change', (e) => loadMembers({ search: document.getElementById('search-input').value, status: e.target.value }));
        document.getElementById('export-btn').addEventListener('click', exportCSV);

        // Photo upload
        document.getElementById('photo-upload-btn').addEventListener('click', () => {
            document.getElementById('photo-upload').click();
        });
        document.getElementById('photo-upload').addEventListener('change', (e) => {
            if (e.target.files[0]) {
                uploadMemberPhoto(e.target.files[0]);
                e.target.value = ''; // Reset for next upload
            }
        });
        document.getElementById('photo-delete-btn').addEventListener('click', deleteMemberPhoto);

        // Auto-set Eintrittsdatum when Feuerwehr Raurica is selected
        document.getElementById('feuerwehr-zugehoerigkeit').addEventListener('change', (e) => {
            if (e.target.value === 'feuerwehr_raurica') {
                const today = new Date().toISOString().split('T')[0];
                const eintrittsdatum = document.getElementById('eintrittsdatum');
                if (!eintrittsdatum.value) {
                    eintrittsdatum.value = today;
                }
            }
        });

        // Events
        document.getElementById('add-event-btn').addEventListener('click', openNewEventModal);
        document.getElementById('event-form').addEventListener('submit', saveEvent);
        document.getElementById('delete-event-btn').addEventListener('click', deleteEvent);
        document.getElementById('close-event-modal').addEventListener('click', () => document.getElementById('event-modal').classList.add('hidden'));
        document.getElementById('cancel-event-btn').addEventListener('click', () => document.getElementById('event-modal').classList.add('hidden'));

        // Audit
        document.getElementById('audit-action-filter').addEventListener('change', (e) => loadAuditLog({ action: e.target.value }));
        document.getElementById('refresh-audit-btn').addEventListener('click', () => loadAuditLog({ action: document.getElementById('audit-action-filter').value }));

        // Email Management
        document.getElementById('add-mailbox-btn').addEventListener('click', openNewMailboxModal);
        document.getElementById('add-alias-btn').addEventListener('click', openNewAliasModal);
        document.getElementById('mailbox-form').addEventListener('submit', saveMailbox);
        document.getElementById('alias-form').addEventListener('submit', saveAlias);
        document.querySelectorAll('.close-mailbox-modal').forEach(btn => btn.addEventListener('click', () => document.getElementById('mailbox-modal').classList.add('hidden')));
        document.querySelectorAll('.close-alias-modal').forEach(btn => btn.addEventListener('click', () => document.getElementById('alias-modal').classList.add('hidden')));

        // Email Sub-Tabs
        document.getElementById('email-tab-mailboxes').addEventListener('click', () => switchEmailTab('mailboxes'));
        document.getElementById('email-tab-aliases').addEventListener('click', () => switchEmailTab('aliases'));
        document.getElementById('email-tab-quota').addEventListener('click', () => switchEmailTab('quota'));

        // Dispatch
        document.querySelectorAll('input[name="delivery-method"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const method = document.querySelector('input[name="delivery-method"]:checked').value;
                // Show subject field for email or auto mode (since auto can send emails)
                const showSubject = method === 'email' || method === 'auto';
                document.getElementById('dispatch-subject-container').style.display = showSubject ? 'block' : 'none';
            });
        });

        document.querySelectorAll('input[name="recipient-type"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const recipientType = document.querySelector('input[name="recipient-type"]:checked').value;
                document.getElementById('recipient-filter').classList.toggle('hidden', recipientType !== 'filter');
                document.getElementById('recipient-selected').classList.toggle('hidden', recipientType !== 'selected');
                updateRecipientCount();
            });
        });

        document.getElementById('dispatch-filter-status').addEventListener('change', updateRecipientCount);
        document.getElementById('dispatch-filter-email').addEventListener('change', updateRecipientCount);
        document.getElementById('dispatch-filter-post').addEventListener('change', updateRecipientCount);
        document.getElementById('dispatch-template').addEventListener('change', onTemplateSelected);
        document.getElementById('dispatch-preview-btn').addEventListener('click', showDispatchPreview);
        document.getElementById('dispatch-send-btn').addEventListener('click', sendDispatch);

        // Registrations
        document.getElementById('registrations-filter').addEventListener('change', () => loadRegistrations());
        document.getElementById('refresh-registrations-btn').addEventListener('click', () => loadRegistrations());
        document.getElementById('close-registration-modal').addEventListener('click', () => document.getElementById('registration-modal').classList.add('hidden'));
        document.getElementById('approve-registration-btn').addEventListener('click', approveRegistration);
        document.getElementById('reject-registration-btn').addEventListener('click', rejectRegistration);

        function switchEmailTab(tab) {
            document.querySelectorAll('.email-tab-btn').forEach(btn => {
                btn.classList.remove('border-fire-500', 'text-fire-600');
                btn.classList.add('border-transparent', 'text-gray-600');
            });
            document.getElementById('mailboxes-panel').classList.add('hidden');
            document.getElementById('aliases-panel').classList.add('hidden');
            document.getElementById('quota-panel').classList.add('hidden');

            if (tab === 'mailboxes') {
                document.getElementById('email-tab-mailboxes').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('mailboxes-panel').classList.remove('hidden');
                loadMailboxes();
            } else if (tab === 'aliases') {
                document.getElementById('email-tab-aliases').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('aliases-panel').classList.remove('hidden');
                loadAliases();
            } else if (tab === 'quota') {
                document.getElementById('email-tab-quota').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('quota-panel').classList.remove('hidden');
                loadQuota();
            }
        }

        async function loadMailboxes() {
            document.getElementById('mailboxes-loading').classList.remove('hidden');
            try {
                const response = await fetch(`${API_BASE}/mailcow/mailboxes`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const mailboxes = await response.json();
                const tbody = document.getElementById('mailboxes-tbody');
                tbody.innerHTML = mailboxes.map(mb => `
                    <tr>
                        <td class="px-6 py-4 font-medium">${mb.username}</td>
                        <td class="px-6 py-4">${mb.name || '-'}</td>
                        <td class="px-6 py-4">${Math.round(mb.quota_used / 1024 / 1024)} / ${mb.quota} MB</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${mb.active == 1 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${mb.active == 1 ? 'Aktiv' : 'Inaktiv'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="editMailbox('${mb.username}')" class="text-blue-600 hover:text-blue-800 mr-3">Bearbeiten</button>
                            <button onclick="deleteMailbox('${mb.username}')" class="text-red-600 hover:text-red-800">Loeschen</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading mailboxes:', error);
            }
            document.getElementById('mailboxes-loading').classList.add('hidden');
        }

        async function loadAliases() {
            document.getElementById('aliases-loading').classList.remove('hidden');
            try {
                const response = await fetch(`${API_BASE}/mailcow/aliases`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const aliases = await response.json();
                const tbody = document.getElementById('aliases-tbody');
                tbody.innerHTML = aliases.map(a => `
                    <tr>
                        <td class="px-6 py-4 font-medium">${a.address}</td>
                        <td class="px-6 py-4">${a.goto}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${a.active == 1 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${a.active == 1 ? 'Aktiv' : 'Inaktiv'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="editAlias(${a.id}, '${a.address}', '${a.goto}', ${a.active})" class="text-blue-600 hover:text-blue-800 mr-3">Bearbeiten</button>
                            <button onclick="deleteAlias(${a.id})" class="text-red-600 hover:text-red-800">Loeschen</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading aliases:', error);
            }
            document.getElementById('aliases-loading').classList.add('hidden');
        }

        async function loadQuota() {
            document.getElementById('quota-loading').classList.remove('hidden');
            try {
                const response = await fetch(`${API_BASE}/mailcow/quota`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const quotaData = await response.json();
                const container = document.getElementById('quota-cards');
                container.innerHTML = quotaData.map(q => `
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="font-medium text-gray-800">${q.email}</div>
                        <div class="text-sm text-gray-600 mb-2">${q.name || ''}</div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-1">
                            <div class="h-3 rounded-full ${q.percent_used > 90 ? 'bg-red-500' : q.percent_used > 70 ? 'bg-yellow-500' : 'bg-green-500'}"
                                 style="width: ${Math.min(q.percent_used, 100)}%"></div>
                        </div>
                        <div class="text-xs text-gray-500">${Math.round(q.quota_used / 1024 / 1024)} / ${q.quota} MB (${q.percent_used}%)</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading quota:', error);
            }
            document.getElementById('quota-loading').classList.add('hidden');
        }

        function openNewMailboxModal() {
            document.getElementById('mailbox-modal-title').textContent = 'Neue Mailbox';
            document.getElementById('mailbox-edit-email').value = '';
            document.getElementById('mailbox-local').value = '';
            document.getElementById('mailbox-local').disabled = false;
            document.getElementById('mailbox-name').value = '';
            document.getElementById('mailbox-password').value = '';
            document.getElementById('mailbox-password').required = true;
            document.getElementById('mailbox-password-hint').textContent = 'Erforderlich fuer neue Mailbox';
            document.getElementById('mailbox-quota').value = '1024';
            document.getElementById('mailbox-active').checked = true;
            document.getElementById('mailbox-modal').classList.remove('hidden');
        }

        async function editMailbox(email) {
            const response = await fetch(`${API_BASE}/mailcow/mailboxes/${email}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const mb = await response.json();

            document.getElementById('mailbox-modal-title').textContent = 'Mailbox bearbeiten';
            document.getElementById('mailbox-edit-email').value = email;
            document.getElementById('mailbox-local').value = email.split('@')[0];
            document.getElementById('mailbox-local').disabled = true;
            document.getElementById('mailbox-name').value = mb.name || '';
            document.getElementById('mailbox-password').value = '';
            document.getElementById('mailbox-password').required = false;
            document.getElementById('mailbox-password-hint').textContent = 'Leer lassen um Passwort nicht zu aendern';
            document.getElementById('mailbox-quota').value = mb.quota || 1024;
            document.getElementById('mailbox-active').checked = mb.active == 1;
            document.getElementById('mailbox-modal').classList.remove('hidden');
        }

        async function saveMailbox(e) {
            e.preventDefault();
            const editEmail = document.getElementById('mailbox-edit-email').value;
            const isEdit = !!editEmail;

            const data = {
                name: document.getElementById('mailbox-name').value,
                quota: parseInt(document.getElementById('mailbox-quota').value),
                active: document.getElementById('mailbox-active').checked ? 1 : 0
            };

            if (!isEdit) {
                data.local_part = document.getElementById('mailbox-local').value;
                data.password = document.getElementById('mailbox-password').value;
            } else if (document.getElementById('mailbox-password').value) {
                data.password = document.getElementById('mailbox-password').value;
            }

            try {
                const response = await fetch(`${API_BASE}/mailcow/mailboxes${isEdit ? '/' + editEmail : ''}`, {
                    method: isEdit ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Fehler beim Speichern');
                document.getElementById('mailbox-modal').classList.add('hidden');
                loadMailboxes();
            } catch (error) {
                alert('Fehler: ' + error.message);
            }
        }

        async function deleteMailbox(email) {
            if (!confirm(`Mailbox ${email} wirklich loeschen? Alle E-Mails gehen verloren!`)) return;
            try {
                await fetch(`${API_BASE}/mailcow/mailboxes/${email}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                loadMailboxes();
            } catch (error) {
                alert('Fehler beim Loeschen');
            }
        }

        function openNewAliasModal() {
            document.getElementById('alias-modal-title').textContent = 'Neuer Alias';
            document.getElementById('alias-edit-id').value = '';
            document.getElementById('alias-address').value = '';
            document.getElementById('alias-address').disabled = false;
            document.getElementById('alias-goto').value = '';
            document.getElementById('alias-active').checked = true;
            document.getElementById('alias-modal').classList.remove('hidden');
        }

        function editAlias(id, address, goto, active) {
            document.getElementById('alias-modal-title').textContent = 'Alias bearbeiten';
            document.getElementById('alias-edit-id').value = id;
            document.getElementById('alias-address').value = address.split('@')[0];
            document.getElementById('alias-address').disabled = true;
            document.getElementById('alias-goto').value = goto;
            document.getElementById('alias-active').checked = active == 1;
            document.getElementById('alias-modal').classList.remove('hidden');
        }

        async function saveAlias(e) {
            e.preventDefault();
            const editId = document.getElementById('alias-edit-id').value;
            const isEdit = !!editId;

            const data = {
                goto: document.getElementById('alias-goto').value,
                active: document.getElementById('alias-active').checked ? 1 : 0
            };

            if (!isEdit) {
                data.address = document.getElementById('alias-address').value;
            }

            try {
                const response = await fetch(`${API_BASE}/mailcow/aliases${isEdit ? '/' + editId : ''}`, {
                    method: isEdit ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Fehler beim Speichern');
                document.getElementById('alias-modal').classList.add('hidden');
                loadAliases();
            } catch (error) {
                alert('Fehler: ' + error.message);
            }
        }

        async function deleteAlias(id) {
            if (!confirm('Alias wirklich loeschen?')) return;
            try {
                await fetch(`${API_BASE}/mailcow/aliases/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                loadAliases();
            } catch (error) {
                alert('Fehler beim Loeschen');
            }
        }

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('vorstand_token');
            window.location.href = '/';
        });

        // ============================================
        // INITIALIZE
        // ============================================

        (async () => {
            if (await checkAuth()) {
                await loadStats();
                await loadMembers();
                loadRegistrationCount(); // Load badge count for pending registrations
            }
        })();
    </script>
</body>
</html>
