<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mein Portal - Feuerwehrverein Raura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fire: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#dc2626',
                            600: '#b91c1c',
                            700: '#991b1b',
                            800: '#7f1d1d'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-fire-700 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <h1 class="text-xl font-bold">Mein Portal</h1>
                <div class="flex space-x-4 items-center">
                    <span id="user-name" class="text-sm">Laden...</span>
                    <a href="index.html" class="hover:text-fire-200 transition-colors">Website</a>
                    <a href="events.html" class="hover:text-fire-200 transition-colors">Veranstaltungen</a>
                    <button id="logout-btn" class="hover:text-fire-200 transition-colors">Abmelden</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Tabs -->
    <section class="bg-white border-b">
        <div class="container mx-auto px-4">
            <div class="flex space-x-8 border-b">
                <button id="tab-profile" class="tab-btn py-4 px-2 font-semibold border-b-2 border-fire-500 text-fire-600">
                    Mein Profil
                </button>
                <button id="tab-notifications" class="tab-btn py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                    Benachrichtigungen
                </button>
                <button id="tab-events" class="tab-btn py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                    Meine Events
                </button>
            </div>
        </div>
    </section>

    <!-- Profile Section -->
    <div id="profile-section">
        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="max-w-3xl mx-auto">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Persönliche Daten</h2>

                        <form id="profile-form" class="space-y-6">
                            <!-- Profilfoto -->
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-3">Profilfoto</h3>
                                <div class="flex items-center space-x-4">
                                    <div id="my-photo-preview" class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                                        <span class="text-gray-400 text-3xl">?</span>
                                    </div>
                                    <div class="flex-1">
                                        <input type="file" id="my-photo-upload" accept="image/*" class="hidden">
                                        <button type="button" id="my-photo-upload-btn" class="px-4 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">
                                            Foto hochladen
                                        </button>
                                        <button type="button" id="my-photo-delete-btn" class="ml-2 px-4 py-2 text-red-600 hover:text-red-800 hidden">
                                            Foto entfernen
                                        </button>
                                        <p class="text-sm text-gray-500 mt-1">Max. 5MB, JPG/PNG/GIF</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Persönliche Daten (read-only) -->
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-3">Stammdaten</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Vorname</label>
                                        <input type="text" id="profile-vorname" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nachname</label>
                                        <input type="text" id="profile-nachname" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Funktion</label>
                                        <input type="text" id="profile-funktion" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                        <input type="text" id="profile-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                    </div>
                                </div>
                            </div>

                            <!-- Kontaktdaten (editable) -->
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-3">Kontaktdaten</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Telefon</label>
                                        <input type="tel" id="profile-telefon" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Mobile</label>
                                        <input type="tel" id="profile-mobile" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">E-Mail</label>
                                        <input type="email" id="profile-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    </div>
                                </div>
                            </div>

                            <!-- Adresse (editable) -->
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-3">Adresse</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Strasse</label>
                                        <input type="text" id="profile-strasse" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">PLZ</label>
                                        <input type="text" id="profile-plz" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ort</label>
                                        <input type="text" id="profile-ort" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    </div>
                                </div>
                            </div>

                            <!-- Bankdaten (editable) -->
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-3">Bankverbindung</h3>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">IBAN</label>
                                    <input type="text" id="profile-iban" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                </div>
                            </div>

                            <!-- Buttons -->
                            <div class="flex justify-end pt-4 border-t">
                                <button type="submit" class="px-6 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">
                                    Speichern
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Funktions-E-Mail Sektion (nur sichtbar wenn Funktion vorhanden) -->
                    <div id="function-email-section" class="bg-white rounded-lg shadow p-6 mt-6 hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Funktions-E-Mails</h2>

                        <!-- Container für mehrere Funktions-Emails -->
                        <div id="function-emails-container" class="space-y-4 mb-6">
                            <!-- Wird dynamisch gefüllt -->
                        </div>

                        <div class="space-y-4">
                            <h3 class="font-semibold text-gray-700">Zugangsdaten</h3>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">IMAP/SMTP Server</label>
                                    <div class="flex">
                                        <input type="text" value="mail.test.juroct.net" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg bg-gray-50" readonly>
                                        <button onclick="copyToClipboard('mail.test.juroct.net')" class="px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg hover:bg-gray-200" title="Kopieren">
                                            <span class="text-gray-600">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Benutzername</label>
                                    <div class="flex">
                                        <input type="text" id="function-email-username" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg bg-gray-50" readonly>
                                        <button id="copy-email-btn" class="px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg hover:bg-gray-200" title="Kopieren">
                                            <span class="text-gray-600">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">IMAP Port</label>
                                    <input type="text" value="993 (SSL/TLS)" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">SMTP Port</label>
                                    <input type="text" value="587 (STARTTLS)" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                </div>
                            </div>

                            <!-- Webmail Link -->
                            <div class="pt-4 border-t">
                                <a href="https://mail.test.juroct.net" target="_blank"
                                   class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                    Webmail öffnen
                                </a>
                            </div>
                        </div>

                        <!-- Passwort ändern -->
                        <div class="mt-6 pt-6 border-t">
                            <h3 class="font-semibold text-gray-700 mb-4">Passwort ändern</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Neues Passwort</label>
                                    <input type="password" id="function-email-password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500" placeholder="Mindestens 8 Zeichen">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Passwort bestätigen</label>
                                    <input type="password" id="function-email-password-confirm" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500" placeholder="Passwort wiederholen">
                                </div>
                                <div class="flex justify-end">
                                    <button id="change-email-password-btn" class="px-6 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600 transition-colors">
                                        Passwort ändern
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Notifications Section -->
    <div id="notifications-section" class="hidden">
        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="max-w-3xl mx-auto">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Benachrichtigungseinstellungen</h2>
                        <p class="text-gray-600 mb-6">Verwalten Sie Ihre E-Mail-Benachrichtigungen. Sie können für jeden Typ eine alternative E-Mail-Adresse angeben.</p>

                        <div id="notifications-list" class="space-y-6">
                            <!-- Will be populated by JavaScript -->
                        </div>

                        <div class="flex justify-end pt-6 border-t mt-6">
                            <button id="save-notifications-btn" class="px-6 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">
                                Einstellungen speichern
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Events Section -->
    <div id="events-section" class="hidden">
        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Meine Veranstaltungen</h2>

                        <div id="my-events-list" class="space-y-4">
                            <!-- Will be populated by JavaScript -->
                        </div>

                        <!-- Loading State -->
                        <div id="events-loading" class="text-center py-8">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                            <p class="mt-4 text-gray-600">Lade Events...</p>
                        </div>

                        <!-- Empty State -->
                        <div id="events-empty" class="text-center py-8 hidden">
                            <p class="text-gray-600">Sie sind für keine Veranstaltungen angemeldet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        const API_BASE = 'https://api.fwv-raura.ch';
        const AUTHENTIK_URL = 'https://auth.fwv-raura.ch';
        const CLIENT_ID = 'fwv-members';
        const REDIRECT_URI = window.location.origin + '/auth-callback.html';

        let authToken = null;
        let currentTab = 'profile';
        let memberData = null;
        let notifications = [];

        // Mapping von Funktionen zu E-Mail-Adressen
        const FUNCTION_EMAIL_MAP = {
            'Präsident': 'praesident@fwv-raura.ch',
            'Praesident': 'praesident@fwv-raura.ch',
            'Aktuar': 'aktuar@fwv-raura.ch',
            'Kassier': 'kassier@fwv-raura.ch',
            'Beisitzer': 'beisitzer@fwv-raura.ch',
            'Beisitzerin': 'beisitzer@fwv-raura.ch',
            'Materialwart': 'materialwart@fwv-raura.ch',
            'Admin': 'admin@fwv-raura.ch',
            'Social Media': 'social-media@fwv-raura.ch'
        };

        // Redirect to Authentik login
        function redirectToLogin() {
            localStorage.removeItem('auth_token');
            const state = encodeURIComponent(window.location.pathname);
            window.location.href = `${AUTHENTIK_URL}/application/o/authorize/?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&scope=openid%20profile%20email&state=${state}`;
        }

        // Check authentication
        async function checkAuth() {
            // Check for token in URL (from callback)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('token')) {
                authToken = urlParams.get('token');
                localStorage.setItem('auth_token', authToken);
                // Remove token from URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                authToken = localStorage.getItem('auth_token');
            }

            if (!authToken) {
                redirectToLogin();
                return false;
            }

            // Validate token by making a test API call
            try {
                const response = await fetch(`${API_BASE}/members/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.status === 401 || response.status === 403) {
                    console.log('Token invalid or expired, redirecting to login');
                    redirectToLogin();
                    return false;
                }

                if (response.ok) {
                    // Token is valid, store the member data
                    memberData = await response.json();
                    document.getElementById('user-name').textContent = `${memberData.vorname} ${memberData.nachname}`;
                    return true;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                redirectToLogin();
                return false;
            }

            return true;
        }

        // Load member profile
        async function loadProfile() {
            try {
                // If memberData wasn't loaded in checkAuth, load it now
                if (!memberData) {
                    const response = await fetch(`${API_BASE}/members/me`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    if (response.status === 401 || response.status === 403) {
                        redirectToLogin();
                        return;
                    }

                    if (!response.ok) throw new Error('Failed to load profile');

                    memberData = await response.json();
                    document.getElementById('user-name').textContent = `${memberData.vorname} ${memberData.nachname}`;
                }

                // Populate form
                document.getElementById('profile-vorname').value = memberData.vorname || '';
                document.getElementById('profile-nachname').value = memberData.nachname || '';
                document.getElementById('profile-funktion').value = memberData.funktion || '-';
                document.getElementById('profile-status').value = memberData.status || 'Aktivmitglied';
                document.getElementById('profile-telefon').value = memberData.telefon || '';
                document.getElementById('profile-mobile').value = memberData.mobile || '';
                document.getElementById('profile-email').value = memberData.email || '';
                document.getElementById('profile-strasse').value = memberData.strasse || '';
                document.getElementById('profile-plz').value = memberData.plz || '';
                document.getElementById('profile-ort').value = memberData.ort || '';
                document.getElementById('profile-iban').value = memberData.iban || '';

                // Load photo
                if (memberData.foto) {
                    document.getElementById('my-photo-preview').innerHTML = `<img src="${API_BASE}${memberData.foto}" class="w-full h-full object-cover">`;
                    document.getElementById('my-photo-delete-btn').classList.remove('hidden');
                } else {
                    document.getElementById('my-photo-preview').innerHTML = '<span class="text-gray-400 text-3xl">?</span>';
                    document.getElementById('my-photo-delete-btn').classList.add('hidden');
                }

                // Show function email section if member has a function
                showFunctionEmailSection(memberData.funktion);

            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Fehler beim Laden des Profils');
            }
        }

        // Show function email section if member has function(s) with email
        function showFunctionEmailSection(funktion) {
            const section = document.getElementById('function-email-section');
            const container = document.getElementById('function-emails-container');

            if (!funktion) {
                section.classList.add('hidden');
                return;
            }

            // Parse multiple functions (comma-separated)
            const funktionen = funktion.split(',').map(f => f.trim()).filter(f => f);
            const emailEntries = [];

            funktionen.forEach(f => {
                if (FUNCTION_EMAIL_MAP[f]) {
                    emailEntries.push({ funktion: f, email: FUNCTION_EMAIL_MAP[f] });
                }
            });

            if (emailEntries.length === 0) {
                section.classList.add('hidden');
                return;
            }

            // Build HTML for each function email
            container.innerHTML = emailEntries.map((entry, index) => `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="text-blue-500 text-2xl">@</div>
                        <div class="flex-1">
                            <p class="text-sm text-blue-800 mb-1">Als <strong>${entry.funktion}</strong> hast du Zugang zu:</p>
                            <div class="flex items-center gap-2">
                                <p class="text-lg font-mono font-semibold text-blue-900">${entry.email}</p>
                                <button onclick="copyToClipboard('${entry.email}')" class="p-1 hover:bg-blue-100 rounded" title="Kopieren">
                                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Update the username field with first email (for password change)
            document.getElementById('function-email-username').value = emailEntries[0].email;

            section.classList.remove('hidden');
        }

        // Copy text to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show brief feedback
                const originalText = event.currentTarget.innerHTML;
                event.currentTarget.innerHTML = '<span class="text-green-600">✓</span>';
                setTimeout(() => {
                    event.currentTarget.innerHTML = originalText;
                }, 1000);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Kopieren fehlgeschlagen');
            });
        }

        // Change function email password
        async function changeFunctionEmailPassword() {
            const password = document.getElementById('function-email-password').value;
            const confirmPassword = document.getElementById('function-email-password-confirm').value;

            if (!password || password.length < 8) {
                alert('Das Passwort muss mindestens 8 Zeichen lang sein.');
                return;
            }

            if (password !== confirmPassword) {
                alert('Die Passwörter stimmen nicht überein.');
                return;
            }

            const btn = document.getElementById('change-email-password-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Wird geändert...';

            try {
                // Use secure members API endpoint that validates function ownership
                const response = await fetch(`${API_BASE}/members/me/function-email-password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ password })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                alert('Passwort erfolgreich geändert!');
                document.getElementById('function-email-password').value = '';
                document.getElementById('function-email-password-confirm').value = '';

            } catch (error) {
                console.error('Error changing password:', error);
                alert('Fehler beim Ändern des Passworts: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Save profile
        async function saveProfile(e) {
            e.preventDefault();

            try {
                const data = {
                    telefon: document.getElementById('profile-telefon').value,
                    mobile: document.getElementById('profile-mobile').value,
                    email: document.getElementById('profile-email').value,
                    strasse: document.getElementById('profile-strasse').value,
                    plz: document.getElementById('profile-plz').value,
                    ort: document.getElementById('profile-ort').value,
                    iban: document.getElementById('profile-iban').value
                };

                console.log('Saving profile data:', data);

                const response = await fetch(`${API_BASE}/members/me`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Save profile failed:', response.status, errorData);
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                alert('Profil erfolgreich gespeichert!');
                await loadProfile();

            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Fehler beim Speichern des Profils: ' + error.message);
            }
        }

        // Load notification preferences
        async function loadNotifications() {
            try {
                const response = await fetch(`${API_BASE}/members/me/notifications`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    console.log('No notifications found, using defaults');
                    notifications = [];
                } else {
                    notifications = await response.json();
                }

                renderNotifications();

            } catch (error) {
                console.error('Error loading notifications:', error);
                // Show defaults even if API fails
                notifications = [];
                renderNotifications();
            }
        }

        // Render notification preferences
        function renderNotifications() {
            const container = document.getElementById('notifications-list');
            const notificationLabels = {
                'shift_reminder': 'Schicht-Erinnerungen',
                'event_update': 'Event-Updates',
                'newsletter': 'Newsletter',
                'general': 'Allgemeine Benachrichtigungen'
            };

            const notificationDescriptions = {
                'shift_reminder': 'Erinnerungen für anstehende Schichten',
                'event_update': 'Benachrichtigungen über Event-Änderungen',
                'newsletter': 'Monatlicher Newsletter',
                'general': 'Allgemeine Vereinsmitteilungen'
            };

            // Default notification types if none exist
            const defaultTypes = ['shift_reminder', 'event_update', 'newsletter', 'general'];

            // Use existing notifications or create defaults
            let displayNotifications = notifications;
            if (!notifications || notifications.length === 0) {
                displayNotifications = defaultTypes.map(type => ({
                    notification_type: type,
                    enabled: true,
                    alternative_email: null
                }));
            }

            container.innerHTML = displayNotifications.map(notif => `
                <div class="border border-gray-200 rounded-lg p-4" data-notification-type="${notif.notification_type}">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h4 class="font-semibold text-gray-800">${notificationLabels[notif.notification_type] || notif.notification_type}</h4>
                            <p class="text-sm text-gray-600">${notificationDescriptions[notif.notification_type] || ''}</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer notif-enabled" ${notif.enabled ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-fire-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-fire-600"></div>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Alternative E-Mail (optional)</label>
                        <input type="email" class="notif-alt-email w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500"
                               value="${notif.alternative_email || ''}"
                               placeholder="Leer = Standard E-Mail verwenden">
                    </div>
                </div>
            `).join('');
        }

        // Save notification preferences
        async function saveNotifications() {
            try {
                const notifElements = document.querySelectorAll('#notifications-list > div');
                const preferences = Array.from(notifElements).map(el => {
                    return {
                        notification_type: el.dataset.notificationType,
                        enabled: el.querySelector('.notif-enabled').checked,
                        alternative_email: el.querySelector('.notif-alt-email').value || null
                    };
                });

                console.log('Saving notification preferences:', preferences);

                const response = await fetch(`${API_BASE}/members/me/notifications`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ preferences })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Save notifications failed:', response.status, errorData);
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                alert('Benachrichtigungseinstellungen gespeichert!');
                await loadNotifications();

            } catch (error) {
                console.error('Error saving notifications:', error);
                alert('Fehler beim Speichern der Einstellungen: ' + error.message);
            }
        }

        // Load my events
        async function loadMyEvents() {
            try {
                document.getElementById('events-loading').classList.remove('hidden');
                document.getElementById('events-empty').classList.add('hidden');
                document.getElementById('my-events-list').innerHTML = '';

                // Check if memberData is loaded
                if (!memberData || !memberData.id) {
                    console.log('memberData not yet loaded, showing empty state');
                    document.getElementById('events-loading').classList.add('hidden');
                    document.getElementById('events-empty').classList.remove('hidden');
                    return;
                }

                const response = await fetch(`${API_BASE}/registrations?member_id=${memberData.id}&include_guest_email=true`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    // If 404 or other error, show empty state instead of error
                    console.log('No registrations found or API error');
                    document.getElementById('events-empty').classList.remove('hidden');
                    return;
                }

                const registrations = await response.json();
                renderMyEvents(registrations);

            } catch (error) {
                console.error('Error loading events:', error);
                // Show empty state instead of error message
                document.getElementById('events-empty').classList.remove('hidden');
            } finally {
                document.getElementById('events-loading').classList.add('hidden');
            }
        }

        // Render my events
        function renderMyEvents(registrations) {
            const container = document.getElementById('my-events-list');

            if (registrations.length === 0) {
                container.innerHTML = '';
                document.getElementById('events-empty').classList.remove('hidden');
                return;
            }

            document.getElementById('events-empty').classList.add('hidden');

            container.innerHTML = registrations.map(reg => {
                // Schichten formatieren
                let shiftsHtml = '';
                if (reg.shifts && reg.shifts.length > 0) {
                    shiftsHtml = `
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <p class="text-xs font-medium text-gray-500 mb-2">Deine Schichten:</p>
                            <div class="space-y-1">
                                ${reg.shifts.map(shift => {
                                    const date = shift.date ? new Date(shift.date).toLocaleDateString('de-CH', { weekday: 'short', day: 'numeric', month: 'short' }) : '';
                                    const time = shift.start_time && shift.end_time ? `${shift.start_time.substring(0,5)} - ${shift.end_time.substring(0,5)}` : '';
                                    return `
                                        <div class="text-sm text-gray-600 bg-gray-50 px-2 py-1 rounded">
                                            <span class="font-medium">${shift.name}</span>
                                            ${date ? `<span class="text-gray-500 ml-2">${date}</span>` : ''}
                                            ${time ? `<span class="text-gray-500 ml-1">(${time})</span>` : ''}
                                            ${shift.bereich ? `<span class="text-xs text-gray-400 ml-2">${shift.bereich}</span>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                } else if (!reg.shift_ids || reg.shift_ids.length === 0) {
                    // Teilnehmer-Registrierung (ohne Schichten)
                    shiftsHtml = `
                        <p class="text-sm text-gray-500 mt-2">Teilnehmer-Anmeldung</p>
                    `;
                }

                return `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">${reg.event_title}</h4>
                                <p class="text-sm text-gray-600 mt-1">
                                    Status: <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusClass(reg.status)}">${getStatusLabel(reg.status)}</span>
                                </p>
                                ${shiftsHtml}
                            </div>
                            <span class="text-xs text-gray-500 whitespace-nowrap ml-4">${new Date(reg.created_at).toLocaleDateString('de-CH')}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusClass(status) {
            const classes = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'approved': 'bg-green-100 text-green-800',
                'confirmed': 'bg-green-100 text-green-800',
                'rejected': 'bg-red-100 text-red-800',
                'cancelled': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'Ausstehend',
                'approved': 'Bestätigt',
                'confirmed': 'Bestätigt',
                'rejected': 'Abgelehnt',
                'cancelled': 'Abgesagt'
            };
            return labels[status] || status;
        }

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-fire-500', 'text-fire-600');
                btn.classList.add('border-transparent', 'text-gray-600');
            });

            // Hide all sections
            document.getElementById('profile-section').classList.add('hidden');
            document.getElementById('notifications-section').classList.add('hidden');
            document.getElementById('events-section').classList.add('hidden');

            // Show selected section
            if (tab === 'profile') {
                document.getElementById('tab-profile').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('tab-profile').classList.remove('border-transparent', 'text-gray-600');
                document.getElementById('profile-section').classList.remove('hidden');
            } else if (tab === 'notifications') {
                document.getElementById('tab-notifications').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('tab-notifications').classList.remove('border-transparent', 'text-gray-600');
                document.getElementById('notifications-section').classList.remove('hidden');
                if (notifications.length === 0) loadNotifications();
            } else if (tab === 'events') {
                document.getElementById('tab-events').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('tab-events').classList.remove('border-transparent', 'text-gray-600');
                document.getElementById('events-section').classList.remove('hidden');
                loadMyEvents();
            }
        }

        // Upload my photo
        async function uploadMyPhoto(file) {
            try {
                const formData = new FormData();
                formData.append('photo', file);

                const response = await fetch(`${API_BASE}/members/me/photo`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Upload fehlgeschlagen');
                }

                const data = await response.json();
                memberData.foto = data.foto;

                // Update preview
                document.getElementById('my-photo-preview').innerHTML = `<img src="${API_BASE}${data.foto}" class="w-full h-full object-cover">`;
                document.getElementById('my-photo-delete-btn').classList.remove('hidden');

                alert('Foto erfolgreich hochgeladen!');
            } catch (error) {
                console.error('Error uploading photo:', error);
                alert('Fehler beim Hochladen: ' + error.message);
            }
        }

        // Delete my photo
        async function deleteMyPhoto() {
            if (!confirm('Möchten Sie Ihr Profilfoto wirklich entfernen?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/members/me/photo`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Löschen fehlgeschlagen');
                }

                memberData.foto = null;

                // Update preview
                document.getElementById('my-photo-preview').innerHTML = '<span class="text-gray-400 text-3xl">?</span>';
                document.getElementById('my-photo-delete-btn').classList.add('hidden');

                alert('Foto erfolgreich entfernt!');
            } catch (error) {
                console.error('Error deleting photo:', error);
                alert('Fehler beim Löschen: ' + error.message);
            }
        }

        // Event listeners
        document.getElementById('profile-form').addEventListener('submit', saveProfile);
        document.getElementById('save-notifications-btn').addEventListener('click', saveNotifications);

        document.getElementById('tab-profile').addEventListener('click', () => switchTab('profile'));
        document.getElementById('tab-notifications').addEventListener('click', () => switchTab('notifications'));
        document.getElementById('tab-events').addEventListener('click', () => switchTab('events'));

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('auth_token');
            window.location.href = '/';
        });

        // Photo upload event listeners
        document.getElementById('my-photo-upload-btn').addEventListener('click', () => {
            document.getElementById('my-photo-upload').click();
        });

        document.getElementById('my-photo-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('Die Datei ist zu gross. Maximal 5MB erlaubt.');
                    return;
                }
                uploadMyPhoto(file);
            }
        });

        document.getElementById('my-photo-delete-btn').addEventListener('click', deleteMyPhoto);

        // Function email event listeners
        document.getElementById('copy-email-btn').addEventListener('click', (e) => {
            const email = document.getElementById('function-email-username').value;
            copyToClipboard(email);
        });

        document.getElementById('change-email-password-btn').addEventListener('click', changeFunctionEmailPassword);

        // Initialize
        (async () => {
            if (await checkAuth()) {
                await loadProfile();
            }
        })();
    </script>
</body>
</html>
