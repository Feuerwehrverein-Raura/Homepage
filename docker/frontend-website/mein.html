<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mein Portal - Feuerwehrverein Raura</title>
    <!-- DEUTSCH: Tailwind CSS wird ueber CDN geladen fuer Utility-First-Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- DEUTSCH: Tailwind-Konfiguration mit benutzerdefinierten Feuerwehr-Rot-Farben (fire-50 bis fire-800) -->
    <script>
        // DEUTSCH: Erweitert die Standard-Tailwind-Farbpalette um die "fire"-Farbabstufungen
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fire: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#dc2626',
                            600: '#b91c1c',
                            700: '#991b1b',
                            800: '#7f1d1d'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <!-- DEUTSCH: Obere Navigationsleiste mit Benutzername, Links zur Website/Events und Abmelde-Button -->
    <nav class="bg-fire-700 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <h1 class="text-xl font-bold">Mein Portal</h1>
                <div class="flex space-x-4 items-center">
                    <!-- DEUTSCH: Benutzername wird nach Authentifizierung dynamisch eingesetzt -->
                    <span id="user-name" class="text-sm">Laden...</span>
                    <a href="index.html" class="hover:text-fire-200 transition-colors">Website</a>
                    <a href="events.html" class="hover:text-fire-200 transition-colors">Veranstaltungen</a>
                    <!-- DEUTSCH: Logout loescht Token und leitet zur Authentik End-Session-URL weiter -->
                    <button id="logout-btn" class="hover:text-fire-200 transition-colors">Abmelden</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- DEUTSCH: Tab-Navigation mit 4 Bereichen: Profil, Benachrichtigungen, Events, Zugaenge.
         Der aktive Tab erhaelt eine rote Unterstreichung (border-fire-500). -->
    <section class="bg-white border-b">
        <div class="container mx-auto px-4">
            <div class="flex space-x-8 border-b">
                <!-- DEUTSCH: Profil-Tab ist standardmaessig aktiv (border-fire-500 gesetzt) -->
                <button id="tab-profile" class="tab-btn py-4 px-2 font-semibold border-b-2 border-fire-500 text-fire-600">
                    Mein Profil
                </button>
                <button id="tab-notifications" class="tab-btn py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                    Benachrichtigungen
                </button>
                <button id="tab-events" class="tab-btn py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                    Meine Events
                </button>
                <button id="tab-accesses" class="tab-btn py-4 px-2 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                    Zugänge
                </button>
            </div>
        </div>
    </section>

    <!-- DEUTSCH: Profil-Sektion - Hauptbereich mit Profilfoto, Stammdaten, Kontaktdaten, Adresse und Bankverbindung.
         Stammdaten sind nur lesbar (readonly), Kontakt/Adresse/Bank sind editierbar. -->
    <div id="profile-section">
        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="max-w-3xl mx-auto">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Persönliche Daten</h2>

                        <form id="profile-form" class="space-y-6">
                            <!-- DEUTSCH: Profilfoto-Bereich mit Vorschau (runder Avatar), Upload-Button und Loeschen-Button.
                                 Das versteckte File-Input wird per Klick auf den Button ausgeloest.
                                 Maximale Dateigroesse: 5MB, erlaubte Formate: JPG/PNG/GIF. -->
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-3">Profilfoto</h3>
                                <div class="flex items-center space-x-4">
                                    <!-- DEUTSCH: Runde Vorschau des aktuellen Profilfotos (oder Fragezeichen-Platzhalter) -->
                                    <div id="my-photo-preview" class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                                        <span class="text-gray-400 text-3xl">?</span>
                                    </div>
                                    <div class="flex-1">
                                        <!-- DEUTSCH: Verstecktes File-Input, wird durch den Upload-Button getriggert -->
                                        <input type="file" id="my-photo-upload" accept="image/*" class="hidden">
                                        <button type="button" id="my-photo-upload-btn" class="px-4 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">
                                            Foto hochladen
                                        </button>
                                        <!-- DEUTSCH: Loeschen-Button ist standardmaessig versteckt, erscheint nur wenn ein Foto existiert -->
                                        <button type="button" id="my-photo-delete-btn" class="ml-2 px-4 py-2 text-red-600 hover:text-red-800 hidden">
                                            Foto entfernen
                                        </button>
                                        <p class="text-sm text-gray-500 mt-1">Max. 5MB, JPG/PNG/GIF</p>
                                    </div>
                                </div>
                            </div>

                            <!-- DEUTSCH: Stammdaten (Vorname, Nachname, Funktion, Status) - readonly-Felder,
                                 werden vom Vorstand gepflegt und koennen vom Mitglied nicht geaendert werden -->
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-3">Stammdaten</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Vorname</label>
                                        <input type="text" id="profile-vorname" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nachname</label>
                                        <input type="text" id="profile-nachname" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Funktion</label>
                                        <input type="text" id="profile-funktion" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                        <input type="text" id="profile-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                                    </div>
                                </div>
                            </div>

                            <!-- DEUTSCH: Kontaktdaten (Telefon, Mobile, E-Mail) - vom Mitglied selbst editierbar -->
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-3">Kontaktdaten</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Telefon</label>
                                        <input type="tel" id="profile-telefon" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Mobile</label>
                                        <input type="tel" id="profile-mobile" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">E-Mail</label>
                                        <input type="email" id="profile-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    </div>
                                </div>
                            </div>

                            <!-- DEUTSCH: Adresse (Strasse, PLZ, Ort) - vom Mitglied selbst editierbar -->
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-3">Adresse</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Strasse</label>
                                        <input type="text" id="profile-strasse" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">PLZ</label>
                                        <input type="text" id="profile-plz" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ort</label>
                                        <input type="text" id="profile-ort" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                    </div>
                                </div>
                            </div>

                            <!-- DEUTSCH: Bankverbindung (IBAN) - vom Mitglied selbst editierbar, wird fuer Rueckerstattungen benoetigt -->
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-3">Bankverbindung</h3>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">IBAN</label>
                                    <input type="text" id="profile-iban" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500">
                                </div>
                            </div>

                            <!-- DEUTSCH: Speichern-Button sendet das Formular ab (PUT /members/me) -->
                            <div class="flex justify-end pt-4 border-t">
                                <button type="submit" class="px-6 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">
                                    Speichern
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- DEUTSCH: Funktions-E-Mail-Sektion - nur sichtbar wenn das Mitglied eine Vorstandsfunktion hat.
                         Zeigt fuer jede Funktion (z.B. Praesident, Aktuar) die zugehoerige E-Mail-Adresse,
                         Mailserver-Zugangsdaten (IMAP/SMTP) und eine Passwort-Aendern-Moeglichkeit. -->
                    <div id="function-email-section" class="bg-white rounded-lg shadow p-6 mt-6 hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Funktions-E-Mails</h2>

                        <!-- DEUTSCH: Container fuer die dynamisch erzeugten Funktions-E-Mail-Karten.
                             Fuer jede Funktion wird eine Karte mit E-Mail, Passwort-Aendern-Formular generiert. -->
                        <div id="function-emails-container" class="space-y-6">
                            <!-- DEUTSCH: Wird dynamisch durch showFunctionEmailSection() befuellt -->
                        </div>

                        <!-- DEUTSCH: Allgemeine Mailserver-Informationen fuer E-Mail-Client-Konfiguration -->
                        <div class="mt-6 pt-6 border-t">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">IMAP/SMTP Server</label>
                                    <div class="flex">
                                        <input type="text" value="mail.test.juroct.net" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg bg-gray-50" readonly>
                                        <button onclick="copyToClipboard('mail.test.juroct.net', this)" class="px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg hover:bg-gray-200" title="Kopieren">
                                            <span class="text-gray-600">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ports</label>
                                    <div class="text-sm text-gray-600">
                                        <p>IMAP: 993 (SSL/TLS)</p>
                                        <p>SMTP: 587 (STARTTLS)</p>
                                    </div>
                                </div>
                            </div>
                            <a href="https://mail.test.juroct.net" target="_blank"
                               class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                Webmail öffnen
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- DEUTSCH: Benachrichtigungen-Sektion - Hier kann das Mitglied 4 Benachrichtigungstypen
         (Schicht-Erinnerungen, Event-Updates, Newsletter, Allgemein) ein-/ausschalten
         und optional eine alternative E-Mail-Adresse pro Typ angeben. -->
    <div id="notifications-section" class="hidden">
        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="max-w-3xl mx-auto">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Benachrichtigungseinstellungen</h2>
                        <p class="text-gray-600 mb-6">Verwalten Sie Ihre E-Mail-Benachrichtigungen. Sie können für jeden Typ eine alternative E-Mail-Adresse angeben.</p>

                        <!-- DEUTSCH: Wird durch renderNotifications() mit Toggle-Schaltern und E-Mail-Feldern befuellt -->
                        <div id="notifications-list" class="space-y-6">
                        </div>

                        <!-- DEUTSCH: Speichert alle Benachrichtigungs-Praeferenzen via PUT /members/me/notifications -->
                        <div class="flex justify-end pt-6 border-t mt-6">
                            <button id="save-notifications-btn" class="px-6 py-2 bg-fire-500 text-white rounded-lg hover:bg-fire-600">
                                Einstellungen speichern
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- DEUTSCH: Events-Sektion - Zeigt alle Veranstaltungen an, fuer die das Mitglied registriert ist.
         Pro Event werden Titel, Status (offen/bestaetigt/abgelehnt), Schichten und Anmeldedatum angezeigt. -->
    <div id="events-section" class="hidden">
        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Meine Veranstaltungen</h2>

                        <!-- DEUTSCH: Wird durch renderMyEvents() mit den Event-Registrierungen des Mitglieds befuellt -->
                        <div id="my-events-list" class="space-y-4">
                        </div>

                        <!-- DEUTSCH: Lade-Animation (Spinner) waehrend API-Aufruf laeuft -->
                        <div id="events-loading" class="text-center py-8">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                            <p class="mt-4 text-gray-600">Lade Events...</p>
                        </div>

                        <!-- DEUTSCH: Leerer Zustand wenn keine Registrierungen vorhanden sind -->
                        <div id="events-empty" class="text-center py-8 hidden">
                            <p class="text-gray-600">Sie sind für keine Veranstaltungen angemeldet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- DEUTSCH: Zugaenge-Sektion - Zeigt alle dem Mitglied zugewiesenen Zugaenge:
         1. Funktions-E-Mails mit Server-Infos und Passwort-Verwaltung
         2. Nextcloud Gruppenordner mit Direktlinks
         3. Events als Organisator mit Dashboard-Zugang
         4. System-Zugaenge (Website, Nextcloud, Vorstand-Portal, etc.) -->
    <div id="accesses-section" class="hidden">
        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="max-w-4xl mx-auto space-y-6">

                    <!-- DEUTSCH: Funktions-E-Mails mit IMAP/SMTP-Infos, Passwort und Webmail-Link -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-fire-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            Funktions-E-Mails
                        </h2>
                        <div id="function-emails-list" class="space-y-4">
                            <!-- Populated by JavaScript -->
                        </div>
                        <div id="no-function-emails" class="text-center py-4 text-gray-500 hidden">
                            Sie haben keine Funktions-E-Mail-Adressen.
                        </div>
                    </div>

                    <!-- DEUTSCH: Nextcloud Gruppenordner - Zeigt Ordner auf die das Mitglied Zugriff hat -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                            </svg>
                            Nextcloud Gruppenordner
                        </h2>
                        <div id="nextcloud-folders-list" class="space-y-3">
                            <!-- Populated by JavaScript -->
                        </div>
                        <div id="no-nextcloud-folders" class="text-center py-4 text-gray-500 hidden">
                            Keine Gruppenordner verfügbar.
                        </div>
                    </div>

                    <!-- DEUTSCH: Netzlaufwerk (SMB) - Zeigt SMB-Zugangsdaten basierend auf der Rolle des Mitglieds.
                         Passwoerter rotieren monatlich und bei Brute-Force-Erkennung. -->
                    <div id="smb-section" class="bg-white rounded-lg shadow p-6 hidden">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"/>
                            </svg>
                            Netzlaufwerk (SMB)
                        </h2>
                        <div id="smb-credentials" class="space-y-4">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- DEUTSCH: Service-Account Zugangsdaten - Generische Logins fuer Kasse/KDS/Bestell-App
                         Passwoerter rotieren automatisch alle 7 Tage. Sichtbar fuer alle Mitglieder. -->
                    <div id="service-accounts-section" class="bg-white rounded-lg shadow p-6 hidden">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-fire-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                            </svg>
                            Gemeinsame Zugänge
                        </h2>
                        <div id="service-accounts-list" class="space-y-4">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- DEUTSCH: Organisator-Events - Nur sichtbar wenn das Mitglied als Organisator fuer Events eingetragen ist.
                         Zeigt Event-Dashboard-Links und optionale Event-Zugangsdaten. -->
                    <div id="organizer-events-section" class="bg-white rounded-lg shadow p-6 hidden">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            Events als Organisator
                        </h2>
                        <div id="organizer-events-list" class="space-y-3">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- DEUTSCH: System-Zugaenge - Liste aller Systeme auf die das Mitglied Zugriff hat,
                         abhaengig von seiner Funktion (Mitglied, Vorstand, Kassier, Admin) -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                            </svg>
                            System-Zugänge
                        </h2>
                        <div id="system-accesses-list" class="space-y-2">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- DEUTSCH: Lade-Animation fuer den Zugaenge-Tab waehrend API-Aufruf -->
                    <div id="accesses-loading" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-fire-500"></div>
                        <p class="mt-4 text-gray-600">Lade Zugänge...</p>
                    </div>

                </div>
            </div>
        </section>
    </div>

    <script>
        // ============================================
        // DEUTSCH: GLOBALE KONSTANTEN UND VARIABLEN
        // ============================================

        // DEUTSCH: Basis-URL fuer alle API-Aufrufe zum Members-Backend
        const API_BASE = 'https://api.fwv-raura.ch';
        // DEUTSCH: URL der Authentik-Instanz fuer OIDC-Authentifizierung
        const AUTHENTIK_URL = 'https://auth.fwv-raura.ch';
        // DEUTSCH: OAuth2 Client-ID fuer die Mitglieder-Anwendung (in Authentik konfiguriert)
        const CLIENT_ID = 'fwv-members';
        // DEUTSCH: Callback-URL nach erfolgreichem Authentik-Login (auth-callback.html tauscht Code gegen Token)
        const REDIRECT_URI = window.location.origin + '/auth-callback.html';

        // DEUTSCH: Aktueller JWT-Token (RS256, von Authentik ausgestellt)
        let authToken = null;
        // DEUTSCH: Aktuell aktiver Tab (profile/notifications/events/accesses)
        let currentTab = 'profile';
        // DEUTSCH: Zwischengespeicherte Mitgliederdaten vom /members/me Endpunkt
        let memberData = null;
        // DEUTSCH: Zwischengespeicherte Benachrichtigungs-Praeferenzen
        let notifications = [];
        // DEUTSCH: Flag ob der Zugaenge-Tab bereits geladen wurde (verhindert doppeltes Laden)
        let accessesLoaded = false;

        // DEUTSCH: Zuordnung von Vereins-Funktionen zu den entsprechenden E-Mail-Adressen.
        // Beide Schreibweisen (Praesident/Praesident) werden unterstuetzt.
        // Beisitzer und Beisitzerin teilen sich dieselbe E-Mail-Adresse.
        const FUNCTION_EMAIL_MAP = {
            'Präsident': 'praesident@fwv-raura.ch',
            'Praesident': 'praesident@fwv-raura.ch',
            'Aktuar': 'aktuar@fwv-raura.ch',
            'Kassier': 'kassier@fwv-raura.ch',
            'Beisitzer': 'beisitzer@fwv-raura.ch',
            'Beisitzerin': 'beisitzer@fwv-raura.ch',
            'Materialwart': 'materialwart@fwv-raura.ch',
            'Admin': 'admin@fwv-raura.ch',
            'Social Media': 'social-media@fwv-raura.ch'
        };

        // ============================================
        // DEUTSCH: AUTHENTIFIZIERUNG (Authentik OIDC)
        // ============================================

        // DEUTSCH: Leitet den Benutzer zur Authentik OIDC Login-Seite weiter.
        // Der aktuelle Pfad wird als "state" mitgegeben, damit nach dem Login
        // zur urspruenglichen Seite zurueckgeleitet werden kann.
        function redirectToLogin() {
            localStorage.removeItem('auth_token');
            const state = encodeURIComponent(window.location.pathname);
            window.location.href = `${AUTHENTIK_URL}/application/o/authorize/?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&scope=openid%20profile%20email&state=${state}`;
        }

        // DEUTSCH: Prueft ob der Benutzer authentifiziert ist.
        // 1. Schaut ob ein Token als URL-Parameter vorhanden ist (kommt vom auth-callback.html nach OIDC-Login)
        // 2. Falls nicht, liest den Token aus dem localStorage
        // 3. Validiert den Token durch einen API-Aufruf an /members/me
        // 4. Bei ungueltigem Token wird zum Login weitergeleitet
        async function checkAuth() {
            // DEUTSCH: Token aus URL-Parameter lesen (nach OIDC-Callback) und in localStorage speichern
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('token')) {
                authToken = urlParams.get('token');
                localStorage.setItem('auth_token', authToken);
                // DEUTSCH: Token aus der URL entfernen, damit er nicht in der Browser-History bleibt
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                authToken = localStorage.getItem('auth_token');
            }

            // DEUTSCH: Ohne Token direkt zum Login weiterleiten
            if (!authToken) {
                redirectToLogin();
                return false;
            }

            // DEUTSCH: Token-Validierung durch API-Aufruf - gleichzeitig werden die Mitgliederdaten geladen
            try {
                const response = await fetch(`${API_BASE}/members/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.status === 401 || response.status === 403) {
                    console.log('Token invalid or expired, redirecting to login');
                    redirectToLogin();
                    return false;
                }

                if (response.ok) {
                    // DEUTSCH: Token gueltig - Mitgliederdaten zwischenspeichern und Benutzername in der Navigation anzeigen
                    memberData = await response.json();
                    document.getElementById('user-name').textContent = `${memberData.vorname} ${memberData.nachname}`;
                    return true;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                redirectToLogin();
                return false;
            }

            return true;
        }

        // ============================================
        // DEUTSCH: PROFIL LADEN UND ANZEIGEN
        // ============================================

        // DEUTSCH: Laedt die Profildaten des eingeloggten Mitglieds und befuellt das Formular.
        // Falls memberData bereits durch checkAuth() geladen wurde, wird kein erneuter API-Aufruf gemacht.
        // Befuellt alle Formularfelder, zeigt das Profilfoto an und prueft ob Funktions-E-Mails angezeigt werden muessen.
        async function loadProfile() {
            try {
                // DEUTSCH: Nur API aufrufen wenn memberData noch nicht vorhanden (Fallback-Fall)
                if (!memberData) {
                    const response = await fetch(`${API_BASE}/members/me`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    if (response.status === 401 || response.status === 403) {
                        redirectToLogin();
                        return;
                    }

                    if (!response.ok) throw new Error('Failed to load profile');

                    memberData = await response.json();
                    document.getElementById('user-name').textContent = `${memberData.vorname} ${memberData.nachname}`;
                }

                // DEUTSCH: Alle Formularfelder mit den Mitgliederdaten befuellen
                document.getElementById('profile-vorname').value = memberData.vorname || '';
                document.getElementById('profile-nachname').value = memberData.nachname || '';
                document.getElementById('profile-funktion').value = memberData.funktion || '-';
                document.getElementById('profile-status').value = memberData.status || 'Aktivmitglied';
                document.getElementById('profile-telefon').value = memberData.telefon || '';
                document.getElementById('profile-mobile').value = memberData.mobile || '';
                document.getElementById('profile-email').value = memberData.email || '';
                document.getElementById('profile-strasse').value = memberData.strasse || '';
                document.getElementById('profile-plz').value = memberData.plz || '';
                document.getElementById('profile-ort').value = memberData.ort || '';
                document.getElementById('profile-iban').value = memberData.iban || '';

                // DEUTSCH: Profilfoto anzeigen oder Platzhalter setzen, Loeschen-Button entsprechend ein-/ausblenden
                if (memberData.foto) {
                    document.getElementById('my-photo-preview').innerHTML = `<img src="${API_BASE}${memberData.foto}" class="w-full h-full object-cover">`;
                    document.getElementById('my-photo-delete-btn').classList.remove('hidden');
                } else {
                    document.getElementById('my-photo-preview').innerHTML = '<span class="text-gray-400 text-3xl">?</span>';
                    document.getElementById('my-photo-delete-btn').classList.add('hidden');
                }

                // DEUTSCH: Funktions-E-Mail-Sektion einblenden falls Mitglied eine Vorstandsfunktion hat
                showFunctionEmailSection(memberData.funktion);

            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Fehler beim Laden des Profils');
            }
        }

        // DEUTSCH: Zeigt die Funktions-E-Mail-Sektion im Profil-Tab an.
        // Parst das Funktionsfeld (kann kommagetrennt mehrere Funktionen enthalten, z.B. "Präsident, Admin")
        // und erzeugt fuer jede Funktion mit zugehoeriger E-Mail eine eigene Karte mit Passwort-Aendern-Formular.
        function showFunctionEmailSection(funktion) {
            const section = document.getElementById('function-email-section');
            const container = document.getElementById('function-emails-container');

            // DEUTSCH: Keine Funktion vorhanden - Sektion verstecken
            if (!funktion) {
                section.classList.add('hidden');
                return;
            }

            // DEUTSCH: Kommagetrennte Funktionen aufteilen und zu E-Mail-Eintraegen zuordnen
            const funktionen = funktion.split(',').map(f => f.trim()).filter(f => f);
            const emailEntries = [];

            funktionen.forEach(f => {
                if (FUNCTION_EMAIL_MAP[f]) {
                    emailEntries.push({ funktion: f, email: FUNCTION_EMAIL_MAP[f] });
                }
            });

            // DEUTSCH: Keine passende E-Mail gefunden - Sektion verstecken
            if (emailEntries.length === 0) {
                section.classList.add('hidden');
                return;
            }

            // DEUTSCH: Fuer jede Funktions-E-Mail eine Karte mit E-Mail-Anzeige, Kopieren-Button
            // und Passwort-Aendern-Formular (2 Felder: Neues Passwort + Bestätigung) generieren
            container.innerHTML = emailEntries.map((entry, index) => `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="text-blue-500 text-2xl">@</div>
                        <div class="flex-1">
                            <p class="text-sm text-blue-800 mb-1">Als <strong>${entry.funktion}</strong> hast du Zugang zu:</p>
                            <div class="flex items-center gap-2 mb-3">
                                <p class="text-lg font-mono font-semibold text-blue-900">${entry.email}</p>
                                <button onclick="copyToClipboard('${entry.email}', this)" class="p-1 hover:bg-blue-100 rounded" title="Kopieren">
                                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                </button>
                            </div>

                            <!-- Password change for this specific email -->
                            <div class="bg-white rounded-lg p-3 mt-2">
                                <p class="text-sm font-medium text-gray-700 mb-2">Passwort ändern für ${entry.email}</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                    <input type="password" id="password-${index}" class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500" placeholder="Neues Passwort">
                                    <input type="password" id="password-confirm-${index}" class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500" placeholder="Bestätigen">
                                </div>
                                <div class="flex justify-end mt-2">
                                    <button onclick="changeFunctionEmailPassword('${entry.email}', ${index})" class="px-4 py-1.5 text-sm bg-fire-500 text-white rounded-lg hover:bg-fire-600 transition-colors">
                                        Passwort ändern
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            section.classList.remove('hidden');
        }

        // ============================================
        // DEUTSCH: HILFSFUNKTIONEN (Profil-Tab)
        // ============================================

        // DEUTSCH: Kopiert den uebergebenen Text in die Zwischenablage (Profil-Tab Version mit Button-Feedback).
        // Zeigt fuer 1 Sekunde ein gruenes Haekchen im Button an, dann wird der urspruengliche Inhalt wiederhergestellt.
        function copyToClipboard(text, btn) {
            const originalHTML = btn.innerHTML;
            navigator.clipboard.writeText(text).then(() => {
                // DEUTSCH: Visuelles Feedback: Haekchen statt Icon fuer 1 Sekunde
                btn.innerHTML = '<span class="text-green-600">✓</span>';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                }, 1000);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Kopieren fehlgeschlagen');
            });
        }

        // DEUTSCH: Aendert das Passwort einer Funktions-E-Mail (Profil-Tab Version mit Formularfeldern).
        // Validiert Mindestlaenge (8 Zeichen) und Uebereinstimmung beider Passwort-Felder.
        // Sendet das neue Passwort an PUT /members/me/function-email-password.
        // Das Backend prueft ob das Mitglied tatsaechlich Zugriff auf diese E-Mail-Adresse hat.
        async function changeFunctionEmailPassword(email, index) {
            const password = document.getElementById(`password-${index}`).value;
            const confirmPassword = document.getElementById(`password-confirm-${index}`).value;

            // DEUTSCH: Validierung: Mindestens 8 Zeichen und Passwort-Bestaetigung muss uebereinstimmen
            if (!password || password.length < 8) {
                alert('Das Passwort muss mindestens 8 Zeichen lang sein.');
                return;
            }

            if (password !== confirmPassword) {
                alert('Die Passwörter stimmen nicht überein.');
                return;
            }

            // DEUTSCH: Button waehrend der Verarbeitung deaktivieren und Text aendern
            const btn = event.currentTarget;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Wird geändert...';

            try {
                // DEUTSCH: API-Aufruf zum Aendern des Mailcow-Passworts ueber das Members-Backend
                const response = await fetch(`${API_BASE}/members/me/function-email-password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ password, email })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                alert(`Passwort für ${email} erfolgreich geändert!`);
                // DEUTSCH: Passwort-Felder nach Erfolg leeren
                document.getElementById(`password-${index}`).value = '';
                document.getElementById(`password-confirm-${index}`).value = '';

            } catch (error) {
                console.error('Error changing password:', error);
                alert('Fehler beim Ändern des Passworts: ' + error.message);
            } finally {
                // DEUTSCH: Button wieder aktivieren und Originaltext wiederherstellen
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // DEUTSCH: Speichert die editierbaren Profildaten (Kontakt, Adresse, IBAN) via PUT /members/me.
        // Nur die editierbaren Felder werden gesendet - Stammdaten (Vorname, Nachname, Funktion, Status)
        // werden nicht mitgeschickt und koennen nur vom Vorstand geaendert werden.
        // Nach erfolgreichem Speichern wird das Profil neu geladen um die Anzeige zu aktualisieren.
        async function saveProfile(e) {
            e.preventDefault();

            try {
                // DEUTSCH: Nur editierbare Felder sammeln (keine readonly-Stammdaten)
                const data = {
                    telefon: document.getElementById('profile-telefon').value,
                    mobile: document.getElementById('profile-mobile').value,
                    email: document.getElementById('profile-email').value,
                    strasse: document.getElementById('profile-strasse').value,
                    plz: document.getElementById('profile-plz').value,
                    ort: document.getElementById('profile-ort').value,
                    iban: document.getElementById('profile-iban').value
                };

                console.log('Saving profile data:', data);

                const response = await fetch(`${API_BASE}/members/me`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Save profile failed:', response.status, errorData);
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                alert('Profil erfolgreich gespeichert!');
                // DEUTSCH: Profil neu laden um sicherzustellen dass die Anzeige aktuell ist
                await loadProfile();

            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Fehler beim Speichern des Profils: ' + error.message);
            }
        }

        // ============================================
        // DEUTSCH: BENACHRICHTIGUNGEN (Tab 2)
        // ============================================

        // DEUTSCH: Laedt die Benachrichtigungs-Praeferenzen des Mitglieds von GET /members/me/notifications.
        // Bei Fehler oder 404 werden Standard-Einstellungen (alle aktiviert) angezeigt.
        async function loadNotifications() {
            try {
                const response = await fetch(`${API_BASE}/members/me/notifications`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    console.log('No notifications found, using defaults');
                    notifications = [];
                } else {
                    notifications = await response.json();
                }

                renderNotifications();

            } catch (error) {
                console.error('Error loading notifications:', error);
                // DEUTSCH: Bei API-Fehler Standardwerte anzeigen damit die Seite trotzdem funktioniert
                notifications = [];
                renderNotifications();
            }
        }

        // DEUTSCH: Rendert die 4 Benachrichtigungstypen als Karten mit Toggle-Schalter und alternativer E-Mail.
        // Jeder Typ hat einen deutschen Titel und eine Beschreibung.
        // Falls keine bestehenden Praeferenzen vorhanden sind, werden alle Typen standardmaessig als aktiviert angezeigt.
        function renderNotifications() {
            const container = document.getElementById('notifications-list');
            // DEUTSCH: Deutsche Bezeichnungen fuer die Benachrichtigungstypen
            const notificationLabels = {
                'shift_reminder': 'Schicht-Erinnerungen',
                'event_update': 'Event-Updates',
                'newsletter': 'Newsletter',
                'general': 'Allgemeine Benachrichtigungen'
            };

            // DEUTSCH: Beschreibungen fuer die Benachrichtigungstypen
            const notificationDescriptions = {
                'shift_reminder': 'Erinnerungen für anstehende Schichten',
                'event_update': 'Benachrichtigungen über Event-Änderungen',
                'newsletter': 'Monatlicher Newsletter',
                'general': 'Allgemeine Vereinsmitteilungen'
            };

            // DEUTSCH: Standard-Benachrichtigungstypen falls noch keine Praeferenzen gespeichert wurden
            const defaultTypes = ['shift_reminder', 'event_update', 'newsletter', 'general'];

            // DEUTSCH: Bestehende Praeferenzen verwenden oder Standardwerte (alle aktiviert) erzeugen
            let displayNotifications = notifications;
            if (!notifications || notifications.length === 0) {
                displayNotifications = defaultTypes.map(type => ({
                    notification_type: type,
                    enabled: true,
                    alternative_email: null
                }));
            }

            // DEUTSCH: Fuer jeden Benachrichtigungstyp eine Karte mit Tailwind-Toggle-Schalter
            // und optionalem Feld fuer alternative E-Mail-Adresse rendern
            container.innerHTML = displayNotifications.map(notif => `
                <div class="border border-gray-200 rounded-lg p-4" data-notification-type="${notif.notification_type}">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h4 class="font-semibold text-gray-800">${notificationLabels[notif.notification_type] || notif.notification_type}</h4>
                            <p class="text-sm text-gray-600">${notificationDescriptions[notif.notification_type] || ''}</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer notif-enabled" ${notif.enabled ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-fire-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-fire-600"></div>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Alternative E-Mail (optional)</label>
                        <input type="email" class="notif-alt-email w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fire-500"
                               value="${notif.alternative_email || ''}"
                               placeholder="Leer = Standard E-Mail verwenden">
                    </div>
                </div>
            `).join('');
        }

        // DEUTSCH: Speichert alle Benachrichtigungs-Praeferenzen gesammelt via PUT /members/me/notifications.
        // Liest den aktuellen Zustand aller Toggle-Schalter und alternativen E-Mail-Felder aus dem DOM.
        // Nach erfolgreichem Speichern werden die Einstellungen neu geladen.
        async function saveNotifications() {
            try {
                // DEUTSCH: Alle Benachrichtigungs-Karten aus dem DOM lesen und Praeferenzen zusammenstellen
                const notifElements = document.querySelectorAll('#notifications-list > div');
                const preferences = Array.from(notifElements).map(el => {
                    return {
                        notification_type: el.dataset.notificationType,
                        enabled: el.querySelector('.notif-enabled').checked,
                        alternative_email: el.querySelector('.notif-alt-email').value || null
                    };
                });

                console.log('Saving notification preferences:', preferences);

                const response = await fetch(`${API_BASE}/members/me/notifications`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ preferences })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Save notifications failed:', response.status, errorData);
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                alert('Benachrichtigungseinstellungen gespeichert!');
                // DEUTSCH: Neu laden um gespeicherte Werte vom Server zu bestaetigen
                await loadNotifications();

            } catch (error) {
                console.error('Error saving notifications:', error);
                alert('Fehler beim Speichern der Einstellungen: ' + error.message);
            }
        }

        // ============================================
        // DEUTSCH: MEINE EVENTS (Tab 3)
        // ============================================

        // DEUTSCH: Laedt alle Event-Registrierungen des eingeloggten Mitglieds von GET /registrations.
        // Filtert nach der Mitglieder-ID und inkludiert Gast-E-Mail-Informationen.
        // Zeigt waehrend des Ladens einen Spinner an, danach die Events oder den Leer-Zustand.
        async function loadMyEvents() {
            try {
                document.getElementById('events-loading').classList.remove('hidden');
                document.getElementById('events-empty').classList.add('hidden');
                document.getElementById('my-events-list').innerHTML = '';

                // DEUTSCH: Sicherheitspruefung: memberData muss geladen sein bevor Registrierungen abgefragt werden
                if (!memberData || !memberData.id) {
                    console.log('memberData not yet loaded, showing empty state');
                    document.getElementById('events-loading').classList.add('hidden');
                    document.getElementById('events-empty').classList.remove('hidden');
                    return;
                }

                // DEUTSCH: Registrierungen fuer dieses Mitglied laden (member_id als Query-Parameter)
                const response = await fetch(`${API_BASE}/registrations?member_id=${memberData.id}&include_guest_email=true`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    // DEUTSCH: Bei Fehler leeren Zustand anzeigen statt Fehlermeldung
                    console.log('No registrations found or API error');
                    document.getElementById('events-empty').classList.remove('hidden');
                    return;
                }

                const registrations = await response.json();
                renderMyEvents(registrations);

            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('events-empty').classList.remove('hidden');
            } finally {
                // DEUTSCH: Spinner immer ausblenden, egal ob Erfolg oder Fehler
                document.getElementById('events-loading').classList.add('hidden');
            }
        }

        // DEUTSCH: Rendert die Event-Registrierungen des Mitglieds als Karten.
        // Pro Registrierung: Event-Titel, Status-Badge (farbcodiert), zugewiesene Schichten
        // (mit Datum, Uhrzeit, Bereich) und Anmeldedatum im Schweizer Format (dd.MM.yyyy).
        function renderMyEvents(registrations) {
            const container = document.getElementById('my-events-list');

            if (registrations.length === 0) {
                container.innerHTML = '';
                document.getElementById('events-empty').classList.remove('hidden');
                return;
            }

            document.getElementById('events-empty').classList.add('hidden');

            container.innerHTML = registrations.map(reg => {
                // DEUTSCH: Schichten als Sub-Liste formatieren (Name, Datum, Uhrzeit, Bereich)
                let shiftsHtml = '';
                if (reg.shifts && reg.shifts.length > 0) {
                    shiftsHtml = `
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <p class="text-xs font-medium text-gray-500 mb-2">Deine Schichten:</p>
                            <div class="space-y-1">
                                ${reg.shifts.map(shift => {
                                    const date = shift.date ? new Date(shift.date).toLocaleDateString('de-CH', { weekday: 'short', day: 'numeric', month: 'short' }) : '';
                                    const time = shift.start_time && shift.end_time ? `${shift.start_time.substring(0,5)} - ${shift.end_time.substring(0,5)}` : '';
                                    return `
                                        <div class="text-sm text-gray-600 bg-gray-50 px-2 py-1 rounded">
                                            <span class="font-medium">${shift.name}</span>
                                            ${date ? `<span class="text-gray-500 ml-2">${date}</span>` : ''}
                                            ${time ? `<span class="text-gray-500 ml-1">(${time})</span>` : ''}
                                            ${shift.bereich ? `<span class="text-xs text-gray-400 ml-2">${shift.bereich}</span>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                } else if (!reg.shift_ids || reg.shift_ids.length === 0) {
                    // DEUTSCH: Einfache Teilnehmer-Anmeldung ohne zugewiesene Schichten
                    shiftsHtml = `
                        <p class="text-sm text-gray-500 mt-2">Teilnehmer-Anmeldung</p>
                    `;
                }

                return `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">${reg.event_title}</h4>
                                <p class="text-sm text-gray-600 mt-1">
                                    Status: <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusClass(reg.status)}">${getStatusLabel(reg.status)}</span>
                                </p>
                                ${shiftsHtml}
                            </div>
                            <span class="text-xs text-gray-500 whitespace-nowrap ml-4">${new Date(reg.created_at).toLocaleDateString('de-CH')}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // DEUTSCH: Gibt die Tailwind-CSS-Klassen fuer das Status-Badge zurueck.
        // Gelb = offen, Gruen = bestaetigt, Rot = abgelehnt/abgesagt.
        function getStatusClass(status) {
            const classes = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'approved': 'bg-green-100 text-green-800',
                'confirmed': 'bg-green-100 text-green-800',
                'rejected': 'bg-red-100 text-red-800',
                'cancelled': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        // DEUTSCH: Uebersetzt den englischen Status-Wert in einen deutschen Anzeigetext
        function getStatusLabel(status) {
            const labels = {
                'pending': 'Offen',
                'approved': 'Bestätigt',
                'confirmed': 'Bestätigt',
                'rejected': 'Abgelehnt',
                'cancelled': 'Abgesagt'
            };
            return labels[status] || status;
        }

        // ============================================
        // DEUTSCH: ZUGAENGE (Tab 4) - Alle Zugriffe des Mitglieds
        // ============================================

        // DEUTSCH: Laedt alle Zugaenge des Mitglieds von GET /members/me/accesses.
        // Die API liefert 4 Bereiche: Funktions-E-Mails, Nextcloud-Ordner, Organisator-Events, System-Zugaenge.
        // Bei API-Fehler werden Fallback-Daten basierend auf den Profildaten des Mitglieds angezeigt.
        async function loadAccesses() {
            try {
                document.getElementById('accesses-loading').classList.remove('hidden');

                const response = await fetch(`${API_BASE}/members/me/accesses`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load accesses');
                }

                const data = await response.json();
                accessesLoaded = true;

                // DEUTSCH: Alle 6 Bereiche rendern mit den Daten aus der API
                renderFunctionEmails(data.functionEmails || []);
                renderNextcloudFolders(data.nextcloudFolders || []);
                renderSmbCredentials(data.smbCredentials || null);
                renderServiceAccounts(data.serviceAccounts || []);
                renderOrganizerEvents(data.organizerEvents || []);
                renderSystemAccesses(data.systemAccesses || []);

            } catch (error) {
                console.error('Error loading accesses:', error);
                accessesLoaded = true;

                // DEUTSCH: Fallback: Zugaenge aus den lokalen Profildaten ableiten statt leere Seite zu zeigen
                renderFunctionEmailsFromProfile();
                renderNextcloudFolders([]);
                renderSmbCredentials(null);
                renderServiceAccounts([]);
                renderOrganizerEvents([]);
                renderDefaultSystemAccesses();
            } finally {
                document.getElementById('accesses-loading').classList.add('hidden');
            }
        }

        // DEUTSCH: Fallback-Funktion: Erzeugt Funktions-E-Mail-Eintraege aus den lokalen Profildaten
        // wenn die /accesses API nicht erreichbar ist. Nutzt FUNCTION_EMAIL_MAP zur Zuordnung.
        function renderFunctionEmailsFromProfile() {
            if (!memberData || !memberData.funktion) {
                document.getElementById('no-function-emails').classList.remove('hidden');
                return;
            }

            const funktionen = memberData.funktion.split(',').map(f => f.trim()).filter(f => f);
            const emails = [];

            for (const func of funktionen) {
                const email = FUNCTION_EMAIL_MAP[func];
                if (email) {
                    emails.push({
                        function: func,
                        email: email,
                        server: 'mail.test.juroct.net',
                        imapPort: 993,
                        smtpPort: 587,
                        webmail: 'https://mail.test.juroct.net'
                    });
                }
            }

            renderFunctionEmails(emails);
        }

        // DEUTSCH: Fallback-Funktion: Generiert System-Zugaenge basierend auf der Funktion des Mitglieds
        // wenn die /accesses API nicht erreichbar ist.
        // Basis-Zugaenge (Website, Nextcloud) erhaelt jedes Mitglied.
        // Zusaetzliche Zugaenge je nach Rolle: Vorstand-Portal, Kassensystem, Admin-Panel.
        function renderDefaultSystemAccesses() {
            const funktion = memberData?.funktion || '';
            const funktionen = funktion.split(',').map(f => f.trim()).filter(f => f);

            // DEUTSCH: Pruefen ob das Mitglied eine Vorstandsfunktion hat
            const isVorstand = funktionen.some(f =>
                ['Präsident', 'Praesident', 'Aktuar', 'Kassier', 'Materialwart', 'Beisitzer', 'Beisitzerin'].includes(f)
            );
            const isKassier = funktionen.includes('Kassier');
            const isAdmin = funktionen.includes('Admin');

            // DEUTSCH: Basis-Zugaenge die jedes Mitglied hat
            const accesses = [
                { system: 'Website', url: 'https://fwv-raura.ch', access: 'Mitglied' },
                { system: 'Nextcloud', url: 'https://nextcloud.fwv-raura.ch', access: 'Mitglied' }
            ];

            // DEUTSCH: Rollenbasierte Zusatz-Zugaenge hinzufuegen
            if (isVorstand) {
                accesses.push({ system: 'Vorstand-Portal', url: 'https://fwv-raura.ch/vorstand.html', access: 'Vorstand' });
            }
            if (isKassier) {
                accesses.push({ system: 'Kassensystem', url: 'https://kasse.fwv-raura.ch', access: 'Kassier' });
            }
            if (isAdmin) {
                accesses.push({ system: 'Admin-Panel', url: 'https://fwv-raura.ch/admin.html', access: 'Admin' });
            }

            renderSystemAccesses(accesses);
        }

        // ============================================
        // DEUTSCH: RENDER-FUNKTIONEN FUER DEN ZUGAENGE-TAB
        // ============================================

        // DEUTSCH: Rendert die Funktions-E-Mails im Zugaenge-Tab als detaillierte Karten.
        // Jede Karte zeigt: Funktion, E-Mail, optionales Passwort (mit Anzeigen/Kopieren),
        // Mailserver-Infos (IMAP/SMTP Ports), Passwort-Aendern-Button und Webmail-Link.
        function renderFunctionEmails(emails) {
            const container = document.getElementById('function-emails-list');
            const noEmails = document.getElementById('no-function-emails');

            if (emails.length === 0) {
                container.innerHTML = '';
                noEmails.classList.remove('hidden');
                return;
            }

            noEmails.classList.add('hidden');

            container.innerHTML = emails.map(email => `
                <div class="border border-blue-100 bg-blue-50 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">${email.function}</h4>
                            <p class="text-blue-600 font-mono mt-1">${email.email}</p>
                        </div>
                        <button onclick="copyToClipboard('${email.email}')" class="text-gray-400 hover:text-gray-600" title="E-Mail kopieren">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
                            </svg>
                        </button>
                    </div>

                    ${email.password ? `
                        <div class="mt-3 pt-3 border-t border-blue-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="text-sm text-gray-600">Passwort:</span>
                                    <span id="pw-${email.email.replace('@', '-at-')}" class="ml-2 font-mono text-gray-800">••••••••</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="togglePassword('${email.email.replace('@', '-at-')}', '${email.password}')" class="text-sm text-blue-600 hover:text-blue-800">
                                        Zeigen
                                    </button>
                                    <button onclick="copyToClipboard('${email.password}')" class="text-sm text-gray-500 hover:text-gray-700">
                                        Kopieren
                                    </button>
                                </div>
                            </div>
                            ${email.passwordUpdatedAt ? `
                                <p class="text-xs text-gray-400 mt-1">Geändert: ${new Date(email.passwordUpdatedAt).toLocaleDateString('de-CH')}</p>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="mt-3 pt-3 border-t border-blue-200">
                            <p class="text-sm text-gray-500">Kein Passwort gespeichert. Setzen Sie ein neues Passwort, um es hier anzuzeigen.</p>
                        </div>
                    `}

                    <div class="mt-3 pt-3 border-t border-blue-200 text-sm text-gray-500">
                        <p><strong>Server:</strong> ${email.server}</p>
                        <p><strong>IMAP:</strong> ${email.imapPort} (SSL) | <strong>SMTP:</strong> ${email.smtpPort} (STARTTLS)</p>
                    </div>

                    <div class="mt-3 flex space-x-3">
                        <button onclick="changeFunctionEmailPassword('${email.email}')" class="text-sm px-3 py-1 bg-fire-500 text-white rounded hover:bg-fire-600">
                            Passwort ändern
                        </button>
                        <a href="${email.webmail}" target="_blank" class="text-sm px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                            Webmail öffnen
                        </a>
                    </div>
                </div>
            `).join('');
        }

        // DEUTSCH: Rendert die Nextcloud-Gruppenordner als klickbare Listeneintraege.
        // Jeder Eintrag zeigt den Ordnernamen, die zugehoerigen Gruppen und einen Direktlink zu Nextcloud.
        function renderNextcloudFolders(folders) {
            const container = document.getElementById('nextcloud-folders-list');
            const noFolders = document.getElementById('no-nextcloud-folders');

            if (folders.length === 0) {
                container.innerHTML = '';
                noFolders.classList.remove('hidden');
                return;
            }

            noFolders.classList.add('hidden');

            container.innerHTML = folders.map(folder => `
                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-blue-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                        </svg>
                        <div>
                            <p class="font-medium text-gray-800">${folder.name}</p>
                            <p class="text-xs text-gray-500">Gruppen: ${folder.groups.join(', ')}</p>
                        </div>
                    </div>
                    <a href="https://nextcloud.fwv-raura.ch/apps/files/?dir=/__groupfolders/${folder.id}" target="_blank"
                       class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
                        Öffnen
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                    </a>
                </div>
            `).join('');
        }

        // DEUTSCH: Rendert die SMB-Netzlaufwerk-Zugangsdaten im Zugaenge-Tab.
        // Zeigt Server, Benutzername, Passwort (mit Zeigen/Kopieren), verfuegbare Shares
        // und eine Kurzanleitung fuer Windows/macOS/Linux.
        function renderSmbCredentials(creds) {
            const section = document.getElementById('smb-section');
            const container = document.getElementById('smb-credentials');

            if (!creds) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');

            const updatedDate = new Date(creds.updatedAt).toLocaleDateString('de-CH');
            const nextRotation = new Date(creds.updatedAt);
            nextRotation.setMonth(nextRotation.getMonth() + 1);
            nextRotation.setDate(1);
            const nextRotationStr = nextRotation.toLocaleDateString('de-CH');

            container.innerHTML = `
                <div class="border border-amber-100 bg-amber-50 rounded-lg p-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <span class="text-sm text-gray-600">Server:</span>
                            <div class="flex items-center">
                                <span class="font-mono text-gray-800">${creds.server}</span>
                                <button onclick="copyToClipboard('${creds.server}')" class="ml-2 text-gray-400 hover:text-gray-600" title="Kopieren">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                                </button>
                            </div>
                        </div>
                        <div>
                            <span class="text-sm text-gray-600">Benutzer:</span>
                            <div class="flex items-center">
                                <span class="font-mono text-gray-800">${creds.user}</span>
                                <button onclick="copyToClipboard('${creds.user}')" class="ml-2 text-gray-400 hover:text-gray-600" title="Kopieren">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3 pt-3 border-t border-amber-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-sm text-gray-600">Passwort:</span>
                                <span id="pw-smb" class="ml-2 font-mono text-gray-800">\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022</span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="togglePassword('smb', '${creds.password}')" class="text-sm text-amber-600 hover:text-amber-800">Zeigen</button>
                                <button onclick="copyToClipboard('${creds.password}')" class="text-sm text-gray-500 hover:text-gray-700">Kopieren</button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Letzte Rotation: ${updatedDate} &middot; N\u00e4chste: ${nextRotationStr}</p>
                    </div>

                    <div class="mt-3 pt-3 border-t border-amber-200">
                        <span class="text-sm text-gray-600 font-medium">Verf\u00fcgbare Ordner:</span>
                        <div class="mt-2 space-y-1">
                            ${creds.shares.map(share => {
                                const displayPath = '\\\\' + creds.server + '\\' + share;
                                const copyPath = '\\\\\\\\' + creds.server + '\\\\' + share;
                                return '<div class="flex items-center justify-between py-1">' +
                                    '<span class="text-sm font-mono text-gray-700">' + displayPath + '</span>' +
                                    '<button onclick="copyToClipboard(\'' + copyPath + '\')" class="text-xs text-gray-400 hover:text-gray-600">Kopieren</button>' +
                                '</div>';
                            }).join('')}
                        </div>
                    </div>

                    <div class="mt-3 pt-3 border-t border-amber-200">
                        <details class="text-sm text-gray-500">
                            <summary class="cursor-pointer hover:text-gray-700">Verbindungsanleitung</summary>
                            <div class="mt-2 space-y-2 pl-4">
                                <p><strong>Windows:</strong> Explorer \u2192 Adressleiste \u2192 <code class="bg-gray-100 px-1 rounded">\\\\${creds.server}\\Ordnername</code></p>
                                <p><strong>macOS:</strong> Finder \u2192 Gehe zu \u2192 Mit Server verbinden \u2192 <code class="bg-gray-100 px-1 rounded">smb://${creds.server}/Ordnername</code></p>
                                <p><strong>Linux:</strong> Dateimanager \u2192 <code class="bg-gray-100 px-1 rounded">smb://${creds.server}/Ordnername</code></p>
                            </div>
                        </details>
                    </div>
                </div>
            `;
        }

        // DEUTSCH: Rendert Service-Account Zugangsdaten (z.B. roterschopf fuer Kasse/KDS).
        // Zeigt Benutzername, Passwort (versteckt/zeigen/kopieren), Beschreibung und Rotationsinfo.
        // Sichtbar fuer alle Mitglieder als gemeinsame Logins.
        function renderServiceAccounts(accounts) {
            const section = document.getElementById('service-accounts-section');
            const container = document.getElementById('service-accounts-list');

            if (!accounts || accounts.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');

            container.innerHTML = accounts.map((sa, index) => {
                const updatedDate = new Date(sa.updatedAt).toLocaleDateString('de-CH');
                const nextRotationDate = new Date(sa.nextRotation).toLocaleDateString('de-CH');
                const saId = 'sa-' + index;

                return `
                    <div class="border border-red-100 bg-red-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-800">${sa.displayName}</h3>
                            <span class="text-xs bg-fire-100 text-fire-700 px-2 py-1 rounded-full">Service Account</span>
                        </div>
                        ${sa.description ? `<p class="text-sm text-gray-600 mb-3">${sa.description}</p>` : ''}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <span class="text-sm text-gray-600">Benutzer:</span>
                                <div class="flex items-center">
                                    <span class="font-mono text-gray-800">${sa.username}</span>
                                    <button onclick="copyToClipboard('${sa.username}')" class="ml-2 text-gray-400 hover:text-gray-600" title="Kopieren">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Login-Seite:</span>
                                <div>
                                    <a href="https://order.fwv-raura.ch" target="_blank" class="text-sm text-fire-600 hover:text-fire-800">order.fwv-raura.ch</a>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3 pt-3 border-t border-red-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="text-sm text-gray-600">Passwort:</span>
                                    <span id="pw-${saId}" class="ml-2 font-mono text-gray-800">\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="togglePassword('${saId}', '${sa.password}')" class="text-sm text-fire-600 hover:text-fire-800">Zeigen</button>
                                    <button onclick="copyToClipboard('${sa.password}')" class="text-sm text-gray-500 hover:text-gray-700">Kopieren</button>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Letzte Rotation: ${updatedDate} \u00b7 N\u00e4chste: ${nextRotationDate} (alle ${sa.rotationDays} Tage)</p>
                        </div>

                        <div class="mt-3 pt-3 border-t border-red-200">
                            <details class="text-sm text-gray-500">
                                <summary class="cursor-pointer hover:text-gray-700">Verwendung</summary>
                                <div class="mt-2 space-y-1 pl-4">
                                    <p>\u2022 <strong>Kassensystem:</strong> <a href="https://order.fwv-raura.ch" target="_blank" class="text-fire-600 hover:underline">order.fwv-raura.ch</a> \u2192 Login mit Benutzer &amp; Passwort</p>
                                    <p>\u2022 <strong>Kitchen Display:</strong> <a href="https://order.fwv-raura.ch/kitchen" target="_blank" class="text-fire-600 hover:underline">order.fwv-raura.ch/kitchen</a> \u2192 Login mit Benutzer &amp; Passwort</p>
                                    <p>\u2022 <strong>Bestell-App:</strong> Gleicher Login in der mobilen App</p>
                                </div>
                            </details>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // DEUTSCH: Rendert die System-Zugaenge als einfache Liste mit System-Name, Zugangsstufe und Oeffnen-Link.
        // Jeder Eintrag hat ein gruenes Haekchen-Icon, den Systemnamen und die Berechtigung in Klammern.
        function renderSystemAccesses(accesses) {
            const container = document.getElementById('system-accesses-list');

            container.innerHTML = accesses.map(access => `
                <div class="flex items-center justify-between p-2">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span class="text-gray-800">${access.system}</span>
                        <span class="text-gray-500 text-sm ml-2">(${access.access})</span>
                    </div>
                    <a href="${access.url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                        Öffnen
                    </a>
                </div>
            `).join('');
        }

        // DEUTSCH: Rendert Events bei denen das Mitglied als Organisator eingetragen ist.
        // Zeigt pro Event: Titel, Datum, "Organisator"-Badge, optionale Event-Zugangsdaten
        // (E-Mail + Ablaufdatum) sowie Links zum Event-Dashboard und zur oeffentlichen Event-Seite.
        // Sektion wird komplett versteckt wenn das Mitglied kein Organisator ist.
        function renderOrganizerEvents(events) {
            const section = document.getElementById('organizer-events-section');
            const container = document.getElementById('organizer-events-list');

            if (events.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');

            container.innerHTML = events.map(event => {
                const startDate = new Date(event.startDate).toLocaleDateString('de-CH', {
                    weekday: 'short', day: 'numeric', month: 'short', year: 'numeric'
                });
                const endDate = event.endDate ? new Date(event.endDate).toLocaleDateString('de-CH', {
                    weekday: 'short', day: 'numeric', month: 'short'
                }) : null;

                return `
                    <div class="border border-purple-100 bg-purple-50 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">${event.title}</h4>
                                <p class="text-sm text-gray-600 mt-1">
                                    ${startDate}${endDate ? ` - ${endDate}` : ''}
                                </p>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-800">
                                Organisator
                            </span>
                        </div>

                        ${event.hasEventAccess ? `
                            <div class="mt-3 pt-3 border-t border-purple-200">
                                <p class="text-sm text-gray-600 mb-2"><strong>Event-Zugangsdaten:</strong></p>
                                <div class="bg-white rounded p-2 text-sm">
                                    <p><strong>E-Mail:</strong> <span class="font-mono">${event.eventEmail}</span>
                                        <button onclick="copyToClipboard('${event.eventEmail}')" class="ml-2 text-gray-400 hover:text-gray-600">
                                            <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
                                            </svg>
                                        </button>
                                    </p>
                                    ${event.accessExpires ? `
                                        <p class="text-xs text-gray-500 mt-1">Zugang gültig bis: ${new Date(event.accessExpires).toLocaleDateString('de-CH')}</p>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        <div class="mt-3 flex space-x-3">
                            <a href="${event.dashboardUrl}" target="_blank"
                               class="text-sm px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600">
                                Event-Dashboard
                            </a>
                            <a href="/events.html#event-${event.id}" target="_blank"
                               class="text-sm px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                                Event ansehen
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // DEUTSCH: HILFSFUNKTIONEN FUER DEN ZUGAENGE-TAB
        // ============================================

        // DEUTSCH: Schaltet die Passwort-Sichtbarkeit um (zwischen Klartext und Punkten).
        // Wird bei den Funktions-E-Mail-Karten im Zugaenge-Tab verwendet.
        function togglePassword(elementId, password) {
            const element = document.getElementById('pw-' + elementId);
            if (element.textContent === '••••••••') {
                element.textContent = password;
            } else {
                element.textContent = '••••••••';
            }
        }

        // DEUTSCH: Kopiert Text in die Zwischenablage (Zugaenge-Tab Version).
        // Zeigt eine Toast-Benachrichtigung "Kopiert!" unten rechts fuer 2 Sekunden an.
        // Diese Version hat keinen Button-Parameter und erzeugt stattdessen ein temporaeres DOM-Element.
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // DEUTSCH: Temporaere Toast-Benachrichtigung erzeugen und nach 2 Sekunden entfernen
                const notification = document.createElement('div');
                notification.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                notification.textContent = 'Kopiert!';
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }

        // DEUTSCH: Aendert das Passwort einer Funktions-E-Mail (Zugaenge-Tab Version mit Prompt-Dialog).
        // Im Gegensatz zur Profil-Tab-Version wird hier ein einfacher Prompt statt Formularfelder verwendet.
        // Nach Erfolg werden die Zugaenge neu geladen um das aktualisierte Passwort anzuzeigen.
        async function changeFunctionEmailPassword(email) {
            const newPassword = prompt('Neues Passwort eingeben (mindestens 8 Zeichen):');
            if (!newPassword || newPassword.length < 8) {
                if (newPassword !== null) {
                    alert('Das Passwort muss mindestens 8 Zeichen lang sein.');
                }
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/members/me/function-email-password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ password: newPassword, email: email })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Passwortänderung fehlgeschlagen');
                }

                alert('Passwort erfolgreich geändert!');
                accessesLoaded = false;
                loadAccesses();

            } catch (error) {
                console.error('Password change error:', error);
                alert('Fehler: ' + error.message);
            }
        }

        // ============================================
        // DEUTSCH: TAB-NAVIGATION
        // ============================================

        // DEUTSCH: Wechselt zwischen den 4 Tabs (profile, notifications, events, accesses).
        // 1. Setzt alle Tab-Buttons auf inaktiv zurueck (graue Schrift, transparenter Rand)
        // 2. Versteckt alle Sektionen
        // 3. Aktiviert den gewaehlten Tab visuell (rote Unterstreichung)
        // 4. Zeigt die entsprechende Sektion an
        // 5. Laedt bei Bedarf Daten nach (Lazy Loading): Benachrichtigungen und Zugaenge
        //    werden erst beim ersten Tab-Wechsel geladen, Events werden jedes Mal neu geladen
        function switchTab(tab) {
            currentTab = tab;

            // DEUTSCH: Alle Tab-Buttons auf inaktiv zuruecksetzen
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-fire-500', 'text-fire-600');
                btn.classList.add('border-transparent', 'text-gray-600');
            });

            // DEUTSCH: Alle Sektionen verstecken
            document.getElementById('profile-section').classList.add('hidden');
            document.getElementById('notifications-section').classList.add('hidden');
            document.getElementById('events-section').classList.add('hidden');
            document.getElementById('accesses-section').classList.add('hidden');

            // DEUTSCH: Gewaehlte Sektion anzeigen und Tab-Button aktivieren
            if (tab === 'profile') {
                document.getElementById('tab-profile').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('tab-profile').classList.remove('border-transparent', 'text-gray-600');
                document.getElementById('profile-section').classList.remove('hidden');
            } else if (tab === 'notifications') {
                document.getElementById('tab-notifications').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('tab-notifications').classList.remove('border-transparent', 'text-gray-600');
                document.getElementById('notifications-section').classList.remove('hidden');
                // DEUTSCH: Benachrichtigungen nur beim ersten Mal laden (Lazy Loading)
                if (notifications.length === 0) loadNotifications();
            } else if (tab === 'events') {
                document.getElementById('tab-events').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('tab-events').classList.remove('border-transparent', 'text-gray-600');
                document.getElementById('events-section').classList.remove('hidden');
                // DEUTSCH: Events bei jedem Tab-Wechsel neu laden (koennten sich geaendert haben)
                loadMyEvents();
            } else if (tab === 'accesses') {
                document.getElementById('tab-accesses').classList.add('border-fire-500', 'text-fire-600');
                document.getElementById('tab-accesses').classList.remove('border-transparent', 'text-gray-600');
                document.getElementById('accesses-section').classList.remove('hidden');
                // DEUTSCH: Zugaenge nur beim ersten Mal laden (Lazy Loading mit accessesLoaded-Flag)
                if (!accessesLoaded) loadAccesses();
            }
        }

        // ============================================
        // DEUTSCH: PROFILFOTO HOCHLADEN UND LOESCHEN
        // ============================================

        // DEUTSCH: Laedt ein Profilfoto per FormData-Upload an POST /members/me/photo hoch.
        // Nach erfolgreichem Upload wird die Vorschau aktualisiert und der Loeschen-Button eingeblendet.
        // Der Content-Type Header wird NICHT gesetzt - der Browser setzt ihn automatisch mit Boundary fuer FormData.
        async function uploadMyPhoto(file) {
            try {
                const formData = new FormData();
                formData.append('photo', file);

                const response = await fetch(`${API_BASE}/members/me/photo`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Upload fehlgeschlagen');
                }

                // DEUTSCH: Server gibt den Pfad zum gespeicherten Foto zurueck
                const data = await response.json();
                memberData.foto = data.foto;

                // DEUTSCH: Vorschau aktualisieren und Loeschen-Button einblenden
                document.getElementById('my-photo-preview').innerHTML = `<img src="${API_BASE}${data.foto}" class="w-full h-full object-cover">`;
                document.getElementById('my-photo-delete-btn').classList.remove('hidden');

                alert('Foto erfolgreich hochgeladen!');
            } catch (error) {
                console.error('Error uploading photo:', error);
                alert('Fehler beim Hochladen: ' + error.message);
            }
        }

        // DEUTSCH: Loescht das Profilfoto per DELETE /members/me/photo.
        // Zeigt eine Bestaetigungsabfrage und setzt nach Erfolg die Vorschau auf den Platzhalter zurueck.
        async function deleteMyPhoto() {
            if (!confirm('Möchten Sie Ihr Profilfoto wirklich entfernen?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/members/me/photo`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Löschen fehlgeschlagen');
                }

                memberData.foto = null;

                // DEUTSCH: Vorschau auf Platzhalter zuruecksetzen und Loeschen-Button verstecken
                document.getElementById('my-photo-preview').innerHTML = '<span class="text-gray-400 text-3xl">?</span>';
                document.getElementById('my-photo-delete-btn').classList.add('hidden');

                alert('Foto erfolgreich entfernt!');
            } catch (error) {
                console.error('Error deleting photo:', error);
                alert('Fehler beim Löschen: ' + error.message);
            }
        }

        // ============================================
        // DEUTSCH: EVENT-LISTENER REGISTRIERUNG
        // ============================================

        // DEUTSCH: Profil-Formular: Beim Absenden (Submit) wird saveProfile() aufgerufen
        document.getElementById('profile-form').addEventListener('submit', saveProfile);
        // DEUTSCH: Benachrichtigungs-Speichern-Button
        document.getElementById('save-notifications-btn').addEventListener('click', saveNotifications);

        // DEUTSCH: Tab-Wechsel-Buttons
        document.getElementById('tab-profile').addEventListener('click', () => switchTab('profile'));
        document.getElementById('tab-notifications').addEventListener('click', () => switchTab('notifications'));
        document.getElementById('tab-events').addEventListener('click', () => switchTab('events'));
        document.getElementById('tab-accesses').addEventListener('click', () => switchTab('accesses'));

        // DEUTSCH: Logout: Token aus localStorage entfernen und Authentik-Session beenden.
        // Die Weiterleitung zur end-session-URL invalidiert die Authentik-Session (Single Sign-Out).
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('auth_token');
            window.location.href = `${AUTHENTIK_URL}/application/o/fwv-members/end-session/`;
        });

        // DEUTSCH: Foto-Upload: Klick auf den "Foto hochladen"-Button oeffnet den versteckten File-Input
        document.getElementById('my-photo-upload-btn').addEventListener('click', () => {
            document.getElementById('my-photo-upload').click();
        });

        // DEUTSCH: Wenn eine Datei im File-Input ausgewaehlt wird: Groessenvalidierung (max 5MB) und Upload
        document.getElementById('my-photo-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('Die Datei ist zu gross. Maximal 5MB erlaubt.');
                    return;
                }
                uploadMyPhoto(file);
            }
        });

        // DEUTSCH: Foto-Loeschen-Button
        document.getElementById('my-photo-delete-btn').addEventListener('click', deleteMyPhoto);

        // ============================================
        // DEUTSCH: INITIALISIERUNG
        // ============================================

        // DEUTSCH: Sofortige Ausfuehrung beim Laden der Seite:
        // 1. Authentifizierung pruefen (Token validieren oder zum Login weiterleiten)
        // 2. Bei Erfolg das Profil laden und im Formular anzeigen
        (async () => {
            if (await checkAuth()) {
                await loadProfile();
            }
        })();
    </script>
</body>
</html>
