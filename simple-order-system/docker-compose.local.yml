# Local deployment for Raspberry Pi
# Runs Kasse + Inventar + Kitchen Display locally with cloud sync
#
# Usage:
#   1. Copy .env.local.example to .env
#   2. Configure printer IPs and cloud sync settings
#   3. docker compose -f docker-compose.local.yml up -d
#
# Access:
#   - Kasse: http://kasse.local or http://<pi-ip>:8080
#   - Kitchen: http://kitchen.local or http://<pi-ip>:8081
#   - Inventar: http://inventar.local or http://<pi-ip>:8082

services:
  # Shared PostgreSQL for both systems
  postgres:
    image: postgres:16-alpine
    container_name: local-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-localuser}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-localpass}
      POSTGRES_DB: ${DB_NAME:-localdb}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U ${DB_USER:-localuser}
      interval: 10s
      timeout: 5s
      retries: 5

  # Order System Backend (Kasse)
  order-backend:
    image: ghcr.io/feuerwehrverein-raura/order-backend:latest
    container_name: local-order-backend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      # Local Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-localdb}
      DB_USER: ${DB_USER:-localuser}
      DB_PASSWORD: ${DB_PASSWORD:-localpass}
      # No auth needed locally
      JWT_SECRET: local-secret-not-important
      # Printers (direct local network access!)
      PRINTER_BAR_IP: ${PRINTER_BAR_IP:-}
      PRINTER_BAR_PORT: ${PRINTER_BAR_PORT:-9100}
      PRINTER_KITCHEN_IP: ${PRINTER_KITCHEN_IP:-}
      PRINTER_KITCHEN_PORT: ${PRINTER_KITCHEN_PORT:-9100}
      # Local Inventory
      USE_INVENTORY_API: "true"
      INVENTORY_API_URL: http://inventory-backend:3000
      # Cloud Sync (optional)
      CLOUD_SYNC_ENABLED: ${CLOUD_SYNC_ENABLED:-false}
      CLOUD_API_URL: ${CLOUD_API_URL:-https://order.fwv-raura.ch/api}
      CLOUD_SYNC_KEY: ${CLOUD_SYNC_KEY:-}
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - 3000:3000

  # Order System Frontend (Kasse UI)
  order-frontend:
    image: ghcr.io/feuerwehrverein-raura/order-frontend:latest
    container_name: local-order-frontend
    restart: unless-stopped
    ports:
      - 8080:80

  # Kitchen Display
  order-kitchen:
    image: ghcr.io/feuerwehrverein-raura/order-kitchen:latest
    container_name: local-order-kitchen
    restart: unless-stopped
    ports:
      - 8081:80

  # Inventory Backend
  inventory-backend:
    image: ghcr.io/feuerwehrverein-raura/inventory-backend:latest
    container_name: local-inventory-backend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      # Local Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-localdb}
      DB_USER: ${DB_USER:-localuser}
      DB_PASSWORD: ${DB_PASSWORD:-localpass}
      # No auth needed locally
      JWT_SECRET: local-secret-not-important
      # Cloud Sync (optional)
      CLOUD_SYNC_ENABLED: ${CLOUD_SYNC_ENABLED:-false}
      CLOUD_API_URL: ${CLOUD_API_URL:-https://inventar.fwv-raura.ch/api}
      CLOUD_SYNC_KEY: ${CLOUD_SYNC_KEY:-}
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - 3001:3000

  # Inventory Frontend
  inventory-frontend:
    image: ghcr.io/feuerwehrverein-raura/inventory-frontend:latest
    container_name: local-inventory-frontend
    restart: unless-stopped
    ports:
      - 8082:80

  # Nginx Reverse Proxy (combines everything under nice URLs)
  nginx:
    image: nginx:alpine
    container_name: local-nginx
    restart: unless-stopped
    ports:
      - 80:80
    volumes:
      - ./nginx.local.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - order-backend
      - order-frontend
      - order-kitchen
      - inventory-backend
      - inventory-frontend
